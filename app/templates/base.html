<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}{{ branding.app_name }} - Enterprise Vulnerability Management{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/static/images/logo-192.png">
    <link rel="manifest" href="/static/manifest.json">
    <style>
        /* Professional Corporate Color Scheme */
        :root {
            /* Primary Brand Colors */
            --primary-color: #1e40af;
            --primary-dark: #1e3a8a;
            --primary-light: #3b82f6;

            /* Priority Colors - Clear and Professional */
            --critical-color: #dc2626;
            --high-color: #ea580c;
            --medium-color: #ca8a04;
            --low-color: #059669;

            /* Neutral Colors - Clean Corporate Look */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;

            /* Semantic Colors */
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* Background and surface colors for theming */
            --bg-color: var(--gray-50);
            --surface-color: white;
            --text-color: var(--gray-900);
            --text-muted: var(--gray-600);
            --border-color: var(--gray-200);
        }

        /* Dark Mode Theme - Softer dark for better readability */
        [data-theme="dark"] {
            --primary-color: #60a5fa;
            --primary-dark: #3b82f6;
            --primary-light: #93c5fd;

            --gray-50: #1e293b;
            --gray-100: #334155;
            --gray-200: #475569;
            --gray-300: #64748b;
            --gray-400: #94a3b8;
            --gray-500: #cbd5e1;
            --gray-600: #e2e8f0;
            --gray-700: #f1f5f9;
            --gray-800: #f8fafc;
            --gray-900: #ffffff;

            --bg-color: #1e293b;
            --surface-color: #334155;
            --text-color: #f1f5f9;
            --text-muted: #cbd5e1;
            --border-color: #475569;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.4), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        [data-theme="dark"] .top-navbar,
        [data-theme="dark"] .card,
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] .dropdown-menu,
        [data-theme="dark"] .app-footer {
            background-color: var(--surface-color);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        [data-theme="dark"] .card-header {
            background-color: var(--gray-100);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        [data-theme="dark"] .card-header span {
            color: var(--text-color);
        }

        [data-theme="dark"] .table {
            color: var(--text-color);
        }

        [data-theme="dark"] .table > :not(caption) > * > * {
            background-color: var(--surface-color);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        [data-theme="dark"] .table-hover > tbody > tr:hover > * {
            background-color: var(--gray-100);
        }

        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select {
            background-color: var(--gray-100);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        [data-theme="dark"] .form-control::placeholder {
            color: var(--gray-400);
        }

        [data-theme="dark"] .form-control:focus,
        [data-theme="dark"] .form-select:focus {
            background-color: var(--gray-100);
            border-color: var(--primary-color);
            color: var(--text-color);
        }

        [data-theme="dark"] .form-control:disabled,
        [data-theme="dark"] .form-control[readonly],
        [data-theme="dark"] .form-select:disabled {
            background-color: #1e293b;
            border-color: #334155;
            color: #94a3b8;
            opacity: 1;
        }

        [data-theme="dark"] .form-label,
        [data-theme="dark"] label {
            color: var(--text-color);
        }

        [data-theme="dark"] .form-text {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] .nav-link {
            color: var(--text-muted);
        }

        [data-theme="dark"] .nav-link:hover,
        [data-theme="dark"] .nav-link.active {
            color: var(--primary-light);
            background-color: var(--gray-100);
        }

        [data-theme="dark"] .dropdown-menu {
            background-color: #1e293b;
            border-color: #475569;
        }

        [data-theme="dark"] .dropdown-item {
            color: #e2e8f0;
        }

        [data-theme="dark"] .dropdown-item:hover,
        [data-theme="dark"] .dropdown-item:focus {
            background-color: #334155;
            color: #f1f5f9;
        }

        [data-theme="dark"] .dropdown-item.active {
            background-color: var(--primary-color);
            color: white;
        }

        [data-theme="dark"] .dropdown-item-text {
            color: #e2e8f0;
        }

        [data-theme="dark"] .dropdown-item-text .fw-semibold,
        [data-theme="dark"] .dropdown-item-text strong {
            color: #f1f5f9;
        }

        [data-theme="dark"] .dropdown-item-text small,
        [data-theme="dark"] .dropdown-item-text .text-muted {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .dropdown-divider {
            border-color: #475569;
        }

        [data-theme="dark"] .text-muted {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] .text-dark,
        [data-theme="dark"] .fw-semibold,
        [data-theme="dark"] .fw-bold {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3,
        [data-theme="dark"] h4, [data-theme="dark"] h5, [data-theme="dark"] h6,
        [data-theme="dark"] .display-6 {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] p {
            color: var(--text-color);
        }

        /* Dark mode code and strong element styling */
        [data-theme="dark"] code {
            color: #93c5fd;
            background-color: rgba(59, 130, 246, 0.15);
        }

        [data-theme="dark"] strong {
            color: var(--text-color);
        }

        [data-theme="dark"] .table td,
        [data-theme="dark"] .modal-body td {
            color: var(--text-color);
        }

        [data-theme="dark"] .table code,
        [data-theme="dark"] .modal-body code {
            color: #93c5fd;
            background-color: rgba(59, 130, 246, 0.15);
        }

        [data-theme="dark"] .btn-outline-secondary {
            color: var(--text-muted);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .btn-outline-secondary:hover {
            background-color: var(--gray-100);
            color: var(--text-color);
        }

        /* Dark mode button adjustments */
        [data-theme="dark"] .btn-primary,
        [data-theme="dark"] .btn-success {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        [data-theme="dark"] .btn-primary:hover,
        [data-theme="dark"] .btn-success:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        [data-theme="dark"] .btn-danger {
            border-color: #f87171;
            color: #f87171;
        }

        [data-theme="dark"] .btn-danger:hover {
            background-color: #dc2626;
            color: white;
        }

        [data-theme="dark"] .btn-warning {
            border-color: #fbbf24;
            color: #fbbf24;
        }

        [data-theme="dark"] .btn-warning:hover {
            background-color: #f59e0b;
            color: #1e293b;
        }

        /* Dark mode outline button variants */
        [data-theme="dark"] .btn-outline-success {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        [data-theme="dark"] .btn-outline-success:hover {
            background-color: var(--primary-color);
            color: white;
        }

        [data-theme="dark"] .btn-outline-danger {
            border-color: #f87171;
            color: #f87171;
        }

        [data-theme="dark"] .btn-outline-danger:hover {
            background-color: #dc2626;
            color: white;
        }

        [data-theme="dark"] .btn-outline-warning {
            border-color: #fbbf24;
            color: #fbbf24;
        }

        [data-theme="dark"] .btn-outline-warning:hover {
            background-color: #f59e0b;
            color: #1e293b;
        }

        [data-theme="dark"] .alert-info {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
            color: #bfdbfe;
        }

        [data-theme="dark"] .vuln-card {
            background-color: var(--surface-color);
            color: var(--text-color);
        }

        /* Dark mode: fix version box, collapsible sections, software overview rows */
        [data-theme="dark"] .border-start.border-success.bg-light {
            background-color: rgba(16, 185, 129, 0.1) !important;
        }

        [data-theme="dark"] .software-overview-row {
            border-bottom-color: var(--border-color, #333) !important;
        }

        [data-theme="dark"] .software-overview-row:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        /* Dark mode settings group separator */
        [data-theme="dark"] .settings-group-separator hr {
            border-color: rgba(255, 255, 255, 0.15) !important;
        }

        [data-theme="dark"] .modal-title {
            color: var(--text-color);
        }

        [data-theme="dark"] .modal-body {
            color: var(--text-color);
        }

        [data-theme="dark"] .badge {
            color: inherit;
        }

        [data-theme="dark"] .page-title,
        [data-theme="dark"] .page-subtitle {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] a {
            color: var(--primary-light);
        }

        [data-theme="dark"] a:hover {
            color: var(--primary-color);
        }

        [data-theme="dark"] .copyright-notice {
            color: var(--text-muted);
        }

        [data-theme="dark"] .copyright-notice a {
            color: var(--primary-light);
        }

        /* Dark mode alert cards */
        [data-theme="dark"] .alert-card {
            background: var(--surface-color) !important;
        }

        [data-theme="dark"] .alert-card-critical {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.15) 0%, rgba(220, 38, 38, 0.25) 100%) !important;
            border-color: rgba(220, 38, 38, 0.4);
        }

        [data-theme="dark"] .alert-card-high {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.25) 100%) !important;
            border-color: rgba(245, 158, 11, 0.4);
        }

        [data-theme="dark"] .alert-card-medium {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.25) 100%) !important;
            border-color: rgba(59, 130, 246, 0.4);
        }

        [data-theme="dark"] .alert-card-low {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.25) 100%) !important;
            border-color: rgba(16, 185, 129, 0.4);
        }

        [data-theme="dark"] .alert-card-label,
        [data-theme="dark"] .alert-card small {
            color: var(--text-muted) !important;
        }

        /* Dark mode sync results */
        [data-theme="dark"] .alert-success {
            background-color: rgba(16, 185, 129, 0.15) !important;
            border-color: rgba(16, 185, 129, 0.4) !important;
            color: #6ee7b7 !important;
        }

        [data-theme="dark"] .alert-success .alert-heading,
        [data-theme="dark"] .alert-success h4,
        [data-theme="dark"] .alert-success h5 {
            color: #6ee7b7 !important;
        }

        [data-theme="dark"] .alert-success small {
            color: #a7f3d0 !important;
        }

        [data-theme="dark"] .alert-danger {
            background-color: rgba(220, 38, 38, 0.15) !important;
            border-color: rgba(220, 38, 38, 0.4) !important;
            color: #fca5a5 !important;
        }

        [data-theme="dark"] .alert-warning {
            background-color: rgba(245, 158, 11, 0.15) !important;
            border-color: rgba(245, 158, 11, 0.4) !important;
            color: #fcd34d !important;
        }

        [data-theme="dark"] .alert-secondary {
            background-color: rgba(100, 116, 139, 0.2) !important;
            border-color: rgba(100, 116, 139, 0.4) !important;
            color: #cbd5e1 !important;
        }

        [data-theme="dark"] .alert-secondary .alert-heading,
        [data-theme="dark"] .alert-secondary h6,
        [data-theme="dark"] .alert-secondary strong {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .alert-secondary p,
        [data-theme="dark"] .alert-secondary small {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .alert-light {
            background-color: rgba(148, 163, 184, 0.15) !important;
            border-color: rgba(148, 163, 184, 0.3) !important;
            color: #cbd5e1 !important;
        }

        [data-theme="dark"] .alert hr {
            border-color: var(--border-color);
        }

        /* Dark mode bg-light - used in license cards, LDAP sync, etc. */
        [data-theme="dark"] .bg-light {
            background-color: #334155 !important;
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .bg-light .card-title,
        [data-theme="dark"] .bg-light h5,
        [data-theme="dark"] .bg-light h6 {
            color: #f1f5f9 !important;
        }

        [data-theme="dark"] .bg-light p,
        [data-theme="dark"] .bg-light span,
        [data-theme="dark"] .bg-light .text-muted {
            color: #94a3b8 !important;
        }

        /* Dark mode for read-only form controls used as display fields */
        [data-theme="dark"] .form-control.bg-light {
            background-color: #334155 !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }

        /* Dark mode table text */
        [data-theme="dark"] td,
        [data-theme="dark"] th {
            color: var(--text-color);
        }

        [data-theme="dark"] .text-success {
            color: #6ee7b7 !important;
        }

        [data-theme="dark"] .text-danger {
            color: #fca5a5 !important;
        }

        [data-theme="dark"] .text-warning {
            color: #fcd34d !important;
        }

        [data-theme="dark"] .text-primary {
            color: var(--primary-light) !important;
        }

        /* Dark mode pagination */
        [data-theme="dark"] .pagination .page-link {
            background-color: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }

        [data-theme="dark"] .pagination .page-link:hover {
            background-color: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        [data-theme="dark"] .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        [data-theme="dark"] .pagination .page-item.disabled .page-link {
            background-color: #1e293b;
            border-color: #334155;
            color: #64748b;
        }

        /* Dark mode column toggles */
        [data-theme="dark"] .column-toggle {
            background: #334155;
            color: #cbd5e1;
            border-color: #475569;
        }

        [data-theme="dark"] .column-toggle:hover {
            background: #475569;
            color: #f1f5f9;
        }

        [data-theme="dark"] .column-toggle.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ============================================================================
           SIDEBAR LAYOUT SYSTEM
           ============================================================================ */

        /* Top Navigation Bar - Clean and Professional */
        .top-navbar {
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1050;
        }

        [data-theme="dark"] .top-navbar {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-bottom-color: var(--border-color);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        [data-theme="dark"] .navbar-brand {
            color: #f1f5f9;
        }

        .navbar-brand img {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        [data-theme="dark"] .navbar-brand img {
            filter: brightness(0) invert(1);
        }

        /* Content wrapper - holds sidebar + main content */
        .content-wrapper {
            display: flex;
            flex: 1;
            min-height: 0; /* Allow flexbox to shrink */
        }

        /* ============================================
           ENHANCED SIDEBAR - Collapsible with Submenus
           ============================================ */

        .app-sidebar {
            width: 260px;
            background: var(--gray-100);
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: sticky;
            top: 56px; /* Navbar height */
            height: calc(100vh - 56px);
            overflow-y: auto;
            overflow-x: hidden;
            transition: width 0.3s ease;
        }

        [data-theme="dark"] .app-sidebar {
            background: var(--surface-color);
            border-right-color: var(--border-color);
        }

        .app-sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .app-sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .app-sidebar::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 3px;
        }

        /* Sidebar Header with Collapse Button */
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        [data-theme="dark"] .sidebar-header {
            border-bottom-color: var(--border-color);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .sidebar-collapse-btn {
            background: transparent;
            border: none;
            padding: 0.4rem;
            cursor: pointer;
            color: var(--gray-500);
            border-radius: 0.375rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-collapse-btn:hover {
            background: var(--gray-200);
            color: var(--gray-900);
        }

        [data-theme="dark"] .sidebar-collapse-btn:hover {
            background: var(--gray-100);
            color: var(--text-color);
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            flex: 1;
            padding: 0.75rem 0;
        }

        .sidebar-nav-section {
            padding: 0 0.5rem;
            margin-bottom: 0.5rem;
        }

        .sidebar-nav-title {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--gray-400);
            padding: 0.75rem 0.75rem 0.4rem;
            margin-bottom: 0;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
        }

        [data-theme="dark"] .sidebar-link {
            color: var(--gray-400);
        }

        .sidebar-link:hover {
            background: var(--gray-200);
            color: var(--gray-900);
        }

        [data-theme="dark"] .sidebar-link:hover {
            background: var(--gray-100);
            color: var(--text-color);
        }

        .sidebar-link.active {
            background: var(--primary-color);
            color: white;
        }

        [data-theme="dark"] .sidebar-link.active {
            background: var(--primary-color);
            color: white;
        }

        .sidebar-link i {
            font-size: 1.1rem;
            width: 22px;
            text-align: center;
            flex-shrink: 0;
        }

        .sidebar-link .link-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-link .badge {
            margin-left: auto;
            font-size: 0.6rem;
            padding: 0.2rem 0.4rem;
        }

        /* Submenu toggle arrow */
        .sidebar-link .submenu-arrow {
            margin-left: auto;
            font-size: 0.75rem;
            transition: transform 0.2s ease;
        }

        .sidebar-link.expanded .submenu-arrow {
            transform: rotate(90deg);
        }

        /* Submenu container */
        .sidebar-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.25s ease-out;
            background: rgba(0,0,0,0.02);
            border-radius: 0.375rem;
            margin: 0 0.25rem 0.25rem;
        }

        [data-theme="dark"] .sidebar-submenu {
            background: rgba(0,0,0,0.15);
        }

        .sidebar-submenu.open {
            max-height: 500px;
            transition: max-height 0.35s ease-in;
        }

        /* Submenu items */
        .sidebar-submenu .sidebar-sublink {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.45rem 0.75rem 0.45rem 2.5rem;
            color: var(--gray-600);
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 500;
            border-radius: 0.375rem;
            transition: all 0.15s ease;
            margin: 2px 0.25rem;
        }

        [data-theme="dark"] .sidebar-submenu .sidebar-sublink {
            color: var(--gray-400);
        }

        .sidebar-submenu .sidebar-sublink:hover {
            background: var(--gray-200);
            color: var(--gray-900);
        }

        [data-theme="dark"] .sidebar-submenu .sidebar-sublink:hover {
            background: var(--gray-100);
            color: var(--text-color);
        }

        .sidebar-submenu .sidebar-sublink.active {
            background: var(--primary-light);
            color: white;
        }

        .sidebar-submenu .sidebar-sublink i {
            font-size: 0.85rem;
            width: 18px;
        }

        /* Sidebar Footer */
        .sidebar-footer {
            padding: 0.75rem;
            border-top: 1px solid var(--gray-200);
            flex-shrink: 0;
        }

        [data-theme="dark"] .sidebar-footer {
            border-top-color: var(--border-color);
        }

        /* Main Content Area */
        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0; /* Prevent flex overflow */
            overflow-x: hidden;
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            background: transparent;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--gray-600);
            border-radius: 0.375rem;
            transition: all 0.2s;
            display: none; /* Hidden by default on desktop */
        }

        .sidebar-toggle:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        .sidebar-toggle i {
            font-size: 1.25rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 1.25rem 1.75rem;
        }

        /* Breadcrumb Styles */
        .breadcrumb-container {
            padding: 0.75rem 1.75rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        [data-theme="dark"] .breadcrumb-container {
            background: var(--gray-100);
            border-bottom-color: var(--border-color);
        }

        .breadcrumb {
            margin-bottom: 0;
            font-size: 0.8rem;
            background: transparent;
            padding: 0;
        }

        .breadcrumb-item a {
            color: var(--gray-600);
            text-decoration: none;
        }

        .breadcrumb-item a:hover {
            color: var(--primary-color);
        }

        .breadcrumb-item.active {
            color: var(--gray-900);
            font-weight: 500;
        }

        [data-theme="dark"] .breadcrumb-item.active {
            color: var(--text-color);
        }

        /* ============================================
           COLLAPSED SIDEBAR STATE (Icon-only mode)
           ============================================ */

        .sidebar-collapsed .app-sidebar {
            width: 60px;
        }

        .sidebar-collapsed .sidebar-brand span,
        .sidebar-collapsed .sidebar-nav-title,
        .sidebar-collapsed .sidebar-link .link-text,
        .sidebar-collapsed .sidebar-link .badge,
        .sidebar-collapsed .sidebar-link .submenu-arrow,
        .sidebar-collapsed .sidebar-submenu {
            display: none;
        }

        .sidebar-collapsed .sidebar-link {
            justify-content: center;
            padding: 0.65rem;
        }

        .sidebar-collapsed .sidebar-link i {
            margin: 0;
            font-size: 1.2rem;
        }

        .sidebar-collapsed .sidebar-header {
            justify-content: center;
            padding: 0.75rem 0.5rem;
        }

        .sidebar-collapsed .sidebar-collapse-btn i::before {
            content: "\F285"; /* bi-chevron-right */
        }

        /* Tooltip for collapsed state */
        .sidebar-collapsed .sidebar-link {
            position: relative;
        }

        .sidebar-collapsed .sidebar-link::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--gray-900);
            color: white;
            padding: 0.35rem 0.65rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
            margin-left: 0.5rem;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .sidebar-collapsed .sidebar-link:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* ============================================
           LOADING SKELETON STYLES
           ============================================ */

        .skeleton {
            background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 0.375rem;
        }

        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, var(--gray-100) 25%, var(--gray-200) 50%, var(--gray-100) 75%);
            background-size: 200% 100%;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 1rem;
            margin-bottom: 0.5rem;
        }

        .skeleton-text-sm {
            height: 0.75rem;
            width: 60%;
        }

        .skeleton-title {
            height: 1.5rem;
            width: 40%;
            margin-bottom: 1rem;
        }

        .skeleton-card {
            height: 120px;
            margin-bottom: 1rem;
        }

        .skeleton-table-row {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .skeleton-table-cell {
            height: 1rem;
            flex: 1;
        }

        .skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        /* Mobile Responsive */
        @media (max-width: 991.98px) {
            .app-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 1045;
                transform: translateX(-100%);
            }

            .content-wrapper {
                flex-direction: column;
            }

            .sidebar-toggle {
                display: block !important;
            }

            .sidebar-open .app-sidebar {
                transform: translateX(0);
            }

            .sidebar-open .sidebar-overlay {
                display: block;
            }

            /* Full-width modals on mobile */
            .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
            }

            /* Scrollable tables on mobile */
            .table-responsive-mobile {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Stack form columns on mobile */
            .row.g-2 > [class*="col-md-"],
            .row.g-3 > [class*="col-md-"] {
                width: 100%;
            }

            /* Adjust card padding on mobile */
            .card-body {
                padding: 1rem;
            }

            /* Smaller buttons on mobile */
            .btn-group-mobile .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
            }
        }

        /* Extra small mobile screens */
        @media (max-width: 575.98px) {
            .modal-dialog {
                margin: 0;
                max-width: 100%;
            }

            .modal-content {
                border-radius: 0;
                min-height: 100vh;
            }

            /* Hide less important table columns on very small screens */
            .hide-xs {
                display: none !important;
            }

            /* Stack action buttons */
            .btn-group.flex-wrap-mobile {
                flex-wrap: wrap;
                gap: 0.25rem;
            }
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1040;
        }

        /* Legacy nav-link support */
        .nav-link {
            color: var(--gray-700);
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link:hover,
        .nav-link.active {
            background: var(--gray-100);
            color: var(--primary-color);
        }

        /* Cards */
        .card {
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            background: white;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Priority Alert Cards */
        .priority-alert {
            border-left: 4px solid;
            padding: 1.25rem;
            border-radius: 0.5rem;
            background: white;
            box-shadow: var(--shadow);
            transition: all 0.2s;
        }

        .priority-alert:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .priority-alert.critical {
            border-left-color: var(--critical-color);
            background: linear-gradient(to right, rgba(220, 38, 38, 0.05), white);
        }

        .priority-alert.high {
            border-left-color: var(--high-color);
            background: linear-gradient(to right, rgba(234, 88, 12, 0.05), white);
        }

        .priority-alert.medium {
            border-left-color: var(--medium-color);
            background: linear-gradient(to right, rgba(202, 138, 4, 0.05), white);
        }

        .priority-alert.low {
            border-left-color: var(--low-color);
            background: linear-gradient(to right, rgba(5, 150, 105, 0.05), white);
        }

        /* Stat Cards */
        .stat-card {
            padding: 1.5rem;
            border-radius: 0.75rem;
            background: white;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.15;
        }

        /* Buttons - Professional, clean styling */
        .btn {
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background-color 0.15s ease, border-color 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            border: 1px solid transparent;
            font-size: 0.875rem;
        }

        .btn-sm {
            padding: 0.25rem 0.625rem;
            font-size: 0.8125rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        /* Success actions use primary color for consistency */
        .btn-success {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        /* Danger actions - outlined style for less visual noise */
        .btn-danger {
            background-color: transparent;
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: var(--danger-color);
            color: white;
        }

        /* Warning - subtle muted style */
        .btn-warning {
            background-color: transparent;
            border-color: var(--warning-color);
            color: #92400e;
        }

        .btn-warning:hover {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-outline-primary {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-outline-secondary {
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
            background: transparent;
        }

        .btn-outline-secondary:hover {
            background-color: var(--gray-100);
            border-color: var(--gray-400);
        }

        /* Outline button variants - subtle, professional */
        .btn-outline-success {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
        }

        .btn-outline-success:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-outline-danger {
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            background: transparent;
        }

        .btn-outline-danger:hover {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-outline-warning {
            border: 1px solid var(--warning-color);
            color: #92400e;
            background: transparent;
        }

        .btn-outline-warning:hover {
            background-color: var(--warning-color);
            color: white;
        }

        /* Forms */
        .form-control,
        .form-select {
            border-radius: 0.5rem;
            border: 1px solid var(--gray-300);
            padding: 0.625rem 1rem;
            transition: all 0.2s;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        /* Tables */
        .table {
            background: white;
        }

        .table thead th {
            background: var(--gray-50);
            border-bottom: 2px solid var(--gray-200);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            color: var(--gray-700);
            padding: 1rem;
        }

        .table tbody tr {
            transition: all 0.2s;
        }

        .table tbody tr:hover {
            background: var(--gray-50);
        }

        /* Badges - Clean Professional Style */
        .badge {
            padding: 0.35rem 0.65rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.7rem;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .badge i {
            font-size: 0.65rem;
        }

        /* Role Badges - Subtle, Professional */
        .badge-role-super {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .badge-role-admin {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .badge-role-manager {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .badge-role-user {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }

        /* Auth Type Badges */
        .badge-auth-ldap {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .badge-auth-local {
            background: #f8fafc;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        /* Status Badges */
        .badge-status-active {
            background: #ecfdf5;
            color: #047857;
            border: 1px solid #a7f3d0;
        }

        .badge-status-inactive {
            background: #f9fafb;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        /* Dark mode badge overrides - high contrast versions */
        [data-theme="dark"] .badge-role-super {
            background: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
            border-color: rgba(220, 38, 38, 0.4);
        }

        [data-theme="dark"] .badge-role-admin {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border-color: rgba(245, 158, 11, 0.4);
        }

        [data-theme="dark"] .badge-role-manager {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border-color: rgba(59, 130, 246, 0.4);
        }

        [data-theme="dark"] .badge-role-user {
            background: rgba(107, 114, 128, 0.2);
            color: #d1d5db;
            border-color: rgba(107, 114, 128, 0.4);
        }

        [data-theme="dark"] .badge-auth-ldap {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border-color: rgba(16, 185, 129, 0.4);
        }

        [data-theme="dark"] .badge-auth-local {
            background: rgba(100, 116, 139, 0.2);
            color: #cbd5e1;
            border-color: rgba(100, 116, 139, 0.4);
        }

        [data-theme="dark"] .badge-status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border-color: rgba(16, 185, 129, 0.4);
        }

        [data-theme="dark"] .badge-status-inactive {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
            border-color: rgba(107, 114, 128, 0.4);
        }

        /* Status LED indicator */
        .status-led {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-led-green {
            background: #10b981;
            box-shadow: 0 0 6px #10b981;
        }
        .status-led-red {
            background: #ef4444;
            box-shadow: 0 0 6px #ef4444;
        }
        .status-led-yellow {
            background: #f59e0b;
            box-shadow: 0 0 6px #f59e0b;
        }

        /* Priority Badges */
        .badge-critical {
            background: var(--critical-color);
            color: white;
        }

        .badge-high {
            background: var(--high-color);
            color: white;
        }

        .badge-medium {
            background: var(--medium-color);
            color: white;
        }

        .badge-low {
            background: var(--low-color);
            color: white;
        }

        /* Action Buttons - Clean Icon Style */
        .btn-action {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: 1px solid transparent;
            background: transparent;
            transition: all 0.15s ease;
        }

        .btn-action i {
            font-size: 0.875rem;
        }

        .btn-action-edit {
            color: var(--primary-color);
        }

        .btn-action-edit:hover {
            background: #eff6ff;
            border-color: #bfdbfe;
            color: var(--primary-dark);
        }

        .btn-action-block {
            color: #d97706;
        }

        .btn-action-block:hover {
            background: #fffbeb;
            border-color: #fde68a;
            color: #b45309;
        }

        .btn-action-delete {
            color: #dc2626;
        }

        .btn-action-delete:hover {
            background: #fef2f2;
            border-color: #fecaca;
            color: #b91c1c;
        }

        .btn-action-success {
            color: #059669;
        }

        .btn-action-success:hover {
            background: #ecfdf5;
            border-color: #a7f3d0;
            color: #047857;
        }

        .btn-action-warning {
            color: #d97706;
        }

        .btn-action-warning:hover {
            background: #fffbeb;
            border-color: #fcd34d;
            color: #b45309;
        }

        .btn-action-primary {
            color: var(--primary-color);
        }

        .btn-action-primary:hover {
            background: #eff6ff;
            border-color: #bfdbfe;
            color: var(--primary-dark);
        }

        .btn-action-secondary {
            color: var(--gray-500);
        }

        .btn-action-secondary:hover {
            background: var(--gray-100);
            border-color: var(--gray-300);
            color: var(--gray-700);
        }

        /* Table Column Controls */
        .table-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .column-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            background: var(--gray-100);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
            transition: all 0.15s;
        }

        .column-toggle:hover {
            background: var(--gray-200);
        }

        .column-toggle.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .column-toggle input {
            display: none;
        }

        /* Resizable table columns */
        .table-resizable th {
            position: relative;
            min-width: 80px;
        }

        .table-resizable th .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            background: transparent;
        }

        .table-resizable th .resize-handle:hover {
            background: var(--primary-color);
        }

        /* Vulnerability Cards */
        .vuln-card {
            border-left: 4px solid var(--gray-400);
            transition: all 0.2s;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
        }

        .vuln-card.priority-critical {
            border-left-color: var(--critical-color);
        }

        .vuln-card.priority-high {
            border-left-color: var(--high-color);
        }

        .vuln-card.priority-medium {
            border-left-color: var(--medium-color);
        }

        .vuln-card.priority-low {
            border-left-color: var(--low-color);
        }

        .vuln-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            display: none !important;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-overlay.show {
            display: flex !important;
        }

        /* Disable modal backdrops completely - they were causing grey overlay issues */
        .modal-backdrop {
            display: none !important;
        }

        /* Toast Notifications */
        .toast {
            border-radius: 0.5rem;
            border: none;
            box-shadow: var(--shadow-lg);
        }

        /* Footer */
        .app-footer {
            background: white;
            padding: 1.5rem 0;
            margin-top: auto; /* Push to bottom */
            border-top: 1px solid var(--gray-200);
            text-align: center;
            color: var(--gray-600);
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        /* Modal Improvements - Compact Styling */
        .modal-content {
            border: none;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-xl);
            font-size: 0.875rem;
        }

        .modal-header {
            border-bottom: 1px solid var(--gray-200);
            padding: 1rem 1.25rem;
        }

        .modal-header .modal-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-body {
            padding: 1rem 1.25rem;
        }

        .modal-body .form-label {
            font-size: 0.8125rem;
            margin-bottom: 0.25rem;
        }

        .modal-body .form-control,
        .modal-body .form-select {
            font-size: 0.8125rem;
            padding: 0.375rem 0.625rem;
        }

        .modal-body .form-text {
            font-size: 0.75rem;
        }

        .modal-body .row.g-3 {
            --bs-gutter-y: 0.75rem;
        }

        .modal-footer {
            border-top: 1px solid var(--gray-200);
            padding: 0.75rem 1.25rem;
        }

        .modal-footer .btn {
            font-size: 0.8125rem;
            padding: 0.375rem 0.75rem;
        }

        /* Compact table styling */
        .table-compact td,
        .table-compact th {
            font-size: 0.8125rem;
            padding: 0.5rem 0.75rem;
        }

        /* Dark mode toggle button */
        .theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--gray-200);
            background: transparent;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--gray-100);
            color: var(--gray-800);
        }

        [data-theme="dark"] .theme-toggle {
            border-color: var(--border-color);
            color: var(--text-muted);
        }

        [data-theme="dark"] .theme-toggle:hover {
            background: var(--gray-100);
            color: var(--text-color);
        }

        /* Page Header */
        .page-header {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            border: 1px solid var(--gray-200);
        }

        .page-title {
            font-size: 1.875rem;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--gray-600);
            font-size: 1rem;
        }

        /* Copyright Footer */
        .copyright-notice {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.5rem;
        }

        /* Sortable Table Headers */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: background-color 0.15s;
        }

        .sortable-header:hover {
            background-color: var(--gray-100);
        }

        .sortable-header .sort-icon {
            display: inline-block;
            margin-left: 0.25rem;
            opacity: 0.3;
            transition: opacity 0.15s, transform 0.15s;
        }

        .sortable-header:hover .sort-icon {
            opacity: 0.6;
        }

        .sortable-header.sort-asc .sort-icon {
            opacity: 1;
            color: var(--primary-color);
            transform: rotate(0deg);
        }

        .sortable-header.sort-desc .sort-icon {
            opacity: 1;
            color: var(--primary-color);
            transform: rotate(180deg);
        }

        [data-theme="dark"] .sortable-header:hover {
            background-color: var(--gray-100);
        }

        /* ============================================================================
           Resizable Columns
           ============================================================================ */
        .resizable-table th {
            position: relative;
        }

        .resizable-table th .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: col-resize;
            background: transparent;
            z-index: 10;
            transition: background-color 0.2s;
        }

        .resizable-table th .resize-handle:hover,
        .resizable-table th .resize-handle.resizing {
            background: var(--primary-color);
            opacity: 0.5;
        }

        .resizable-table th .resize-handle::after {
            content: '';
            position: absolute;
            right: 2px;
            top: 25%;
            height: 50%;
            width: 2px;
            background: var(--gray-300);
            border-radius: 1px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .resizable-table th:hover .resize-handle::after {
            opacity: 1;
        }

        /* Prevent text selection while resizing */
        .resizing-active {
            user-select: none;
            cursor: col-resize !important;
        }

        .resizing-active * {
            cursor: col-resize !important;
        }

        /* ============================================================================
           Column Visibility Dropdown (SentriKat Styled)
           ============================================================================ */
        .column-dropdown {
            min-width: 220px;
            padding: 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .column-dropdown .dropdown-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: none;
        }

        .column-dropdown .dropdown-header i {
            font-size: 1rem;
        }

        .column-dropdown .column-list {
            padding: 8px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .column-dropdown .column-item {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.15s;
            gap: 10px;
        }

        .column-dropdown .column-item:hover {
            background-color: var(--gray-100);
        }

        .column-dropdown .column-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid var(--gray-300);
            cursor: pointer;
            flex-shrink: 0;
        }

        .column-dropdown .column-item input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .column-dropdown .column-item .column-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--gray-600);
            flex-shrink: 0;
        }

        .column-dropdown .column-item label {
            flex: 1;
            margin: 0;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-color);
        }

        .column-dropdown .dropdown-divider {
            margin: 8px 0;
            border-top: 1px solid var(--border-color);
        }

        .column-dropdown .dropdown-footer {
            padding: 8px 12px;
            background: var(--gray-50);
            border-top: 1px solid var(--border-color);
        }

        .column-dropdown .reset-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px dashed var(--gray-300);
            border-radius: 6px;
            background: transparent;
            color: var(--gray-600);
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .column-dropdown .reset-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: var(--primary-color);
            background: rgba(30, 64, 175, 0.05);
        }

        /* Column toggle button */
        .btn-column-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 0.8125rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--surface-color);
            color: var(--gray-600);
            transition: all 0.2s;
        }

        .btn-column-toggle:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: var(--surface-color);
        }

        .btn-column-toggle i {
            font-size: 1rem;
        }

        /* Dark mode adjustments */
        [data-theme="dark"] .column-dropdown {
            background: var(--surface-color);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .column-dropdown .column-item:hover {
            background-color: var(--gray-100);
        }

        [data-theme="dark"] .column-dropdown .dropdown-footer {
            background: var(--gray-100);
        }

        [data-theme="dark"] .column-dropdown .column-item .column-icon {
            background: var(--gray-100);
            color: var(--gray-400);
        }

        [data-theme="dark"] .btn-column-toggle {
            background: var(--surface-color);
            border-color: var(--border-color);
            color: var(--text-muted);
        }

        /* Confirmation modal should stack above other modals */
        #confirmModal {
            z-index: 1060 !important;
        }
        #confirmModal ~ .modal-backdrop {
            z-index: 1059 !important;
        }

        /* Security Settings modal - ensure it shows properly */
        #securitySettingsModal {
            z-index: 1055 !important;
        }
        #securitySettingsModal .modal-dialog {
            z-index: 1056 !important;
        }
        #securitySettingsModal .modal-content {
            position: relative;
            z-index: 1056 !important;
        }
        /* Custom backdrop for security settings modal */
        #securitySettingsBackdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1054;
            display: none;
        }
        #securitySettingsBackdrop.show {
            display: block;
        }
        /* Hide any Bootstrap backdrops when security modal is open */
        body.security-modal-open .modal-backdrop {
            display: none !important;
        }

        /* ========================================
           SentriKat Security Settings Modal Styling
           ======================================== */

        /* Modal header with gradient */
        #securitySettingsModal .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom: none;
            padding: 1.25rem 1.5rem;
        }

        #securitySettingsModal .modal-header .modal-title {
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        #securitySettingsModal .modal-header .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.8;
        }

        #securitySettingsModal .modal-header .btn-close:hover {
            opacity: 1;
        }

        #securitySettingsModal .modal-body {
            padding: 1.5rem;
            background-color: var(--bg-color);
        }

        /* Card styling within security modal */
        #securitySettingsModal .card {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: box-shadow 0.2s ease;
        }

        #securitySettingsModal .card:hover {
            box-shadow: var(--shadow-md);
        }

        #securitySettingsModal .card-header {
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--gray-800);
            padding: 0.875rem 1.25rem;
            display: flex;
            align-items: center;
        }

        #securitySettingsModal .card-header i {
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        #securitySettingsModal .card-body {
            padding: 1.5rem;
            background-color: var(--surface-color);
        }

        /* 2FA Section specific styles */
        #2faDisabled .alert-info,
        #2faSetup .alert-warning,
        #2faEnabled .alert-success {
            border-radius: 10px;
            border: none;
            padding: 1rem 1.25rem;
            font-size: 0.9rem;
        }

        #2faDisabled .alert-info {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            color: #1e40af;
            border-left: 4px solid var(--primary-color);
        }

        #2faSetup .alert-warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            color: #92400e;
            border-left: 4px solid var(--warning-color);
        }

        #2faEnabled .alert-success {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #065f46;
            border-left: 4px solid var(--success-color);
        }

        /* QR Code container styling */
        #qrCodeContainer {
            background: white !important;
            border-radius: 12px !important;
            border: 2px solid var(--gray-200) !important;
            padding: 1.25rem !important;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #qrCodeContainer:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        /* TOTP secret display */
        #totpSecretDisplay {
            background: var(--gray-100);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-family: 'SF Mono', 'Fira Code', 'Monaco', monospace;
            font-size: 0.85rem;
            color: var(--primary-dark);
            border: 1px solid var(--border-color);
            display: inline-block;
            margin-top: 0.5rem;
        }

        /* Verification code input - SentriKat branded */
        #verify2FACode {
            font-size: 1.75rem !important;
            letter-spacing: 0.75rem !important;
            font-family: 'SF Mono', 'Fira Code', 'Monaco', monospace !important;
            text-align: center !important;
            padding: 1rem !important;
            border: 2px solid var(--border-color) !important;
            border-radius: 10px !important;
            background: var(--surface-color) !important;
            transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
        }

        #verify2FACode:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.15) !important;
            outline: none !important;
        }

        #verify2FACode::placeholder {
            color: var(--gray-300) !important;
            letter-spacing: 0.75rem !important;
        }

        /* Professional button styling - subtle and clean */
        #securitySettingsModal .btn-success {
            background-color: var(--primary-color);
            border: 1px solid var(--primary-dark);
            padding: 0.5rem 1rem;
            font-weight: 500;
            border-radius: 6px;
            color: white;
            transition: background-color 0.15s ease;
        }

        #securitySettingsModal .btn-success:hover {
            background-color: var(--primary-dark);
        }

        #securitySettingsModal .btn-danger {
            background-color: transparent;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 0.5rem 1rem;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        #securitySettingsModal .btn-danger:hover {
            background-color: var(--danger-color);
            color: white;
        }

        #securitySettingsModal .btn-primary {
            background-color: var(--primary-color);
            border: 1px solid var(--primary-dark);
            padding: 0.5rem 1rem;
            font-weight: 500;
            border-radius: 6px;
            color: white;
            transition: background-color 0.15s ease;
        }

        #securitySettingsModal .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        #securitySettingsModal .btn-outline-secondary {
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            transition: all 0.15s ease;
        }

        #securitySettingsModal .btn-outline-secondary:hover {
            background-color: var(--gray-100);
            border-color: var(--gray-400);
        }

        /* Form labels and text */
        #securitySettingsModal .form-label {
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        #securitySettingsModal .form-text {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        #securitySettingsModal small.text-muted {
            color: var(--text-muted) !important;
        }

        /* Password change section inputs */
        #securitySettingsModal .form-control {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 0.625rem 0.875rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        #securitySettingsModal .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        /* Loading spinner in 2FA status */
        #2faStatus .spinner-border {
            width: 2.5rem;
            height: 2.5rem;
            border-width: 3px;
            color: var(--primary-color) !important;
        }

        /* LDAP user notice */
        #securitySettingsModal .alert-info:not(#2faDisabled .alert-info) {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            color: #1e40af;
            border: none;
            border-radius: 10px;
            border-left: 4px solid var(--info-color);
        }

        /* Dark mode adjustments for security modal */
        [data-theme="dark"] #securitySettingsModal .modal-body {
            background-color: var(--bg-color);
        }

        [data-theme="dark"] #securitySettingsModal .card {
            background-color: var(--surface-color);
            border-color: var(--border-color);
        }

        [data-theme="dark"] #securitySettingsModal .card-header {
            background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-50) 100%);
            color: var(--text-color);
        }

        [data-theme="dark"] #securitySettingsModal .card-header i {
            color: var(--primary-light);
        }

        [data-theme="dark"] #securitySettingsModal .card-body {
            background-color: var(--surface-color);
        }

        [data-theme="dark"] #2faDisabled .alert-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%);
            color: var(--primary-light);
        }

        [data-theme="dark"] #2faSetup .alert-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.1) 100%);
            color: #fbbf24;
        }

        [data-theme="dark"] #2faEnabled .alert-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%);
            color: #34d399;
        }

        [data-theme="dark"] #qrCodeContainer {
            background: white !important;
            border-color: var(--gray-400) !important;
        }

        [data-theme="dark"] #totpSecretDisplay {
            background: var(--gray-100);
            color: var(--primary-light);
            border-color: var(--border-color);
        }

        [data-theme="dark"] #verify2FACode {
            background: var(--surface-color) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] #verify2FACode:focus {
            border-color: var(--primary-light) !important;
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2) !important;
        }

        [data-theme="dark"] #verify2FACode::placeholder {
            color: var(--gray-400) !important;
        }

        [data-theme="dark"] #securitySettingsModal .form-label {
            color: var(--text-color);
        }

        [data-theme="dark"] #securitySettingsModal .alert-info:not(#2faDisabled .alert-info) {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%);
            color: var(--primary-light);
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Demo Version Banner (shown when no PRO license) -->
    {% if license and not license.is_professional() %}
    <div class="demo-banner bg-warning text-dark text-center py-2 px-3" style="position: fixed; top: 0; left: 0; right: 0; z-index: 9999; font-size: 0.85rem;">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>DEMO VERSION</strong> - Limited to {{ license.get_effective_limits().max_users }} user, {{ license.get_effective_limits().max_products }} products, {{ license.get_effective_limits().max_agents }} agents.
        <a href="https://sentrikat.com/pricing" target="_blank" class="ms-2 text-dark fw-semibold text-decoration-underline">Upgrade to Professional</a>
        <button type="button" class="btn-close btn-close-sm ms-3" style="font-size: 0.7rem; vertical-align: middle;" onclick="this.parentElement.style.display='none'" aria-label="Close"></button>
    </div>
    <style>
        .demo-banner ~ * { margin-top: 40px !important; }
        .demo-banner ~ .top-navbar { margin-top: 40px !important; }
    </style>
    {% endif %}

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <p class="text-secondary fw-semibold mt-3">Processing...</p>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-3" onclick="SK.Loading.forceHide()" style="opacity: 0.5;">
                Click here if stuck
            </button>
        </div>
    </div>

    <!-- Top Navigation Bar -->
    <nav class="top-navbar py-2">
        <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <a class="navbar-brand" href="/">
                        <img src="{{ branding.logo_url }}" alt="{{ branding.app_name }}">
                        <span>{{ branding.app_name }}</span>
                    </a>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <!-- Organization Switcher -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="orgDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-building"></i> <span id="currentOrgName">{% if current_user and current_user.organization %}{{ current_user.organization.display_name }}{% else %}Organization{% endif %}</span>
                        </button>
                        <ul class="dropdown-menu" id="orgList">
                            <li><span class="dropdown-item-text text-muted small">Loading organizations...</span></li>
                        </ul>
                    </div>

                    <div class="vr"></div>
                    <button class="btn btn-primary btn-sm" id="syncBtn" onclick="triggerSync(this)">
                        <i class="bi bi-arrow-clockwise"></i> Sync
                    </button>

                    <!-- Dark Mode Toggle -->
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode" id="themeToggle" aria-label="Toggle dark mode">
                        <i class="bi bi-moon-fill" id="themeIcon" aria-hidden="true"></i>
                    </button>

                    <!-- User Menu (when auth is enabled) -->
                    {% if auth_enabled and current_user %}
                    <div class="vr"></div>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                                type="button"
                                id="userDropdown"
                                data-bs-toggle="dropdown"
                                aria-expanded="false">
                            <i class="bi bi-person-circle" style="font-size: 1.1rem;"></i> {{ current_user.username }}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li>
                                <span class="dropdown-item-text">
                                    <div class="fw-semibold">{{ current_user.full_name or current_user.username }}</div>
                                    <small class="text-muted">{{ current_user.email }}</small>
                                </span>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <span class="dropdown-item-text">
                                    <small>
                                        <i class="bi bi-shield-check me-1"></i>
                                        {% if current_user.role == 'super_admin' %}Super Admin
                                        {% elif current_user.role == 'org_admin' %}Org Admin
                                        {% elif current_user.role == 'manager' %}Manager
                                        {% else %}User{% endif %}
                                    </small>
                                </span>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="openSecuritySettings(); return false;">
                                    <i class="bi bi-shield-lock me-2"></i>Security Settings
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="/logout">
                                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Content Wrapper: Sidebar + Main Content -->
    <div class="content-wrapper" id="contentWrapper">
        <!-- Mobile Sidebar Overlay -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Enhanced Sidebar with Collapsible Submenus -->
        <aside class="app-sidebar" id="appSidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <i class="bi bi-shield-lock-fill"></i>
                    <span>{{ branding.app_name }}</span>
                </div>
                <button class="sidebar-collapse-btn" onclick="toggleSidebarCollapse()" title="Collapse sidebar">
                    <i class="bi bi-chevron-left"></i>
                </button>
            </div>

            <!-- Sidebar Navigation -->
            <nav class="sidebar-nav" aria-label="Main navigation">
                <!-- Overview Section -->
                <div class="sidebar-nav-section" role="group" aria-label="Overview">
                    <div class="sidebar-nav-title">Overview</div>
                    <a href="/" class="sidebar-link {{ 'active' if request.endpoint == 'main.index' else '' }}" data-tooltip="Dashboard">
                        <i class="bi bi-grid-1x2-fill" aria-hidden="true"></i>
                        <span class="link-text">Dashboard</span>
                    </a>
                </div>

                <!-- Assets & Inventory Section -->
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Inventory</div>
                    <a href="/admin" class="sidebar-link {{ 'active' if request.endpoint == 'main.admin' else '' }}" data-tooltip="Products">
                        <i class="bi bi-box-seam-fill"></i>
                        <span class="link-text">Products</span>
                    </a>
                    <a href="/admin#endpoints" class="sidebar-link" data-tooltip="Endpoints">
                        <i class="bi bi-pc-display"></i>
                        <span class="link-text">Endpoints</span>
                    </a>
                    <a href="/admin#software-overview" class="sidebar-link" data-tooltip="Software Overview">
                        <i class="bi bi-layers"></i>
                        <span class="link-text">Software Overview</span>
                    </a>
                </div>

                <!-- User Management Section (visible for admins) -->
                {% if not auth_enabled or (current_user and (current_user.is_super_admin() or current_user.is_org_admin() or current_user.is_admin)) %}
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Management</div>

                    <!-- Users & Access submenu -->
                    <a href="#" class="sidebar-link" onclick="toggleSubmenu(this, event)" data-tooltip="Users & Access">
                        <i class="bi bi-people-fill"></i>
                        <span class="link-text">Users & Access</span>
                        <i class="bi bi-chevron-right submenu-arrow"></i>
                    </a>
                    <div class="sidebar-submenu">
                        <a href="/admin-panel#users" class="sidebar-sublink">
                            <i class="bi bi-person"></i>
                            All Users
                        </a>
                        {% if license and license.is_professional() %}
                        <a href="/admin-panel#ldapUsers" class="sidebar-sublink">
                            <i class="bi bi-diagram-3"></i>
                            LDAP Users
                        </a>
                        {% if current_user and current_user.is_super_admin() %}
                        <a href="/admin-panel#ldapGroups" class="sidebar-sublink">
                            <i class="bi bi-diagram-2"></i>
                            LDAP Groups
                        </a>
                        {% endif %}
                        {% endif %}
                    </div>

                    <!-- Organizations -->
                    <a href="/admin-panel#organizations" class="sidebar-link" data-tooltip="Organizations">
                        <i class="bi bi-building"></i>
                        <span class="link-text">Organizations</span>
                    </a>
                </div>
                {% endif %}

                <!-- Integrations Section (PRO license required) -->
                {% if license and license.is_professional() %}
                {% if not auth_enabled or (current_user and (current_user.is_super_admin() or current_user.is_org_admin() or current_user.is_admin)) %}
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Integrations</div>
                    <a href="/admin-panel#integrations" class="sidebar-link" data-tooltip="Integrations">
                        <i class="bi bi-plug-fill"></i>
                        <span class="link-text">Integrations</span>
                    </a>
                </div>
                {% endif %}
                {% endif %}

                <!-- Settings Section (Super Admin only) -->
                {% if current_user and current_user.is_super_admin() %}
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">System</div>
                    <a href="/admin-panel#settings" class="sidebar-link" data-tooltip="Settings">
                        <i class="bi bi-gear-fill"></i>
                        <span class="link-text">Settings</span>
                    </a>
                </div>
                {% endif %}
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="app-main">
            <!-- Mobile Sidebar Toggle -->
            <div class="d-lg-none p-2 border-bottom">
                <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar" aria-label="Toggle navigation menu" aria-expanded="false">
                    <i class="bi bi-list" aria-hidden="true"></i> Menu
                </button>
            </div>

            <!-- Breadcrumb Navigation -->
            {% block breadcrumb %}
            <div class="breadcrumb-container">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/"><i class="bi bi-house-door"></i> Home</a></li>
                        {% block breadcrumb_items %}{% endblock %}
                    </ol>
                </nav>
            </div>
            {% endblock %}

            <!-- Main Content -->
            <div class="main-content">
                {% block content %}{% endblock %}
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <div class="container-fluid px-4">
            <div class="text-center">
                <p class="mb-1">
                    <strong>{{ branding.app_name }}</strong> - Enterprise Vulnerability Management Platform
                </p>
                <p class="copyright-notice mb-1">
                    Data from <a href="https://www.cisa.gov/known-exploited-vulnerabilities-catalog" target="_blank">CISA KEV Catalog</a>
                    {% if branding.support_email %}
                    | <a href="mailto:{{ branding.support_email }}">Support</a>
                    {% endif %}
                </p>
                <!-- CVE Service Status Indicator -->
                {% if branding.show_version %}
                <div class="d-flex align-items-center justify-content-center gap-2" id="cveServiceStatus" title="CVE Service Status">
                    <span class="status-led status-led-yellow" id="cveStatusLed"></span>
                    <small class="text-muted" id="cveStatusText">NVD: Checking...</small>
                </div>
                {% endif %}
                {% if branding.show_powered_by | default(true) %}
                <p class="text-muted mt-1 mb-0" style="font-size: 0.7rem; opacity: 0.7;">
                    Powered by <a href="https://github.com/sbr0nch/SentriKat" target="_blank" class="text-muted text-decoration-none">SentriKat</a>
                </p>
                {% endif %}
            </div>
        </div>
    </footer>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <!-- Confirmation Modal (higher z-index for stacking on top of other modals) -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">
                        <i class="bi bi-question-circle me-2"></i>Confirm Action
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    Are you sure you want to proceed?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmModalButton">
                        <i class="bi bi-check-circle me-1"></i>Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal (replacement for native alert()) -->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalLabel">
                        <i class="bi bi-info-circle me-2"></i>Notice
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="alertModalBody">
                    Message goes here
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check me-1"></i>OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Modal -->
    <div class="modal fade" id="promptModal" tabindex="-1" aria-labelledby="promptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="promptModalLabel">
                        <i class="bi bi-pencil-square me-2"></i>Input Required
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="promptModalBody">Please enter a value:</p>
                    <input type="text" class="form-control" id="promptModalInput" placeholder="Enter value">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="promptModalButton">
                        <i class="bi bi-check-circle me-1"></i>Submit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SentriKat Core Module - Centralized utilities -->
    <script src="{{ url_for('static', filename='js/sentrikat-core.js') }}"></script>
    <!-- SentriKat Modal Configurations -->
    <script src="{{ url_for('static', filename='js/sentrikat-modals.js') }}"></script>
    <script>
        /**
         * Page-specific utilities
         */

        /**
         * Safely close and dispose of a Bootstrap modal
         */
        function safeCloseModal(modalElement) {
            if (!modalElement) return;
            const instance = bootstrap.Modal.getInstance(modalElement);
            if (instance) {
                instance.hide();
            }
        }

        /**
         * Safely remove a dynamic modal element from the DOM
         */
        function safeRemoveModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (!modalElement) return;
            const instance = bootstrap.Modal.getInstance(modalElement);
            if (instance) {
                try { instance.dispose(); } catch (e) {}
            }
            modalElement.remove();
        }

        /**
         * Switch to a specific admin panel tab
         */
        function switchToAdminTab(tabId) {
            if (window.location.pathname !== '/admin-panel') {
                window.location.href = '/admin-panel#' + tabId;
                return;
            }
            const tabButton = document.getElementById(tabId + '-tab');
            if (tabButton) {
                const tab = new bootstrap.Tab(tabButton);
                tab.show();
            }
        }

        // Initialize SK if available
        if (typeof SK !== 'undefined') {
            SK.init({ debug: true });
        }

        /**
         * Check CVE service status and update the status indicator
         */
        async function checkCVEServiceStatus() {
            const led = document.getElementById('cveStatusLed');
            const text = document.getElementById('cveStatusText');

            if (!led || !text) return;

            try {
                const response = await fetch('/api/cve-service/status');
                const data = await response.json();

                // Remove all status classes
                led.classList.remove('status-led-green', 'status-led-red', 'status-led-yellow');

                if (data.status === 'online') {
                    led.classList.add('status-led-green');
                    text.textContent = 'NVD Online';
                    text.title = 'CVE service is accessible';
                } else if (data.status === 'rate_limited') {
                    led.classList.add('status-led-yellow');
                    text.textContent = 'Rate Limited';
                    text.title = 'NVD API is rate limited - try again later';
                } else {
                    led.classList.add('status-led-red');
                    text.textContent = 'NVD Offline';
                    text.title = data.message || 'Cannot connect to CVE service';
                }
            } catch (error) {
                led.classList.remove('status-led-green', 'status-led-red', 'status-led-yellow');
                led.classList.add('status-led-red');
                text.textContent = 'Error';
                text.title = 'Failed to check CVE service status';
            }
        }

        // Check CVE status on page load and every 5 minutes
        // Retry mechanism for initial load timing issues
        let cveStatusRetries = 0;
        async function checkCVEServiceStatusWithRetry() {
            const led = document.getElementById('cveStatusLed');
            try {
                await checkCVEServiceStatus();
                // If status is red/error on first load, retry a few times
                if (led && led.classList.contains('status-led-red') && cveStatusRetries < 3) {
                    cveStatusRetries++;
                    setTimeout(checkCVEServiceStatusWithRetry, 2000); // Retry after 2 seconds
                }
            } catch (e) {
                if (cveStatusRetries < 3) {
                    cveStatusRetries++;
                    setTimeout(checkCVEServiceStatusWithRetry, 2000);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Small delay to ensure database connections are ready
            setTimeout(checkCVEServiceStatusWithRetry, 500);
            setInterval(checkCVEServiceStatus, 300000); // 5 minutes
        });

        /**
         * Shows a confirmation modal dialog (replacement for confirm())
         * @param {string} message - The confirmation message
         * @param {string} title - Optional title (default: "Confirm Action")
         * @param {string} confirmText - Optional confirm button text (default: "Confirm")
         * @param {string} confirmClass - Optional button class (default: "btn-primary", use "btn-danger" for destructive actions)
         * @returns {Promise<boolean>} - Resolves to true if confirmed, false if cancelled
         */
        function showConfirm(message, title = 'Confirm Action', confirmText = 'Confirm', confirmClass = 'btn-primary') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const modalTitle = document.getElementById('confirmModalLabel');
                const modalBody = document.getElementById('confirmModalBody');
                const confirmBtn = document.getElementById('confirmModalButton');

                // Set content
                modalTitle.innerHTML = `<i class="bi bi-question-circle me-2"></i>${title}`;
                modalBody.innerHTML = message.replace(/\n/g, '<br>');
                confirmBtn.textContent = confirmText;
                confirmBtn.className = `btn ${confirmClass}`;

                // Use getOrCreateInstance to avoid creating duplicate modal instances
                const bsModal = bootstrap.Modal.getOrCreateInstance(modal);

                // Handle confirm
                const handleConfirm = () => {
                    cleanup();
                    resolve(true);
                };

                // Handle cancel/close
                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    modal.removeEventListener('hidden.bs.modal', handleCancel);
                    bsModal.hide();
                };

                confirmBtn.addEventListener('click', handleConfirm);
                modal.addEventListener('hidden.bs.modal', handleCancel, { once: true });

                bsModal.show();
            });
        }

        /**
         * Shows an alert modal dialog (replacement for alert())
         * @param {string} message - The message to display
         * @param {string} title - Optional title (default: "Notice")
         * @param {string} type - Optional type: 'info', 'success', 'warning', 'error' (default: 'info')
         * @returns {Promise<void>} - Resolves when user closes the modal
         */
        function showAlert(message, title = 'Notice', type = 'info') {
            return new Promise((resolve) => {
                const modal = document.getElementById('alertModal');
                const modalTitle = document.getElementById('alertModalLabel');
                const modalBody = document.getElementById('alertModalBody');

                // Icon based on type
                const icons = {
                    'info': 'bi-info-circle text-primary',
                    'success': 'bi-check-circle text-success',
                    'warning': 'bi-exclamation-triangle text-warning',
                    'error': 'bi-x-circle text-danger'
                };
                const icon = icons[type] || icons['info'];

                // Set content
                modalTitle.innerHTML = `<i class="bi ${icon} me-2"></i>${title}`;
                modalBody.innerHTML = message.replace(/\n/g, '<br>');

                // Use getOrCreateInstance to avoid creating duplicate modal instances
                const bsModal = bootstrap.Modal.getOrCreateInstance(modal);

                const handleClose = () => {
                    modal.removeEventListener('hidden.bs.modal', handleClose);
                    resolve();
                };

                modal.addEventListener('hidden.bs.modal', handleClose, { once: true });
                bsModal.show();
            });
        }

        /**
         * Shows a prompt modal dialog (replacement for prompt())
         * @param {string} message - The prompt message
         * @param {string} defaultValue - Optional default value
         * @param {string} title - Optional title (default: "Input Required")
         * @returns {Promise<string|null>} - Resolves to the input value if submitted, null if cancelled
         */
        function showPrompt(message, defaultValue = '', title = 'Input Required') {
            return new Promise((resolve) => {
                const modal = document.getElementById('promptModal');
                const modalTitle = document.getElementById('promptModalLabel');
                const modalBody = document.getElementById('promptModalBody');
                const input = document.getElementById('promptModalInput');
                const submitBtn = document.getElementById('promptModalButton');

                // Set content
                modalTitle.innerHTML = `<i class="bi bi-pencil-square me-2"></i>${title}`;
                modalBody.innerHTML = message.replace(/\n/g, '<br>');
                input.value = defaultValue;

                // Use getOrCreateInstance to avoid creating duplicate modal instances
                const bsModal = bootstrap.Modal.getOrCreateInstance(modal);

                // Handle submit
                const handleSubmit = () => {
                    const value = input.value.trim();
                    cleanup();
                    resolve(value || null);
                };

                // Handle cancel/close
                const handleCancel = () => {
                    cleanup();
                    resolve(null);
                };

                // Handle Enter key
                const handleEnter = (e) => {
                    if (e.key === 'Enter') {
                        handleSubmit();
                    }
                };

                const cleanup = () => {
                    submitBtn.removeEventListener('click', handleSubmit);
                    input.removeEventListener('keypress', handleEnter);
                    modal.removeEventListener('hidden.bs.modal', handleCancel);
                    bsModal.hide();
                };

                submitBtn.addEventListener('click', handleSubmit);
                input.addEventListener('keypress', handleEnter);
                modal.addEventListener('hidden.bs.modal', handleCancel, { once: true });

                bsModal.show();

                // Focus input after modal is shown
                setTimeout(() => input.focus(), 300);
            });
        }

        async function triggerSync(btn) {
            const confirmed = await showConfirm(
                'Download the latest CISA KEV data and update all matches?<br><br>This may take a minute.',
                'Sync Vulnerability Data',
                'Start Sync',
                'btn-primary'
            );

            if (!confirmed) {
                return;
            }

            const syncBtn = btn || document.getElementById('syncBtn');
            setButtonLoading(syncBtn, 'Syncing...');
            showLoading();
            try {
                const response = await fetch('/api/sync', { method: 'POST' });
                const result = await response.json();

                if (result.status === 'success') {
                    showToast(`Sync completed! ${result.updated} vulnerabilities updated, ${result.matches} new matches found.`, 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showToast(`Sync failed: ${result.error}`, 'danger');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'danger');
            } finally {
                hideLoading();
                resetButton(syncBtn);
            }
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // CSRF token helper for AJAX requests
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]')?.content || '';
        }

        // Helper to add CSRF header to fetch options
        function withCSRF(options = {}) {
            const headers = options.headers || {};
            headers['X-CSRFToken'] = getCSRFToken();
            return { ...options, headers };
        }

        // Button loading state helpers
        function setButtonLoading(btn, loadingText = 'Loading...') {
            if (!btn) return;
            btn._originalHTML = btn.innerHTML;
            btn._originalDisabled = btn.disabled;
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm me-1" role="status"></span>${loadingText}`;
        }

        function resetButton(btn) {
            if (!btn) return;
            btn.disabled = btn._originalDisabled || false;
            btn.innerHTML = btn._originalHTML || btn.innerHTML;
        }

        // Async button wrapper - handles loading state automatically
        async function withLoadingButton(btn, loadingText, asyncFn) {
            setButtonLoading(btn, loadingText);
            try {
                return await asyncFn();
            } finally {
                resetButton(btn);
            }
        }

        // Form validation helpers
        function setFieldInvalid(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            field.classList.add('is-invalid');
            // Look for or create feedback element
            let feedback = field.parentElement.querySelector('.invalid-feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                field.parentElement.appendChild(feedback);
            }
            feedback.textContent = message;
            feedback.style.display = 'block';
        }

        function clearFieldValidation(fieldId) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            field.classList.remove('is-invalid');
            const feedback = field.parentElement.querySelector('.invalid-feedback');
            if (feedback) {
                feedback.style.display = 'none';
            }
        }

        function clearFormValidation(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            form.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none');
        }

        function getPriorityBadgeClass(priority) {
            const badges = {
                'critical': 'badge-critical',
                'high': 'badge-high',
                'medium': 'badge-medium',
                'low': 'badge-low'
            };
            return badges[priority] || 'bg-secondary';
        }

        function getPriorityIcon(priority) {
            const icons = {
                'critical': 'exclamation-octagon-fill',
                'high': 'exclamation-triangle-fill',
                'medium': 'exclamation-circle-fill',
                'low': 'info-circle-fill'
            };
            return icons[priority] || 'circle';
        }

        function getPriorityColor(priority) {
            const colors = {
                'critical': '#dc2626',
                'high': '#ea580c',
                'medium': '#ca8a04',
                'low': '#059669'
            };
            return colors[priority] || '#6b7280';
        }

        // Organization Switcher Functions
        async function loadNavbarOrganizations() {
            try {
                // Show cached organization name immediately to avoid "Loading..." flash
                const cachedOrgName = localStorage.getItem('currentOrgName');
                if (cachedOrgName) {
                    document.getElementById('currentOrgName').textContent = cachedOrgName;
                }

                // Get current organization
                const currentResponse = await fetch('/api/session/organization');
                if (!currentResponse.ok) {
                    // Check if session expired (redirect to login)
                    if (currentResponse.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(`Failed to load current organization: ${currentResponse.status}`);
                }

                // Check content type before parsing JSON
                const currentContentType = currentResponse.headers.get('content-type');
                if (!currentContentType || !currentContentType.includes('application/json')) {
                    console.error('Invalid content type from /api/session/organization:', currentContentType);
                    // Try to get the response text for debugging
                    const text = await currentResponse.text();
                    console.error('Response body:', text.substring(0, 500));
                    throw new Error('Server returned non-JSON response');
                }
                const currentOrg = await currentResponse.json();

                if (currentOrg && currentOrg.display_name) {
                    document.getElementById('currentOrgName').textContent = currentOrg.display_name;
                    // Cache for next page load
                    localStorage.setItem('currentOrgName', currentOrg.display_name);
                }

                // Get all organizations
                const orgsResponse = await fetch('/api/organizations');
                if (!orgsResponse.ok) {
                    // Check if session expired (redirect to login)
                    if (orgsResponse.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(`Failed to load organizations: ${orgsResponse.status}`);
                }

                // Check content type before parsing JSON
                const orgsContentType = orgsResponse.headers.get('content-type');
                if (!orgsContentType || !orgsContentType.includes('application/json')) {
                    throw new Error('Invalid response from server');
                }
                const organizations = await orgsResponse.json();

                const orgList = document.getElementById('orgList');
                if (organizations.length > 0) {
                    orgList.innerHTML = organizations.map(org => `
                        <li>
                            <a class="dropdown-item ${org.id === currentOrg.id ? 'active' : ''}"
                               href="#"
                               data-org-id="${org.id}"
                               data-org-name="${escapeHtml(org.display_name)}">
                                <i class="bi bi-building me-2"></i>${escapeHtml(org.display_name)}
                            </a>
                        </li>
                    `).join('');
                    // Add click handlers using event delegation
                    orgList.querySelectorAll('[data-org-id]').forEach(link => {
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            switchOrganization(parseInt(this.dataset.orgId), this.dataset.orgName);
                        });
                    });
                } else {
                    orgList.innerHTML = '<li><span class="dropdown-item-text text-muted small">No organizations available</span></li>';
                }
            } catch (error) {
                console.error('Error loading organizations:', error);
                // Update both the button and the dropdown list on error
                const orgList = document.getElementById('orgList');
                if (orgList) {
                    orgList.innerHTML = `<li><span class="dropdown-item-text text-danger small">Error: ${error.message}</span></li>`;
                }
            }
        }

        async function switchOrganization(orgId, orgName) {
            try {
                const response = await fetch(`/api/session/organization/${orgId}`, {
                    method: 'POST',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });

                if (response.ok) {
                    document.getElementById('currentOrgName').textContent = orgName;
                    // Cache the new organization name
                    localStorage.setItem('currentOrgName', orgName);
                    showToast(`Switched to ${orgName}`, 'success');

                    // Reload page immediately with cache-bust to ensure fresh data
                    // The short delay is just for the toast to be visible
                    setTimeout(() => {
                        // Add cache-bust parameter to force fresh load
                        const url = new URL(window.location.href);
                        url.searchParams.set('_t', Date.now());
                        window.location.href = url.toString();
                    }, 300);
                } else {
                    // Check if session expired
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    // Try to parse error message from JSON response
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        showToast(`Error: ${errorData.error || 'Failed to switch organization'}`, 'danger');
                    } else {
                        showToast('Failed to switch organization', 'danger');
                    }
                }
            } catch (error) {
                console.error('Error switching organization:', error);
                showToast(`Error: ${error.message}`, 'danger');
            }
        }

        // ============================================================================
        // Enhanced Sidebar Functions - Collapsible with Submenus
        // ============================================================================

        // Toggle sidebar for mobile (slide in/out)
        function toggleSidebar() {
            const wrapper = document.getElementById('contentWrapper');
            const isMobile = window.innerWidth < 992;

            if (isMobile) {
                wrapper.classList.toggle('sidebar-open');
            } else {
                toggleSidebarCollapse();
            }
        }

        // Toggle sidebar collapse (icon-only mode) for desktop
        function toggleSidebarCollapse() {
            const wrapper = document.getElementById('contentWrapper');
            wrapper.classList.toggle('sidebar-collapsed');

            // Save state to localStorage
            const isCollapsed = wrapper.classList.contains('sidebar-collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);

            // Close all submenus when collapsing
            if (isCollapsed) {
                document.querySelectorAll('.sidebar-submenu.open').forEach(submenu => {
                    submenu.classList.remove('open');
                });
                document.querySelectorAll('.sidebar-link.expanded').forEach(link => {
                    link.classList.remove('expanded');
                });
            }
        }

        // Toggle submenu open/close
        function toggleSubmenu(linkElement, event) {
            event.preventDefault();
            event.stopPropagation();

            const wrapper = document.getElementById('contentWrapper');
            const isCollapsed = wrapper.classList.contains('sidebar-collapsed');

            // Don't toggle submenus when sidebar is collapsed
            if (isCollapsed) {
                return;
            }

            const submenu = linkElement.nextElementSibling;
            if (submenu && submenu.classList.contains('sidebar-submenu')) {
                const isOpen = submenu.classList.contains('open');

                // Close other submenus (accordion behavior)
                document.querySelectorAll('.sidebar-submenu.open').forEach(other => {
                    if (other !== submenu) {
                        other.classList.remove('open');
                        other.previousElementSibling?.classList.remove('expanded');
                    }
                });

                // Toggle current submenu
                submenu.classList.toggle('open');
                linkElement.classList.toggle('expanded');

                // Save submenu state
                const submenuStates = JSON.parse(localStorage.getItem('submenuStates') || '{}');
                const submenuId = linkElement.getAttribute('data-tooltip') || linkElement.textContent.trim();
                submenuStates[submenuId] = !isOpen;
                localStorage.setItem('submenuStates', JSON.stringify(submenuStates));
            }
        }

        function initSidebar() {
            const wrapper = document.getElementById('contentWrapper');
            if (!wrapper) return;

            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            const isMobile = window.innerWidth < 992;

            // Only apply collapsed state on desktop
            if (isCollapsed && !isMobile) {
                wrapper.classList.add('sidebar-collapsed');
            }

            // Restore submenu states
            const submenuStates = JSON.parse(localStorage.getItem('submenuStates') || '{}');
            document.querySelectorAll('.sidebar-link[data-tooltip]').forEach(link => {
                const submenu = link.nextElementSibling;
                if (submenu && submenu.classList.contains('sidebar-submenu')) {
                    const submenuId = link.getAttribute('data-tooltip');
                    if (submenuStates[submenuId] && !isCollapsed) {
                        submenu.classList.add('open');
                        link.classList.add('expanded');
                    }
                }
            });

            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 992) {
                    wrapper.classList.remove('sidebar-open');
                }
            });
        }

        // Initialize sidebar on page load
        document.addEventListener('DOMContentLoaded', initSidebar);

        // ============================================================================
        // Theme Toggle Functions
        // ============================================================================

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                if (theme === 'dark') {
                    icon.className = 'bi bi-sun-fill';
                } else {
                    icon.className = 'bi bi-moon-fill';
                }
            }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');

            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon(theme);
        }

        // Initialize theme immediately to prevent flash
        initTheme();

        // Load navbar organizations on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadNavbarOrganizations();
        });

        // ============================================================================
        // Sortable Table Utility
        // ============================================================================

        /**
         * SortableTable - Makes any table sortable by clicking column headers
         *
         * Usage:
         *   1. Add data-sortable="true" to the table
         *   2. Add data-sort-key="fieldName" to sortable th elements
         *   3. Add data-sort-type="string|number|date|priority|boolean" for proper sorting
         *   4. Call SortableTable.init('tableId') or let auto-init find tables
         *
         * Example:
         *   <table id="myTable" data-sortable="true">
         *     <thead>
         *       <tr>
         *         <th data-sort-key="name" data-sort-type="string">Name</th>
         *         <th data-sort-key="count" data-sort-type="number">Count</th>
         *         <th data-sort-key="date" data-sort-type="date">Date</th>
         *         <th data-sort-key="priority" data-sort-type="priority">Priority</th>
         *         <th data-sort-key="active" data-sort-type="boolean">Status</th>
         *       </tr>
         *     </thead>
         *     <tbody>...</tbody>
         *   </table>
         */
        const SortableTable = {
            tables: {},
            handlers: {}, // Store handlers for cleanup

            // Priority order for sorting
            priorityOrder: { 'critical': 0, 'high': 1, 'medium': 2, 'low': 3 },

            /**
             * Initialize sorting for a table
             * @param {string} tableId - The table element ID
             * @param {function} dataExtractor - Optional function to extract sort data from row
             */
            init: function(tableId, dataExtractor = null) {
                const table = document.getElementById(tableId);
                if (!table) return;

                // Clean up existing handlers if re-initializing
                if (this.handlers[tableId]) {
                    this.handlers[tableId].forEach(({ header, handler }) => {
                        header.removeEventListener('click', handler);
                    });
                }
                this.handlers[tableId] = [];

                this.tables[tableId] = {
                    currentSort: null,
                    currentDirection: 'asc',
                    dataExtractor: dataExtractor
                };

                const headers = table.querySelectorAll('th[data-sort-key]');
                const self = this;
                headers.forEach(header => {
                    // Add sortable class and icon
                    header.classList.add('sortable-header');
                    if (!header.querySelector('.sort-icon')) {
                        header.innerHTML += ' <i class="bi bi-chevron-up sort-icon"></i>';
                    }

                    // Create and store click handler for cleanup
                    const handler = function(e) {
                        // Prevent sorting if we just finished resizing a column
                        if (typeof TableEnhancements !== 'undefined' && TableEnhancements.justResized) {
                            return;
                        }
                        // Prevent sorting if click was on resize handle
                        if (e.target.classList.contains('resize-handle')) {
                            return;
                        }
                        self.sortTable(tableId, header);
                    };
                    header.addEventListener('click', handler);
                    self.handlers[tableId].push({ header, handler });
                });
            },

            /**
             * Sort the table by the clicked header
             */
            sortTable: function(tableId, header) {
                const table = document.getElementById(tableId);
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const sortKey = header.dataset.sortKey;
                const sortType = header.dataset.sortType || 'string';
                const tableState = this.tables[tableId];

                // Determine sort direction (first click = descending, then toggle)
                if (tableState.currentSort === sortKey) {
                    tableState.currentDirection = tableState.currentDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    tableState.currentSort = sortKey;
                    tableState.currentDirection = 'desc'; // First click shows descending (arrow down)
                }

                // Update header classes and icons
                table.querySelectorAll('th[data-sort-key]').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                    const icon = th.querySelector('.sort-icon');
                    if (icon) {
                        icon.classList.remove('bi-chevron-up', 'bi-chevron-down');
                        icon.classList.add('bi-chevron-up'); // Reset to default
                    }
                });
                header.classList.add('sort-' + tableState.currentDirection);

                // Update the clicked header's icon
                const headerIcon = header.querySelector('.sort-icon');
                if (headerIcon) {
                    headerIcon.classList.remove('bi-chevron-up', 'bi-chevron-down');
                    headerIcon.classList.add(tableState.currentDirection === 'asc' ? 'bi-chevron-up' : 'bi-chevron-down');
                }

                // Sort rows
                const direction = tableState.currentDirection === 'asc' ? 1 : -1;

                rows.sort((a, b) => {
                    let aVal, bVal;

                    // Use custom data extractor if provided
                    if (tableState.dataExtractor) {
                        const aData = tableState.dataExtractor(a);
                        const bData = tableState.dataExtractor(b);
                        aVal = aData[sortKey];
                        bVal = bData[sortKey];
                    } else {
                        // Default: extract from cell content
                        const aCell = a.querySelector(`td[data-column="${sortKey}"]`) ||
                                     a.cells[this.getColumnIndex(table, sortKey)];
                        const bCell = b.querySelector(`td[data-column="${sortKey}"]`) ||
                                     b.cells[this.getColumnIndex(table, sortKey)];

                        aVal = this.getCellValue(aCell, sortType);
                        bVal = this.getCellValue(bCell, sortType);
                    }

                    return this.compareValues(aVal, bVal, sortType) * direction;
                });

                // Re-append rows in sorted order
                rows.forEach(row => tbody.appendChild(row));
            },

            /**
             * Get column index by sort key
             */
            getColumnIndex: function(table, sortKey) {
                const headers = table.querySelectorAll('th');
                for (let i = 0; i < headers.length; i++) {
                    if (headers[i].dataset.sortKey === sortKey) {
                        return i;
                    }
                }
                return 0;
            },

            /**
             * Extract value from cell based on type
             */
            getCellValue: function(cell, sortType) {
                if (!cell) return '';

                // Check for explicit sort value (useful for icon-only cells like CPE badges)
                if (cell.dataset.sortValue !== undefined) {
                    return cell.dataset.sortValue.toLowerCase();
                }

                const text = cell.textContent.trim();

                // Check for badge content
                const badge = cell.querySelector('.badge');
                if (badge) {
                    return badge.textContent.trim().toLowerCase();
                }

                return text;
            },

            /**
             * Compare two values based on type
             */
            compareValues: function(a, b, sortType) {
                // Handle empty/null values
                if (a === null || a === undefined || a === '' || a === '-') a = null;
                if (b === null || b === undefined || b === '' || b === '-') b = null;

                // Nulls go to end
                if (a === null && b === null) return 0;
                if (a === null) return 1;
                if (b === null) return -1;

                switch (sortType) {
                    case 'number':
                        return parseFloat(a) - parseFloat(b);

                    case 'date':
                        const dateA = new Date(a);
                        const dateB = new Date(b);
                        return dateA - dateB;

                    case 'priority':
                        const priorityA = this.priorityOrder[a.toLowerCase()] ?? 999;
                        const priorityB = this.priorityOrder[b.toLowerCase()] ?? 999;
                        return priorityA - priorityB;

                    case 'boolean':
                        const boolA = a.toLowerCase() === 'active' || a.toLowerCase() === 'true' || a.toLowerCase() === 'yes' ? 1 : 0;
                        const boolB = b.toLowerCase() === 'active' || b.toLowerCase() === 'true' || b.toLowerCase() === 'yes' ? 1 : 0;
                        return boolB - boolA; // Active first

                    case 'string':
                    default:
                        return String(a).toLowerCase().localeCompare(String(b).toLowerCase());
                }
            },

            /**
             * Reset sort state for a table
             */
            reset: function(tableId) {
                if (this.tables[tableId]) {
                    this.tables[tableId].currentSort = null;
                    this.tables[tableId].currentDirection = 'asc';
                }

                const table = document.getElementById(tableId);
                if (table) {
                    table.querySelectorAll('th[data-sort-key]').forEach(th => {
                        th.classList.remove('sort-asc', 'sort-desc');
                    });
                }
            }
        };

        // Auto-initialize sortable tables on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('table[data-sortable="true"]').forEach(table => {
                if (table.id) {
                    SortableTable.init(table.id);
                }
            });
        });

        // ============================================================================
        // Table Enhancements Utility
        // ============================================================================

        /**
         * TableEnhancements - Adds resizable columns and column visibility to tables
         *
         * Usage:
         *   1. Add data-enhanced="true" to the table
         *   2. Add data-column="columnName" to both th and td elements
         *   3. Optionally add data-column-label="Display Name" to th for dropdown label
         *   4. Call TableEnhancements.init('tableId') or let auto-init find tables
         *
         * Features:
         *   - Draggable column resize handles
         *   - Column visibility dropdown with modern SentriKat styling
         *   - Persistent settings via localStorage
         */
        const TableEnhancements = {
            tables: {},
            resizeState: null,
            justResized: false, // Flag to prevent click-to-sort after resize

            /**
             * Initialize enhancements for a table
             * @param {string} tableId - The table element ID
             * @param {object} options - Optional configuration
             */
            init: function(tableId, options = {}) {
                const table = document.getElementById(tableId);
                if (!table) return;

                const defaults = {
                    resizable: true,
                    columnToggle: true,
                    storageKey: `table_${tableId}_prefs`,
                    dropdownContainer: null, // If null, auto-create in card header
                    excludeColumns: ['actions', 'checkbox'], // Columns to exclude from toggle
                    columnIcons: {} // Map of columnName -> bootstrap icon class
                };

                const config = { ...defaults, ...options };

                this.tables[tableId] = {
                    table,
                    config,
                    columns: this.getColumns(table, config)
                };

                // Add resizable class
                table.classList.add('resizable-table');

                // Initialize features
                if (config.resizable) {
                    this.initResizable(tableId);
                }

                if (config.columnToggle) {
                    this.initColumnToggle(tableId);
                }

                // Restore saved preferences
                this.restorePreferences(tableId);
            },

            /**
             * Get column definitions from table headers
             */
            getColumns: function(table, config) {
                const columns = [];
                const headers = table.querySelectorAll('thead th[data-column]');

                headers.forEach((th, index) => {
                    const columnName = th.dataset.column;
                    if (!config.excludeColumns.includes(columnName)) {
                        columns.push({
                            name: columnName,
                            label: th.dataset.columnLabel || th.textContent.trim().replace(/[\u25B2\u25BC]/g, '').trim(),
                            index: index,
                            element: th,
                            icon: config.columnIcons[columnName] || this.getDefaultIcon(columnName)
                        });
                    }
                });

                return columns;
            },

            /**
             * Get default icon for common column types
             */
            getDefaultIcon: function(columnName) {
                const iconMap = {
                    'vendor': 'bi-building',
                    'product': 'bi-box',
                    'version': 'bi-tag',
                    'organization': 'bi-people',
                    'criticality': 'bi-exclamation-triangle',
                    'status': 'bi-toggle-on',
                    'username': 'bi-person',
                    'fullname': 'bi-person-badge',
                    'email': 'bi-envelope',
                    'role': 'bi-shield',
                    'authtype': 'bi-key',
                    'name': 'bi-card-text',
                    'displayname': 'bi-type',
                    'users': 'bi-people',
                    'smtp': 'bi-envelope-at',
                    'group': 'bi-diagram-3',
                    'priority': 'bi-sort-numeric-up',
                    'members': 'bi-person-lines-fill',
                    'lastsync': 'bi-clock-history',
                    'date': 'bi-calendar',
                    'duration': 'bi-stopwatch',
                    'added': 'bi-plus-circle',
                    'updated': 'bi-pencil',
                    'deactivated': 'bi-x-circle',
                    'errors': 'bi-exclamation-octagon'
                };
                return iconMap[columnName.toLowerCase()] || 'bi-grip-vertical';
            },

            /**
             * Initialize resizable columns
             */
            initResizable: function(tableId) {
                const { table } = this.tables[tableId];
                const headers = table.querySelectorAll('thead th');
                const self = this;

                headers.forEach((th, index) => {
                    // Skip last column (usually actions)
                    if (index === headers.length - 1) return;

                    // Create resize handle
                    const handle = document.createElement('div');
                    handle.className = 'resize-handle';
                    handle.addEventListener('mousedown', function(e) {
                        self.startResize(e, tableId, th, index);
                    });
                    th.appendChild(handle);
                });

                // Global mouse events for resizing
                document.addEventListener('mousemove', this.handleResize.bind(this));
                document.addEventListener('mouseup', this.stopResize.bind(this));
            },

            /**
             * Start column resize
             */
            startResize: function(e, tableId, th, columnIndex) {
                e.preventDefault();
                e.stopPropagation();

                this.resizeState = {
                    tableId,
                    th,
                    columnIndex,
                    startX: e.pageX,
                    startWidth: th.offsetWidth
                };

                th.querySelector('.resize-handle').classList.add('resizing');
                document.body.classList.add('resizing-active');
            },

            /**
             * Handle resize drag
             */
            handleResize: function(e) {
                if (!this.resizeState) return;

                const { th, startX, startWidth } = this.resizeState;
                const diff = e.pageX - startX;
                const newWidth = Math.max(50, startWidth + diff);
                th.style.width = newWidth + 'px';
                th.style.minWidth = newWidth + 'px';
            },

            /**
             * Stop resizing
             */
            stopResize: function() {
                if (!this.resizeState) return;

                const { tableId, th } = this.resizeState;
                th.querySelector('.resize-handle').classList.remove('resizing');
                document.body.classList.remove('resizing-active');

                // Save width preference
                this.savePreferences(tableId);
                this.resizeState = null;

                // Set flag to prevent click-to-sort from triggering
                this.justResized = true;
                setTimeout(() => {
                    this.justResized = false;
                }, 100);
            },

            /**
             * Initialize column visibility toggle dropdown
             */
            initColumnToggle: function(tableId) {
                const { table, config, columns } = this.tables[tableId];

                // Find or create dropdown container
                let container = config.dropdownContainer
                    ? document.querySelector(config.dropdownContainer)
                    : table.closest('.card')?.querySelector('.card-header');

                if (!container) {
                    // Create container before table
                    container = document.createElement('div');
                    container.className = 'd-flex justify-content-end mb-2';
                    table.parentNode.insertBefore(container, table);
                }

                // Check if dropdown already exists
                const existingDropdown = container.querySelector(`[data-column-toggle="${tableId}"]`);
                if (existingDropdown) return;

                // Create dropdown HTML - using data attributes for safer event handling
                const dropdownId = `columnToggle_${tableId}`;
                const safeTableId = escapeHtml(tableId);
                const dropdownHTML = `
                    <div class="dropdown" data-column-toggle="${safeTableId}">
                        <button class="btn-column-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                            <i class="bi bi-layout-three-columns"></i>
                            <span>Columns</span>
                            <i class="bi bi-chevron-down" style="font-size: 0.625rem; margin-left: 2px;"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end column-dropdown" id="${dropdownId}">
                            <div class="dropdown-header">
                                <i class="bi bi-eye"></i>
                                Show/Hide Columns
                            </div>
                            <div class="column-list">
                                ${columns.map(col => `
                                    <div class="column-item" data-table-id="${safeTableId}" data-col-name="${escapeHtml(col.name)}">
                                        <input type="checkbox" class="form-check-input column-toggle-checkbox"
                                               id="col_${safeTableId}_${escapeHtml(col.name)}"
                                               data-column="${escapeHtml(col.name)}"
                                               data-table-id="${safeTableId}"
                                               checked>
                                        <div class="column-icon">
                                            <i class="bi ${escapeHtml(col.icon)}"></i>
                                        </div>
                                        <label for="col_${safeTableId}_${escapeHtml(col.name)}">${escapeHtml(col.label)}</label>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="dropdown-footer">
                                <button class="reset-btn" data-reset-table="${safeTableId}">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                    Reset All
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Insert dropdown
                const wrapper = document.createElement('div');
                wrapper.innerHTML = dropdownHTML;
                const dropdownEl = wrapper.firstElementChild;
                container.appendChild(dropdownEl);

                // Add event listeners for column items
                dropdownEl.querySelectorAll('.column-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.type === 'checkbox') return;
                        const tblId = item.dataset.tableId;
                        const colName = item.dataset.colName;
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            TableEnhancements.toggleColumn(tblId, colName, checkbox.checked);
                        }
                    });
                });

                // Add event listeners for checkboxes
                dropdownEl.querySelectorAll('.column-toggle-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const tblId = checkbox.dataset.tableId;
                        const colName = checkbox.dataset.column;
                        TableEnhancements.toggleColumn(tblId, colName, checkbox.checked);
                    });
                });

                // Add event listener for reset button
                const resetBtn = dropdownEl.querySelector('[data-reset-table]');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        TableEnhancements.resetColumns(resetBtn.dataset.resetTable);
                    });
                }
            },

            /**
             * Toggle column checkbox from row click
             */
            toggleColumnCheckbox: function(tableId, columnName, event) {
                if (event.target.type === 'checkbox') return;
                const checkbox = document.getElementById(`col_${tableId}_${columnName}`);
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    this.toggleColumn(tableId, columnName, checkbox.checked);
                }
            },

            /**
             * Toggle column visibility
             */
            toggleColumn: function(tableId, columnName, visible) {
                const { table } = this.tables[tableId];

                // Toggle header
                const header = table.querySelector(`th[data-column="${columnName}"]`);
                if (header) {
                    header.style.display = visible ? '' : 'none';
                }

                // Toggle all cells in that column
                const cells = table.querySelectorAll(`td[data-column="${columnName}"]`);
                cells.forEach(cell => {
                    cell.style.display = visible ? '' : 'none';
                });

                // Save preference
                this.savePreferences(tableId);
            },

            /**
             * Reset all columns to visible
             */
            resetColumns: function(tableId) {
                const { columns } = this.tables[tableId];

                columns.forEach(col => {
                    const checkbox = document.getElementById(`col_${tableId}_${col.name}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                    this.toggleColumn(tableId, col.name, true);
                });

                // Clear saved preferences
                localStorage.removeItem(this.tables[tableId].config.storageKey);

                if (typeof showToast === 'function') {
                    showToast('Columns reset to default', 'info');
                }
            },

            /**
             * Save preferences to localStorage
             */
            savePreferences: function(tableId) {
                const { table, config, columns } = this.tables[tableId];
                const prefs = {
                    columnWidths: {},
                    hiddenColumns: []
                };

                // Save column widths
                const headers = table.querySelectorAll('thead th');
                headers.forEach((th, index) => {
                    if (th.style.width) {
                        prefs.columnWidths[index] = th.style.width;
                    }
                });

                // Save hidden columns
                columns.forEach(col => {
                    const checkbox = document.getElementById(`col_${tableId}_${col.name}`);
                    if (checkbox && !checkbox.checked) {
                        prefs.hiddenColumns.push(col.name);
                    }
                });

                localStorage.setItem(config.storageKey, JSON.stringify(prefs));
            },

            /**
             * Restore preferences from localStorage
             */
            restorePreferences: function(tableId) {
                const { table, config } = this.tables[tableId];
                const saved = localStorage.getItem(config.storageKey);
                if (!saved) return;

                try {
                    const prefs = JSON.parse(saved);

                    // Restore column widths
                    if (prefs.columnWidths) {
                        const headers = table.querySelectorAll('thead th');
                        Object.entries(prefs.columnWidths).forEach(([index, width]) => {
                            if (headers[index]) {
                                headers[index].style.width = width;
                                headers[index].style.minWidth = width;
                            }
                        });
                    }

                    // Restore hidden columns
                    if (prefs.hiddenColumns) {
                        prefs.hiddenColumns.forEach(columnName => {
                            const checkbox = document.getElementById(`col_${tableId}_${columnName}`);
                            if (checkbox) {
                                checkbox.checked = false;
                            }
                            this.toggleColumn(tableId, columnName, false);
                        });
                    }
                } catch (e) {
                    console.warn('Failed to restore table preferences:', e);
                }
            },

            /**
             * Reinitialize after dynamic content load
             */
            refresh: function(tableId) {
                const tableData = this.tables[tableId];
                if (!tableData) return;

                // Restore preferences after content reload
                this.restorePreferences(tableId);
            }
        };

        // Auto-initialize enhanced tables on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('table[data-enhanced="true"]').forEach(table => {
                if (table.id) {
                    TableEnhancements.init(table.id);
                }
            });
        });
    </script>

    <!-- Security Settings Modal -->
    {% if auth_enabled and current_user %}
    <!-- Custom backdrop for security settings - we manage this ourselves -->
    <div id="securitySettingsBackdrop" onclick="closeSecuritySettings()"></div>
    <div class="modal fade" id="securitySettingsModal" tabindex="-1" aria-labelledby="securitySettingsModalLabel" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-shield-lock me-2"></i>Security Settings</h5>
                    <button type="button" class="btn-close" onclick="closeSecuritySettings()" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if current_user.auth_type == 'local' %}
                    <!-- Password Change Section (Local users only) -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-key me-2"></i>Change Password
                        </div>
                        <div class="card-body">
                            <form id="changePasswordForm" novalidate>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Current Password</label>
                                        <input type="password" class="form-control" id="secCurrentPassword" required>
                                        <div class="invalid-feedback">Please enter your current password</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">New Password</label>
                                        <input type="password" class="form-control" id="secNewPassword" required minlength="8">
                                        <div class="invalid-feedback">Password must be at least 8 characters</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Confirm New Password</label>
                                        <input type="password" class="form-control" id="secConfirmPassword" required>
                                        <div class="invalid-feedback">Passwords do not match</div>
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-circle me-1"></i>Update Password
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <!-- LDAP User Notice -->
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        Your password is managed through your organization's directory service (LDAP/Active Directory).
                        You can still enable two-factor authentication below for additional security.
                    </div>
                    {% endif %}

                    <!-- Two-Factor Authentication Section (all users) -->
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-phone me-2"></i>Two-Factor Authentication
                        </div>
                        <div class="card-body">
                            <div id="2faStatus">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary"></div>
                                </div>
                            </div>

                            <!-- 2FA Disabled State -->
                            <div id="2faDisabled" class="d-none">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Two-factor authentication adds an extra layer of security to your account by requiring a code from your authenticator app when you sign in.
                                </div>
                                <button type="button" class="btn btn-success" onclick="setup2FA()">
                                    <i class="bi bi-shield-plus me-1"></i>Enable 2FA
                                </button>
                            </div>

                            <!-- 2FA Setup State -->
                            <div id="2faSetup" class="d-none">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    Scan the QR code with your authenticator app (Google Authenticator, Authy, etc.) then enter the verification code.
                                </div>
                                <div class="row">
                                    <div class="col-md-6 text-center">
                                        <div id="qrCodeContainer" class="mb-3 p-3 bg-white rounded border d-inline-block">
                                            <!-- QR Code will be generated here -->
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">Can't scan? Use this code:</small><br>
                                            <code id="totpSecretDisplay" class="user-select-all"></code>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Verification Code</label>
                                        <input type="text" class="form-control form-control-lg text-center"
                                               id="verify2FACode" maxlength="6" pattern="[0-9]{6}"
                                               placeholder="000000" style="letter-spacing: 0.5rem; font-family: monospace;">
                                        <small class="form-text text-muted">Enter the 6-digit code from your app</small>
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-success me-2" onclick="verify2FA()">
                                                <i class="bi bi-check-circle me-1"></i>Verify & Enable
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="cancel2FASetup()">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2FA Enabled State -->
                            <div id="2faEnabled" class="d-none">
                                <div class="alert alert-success">
                                    <i class="bi bi-shield-check me-2"></i>
                                    Two-factor authentication is enabled on your account.
                                </div>
                                <button type="button" class="btn btn-danger" onclick="disable2FA()">
                                    <i class="bi bi-shield-x me-1"></i>Disable 2FA
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Security Settings Functions
        let securityModal = null;

        function openSecuritySettings() {
            // AGGRESSIVE CLEANUP: Remove ALL Bootstrap backdrops and modal state
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');

            const modalEl = document.getElementById('securitySettingsModal');
            const customBackdrop = document.getElementById('securitySettingsBackdrop');

            // Dispose existing modal instance if any
            if (securityModal) {
                try {
                    securityModal.dispose();
                } catch (e) {}
                securityModal = null;
            }

            // Remove any existing Bootstrap Modal instance from the element
            const existingInstance = bootstrap.Modal.getInstance(modalEl);
            if (existingInstance) {
                try {
                    existingInstance.dispose();
                } catch (e) {}
            }

            // Show our custom backdrop
            customBackdrop.classList.add('show');
            document.body.classList.add('security-modal-open');
            document.body.style.overflow = 'hidden';

            // Create fresh modal instance WITHOUT Bootstrap backdrop
            securityModal = new bootstrap.Modal(modalEl, {
                backdrop: false,
                keyboard: true,
                focus: true
            });

            // Listen for modal hide to clean up
            modalEl.addEventListener('hidden.bs.modal', handleSecurityModalHidden, { once: true });

            // Also listen for escape key
            document.addEventListener('keydown', handleSecurityModalEscape);

            securityModal.show();
            load2FAStatus();
        }

        function handleSecurityModalEscape(e) {
            if (e.key === 'Escape') {
                closeSecuritySettings();
            }
        }

        function handleSecurityModalHidden() {
            cleanupSecurityModal();
        }

        function closeSecuritySettings() {
            const modalEl = document.getElementById('securitySettingsModal');

            if (securityModal) {
                try {
                    securityModal.hide();
                } catch (e) {}
            }

            // Force cleanup after a small delay to ensure Bootstrap has finished
            setTimeout(cleanupSecurityModal, 100);
        }

        function cleanupSecurityModal() {
            const customBackdrop = document.getElementById('securitySettingsBackdrop');
            const modalEl = document.getElementById('securitySettingsModal');

            // Hide custom backdrop
            if (customBackdrop) {
                customBackdrop.classList.remove('show');
            }

            // Remove body classes and styles
            document.body.classList.remove('security-modal-open');
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');

            // Remove ALL Bootstrap backdrops (paranoid cleanup)
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

            // Dispose modal instance
            if (securityModal) {
                try {
                    securityModal.dispose();
                } catch (e) {}
                securityModal = null;
            }

            // Also dispose any Bootstrap instance on the element
            const existingInstance = bootstrap.Modal.getInstance(modalEl);
            if (existingInstance) {
                try {
                    existingInstance.dispose();
                } catch (e) {}
            }

            // Remove escape key listener
            document.removeEventListener('keydown', handleSecurityModalEscape);

            // Reset modal element classes
            if (modalEl) {
                modalEl.classList.remove('show');
                modalEl.style.display = '';
                modalEl.setAttribute('aria-hidden', 'true');
                modalEl.removeAttribute('aria-modal');
                modalEl.removeAttribute('role');
            }
        }

        async function load2FAStatus() {
            const statusDiv = document.getElementById('2faStatus');
            const disabledDiv = document.getElementById('2faDisabled');
            const setupDiv = document.getElementById('2faSetup');
            const enabledDiv = document.getElementById('2faEnabled');

            statusDiv.classList.remove('d-none');
            disabledDiv.classList.add('d-none');
            setupDiv.classList.add('d-none');
            enabledDiv.classList.add('d-none');

            try {
                const response = await fetch('/api/auth/2fa/status');
                const data = await response.json();

                statusDiv.classList.add('d-none');

                if (data.enabled) {
                    enabledDiv.classList.remove('d-none');
                } else {
                    disabledDiv.classList.remove('d-none');
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Error loading 2FA status</div>';
            }
        }

        async function setup2FA() {
            const disabledDiv = document.getElementById('2faDisabled');
            const setupDiv = document.getElementById('2faSetup');

            try {
                const response = await fetch('/api/auth/2fa/setup', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    // Display secret
                    document.getElementById('totpSecretDisplay').textContent = data.secret;

                    // Generate QR code using server-side endpoint
                    const qrContainer = document.getElementById('qrCodeContainer');
                    // Add timestamp to prevent caching
                    const qrUrl = `/api/auth/2fa/qrcode?t=${Date.now()}`;
                    qrContainer.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="width: 200px; height: 200px; border: 1px solid #dee2e6; border-radius: 8px;">`;

                    disabledDiv.classList.add('d-none');
                    setupDiv.classList.remove('d-none');

                    document.getElementById('verify2FACode').focus();
                } else {
                    await showAlert(data.error || 'Failed to setup 2FA', 'Error', 'error');
                }
            } catch (error) {
                await showAlert('Error setting up 2FA: ' + error.message, 'Error', 'error');
            }
        }

        async function verify2FA() {
            const code = document.getElementById('verify2FACode').value;

            if (!code || code.length !== 6) {
                await showAlert('Please enter a valid 6-digit code', 'Invalid Code', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/auth/2fa/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                const data = await response.json();

                if (data.success) {
                    await showAlert('Two-factor authentication has been enabled successfully!', 'Success', 'success');
                    load2FAStatus();
                } else {
                    await showAlert(data.error || 'Invalid verification code', 'Error', 'error');
                    document.getElementById('verify2FACode').value = '';
                    document.getElementById('verify2FACode').focus();
                }
            } catch (error) {
                await showAlert('Error verifying code: ' + error.message, 'Error', 'error');
            }
        }

        function cancel2FASetup() {
            document.getElementById('2faSetup').classList.add('d-none');
            document.getElementById('2faDisabled').classList.remove('d-none');
            document.getElementById('verify2FACode').value = '';
        }

        async function disable2FA() {
            const password = await showPrompt('Enter your password to disable 2FA:', '', 'Disable 2FA');
            if (!password) return;

            try {
                const response = await fetch('/api/auth/2fa/disable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.success) {
                    await showAlert('Two-factor authentication has been disabled.', 'Success', 'success');
                    load2FAStatus();
                } else {
                    await showAlert(data.error || 'Failed to disable 2FA', 'Error', 'error');
                }
            } catch (error) {
                await showAlert('Error disabling 2FA: ' + error.message, 'Error', 'error');
            }
        }

        // Password Change Form - helper to set field invalid
        function setSecFieldInvalid(fieldId, message) {
            const field = document.getElementById(fieldId);
            const feedback = field?.nextElementSibling;
            if (field) {
                field.classList.add('is-invalid');
                if (feedback && feedback.classList.contains('invalid-feedback') && message) {
                    feedback.textContent = message;
                }
            }
        }

        function clearSecFieldValidation(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) field.classList.remove('is-invalid');
        }

        // Clear validation on input
        ['secCurrentPassword', 'secNewPassword', 'secConfirmPassword'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', () => clearSecFieldValidation(id));
        });

        // Password Change Form
        document.getElementById('changePasswordForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Clear previous validation
            ['secCurrentPassword', 'secNewPassword', 'secConfirmPassword'].forEach(clearSecFieldValidation);

            const currentPassword = document.getElementById('secCurrentPassword').value;
            const newPassword = document.getElementById('secNewPassword').value;
            const confirmPassword = document.getElementById('secConfirmPassword').value;

            // Client-side validation
            let isValid = true;

            if (!currentPassword) {
                setSecFieldInvalid('secCurrentPassword', 'Please enter your current password');
                isValid = false;
            }

            if (!newPassword) {
                setSecFieldInvalid('secNewPassword', 'Please enter a new password');
                isValid = false;
            } else if (newPassword.length < 8) {
                setSecFieldInvalid('secNewPassword', 'Password must be at least 8 characters');
                isValid = false;
            }

            if (!confirmPassword) {
                setSecFieldInvalid('secConfirmPassword', 'Please confirm your new password');
                isValid = false;
            } else if (newPassword !== confirmPassword) {
                setSecFieldInvalid('secConfirmPassword', 'Passwords do not match');
                isValid = false;
            }

            if (!isValid) return;

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    await showAlert('Password changed successfully!', 'Success', 'success');
                    document.getElementById('secCurrentPassword').value = '';
                    document.getElementById('secNewPassword').value = '';
                    document.getElementById('secConfirmPassword').value = '';
                } else {
                    // Show field-specific error if possible
                    if (data.error && data.error.toLowerCase().includes('current')) {
                        setSecFieldInvalid('secCurrentPassword', data.error);
                    } else if (data.error && (data.error.toLowerCase().includes('policy') || data.error.toLowerCase().includes('new password'))) {
                        setSecFieldInvalid('secNewPassword', data.error);
                    } else {
                        await showAlert(data.error || 'Failed to change password', 'Error', 'error');
                    }
                }
            } catch (error) {
                await showAlert('Error changing password: ' + error.message, 'Error', 'error');
            }
        });

        // Auto-format 2FA code input
        document.getElementById('verify2FACode')?.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);
        });
    </script>

    <!-- Session Timeout Handler -->
    <script>
    (function() {
        const SESSION_TIMEOUT_MINUTES = {{ session_timeout_minutes|default(480) }};
        const WARNING_BEFORE_MINUTES = 5; // Show warning 5 minutes before expiry
        const CHECK_INTERVAL_SECONDS = 60; // Check every minute

        let lastActivity = Date.now();
        let warningShown = false;
        let warningModal = null;

        // Track user activity
        function updateActivity() {
            lastActivity = Date.now();
            warningShown = false;
            // Hide warning if shown
            if (warningModal) {
                warningModal.hide();
            }
        }

        // Activity events to track
        ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'].forEach(event => {
            document.addEventListener(event, updateActivity, { passive: true });
        });

        // Create warning modal
        function createWarningModal() {
            const modalHtml = `
                <div class="modal fade" id="sessionWarningModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Session Expiring</h5>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-clock-history text-warning" style="font-size: 3rem;"></i>
                                <p class="mt-3 mb-2">Your session will expire in <strong id="sessionCountdown">${WARNING_BEFORE_MINUTES}</strong> minutes due to inactivity.</p>
                                <p class="text-muted small">Click anywhere or press any key to stay logged in.</p>
                            </div>
                            <div class="modal-footer justify-content-center">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                                    <i class="bi bi-arrow-repeat me-1"></i>Stay Logged In
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='/logout'">
                                    <i class="bi bi-box-arrow-right me-1"></i>Logout Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            return new bootstrap.Modal(document.getElementById('sessionWarningModal'));
        }

        // Check session status
        function checkSession() {
            const elapsed = (Date.now() - lastActivity) / 1000 / 60; // minutes
            const remaining = SESSION_TIMEOUT_MINUTES - elapsed;

            // Session expired - redirect to login
            if (remaining <= 0) {
                window.location.href = '/login?expired=1';
                return;
            }

            // Show warning
            if (remaining <= WARNING_BEFORE_MINUTES && !warningShown) {
                warningShown = true;
                if (!warningModal) {
                    warningModal = createWarningModal();
                }
                warningModal.show();
                updateCountdown(Math.ceil(remaining));
            }

            // Update countdown if warning is shown
            if (warningShown && remaining > 0) {
                updateCountdown(Math.ceil(remaining));
            }
        }

        function updateCountdown(minutes) {
            const el = document.getElementById('sessionCountdown');
            if (el) {
                el.textContent = minutes;
            }
        }

        // Start checking - only if timeout is reasonable (> 0 and < 24 hours)
        if (SESSION_TIMEOUT_MINUTES > 0 && SESSION_TIMEOUT_MINUTES < 1440) {
            setInterval(checkSession, CHECK_INTERVAL_SECONDS * 1000);
        }
    })();
    </script>
    {% endif %}

    {% block extra_js %}{% endblock %}
</body>
</html>
