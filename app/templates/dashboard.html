{% extends "base.html" %}

{% block title %}Dashboard - SentriKat{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">Dashboard</li>
{% endblock %}

{% block content %}
<style>
    /* Priority Alert Cards - Compact */
    .alert-card {
        border-radius: 8px;
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        background: linear-gradient(135deg, var(--card-bg-start) 0%, var(--card-bg-end) 100%);
        box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        height: 100%;
        cursor: pointer;
        user-select: none;
    }

    .alert-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .alert-card.active-filter {
        border: 2px solid var(--active-border-color, #6b7280);
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        transform: translateY(-1px);
    }

    .alert-card-critical.active-filter { --active-border-color: var(--critical-color); }
    .alert-card-high.active-filter { --active-border-color: var(--high-color); }
    .alert-card-medium.active-filter { --active-border-color: var(--info-color); }
    .alert-card-zeroday.active-filter { --active-border-color: #6d47a8; }

    .alert-card-critical {
        --card-bg-start: #fefafa;
        --card-bg-end: #fef2f2;
        border-left: 3px solid var(--critical-color);
    }

    .alert-card-high {
        --card-bg-start: #fffcf5;
        --card-bg-end: #fef8ee;
        border-left: 3px solid var(--high-color);
    }

    .alert-card-medium {
        --card-bg-start: #f8faff;
        --card-bg-end: #eff4ff;
        border-left: 3px solid var(--info-color);
    }

    .alert-card-zeroday {
        --card-bg-start: #f8f5ff;
        --card-bg-end: #f0eaf8;
        border-left: 3px solid #6d47a8;
    }

    .alert-card-label {
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: 0.25rem;
        color: var(--text-color, #374151);
    }

    .alert-card-value {
        font-size: 2.25rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.15rem;
    }

    .alert-card-critical .alert-card-value { color: var(--critical-color); }
    .alert-card-high .alert-card-value { color: var(--high-color); }
    .alert-card-medium .alert-card-value { color: var(--info-color); }
    .alert-card-low .alert-card-value { color: var(--low-color); }

    .alert-card i.alert-icon {
        font-size: 1.5rem;
        opacity: 0.4;
    }

    .alert-card small {
        font-size: 0.75rem;
    }

    /* Compact Stat Cards */
    .stat-card-compact {
        border-radius: 8px;
    }

    .stat-label-sm {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-muted, #6b7280);
        letter-spacing: 0.02em;
        margin-bottom: 0.15rem;
    }

    .stat-value-sm {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1.1;
        margin-bottom: 0.1rem;
    }

    /* Compact Filters */
    .filters-compact .form-label {
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
    }
    .filters-compact .form-select,
    .filters-compact .form-control {
        font-size: 0.875rem;
        padding: 0.35rem 0.5rem;
    }
    .filters-compact .form-check-label {
        font-size: 0.875rem;
    }

    .stat-icon-sm {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.25rem;
        opacity: 0.15;
    }

    /* CVE Card Scroll Performance Optimizations */
    #vulnerabilitiesContainer {
        contain: layout style;
    }

    /* Lean grouped CVE cards */
    .vuln-card-v2 {
        content-visibility: auto;
        contain-intrinsic-size: 0 180px;
    }

    .vuln-card-v2 .card-body {
        transition: none;
    }

    /* Smooth chevron rotation on collapse toggle */
    .vuln-card-v2 [data-bs-toggle="collapse"] .bi-chevron-down {
        transition: transform 0.2s ease;
    }
    .vuln-card-v2 [data-bs-toggle="collapse"][aria-expanded="true"] .bi-chevron-down {
        transform: rotate(180deg);
    }

    /* Tighter spacing between cards */
    .vuln-card-v2.mb-4 {
        margin-bottom: 0.75rem !important;
    }
</style>
<div class="fade-in">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h4 fw-bold text-dark mb-0">
                <i class="bi bi-speedometer2 me-2"></i>Vulnerability Dashboard
            </h1>
            <small class="text-muted">Real-time monitoring of known exploited vulnerabilities and 0-days</small>
        </div>
    </div>

    <!-- Unmapped Products Warning (top-level, right under title) -->
    <div id="unmappedWarning" class="alert alert-warning d-none mb-3 alert-dismissible" role="alert">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong><span id="unmappedCount">0</span> products without CPE mapping</strong> -
                These cannot be checked for vulnerabilities.
                <a href="/admin#products" class="alert-link">Review manually</a>
            </div>
            <div class="d-flex align-items-center gap-2 ms-3">
                <button class="btn btn-warning btn-sm" onclick="autoFixCpe()" id="autoFixCpeBtn">
                    <i class="bi bi-magic me-1"></i>Auto-Detect CPE
                </button>
                <button type="button" class="btn-close" aria-label="Dismiss" onclick="dismissUnmappedWarning()"></button>
            </div>
        </div>
    </div>

    <!-- Dashboard Top: Two-Column Widget Layout -->
    <div class="row g-3 mb-3">
        <!-- Left Column: Priority + Stats -->
        <div class="col-lg-5 col-xl-4">
            <!-- Source Type Filter -->
            <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                <small class="text-muted"><i class="bi bi-funnel me-1"></i>Source:</small>
                <div class="btn-group btn-group-sm" role="group" id="sourceKeyTypeToggle">
                    <button type="button" class="btn btn-outline-secondary active" data-source="" onclick="setDashboardSourceFilter('')" title="Show all">All</button>
                    <button type="button" class="btn btn-outline-secondary" data-source="server" onclick="setDashboardSourceFilter('server')" title="Server-reported only"><i class="bi bi-hdd-rack me-1"></i>Servers</button>
                    <button type="button" class="btn btn-outline-secondary" data-source="client" onclick="setDashboardSourceFilter('client')" title="Client-reported only"><i class="bi bi-laptop me-1"></i>Clients</button>
                    <button type="button" class="btn btn-outline-secondary" data-source="containers" onclick="setDashboardSourceFilter('containers')" title="Container image vulnerabilities"><i class="bi bi-box me-1"></i>Containers</button>
                    <button type="button" class="btn btn-outline-secondary" data-source="dependencies" onclick="setDashboardSourceFilter('dependencies')" title="Code libraries and extensions"><i class="bi bi-puzzle me-1"></i>Dependencies</button>
                </div>
            </div>
            <!-- Priority Alert Cards (compact 2x2 grid) -->
            <div class="row g-2 mb-2" id="priorityAlerts">
                <div class="col-6">
                    <div class="alert-card alert-card-zeroday" data-priority="zeroday" onclick="filterByZeroDay()" title="Click to filter by Zero-Day (Pre-KEV)">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="alert-card-label" style="color: #6d47a8;">0-Day</div>
                                <div class="alert-card-value"><span id="zeroDayCves" style="color: #6d47a8;">-</span> <small class="text-muted fw-normal" style="font-size: 0.8rem;">(<span id="zeroDayMatches">-</span>)</small></div>
                            </div>
                            <i class="bi bi-lightning-fill alert-icon" style="color: #6d47a8;"></i>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="alert-card alert-card-critical" data-priority="critical" onclick="filterBySeverity('CRITICAL')" title="Click to filter by Critical">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="alert-card-label">Critical</div>
                                <div class="alert-card-value"><span id="criticalCves">-</span> <small class="text-muted fw-normal" style="font-size: 0.8rem;">(<span id="criticalCount">-</span>)</small></div>
                            </div>
                            <i class="bi bi-exclamation-octagon-fill alert-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="alert-card alert-card-high" data-priority="high" onclick="filterBySeverity('HIGH')" title="Click to filter by High">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="alert-card-label">High</div>
                                <div class="alert-card-value"><span id="highCves">-</span> <small class="text-muted fw-normal" style="font-size: 0.8rem;">(<span id="highCount">-</span>)</small></div>
                            </div>
                            <i class="bi bi-exclamation-triangle-fill alert-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="alert-card alert-card-medium" data-priority="medium" onclick="filterBySeverity('MEDIUM')" title="Click to filter by Medium">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="alert-card-label">Medium</div>
                                <div class="alert-card-value"><span id="mediumCves">-</span> <small class="text-muted fw-normal" style="font-size: 0.8rem;">(<span id="mediumCount">-</span>)</small></div>
                            </div>
                            <i class="bi bi-info-circle-fill alert-icon"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats (compact list) -->
            <div class="card" id="statsContainer">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center py-1 px-2 border-bottom">
                        <small class="text-muted"><i class="bi bi-database me-1"></i>KEV Catalog</small>
                        <span class="fw-bold text-primary" id="totalVulns">-</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-1 px-2 border-bottom">
                        <small class="text-muted"><i class="bi bi-exclamation-triangle me-1"></i>Affecting Products</small>
                        <span class="fw-bold text-danger" id="totalMatches">-</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-1 px-2 border-bottom">
                        <small class="text-muted"><i class="bi bi-clock-history me-1"></i>Needs Review</small>
                        <span class="fw-bold text-warning" id="unacknowledged">-</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-1 px-2 border-bottom">
                        <small class="text-muted"><i class="bi bi-gear-fill me-1"></i>Products Tracked</small>
                        <span class="fw-bold text-success" id="productsTracked">-</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-1 px-2 border-bottom">
                        <small class="text-muted"><i class="bi bi-lightning-charge me-1"></i>High EPSS Risk</small>
                        <span class="fw-bold text-danger" id="highEpss" title="CVEs with EPSS >= 10% exploit probability">-</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-1 px-2">
                        <small class="text-muted"><i class="bi bi-shield-check me-1"></i>Low Priority</small>
                        <span class="fw-bold text-success" id="lowCves" title="Low priority vulnerability matches">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Configurable Chart Widgets -->
        <div class="col-lg-7 col-xl-8">
            <div class="row g-3 h-100">
                <!-- Widget Slot 1 (Left) -->
                <div class="col-md-5">
                    <div class="card h-100" id="widgetCard1">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center">
                            <span id="widgetTitle1"><i class="bi bi-pie-chart me-2"></i>Priority Breakdown</span>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary py-0 px-2 dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Change widget">
                                    <i class="bi bi-gear"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="setWidget(1, 'severity_donut'); return false;"><i class="bi bi-pie-chart me-2"></i>Priority Breakdown</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setWidget(1, 'epss_distribution'); return false;"><i class="bi bi-lightning-charge me-2"></i>EPSS Distribution</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setWidget(1, 'age_distribution'); return false;"><i class="bi bi-clock-history me-2"></i>Vulnerability Age</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setWidget(1, 'top_vendors'); return false;"><i class="bi bi-building me-2"></i>Top Vendors</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setWidget(1, 'vuln_timeline'); return false;"><i class="bi bi-calendar3 me-2"></i>Monthly Timeline</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setWidget(1, 'remediation_rate'); return false;"><i class="bi bi-check2-circle me-2"></i>Remediation Progress</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body py-2 d-flex flex-column align-items-center justify-content-center">
                            <p class="text-muted mb-1 small widget-subtitle" id="widgetSubtitle1" style="font-size: 0.7rem;">Unacknowledged matches by effective priority</p>
                            <div id="widgetChartContainer1" style="position: relative; width: 100%; max-height: 200px;">
                                <canvas id="widgetCanvas1"></canvas>
                            </div>
                            <div id="widgetNoData1" class="text-center text-muted py-3 d-none">
                                <i class="bi bi-pie-chart fs-2 opacity-50"></i>
                                <p class="mt-1 mb-0 small">No data yet</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Widget Slot 2 (Right) -->
                <div class="col-md-7">
                    <div class="card h-100" id="widgetCard2">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center">
                            <span id="widgetTitle2"><i class="bi bi-building me-2"></i>Top Affected Vendors</span>
                            <div class="d-flex gap-1">
                                <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="refreshWidget(2)" title="Refresh">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary py-0 px-2 dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Change widget">
                                        <i class="bi bi-gear"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#" onclick="setWidget(2, 'severity_donut'); return false;"><i class="bi bi-pie-chart me-2"></i>Priority Breakdown</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setWidget(2, 'epss_distribution'); return false;"><i class="bi bi-lightning-charge me-2"></i>EPSS Distribution</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setWidget(2, 'age_distribution'); return false;"><i class="bi bi-clock-history me-2"></i>Vulnerability Age</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setWidget(2, 'top_vendors'); return false;"><i class="bi bi-building me-2"></i>Top Vendors</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setWidget(2, 'vuln_timeline'); return false;"><i class="bi bi-calendar3 me-2"></i>Monthly Timeline</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setWidget(2, 'remediation_rate'); return false;"><i class="bi bi-check2-circle me-2"></i>Remediation Progress</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="card-body py-2">
                            <p class="text-muted mb-1 small widget-subtitle" id="widgetSubtitle2" style="font-size: 0.7rem;">Top 10 vendors with unacknowledged vulnerabilities</p>
                            <div id="widgetChartContainer2" style="position: relative; height: 190px;">
                                <canvas id="widgetCanvas2"></canvas>
                            </div>
                            <div id="widgetNoData2" class="text-center text-muted py-3 d-none">
                                <i class="bi bi-bar-chart fs-2 opacity-50"></i>
                                <p class="mt-1 mb-0 small">No data yet</p>
                                {% if session.get('is_admin') %}
                                <button class="btn btn-sm btn-outline-primary mt-1" onclick="takeManualSnapshot()">
                                    <i class="bi bi-camera"></i> Take Snapshot
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Filters Panel -->
    <div class="card mb-3">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span><i class="bi bi-funnel me-2"></i>Filters</span>
            <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="resetFilters()">
                <i class="bi bi-arrow-counterclockwise"></i> Reset
            </button>
        </div>
        <div class="card-body py-2 filters-compact">
            <div class="row g-2">
                <div class="col-6 col-md-2">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="filterPriority">
                        <option value="">All</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Severity</label>
                    <select class="form-select" id="filterSeverity">
                        <option value="">All</option>
                        <option value="CRITICAL">Critical</option>
                        <option value="HIGH">High</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="LOW">Low</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Urgency</label>
                    <select class="form-select" id="filterUrgency">
                        <option value="">All</option>
                        <option value="critical">≤7 Days</option>
                        <option value="high">≤30 Days</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Age</label>
                    <select class="form-select" id="filterAge">
                        <option value="">All</option>
                        <option value="30">30 Days</option>
                        <option value="90">90 Days</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">CVE ID</label>
                    <input type="text" class="form-control" id="filterCVE" placeholder="CVE-...">
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">EPSS Risk</label>
                    <select class="form-select" id="filterEpss">
                        <option value="">All</option>
                        <option value="critical">Top 5% (Critical)</option>
                        <option value="high">Top 15% (High)</option>
                        <option value="medium">Top 30% (Medium)</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Vendor</label>
                    <input type="text" class="form-control" id="filterVendor" placeholder="Microsoft">
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Product</label>
                    <input type="text" class="form-control" id="filterProduct" placeholder="Windows">
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Platform</label>
                    <select class="form-select" id="filterPlatform">
                        <option value="">All</option>
                        <option value="windows">Windows</option>
                        <option value="linux">Linux</option>
                        <option value="macos">macOS</option>
                        <option value="container">Container</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-3 align-items-center h-100">
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="filterRansomware">
                            <label class="form-check-label" for="filterRansomware">Ransomware</label>
                        </div>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="filterUnack" checked>
                            <label class="form-check-label" for="filterUnack">Unacknowledged Only</label>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="resetAndLoadVulnerabilities()">
                            <i class="bi bi-search"></i> Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vulnerabilities List -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span><i class="bi bi-shield-exclamation me-2"></i>Vulnerabilities (<span id="vulnCount">0</span> CVEs)</span>
            <div class="d-flex align-items-center gap-3">
                <!-- Export Report Dropdown -->
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Export Report">
                        <i class="bi bi-file-earmark-pdf me-1"></i>Export
                    </button>
                    <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 280px;">
                        <h6 class="dropdown-header px-0">Export PDF Report</h6>
                        <div class="mb-2">
                            <select class="form-select form-select-sm" id="reportType" onchange="toggleReportDateFields()">
                                <option value="monthly">Monthly Report</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                        </div>
                        <div class="row g-2 mb-2" id="monthlyFields">
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="reportMonth">
                                    <option value="1">Jan</option>
                                    <option value="2">Feb</option>
                                    <option value="3">Mar</option>
                                    <option value="4">Apr</option>
                                    <option value="5">May</option>
                                    <option value="6">Jun</option>
                                    <option value="7">Jul</option>
                                    <option value="8">Aug</option>
                                    <option value="9">Sep</option>
                                    <option value="10">Oct</option>
                                    <option value="11">Nov</option>
                                    <option value="12">Dec</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="reportYear"></select>
                            </div>
                        </div>
                        <div class="row g-2 mb-2" id="customFields" style="display: none;">
                            <div class="col-6">
                                <input type="date" class="form-control form-control-sm" id="reportStartDate" placeholder="Start">
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control form-control-sm" id="reportEndDate" placeholder="End">
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm w-100" onclick="exportReport()">
                            <i class="bi bi-download me-1"></i>Download PDF
                        </button>
                        <hr class="my-2">
                        <h6 class="dropdown-header px-0">Quick Export</h6>
                        <button class="btn btn-outline-success btn-sm w-100 mb-1" onclick="exportCSV()">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Export CSV (Excel)
                        </button>
                        <button class="btn btn-outline-info btn-sm w-100" onclick="exportExecutiveSummary()">
                            <i class="bi bi-file-earmark-bar-graph me-1"></i>Executive Summary PDF
                        </button>
                    </div>
                </div>
                <!-- Sort By -->
                <select class="form-select form-select-sm" id="sortBy" style="width: auto;" onchange="loadGroupedVulnerabilities()" title="Sort by">
                    <option value="priority-asc">Priority (Critical first)</option>
                    <option value="priority-desc">Priority (Low first)</option>
                    <option value="cve-asc">CVE ID (A-Z)</option>
                    <option value="cve-desc">CVE ID (Z-A)</option>
                    <option value="product-asc">Product (A-Z)</option>
                    <option value="product-desc">Product (Z-A)</option>
                    <option value="due-asc">Due Date (Soonest)</option>
                    <option value="due-desc">Due Date (Latest)</option>
                    <option value="date-asc">Date Added (Oldest)</option>
                    <option value="date-desc">Date Added (Newest)</option>
                </select>
                <!-- Page Size -->
                <select class="form-select form-select-sm" id="pageSize" style="width: 75px;" onchange="changePageSize()" title="Items per page">
                    <option value="15" selected>15</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="all">All</option>
                </select>
                <div class="form-check mb-0">
                    <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                    <label class="form-check-label" for="selectAll">Select All</label>
                </div>
            </div>
        </div>
        <!-- Bulk Actions Toolbar (hidden until selection made) -->
        <div id="bulkActionsBar" class="card-body bg-primary bg-opacity-10 border-bottom py-2" style="display: none;">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-primary"><span id="selectedCount">0</span> selected</span>
                    <button class="btn btn-sm btn-success" id="bulkAckBtn" onclick="bulkAcknowledge()" disabled>
                        <i class="bi bi-check-circle me-1"></i>Acknowledge
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-warning dropdown-toggle" id="bulkSnoozeBtn" data-bs-toggle="dropdown" disabled>
                            <i class="bi bi-clock me-1"></i>Snooze
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="bulkSnooze(24); return false;">24 hours</a></li>
                            <li><a class="dropdown-item" href="#" onclick="bulkSnooze(72); return false;">3 days</a></li>
                            <li><a class="dropdown-item" href="#" onclick="bulkSnooze(168); return false;">1 week</a></li>
                        </ul>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" id="bulkUnackBtn" onclick="bulkUnacknowledge()" disabled>
                        <i class="bi bi-x-circle me-1"></i>Unacknowledge
                    </button>
                    <button class="btn btn-sm btn-outline-primary" id="bulkExportBtn" onclick="bulkExport()" disabled>
                        <i class="bi bi-download me-1"></i>Export Selected
                    </button>
                </div>
                <button class="btn btn-sm btn-link text-decoration-none" onclick="clearSelection()">
                    <i class="bi bi-x me-1"></i>Clear Selection
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <!-- Top Pagination Controls -->
            <div id="paginationControlsTop" class="d-flex justify-content-between align-items-center p-3 border-bottom" style="display: none;">
                <div class="text-muted small paginationInfo">Showing 1-50 of 0</div>
                <nav>
                    <ul class="pagination pagination-sm mb-0 paginationNav"></ul>
                </nav>
            </div>
            <div id="vulnerabilitiesContainer" class="p-3"></div>
            <!-- Bottom Pagination Controls -->
            <div id="paginationControlsBottom" class="d-flex justify-content-between align-items-center p-3 border-top" style="display: none;">
                <div class="text-muted small paginationInfo">Showing 1-50 of 0</div>
                <nav>
                    <ul class="pagination pagination-sm mb-0 paginationNav"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Last Sync Info -->
    <div class="card mt-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Last Synchronization</h6>
                    <p class="text-muted mb-0 mt-1" id="lastSync">Loading...</p>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-outline-primary" onclick="viewSyncHistory()">
                        <i class="bi bi-clock-history"></i> View Sync History
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sync History Modal -->
<div class="modal fade" id="syncHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-clock-history me-2"></i>Synchronization History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Status</th>
                                <th>Vulnerabilities</th>
                                <th>Matches Found</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody id="syncHistoryTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Filtered View Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Share Filtered View</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name (Optional)</label>
                        <input type="text" class="form-control" id="shareName" placeholder="e.g., Critical Windows Vulnerabilities">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="shareDescription" rows="2" placeholder="Brief description of this filtered view"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Link Expiration</label>
                        <select class="form-select" id="shareExpiration">
                            <option value="">Never expires</option>
                            <option value="7">7 days</option>
                            <option value="30" selected>30 days</option>
                            <option value="90">90 days</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Current Filters:</strong>
                        <div id="shareFiltersSummary" class="mt-2 small">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    <div id="shareResult" style="display: none;">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Shareable link created!</strong>
                            <div class="input-group mt-2">
                                <input type="text" class="form-control" id="shareUrl" readonly>
                                <button class="btn btn-outline-secondary" onclick="copyShareUrl()">
                                    <i class="bi bi-clipboard"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="createShareLink()" id="createShareBtn">
                        <i class="bi bi-share"></i> Create Share Link
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<!-- Chart.js for trend visualization (CDN-first with local fallback) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
        onerror="var s=document.createElement('script');s.src='{{ url_for('static', filename='vendor/js/chart.umd.min.js') }}';document.body.appendChild(s);"></script>
<script>
    // Helper functions for priority styling
    function getPriorityBadgeClass(priority) {
        const classes = {
            'critical': 'bg-danger',
            'high': 'bg-warning text-dark',
            'medium': 'bg-info text-dark',
            'low': 'bg-secondary'
        };
        return classes[priority?.toLowerCase()] || 'bg-secondary';
    }

    function getPriorityIcon(priority) {
        const icons = {
            'critical': 'bi-exclamation-triangle-fill',
            'high': 'bi-exclamation-circle-fill',
            'medium': 'bi-info-circle-fill',
            'low': 'bi-dash-circle'
        };
        return icons[priority?.toLowerCase()] || 'bi-circle';
    }

    function getPriorityColor(priority) {
        const style = getComputedStyle(document.documentElement);
        const colors = {
            'critical': style.getPropertyValue('--critical-color').trim() || '#b91c1c',
            'high': style.getPropertyValue('--high-color').trim() || '#c2410c',
            'medium': style.getPropertyValue('--info-color').trim() || '#2563eb',
            'low': '#6b7280'
        };
        return colors[priority?.toLowerCase()] || '#6b7280';
    }

    // EPSS Badge Class - color based on percentile (higher = more likely to be exploited)
    function getEpssBadgeClass(percentile) {
        if (percentile == null) return 'bg-secondary';
        if (percentile >= 0.95) return 'bg-danger';        // Top 5% - Critical risk
        if (percentile >= 0.85) return 'bg-warning text-dark'; // Top 15% - High risk
        if (percentile >= 0.70) return 'bg-info text-dark';    // Top 30% - Medium risk
        return 'bg-success';  // Lower risk
    }

    // Asset OS type icon based on asset_type field
    function getAssetOsIcon(assetType) {
        const t = (assetType || '').toLowerCase();
        if (t === 'container') return 'bi-box';
        if (t === 'appliance') return 'bi-router';
        // Default to PC icon for server/workstation
        return 'bi-pc-display';
    }

    // Get OS icon based on os_name string
    function getOsIcon(osName) {
        const os = (osName || '').toLowerCase();
        if (os.includes('windows')) return 'bi-windows';
        if (os.includes('ubuntu') || os.includes('debian') || os.includes('centos') || os.includes('rhel') || os.includes('fedora') || os.includes('linux') || os.includes('arch') || os.includes('suse')) return 'bi-ubuntu';
        if (os.includes('macos') || os.includes('darwin') || os.includes('mac os')) return 'bi-apple';
        if (os.includes('alpine') || os.includes('container')) return 'bi-box';
        return 'bi-question-circle';
    }

    // Build platform summary badges from affected assets across all products
    function getPlatformSummary(group) {
        const platforms = {};
        (group.affected_products || []).forEach(prod => {
            (prod.affected_assets || []).forEach(a => {
                const os = (a.os_name || '').toLowerCase();
                const type = (a.type || '').toLowerCase();
                let platform;
                if (type === 'container') platform = 'Container';
                else if (os.includes('windows')) platform = 'Windows';
                else if (os.includes('ubuntu') || os.includes('debian') || os.includes('centos') || os.includes('rhel') || os.includes('fedora') || os.includes('linux') || os.includes('suse') || os.includes('arch')) platform = 'Linux';
                else if (os.includes('macos') || os.includes('darwin')) platform = 'macOS';
                else if (os) platform = os.split(' ')[0]; // First word of OS name
                else return; // skip if no OS info
                platforms[platform] = (platforms[platform] || 0) + 1;
            });
        });

        const iconMap = { 'Windows': 'bi-windows', 'Linux': 'bi-ubuntu', 'macOS': 'bi-apple', 'Container': 'bi-box' };
        const colorMap = { 'Windows': '#4a7ab5', 'Linux': '#b07050', 'macOS': '#555', 'Container': '#4a8fa5' };
        const cveId = group.cve_id || '';

        return Object.entries(platforms).map(([name, count]) => {
            const icon = iconMap[name] || 'bi-hdd';
            const color = colorMap[name] || '#6b7280';
            return `<a href="/admin#endpointsPane?cve=${encodeURIComponent(cveId)}" class="badge rounded-pill me-1 text-decoration-none" style="background-color: ${color}; font-size: 0.75rem; cursor: pointer;" title="View ${count} ${name} endpoint${count > 1 ? 's' : ''} affected by ${cveId}" onclick="event.preventDefault(); event.stopPropagation(); window.location.href='/admin#endpointsPane?cve=${encodeURIComponent(cveId)}';">
                <i class="bi ${icon} me-1"></i>${count}
            </a>`;
        }).join('');
    }

    // Report Export Functions
    function initReportFields() {
        // Populate year dropdown
        const yearSelect = document.getElementById('reportYear');
        const currentYear = new Date().getFullYear();
        for (let year = currentYear; year >= currentYear - 5; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }

        // Set current month and year
        const currentMonth = new Date().getMonth() + 1;
        document.getElementById('reportMonth').value = currentMonth;

        // Set default date range for custom reports (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);

        document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
        document.getElementById('reportStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    }

    function toggleReportDateFields() {
        const reportType = document.getElementById('reportType').value;
        const monthlyFields = document.getElementById('monthlyFields');
        const customFields = document.getElementById('customFields');

        if (reportType === 'monthly') {
            monthlyFields.style.display = 'flex';
            customFields.style.display = 'none';
        } else {
            monthlyFields.style.display = 'none';
            customFields.style.display = 'flex';
        }
    }

    async function exportReport() {
        const reportType = document.getElementById('reportType').value;
        let url;

        if (reportType === 'monthly') {
            const month = document.getElementById('reportMonth').value;
            const year = document.getElementById('reportYear').value;
            url = `/api/reports/monthly?month=${month}&year=${year}`;
        } else {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            if (!startDate || !endDate) {
                showToast('Please select both start and end dates', 'warning');
                return;
            }

            url = `/api/reports/custom?start_date=${startDate}&end_date=${endDate}`;
        }

        try {
            showLoading();
            showToast('Generating report...', 'info');

            const response = await fetch(url);

            if (!response.ok) {
                // Try to parse error as JSON, fallback to status text
                let errorMessage = 'Failed to generate report';
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        errorMessage = error.error || errorMessage;
                    } else {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                } catch (e) {
                    errorMessage = `Server error: ${response.status}`;
                }
                throw new Error(errorMessage);
            }

            // Download the PDF
            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;

            // Get filename from Content-Disposition header or generate one
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'SentriKat_Report.pdf';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename="(.+)"/);
                if (match) filename = match[1];
            }

            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(downloadUrl);

            showToast('Report downloaded successfully!', 'success');
        } catch (error) {
            console.error('Error generating report:', error);
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function exportCSV() {
        try {
            showLoading();
            showToast('Exporting CSV...', 'info');

            // Pass current filters to CSV export
            const params = new URLSearchParams();
            const priorityFilter = document.getElementById('priorityFilter');
            if (priorityFilter && priorityFilter.value) params.set('priority', priorityFilter.value);
            const ackFilter = document.getElementById('acknowledgedFilter');
            if (ackFilter && ackFilter.value) params.set('acknowledged', ackFilter.value);

            const response = await fetch(`/api/reports/export/csv?${params.toString()}`);
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error || `Server error: ${response.status}`);
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const cd = response.headers.get('Content-Disposition');
            a.download = cd ? (cd.match(/filename="(.+)"/) || [])[1] || 'vulnerabilities.csv' : 'vulnerabilities.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast('CSV exported successfully!', 'success');
        } catch (error) {
            console.error('CSV export error:', error);
            showToast(`Export failed: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function exportExecutiveSummary() {
        try {
            showLoading();
            showToast('Generating executive summary...', 'info');

            const response = await fetch('/api/reports/executive-summary?format=pdf');
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                if (response.status === 403) {
                    showToast('Executive Summary requires a Professional license', 'warning');
                    return;
                }
                throw new Error(err.error || `Server error: ${response.status}`);
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const cd = response.headers.get('Content-Disposition');
            a.download = cd ? (cd.match(/filename="(.+)"/) || [])[1] || 'executive_summary.pdf' : 'executive_summary.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast('Executive summary downloaded!', 'success');
        } catch (error) {
            console.error('Executive summary error:', error);
            showToast(`Export failed: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    // Initialize report fields on page load
    document.addEventListener('DOMContentLoaded', function() {
        initReportFields();
    });

    // Retry utility for API calls during startup
    async function fetchWithRetry(url, options = {}, maxRetries = 3, delayMs = 800) {
        let lastError;
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const response = await fetch(url, options);
                if (response.status >= 500 && attempt < maxRetries) {
                    console.warn(`[Retry ${attempt}/${maxRetries}] Server error ${response.status} for ${url}`);
                    await new Promise(r => setTimeout(r, delayMs * attempt));
                    continue;
                }
                return response;
            } catch (error) {
                lastError = error;
                console.warn(`[Retry ${attempt}/${maxRetries}] Network error for ${url}: ${error.message}`);
                if (attempt < maxRetries) {
                    await new Promise(r => setTimeout(r, delayMs * attempt));
                }
            }
        }
        throw lastError || new Error(`Failed to fetch ${url} after ${maxRetries} attempts`);
    }

    let currentVulnerabilities = [];
    let currentGroupedVulnerabilities = [];
    let selectedVulns = new Set();
    let currentPage = 1;
    let pageSize = 15;
    let zeroDayFilterActive = false;

    function changePageSize() {
        const select = document.getElementById('pageSize');
        pageSize = select.value === 'all' ? Infinity : parseInt(select.value);
        currentPage = 1;
        loadGroupedVulnerabilities();
    }

    // Shared function to update both top and bottom pagination controls
    function updatePaginationControls(totalPages, total, startIdx, endIdx, goToFn) {
        const paginationTop = document.getElementById('paginationControlsTop');
        const paginationBottom = document.getElementById('paginationControlsBottom');

        if (totalPages > 1) {
            const infoText = `Showing ${startIdx + 1}-${endIdx} of ${total}`;

            // Build pagination nav HTML
            let navHtml = '';
            navHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="${goToFn}(${currentPage - 1}); return false;">&laquo;</a>
            </li>`;

            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                navHtml += `<li class="page-item"><a class="page-link" href="#" onclick="${goToFn}(1); return false;">1</a></li>`;
                if (startPage > 2) navHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                navHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="${goToFn}(${i}); return false;">${i}</a>
                </li>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) navHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                navHtml += `<li class="page-item"><a class="page-link" href="#" onclick="${goToFn}(${totalPages}); return false;">${totalPages}</a></li>`;
            }

            navHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="${goToFn}(${currentPage + 1}); return false;">&raquo;</a>
            </li>`;

            // Update both top and bottom
            [paginationTop, paginationBottom].forEach(el => {
                if (el) {
                    el.style.display = 'flex';
                    el.querySelector('.paginationInfo').textContent = infoText;
                    el.querySelector('.paginationNav').innerHTML = navHtml;
                }
            });
        } else {
            [paginationTop, paginationBottom].forEach(el => {
                if (el) el.style.display = 'none';
            });
        }
    }

    // Dashboard source key type filter state
    let dashboardSourceFilter = '';

    function setDashboardSourceFilter(value) {
        dashboardSourceFilter = value;
        // Update toggle button states
        document.querySelectorAll('#sourceKeyTypeToggle button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.source === value);
        });
        // Reload stats and grouped vulnerabilities with the new filter
        loadStats();
        loadGroupedVulnerabilities();
    }

    async function loadStats() {
        try {
            let statsUrl = '/api/vulnerabilities/stats';
            if (dashboardSourceFilter === 'containers') {
                statsUrl += '?source_type=container';
            } else if (dashboardSourceFilter === 'dependencies') {
                statsUrl += '?source_type=code_library&include_extensions=true';
            } else if (dashboardSourceFilter) {
                statsUrl += `?source_key_type=${dashboardSourceFilter}`;
            }
            const response = await fetchWithRetry(statsUrl, {}, 4, 1000);

            // Check if response is OK before parsing
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`Server error: ${response.status}`);
            }

            const stats = await response.json();

            document.getElementById('totalVulns').textContent = formatNumber(stats.total_vulnerabilities);
            document.getElementById('totalMatches').textContent = formatNumber(stats.total_matches);
            document.getElementById('unacknowledged').textContent = formatNumber(stats.unacknowledged_cves || stats.unacknowledged);
            document.getElementById('productsTracked').textContent = formatNumber(stats.products_tracked);

            // EPSS risk indicator
            if (stats.epss) {
                const epssEl = document.getElementById('highEpss');
                epssEl.textContent = formatNumber(stats.epss.high_epss);
                epssEl.title = `${stats.epss.high_epss} CVEs with ≥10% exploit probability (avg: ${(stats.epss.avg_epss * 100).toFixed(1)}%)`;
            }

            // Low priority count (moved from quadrant to stats row)
            document.getElementById('lowCves').textContent = formatNumber(stats.low_cves || 0);

            // Show/hide unmapped products warning (respects dismiss)
            const unmappedWarning = document.getElementById('unmappedWarning');
            const unmappedCount = document.getElementById('unmappedCount');
            if (unmappedWarning && stats.products_unmapped > 0) {
                unmappedCount.textContent = stats.products_unmapped;
                // Check if user dismissed this warning recently (4-hour cooldown)
                const dismissedAt = localStorage.getItem('unmappedWarningDismissed');
                const dismissedCount = parseInt(localStorage.getItem('unmappedWarningDismissedCount') || '0');
                const cooldownMs = 4 * 60 * 60 * 1000; // 4 hours
                const isStillDismissed = dismissedAt && (Date.now() - parseInt(dismissedAt)) < cooldownMs
                    && dismissedCount === stats.products_unmapped;
                if (!isStillDismissed) {
                    unmappedWarning.classList.remove('d-none');
                    // Clear stale dismiss if count changed
                    if (dismissedCount !== stats.products_unmapped) {
                        localStorage.removeItem('unmappedWarningDismissed');
                    }
                }
            } else if (unmappedWarning) {
                unmappedWarning.classList.add('d-none');
                localStorage.removeItem('unmappedWarningDismissed');
            }

            // Update priority counts - CVE counts and match counts
            document.getElementById('zeroDayCves').textContent = formatNumber(stats.zero_day_count || 0);
            document.getElementById('zeroDayMatches').textContent = formatNumber(stats.zero_day_matches || 0);
            document.getElementById('criticalCves').textContent = formatNumber(stats.critical_cves || 0);
            document.getElementById('criticalCount').textContent = formatNumber(stats.critical_count || 0);
            document.getElementById('highCves').textContent = formatNumber(stats.high_cves || 0);
            document.getElementById('highCount').textContent = formatNumber(stats.high_count || 0);
            document.getElementById('mediumCves').textContent = formatNumber(stats.medium_cves || 0);
            document.getElementById('mediumCount').textContent = formatNumber(stats.medium_count || 0);

            // Update configurable dashboard widgets with stats data
            lastStatsData = stats;
            loadAllWidgets();
        } catch (error) {
            console.error('Error loading stats:', error);
            // Show error in cards instead of just toast
            document.getElementById('totalVulns').textContent = '-';
            document.getElementById('totalMatches').textContent = '-';
            document.getElementById('unacknowledged').textContent = '-';
            document.getElementById('productsTracked').textContent = '-';
            document.getElementById('highEpss').textContent = '-';
            document.getElementById('zeroDayCves').textContent = '-';
            document.getElementById('zeroDayMatches').textContent = '-';
            document.getElementById('criticalCves').textContent = '-';
            document.getElementById('criticalCount').textContent = '-';
            document.getElementById('highCves').textContent = '-';
            document.getElementById('highCount').textContent = '-';
            document.getElementById('mediumCves').textContent = '-';
            document.getElementById('mediumCount').textContent = '-';
            showToast('Failed to load statistics. Try refreshing.', 'danger');
        }
    }

    // ============================================================================
    // Configurable Dashboard Widget System
    // ============================================================================

    // Chart instances for each widget slot
    const widgetInstances = { 1: null, 2: null };
    let lastStatsData = null;

    // Widget type definitions
    const WIDGET_TYPES = {
        severity_donut: { icon: 'bi-pie-chart', title: 'Priority Breakdown', subtitle: 'Unacknowledged matches by effective priority' },
        epss_distribution: { icon: 'bi-lightning-charge', title: 'EPSS Distribution', subtitle: 'Exploit probability score distribution' },
        age_distribution: { icon: 'bi-clock-history', title: 'Vulnerability Age', subtitle: 'Time since CVEs were added to KEV catalog' },
        top_vendors: { icon: 'bi-building', title: 'Top Affected Vendors', subtitle: 'Top 10 vendors with unacknowledged vulnerabilities' },
        vuln_timeline: { icon: 'bi-calendar3', title: 'Monthly Timeline', subtitle: 'New affecting CVEs per month (last 12 months)' },
        remediation_rate: { icon: 'bi-check2-circle', title: 'Remediation Progress', subtitle: 'Acknowledged vs unacknowledged over time' }
    };

    // Get saved widget preferences from localStorage
    function getWidgetPrefs() {
        try {
            const saved = localStorage.getItem('sentrikat_widget_prefs');
            if (saved) return JSON.parse(saved);
        } catch (e) { /* ignore */ }
        return { slot1: 'severity_donut', slot2: 'top_vendors' };
    }

    function saveWidgetPrefs(prefs) {
        localStorage.setItem('sentrikat_widget_prefs', JSON.stringify(prefs));
    }

    // Set widget type for a slot and reload
    function setWidget(slot, widgetType) {
        const prefs = getWidgetPrefs();
        prefs['slot' + slot] = widgetType;
        saveWidgetPrefs(prefs);
        loadWidget(slot, widgetType);
    }

    function refreshWidget(slot) {
        const prefs = getWidgetPrefs();
        loadWidget(slot, prefs['slot' + slot]);
    }

    // Load all widgets based on saved preferences
    function loadAllWidgets() {
        const prefs = getWidgetPrefs();
        loadWidget(1, prefs.slot1);
        loadWidget(2, prefs.slot2);
    }

    // Common chart helpers
    function getChartColors() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        return {
            isDark,
            gridColor: isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.05)',
            tickColor: isDark ? '#9ca3af' : '#6b7280',
            legendColor: isDark ? '#d1d5db' : undefined,
            tooltipBg: isDark ? 'rgba(30, 30, 30, 0.95)' : 'rgba(0, 0, 0, 0.8)',
            borderColor: isDark ? '#1e1e1e' : '#ffffff'
        };
    }

    function formatAxisValue(value) {
        if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
        if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
        return value;
    }

    // Load a specific widget into a slot
    async function loadWidget(slot, widgetType) {
        const meta = WIDGET_TYPES[widgetType] || WIDGET_TYPES.severity_donut;
        const titleEl = document.getElementById('widgetTitle' + slot);
        const subtitleEl = document.getElementById('widgetSubtitle' + slot);
        const container = document.getElementById('widgetChartContainer' + slot);
        const noData = document.getElementById('widgetNoData' + slot);
        const canvas = document.getElementById('widgetCanvas' + slot);

        // Update header
        titleEl.innerHTML = `<i class="bi ${meta.icon} me-2"></i>${meta.title}`;
        subtitleEl.textContent = meta.subtitle;

        // Destroy old chart
        if (widgetInstances[slot]) {
            widgetInstances[slot].destroy();
            widgetInstances[slot] = null;
        }

        try {
            if (widgetType === 'severity_donut') {
                renderSeverityDonut(slot, lastStatsData);
            } else {
                const response = await fetchWithRetry(`/api/vulnerabilities/charts?chart=${widgetType}`, {}, 2, 500);
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const data = await response.json();
                renderChartWidget(slot, widgetType, data);
            }
        } catch (error) {
            console.error(`Error loading widget ${widgetType}:`, error);
            container.classList.add('d-none');
            noData.classList.remove('d-none');
        }
    }

    // Render severity donut (uses live stats data)
    function renderSeverityDonut(slot, stats) {
        const container = document.getElementById('widgetChartContainer' + slot);
        const noData = document.getElementById('widgetNoData' + slot);
        const canvas = document.getElementById('widgetCanvas' + slot);
        const colors = getChartColors();

        const zeroDay = (stats && stats.zero_day_matches) || 0;
        const critical = (stats && stats.critical_count) || 0;
        const high = (stats && stats.high_count) || 0;
        const medium = (stats && stats.medium_count) || 0;
        const total = zeroDay + critical + high + medium;

        if (total === 0) {
            container.classList.add('d-none');
            noData.classList.remove('d-none');
            return;
        }

        container.classList.remove('d-none');
        noData.classList.add('d-none');

        widgetInstances[slot] = new Chart(canvas.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['0-Day', 'Critical', 'High', 'Medium'],
                datasets: [{
                    data: [zeroDay, critical, high, medium],
                    backgroundColor: ['rgba(124, 58, 237, 0.75)', 'rgba(185, 28, 28, 0.75)', 'rgba(194, 65, 12, 0.75)', 'rgba(37, 99, 235, 0.75)'],
                    borderColor: colors.borderColor,
                    borderWidth: 2,
                    hoverOffset: 6
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: true, cutout: '60%',
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 10, font: { size: 10 }, color: colors.legendColor,
                        generateLabels: function(chart) {
                            return chart.data.labels.map((label, i) => ({
                                text: label + ' (' + chart.data.datasets[0].data[i] + ')',
                                fillStyle: chart.data.datasets[0].backgroundColor[i],
                                strokeStyle: chart.data.datasets[0].backgroundColor[i],
                                pointStyle: 'circle', hidden: false, index: i
                            }));
                        }
                    }},
                    tooltip: { backgroundColor: colors.tooltipBg, titleColor: '#fff', bodyColor: '#e5e7eb',
                        callbacks: { label: ctx => ctx.label + ': ' + ctx.parsed + ' (' + ((ctx.parsed / total) * 100).toFixed(1) + '%)' }
                    }
                }
            }
        });
    }

    // Generic chart renderer for API-driven widgets
    function renderChartWidget(slot, widgetType, data) {
        const container = document.getElementById('widgetChartContainer' + slot);
        const noData = document.getElementById('widgetNoData' + slot);
        const canvas = document.getElementById('widgetCanvas' + slot);
        const colors = getChartColors();

        const hasData = (data.labels && data.labels.length > 0) || (data.dates && data.dates.length > 0);
        if (!hasData) {
            container.classList.add('d-none');
            noData.classList.remove('d-none');
            return;
        }

        container.classList.remove('d-none');
        noData.classList.add('d-none');

        const ctx = canvas.getContext('2d');
        let chartConfig;

        switch (widgetType) {
            case 'top_vendors':
                chartConfig = {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Vulnerabilities',
                            data: data.values,
                            backgroundColor: data.labels.map((_, i) => {
                                const palette = ['#b91c1c', '#c2410c', '#2563eb', '#047857', '#6d47a8', '#9b4d7c', '#0d9488', '#a16207', '#4a8fa5', '#5a8a30'];
                                return palette[i % palette.length] + 'CC';
                            }),
                            borderRadius: 4,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                        plugins: {
                            legend: { display: false },
                            tooltip: { backgroundColor: colors.tooltipBg, titleColor: '#fff', bodyColor: '#e5e7eb' }
                        },
                        scales: {
                            x: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { font: { size: 10 }, color: colors.tickColor, precision: 0, callback: formatAxisValue } },
                            y: { grid: { display: false }, ticks: { font: { size: 9 }, color: colors.tickColor } }
                        }
                    }
                };
                break;

            case 'epss_distribution':
                chartConfig = {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'CVEs',
                            data: data.values,
                            backgroundColor: ['#047857CC', '#65a30dCC', '#d97706CC', '#c2410cCC', '#b91c1cCC', '#991b1bCC'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { backgroundColor: colors.tooltipBg, titleColor: '#fff', bodyColor: '#e5e7eb' }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { font: { size: 9 }, color: colors.tickColor } },
                            y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { font: { size: 10 }, color: colors.tickColor, precision: 0 } }
                        }
                    }
                };
                break;

            case 'age_distribution':
                chartConfig = {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'CVEs',
                            data: data.values,
                            backgroundColor: ['#b91c1cCC', '#c2410cCC', '#2563ebCC', '#6d47a8CC', '#6b7280CC', '#374151CC'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { backgroundColor: colors.tooltipBg, titleColor: '#fff', bodyColor: '#e5e7eb' }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { font: { size: 9 }, color: colors.tickColor } },
                            y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { font: { size: 10 }, color: colors.tickColor, precision: 0 } }
                        }
                    }
                };
                break;

            case 'vuln_timeline':
                chartConfig = {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'New CVEs',
                            data: data.values,
                            backgroundColor: '#3b82f6CC',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { backgroundColor: colors.tooltipBg, titleColor: '#fff', bodyColor: '#e5e7eb' }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { font: { size: 9 }, color: colors.tickColor, maxRotation: 45 } },
                            y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { font: { size: 10 }, color: colors.tickColor, precision: 0 } }
                        }
                    }
                };
                break;

            case 'remediation_rate':
                chartConfig = {
                    type: 'line',
                    data: {
                        labels: data.dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                        datasets: [
                            {
                                label: 'Acknowledged',
                                data: data.acknowledged,
                                borderColor: '#047857',
                                backgroundColor: 'rgba(4, 120, 87, 0.1)',
                                fill: true, tension: 0.3, pointRadius: 2, borderWidth: 2
                            },
                            {
                                label: 'Unacknowledged',
                                data: data.unacknowledged,
                                borderColor: '#b91c1c',
                                backgroundColor: 'rgba(185, 28, 28, 0.1)',
                                fill: true, tension: 0.3, pointRadius: 2, borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: { position: 'top', labels: { usePointStyle: true, padding: 12, font: { size: 10 }, color: colors.legendColor, boxWidth: 8 } },
                            tooltip: { backgroundColor: colors.tooltipBg, titleColor: '#fff', bodyColor: '#e5e7eb' }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { font: { size: 9 }, color: colors.tickColor, maxRotation: 45, autoSkip: true, maxTicksLimit: 10 } },
                            y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { font: { size: 10 }, color: colors.tickColor, precision: 0, callback: formatAxisValue } }
                        }
                    }
                };
                break;

            default:
                container.classList.add('d-none');
                noData.classList.remove('d-none');
                return;
        }

        widgetInstances[slot] = new Chart(ctx, chartConfig);
    }

    async function takeManualSnapshot() {
        try {
            const response = await fetch('/api/vulnerabilities/trends/snapshot', {
                method: 'POST'
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Failed to take snapshot');
            }

            showToast('Snapshot taken successfully!', 'success');
            loadAllWidgets();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        }
    }

    function applyClientFilters() {
        // Filter by zero-day
        if (zeroDayFilterActive) {
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const vuln = match.vulnerability;
                return vuln && vuln.is_zero_day;
            });
        }

        // Filter by priority
        const priorityFilter = document.getElementById('filterPriority').value;
        if (priorityFilter) {
            const priorityOrder = {'critical': 4, 'high': 3, 'medium': 2, 'low': 1};
            const minLevel = priorityOrder[priorityFilter];
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const effectivePriority = match.effective_priority;
                return priorityOrder[effectivePriority] >= minLevel;
            });
        }

        // Filter by CVE severity (from CVSS score)
        const severityFilter = document.getElementById('filterSeverity').value;
        if (severityFilter) {
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const vuln = match.vulnerability;
                return vuln.severity === severityFilter;
            });
        }

        // Filter by CISA urgency (based on due date)
        const urgencyFilter = document.getElementById('filterUrgency').value;
        if (urgencyFilter) {
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const vuln = match.vulnerability;

                // If urgency filter is active, CVEs MUST have a due date
                if (!vuln.due_date) {
                    return false;
                }

                // Calculate days until due
                const today = new Date();
                const dueDate = new Date(vuln.due_date);
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                switch(urgencyFilter) {
                    case 'critical':
                        // Critical: Due within 7 days OR ransomware
                        return daysUntilDue <= 7 || vuln.known_ransomware;
                    case 'high':
                        // High: Due within 30 days
                        return daysUntilDue <= 30;
                    case 'has_due_date':
                        // Any CVE with a due date
                        return true;
                    default:
                        return true;
                }
            });
        }

        // Filter by age
        const ageFilter = document.getElementById('filterAge').value;
        if (ageFilter) {
            const maxDays = parseInt(ageFilter);
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const daysOld = match.vulnerability.days_old || 0;
                return daysOld <= maxDays;
            });
        }

        // Filter by EPSS risk percentile
        const epssFilter = document.getElementById('filterEpss').value;
        if (epssFilter) {
            const thresholds = {'critical': 0.95, 'high': 0.85, 'medium': 0.70};
            const minPercentile = thresholds[epssFilter] || 0;
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const percentile = match.vulnerability.epss_percentile;
                return percentile != null && percentile >= minPercentile;
            });
        }
    }


    function toggleSelection(matchId, selected) {
        if (selected) {
            selectedVulns.add(matchId);
        } else {
            selectedVulns.delete(matchId);
            document.getElementById('selectAll').checked = false;
        }
        updateBulkActions();
    }

    // Toggle selection for V2 cards (each CVE card can have multiple match IDs)
    function toggleCveSelection(checkbox, matchIds) {
        if (checkbox.checked) {
            matchIds.forEach(id => selectedVulns.add(id));
        } else {
            matchIds.forEach(id => selectedVulns.delete(id));
            document.getElementById('selectAll').checked = false;
        }
        updateBulkActions();
    }

    function toggleSelectAll(checkbox) {
        // Handle old flat list cards
        const checkboxesV1 = document.querySelectorAll('.vuln-card input[type="checkbox"]');
        checkboxesV1.forEach(cb => {
            cb.checked = checkbox.checked;
            const matchId = parseInt(cb.value);
            if (checkbox.checked) {
                selectedVulns.add(matchId);
            } else {
                selectedVulns.delete(matchId);
            }
        });

        // Handle new grouped V2 cards
        const checkboxesV2 = document.querySelectorAll('.vuln-card-v2 input[type="checkbox"]');
        checkboxesV2.forEach(cb => {
            cb.checked = checkbox.checked;
            const card = cb.closest('.vuln-card-v2');
            if (card && card.dataset.matchIds) {
                try {
                    const matchIds = JSON.parse(card.dataset.matchIds);
                    if (checkbox.checked) {
                        matchIds.forEach(id => selectedVulns.add(id));
                    } else {
                        matchIds.forEach(id => selectedVulns.delete(id));
                    }
                } catch (e) { /* ignore parse errors */ }
            }
        });

        updateBulkActions();
    }

    function updateBulkActions() {
        const count = selectedVulns.size;
        const bulkActionsBar = document.getElementById('bulkActionsBar');
        const selectedCountEl = document.getElementById('selectedCount');
        const bulkAckBtnEl = document.getElementById('bulkAckBtn');
        const bulkUnackBtnEl = document.getElementById('bulkUnackBtn');
        const bulkExportBtnEl = document.getElementById('bulkExportBtn');
        const bulkSnoozeBtnEl = document.getElementById('bulkSnoozeBtn');

        // Show/hide bulk actions bar
        if (bulkActionsBar) {
            bulkActionsBar.style.display = count > 0 ? 'block' : 'none';
        }

        if (selectedCountEl) selectedCountEl.textContent = count;
        if (bulkAckBtnEl) bulkAckBtnEl.disabled = count === 0;
        if (bulkUnackBtnEl) bulkUnackBtnEl.disabled = count === 0;
        if (bulkExportBtnEl) bulkExportBtnEl.disabled = count === 0;
        if (bulkSnoozeBtnEl) bulkSnoozeBtnEl.disabled = count === 0;
    }

    function clearSelection() {
        selectedVulns.clear();
        // Clear both V1 and V2 card checkboxes
        document.querySelectorAll('.vuln-card input[type="checkbox"], .vuln-card-v2 input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        document.getElementById('selectAll').checked = false;
        updateBulkActions();
    }

    async function bulkAcknowledge() {
        if (selectedVulns.size === 0) return;

        const confirmed = await showConfirm(
            `Acknowledge ${selectedVulns.size} vulnerabilities?`,
            'Bulk Acknowledge',
            'Acknowledge',
            'btn-primary'
        );

        if (!confirmed) return;

        showLoading();
        let success = 0;
        let failed = 0;

        for (const matchId of selectedVulns) {
            try {
                await fetch(`/api/matches/${matchId}/acknowledge`, { method: 'POST' });
                success++;
            } catch {
                failed++;
            }
        }

        hideLoading();
        showToast(`Acknowledged ${success} vulnerabilities${failed > 0 ? `, ${failed} failed` : ''}`, success > 0 ? 'success' : 'danger');
        selectedVulns.clear();
        updateBulkActions();
        loadGroupedVulnerabilities();
        loadStats();

    }

    async function bulkUnacknowledge() {
        if (selectedVulns.size === 0) return;

        const confirmed = await showConfirm(
            `Unacknowledge ${selectedVulns.size} vulnerabilities?`,
            'Bulk Unacknowledge',
            'Unacknowledge',
            'btn-secondary'
        );

        if (!confirmed) return;

        showLoading();
        let success = 0;
        let failed = 0;

        for (const matchId of selectedVulns) {
            try {
                await fetch(`/api/matches/${matchId}/unacknowledge`, { method: 'POST' });
                success++;
            } catch {
                failed++;
            }
        }

        hideLoading();
        showToast(`Unacknowledged ${success} vulnerabilities${failed > 0 ? `, ${failed} failed` : ''}`, success > 0 ? 'info' : 'danger');
        selectedVulns.clear();
        updateBulkActions();
        loadGroupedVulnerabilities();
        loadStats();
    }

    async function bulkSnooze(hours) {
        if (selectedVulns.size === 0) return;

        const timeLabel = hours >= 168 ? '1 week' : hours >= 72 ? '3 days' : '24 hours';
        const confirmed = await showConfirm(
            `Snooze ${selectedVulns.size} vulnerabilities for ${timeLabel}?`,
            'Bulk Snooze',
            'Snooze',
            'btn-warning'
        );

        if (!confirmed) return;

        showLoading();
        let success = 0;
        let failed = 0;

        for (const matchId of selectedVulns) {
            try {
                const response = await fetch(`/api/matches/${matchId}/snooze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hours: hours })
                });
                if (response.ok) {
                    success++;
                } else {
                    failed++;
                }
            } catch {
                failed++;
            }
        }

        hideLoading();
        showToast(`Snoozed ${success} vulnerabilities for ${timeLabel}${failed > 0 ? `, ${failed} failed` : ''}`, success > 0 ? 'warning' : 'danger');
        selectedVulns.clear();
        updateBulkActions();
        loadGroupedVulnerabilities();
    }

    async function bulkExport() {
        if (selectedVulns.size === 0) return;

        showLoading();
        try {
            // Get match IDs as comma-separated list
            const matchIds = Array.from(selectedVulns).join(',');

            // Trigger PDF export with selected match IDs
            const response = await fetch(`/api/reports/export?match_ids=${matchIds}`);

            if (!response.ok) {
                throw new Error('Export failed');
            }

            // Download the PDF
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vulnerabilities_selected_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

            showToast(`Exported ${selectedVulns.size} vulnerabilities to PDF`, 'success');
        } catch (error) {
            showToast(`Export failed: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function acknowledgeMatch(matchId) {
        try {
            await fetch(`/api/matches/${matchId}/acknowledge`, { method: 'POST' });
            showToast('✓ Vulnerability acknowledged', 'success');
            loadGroupedVulnerabilities();
            loadStats();
        } catch (error) {
            showToast(`✗ Error: ${error.message}`, 'danger');
        }
    }

    async function unacknowledgeMatch(matchId) {
        try {
            await fetch(`/api/matches/${matchId}/unacknowledge`, { method: 'POST' });
            showToast('Vulnerability unacknowledged', 'info');
            loadGroupedVulnerabilities();
            loadStats();
        } catch (error) {
            showToast(`✗ Error: ${error.message}`, 'danger');
        }
    }

    async function snoozeMatch(matchId, hours) {
        try {
            const response = await fetch(`/api/matches/${matchId}/snooze`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hours: hours })
            });
            if (!response.ok) throw new Error('Failed to snooze');
            const data = await response.json();
            const snoozeUntil = new Date(data.snoozed_until);
            showToast(`✓ Snoozed until ${snoozeUntil.toLocaleString()}`, 'warning');
            loadGroupedVulnerabilities();
        } catch (error) {
            showToast(`✗ Error: ${error.message}`, 'danger');
        }
    }

    async function loadLastSync() {
        try {
            const response = await fetch('/api/sync/status');
            const sync = await response.json();

            if (sync.sync_date) {
                const date = new Date(sync.sync_date);
                const statusBadge = sync.status === 'success' ?
                    '<span class="badge bg-success">Success</span>' :
                    '<span class="badge bg-danger">Failed</span>';
                document.getElementById('lastSync').innerHTML = `
                    ${date.toLocaleString()} ${statusBadge} |
                    ${sync.matches_found || 0} matches found in ${(sync.duration_seconds || 0).toFixed(2)}s
                `;
            }
        } catch (error) {
            console.error('Error loading sync status:', error);
        }
    }

    async function viewSyncHistory() {
        try {
            const response = await fetch('/api/sync/history?limit=20');
            const history = await response.json();

            const tbody = document.getElementById('syncHistoryTable');
            tbody.innerHTML = history.map(sync => {
                const date = new Date(sync.sync_date);
                const statusBadge = sync.status === 'success' ?
                    '<span class="badge bg-success">Success</span>' :
                    '<span class="badge bg-danger">Failed</span>';

                return `
                    <tr>
                        <td>${date.toLocaleString()}</td>
                        <td>${statusBadge}</td>
                        <td>${sync.vulnerabilities_count || 0}</td>
                        <td>${sync.matches_found || 0}</td>
                        <td>${(sync.duration_seconds || 0).toFixed(2)}s</td>
                    </tr>
                `;
            }).join('');

            bootstrap.Modal.getOrCreateInstance(document.getElementById('syncHistoryModal')).show();
        } catch (error) {
            showToast('Failed to load sync history', 'danger');
        }
    }

    function resetFilters() {
        zeroDayFilterActive = false;
        document.getElementById('filterPriority').value = '';
        document.getElementById('filterSeverity').value = '';
        document.getElementById('filterUrgency').value = '';
        document.getElementById('filterAge').value = '';
        document.getElementById('filterCVE').value = '';
        document.getElementById('filterVendor').value = '';
        document.getElementById('filterProduct').value = '';
        document.getElementById('filterPlatform').value = '';
        document.getElementById('filterRansomware').checked = false;
        document.getElementById('filterUnack').checked = false;
        document.getElementById('filterEpss').value = '';
        document.getElementById('sortBy').value = 'priority-asc';
        document.querySelectorAll('.alert-card').forEach(card => card.classList.remove('active-filter'));
        currentPage = 1;  // Reset pagination
        loadGroupedVulnerabilities();
    }

    function exportData(format) {
        const data = currentVulnerabilities.map(match => ({
            priority: match.effective_priority,
            cve_id: match.vulnerability.cve_id,
            vulnerability_name: match.vulnerability.vulnerability_name,
            vendor_project: match.vulnerability.vendor_project,
            product: match.vulnerability.product,
            date_added: match.vulnerability.date_added,
            days_old: match.vulnerability.days_old,
            due_date: match.vulnerability.due_date,
            description: match.vulnerability.short_description,
            required_action: match.vulnerability.required_action,
            ransomware: match.vulnerability.known_ransomware,
            your_product: `${match.product.vendor} - ${match.product.product_name}`,
            acknowledged: match.acknowledged,
            match_reason: match.match_reason
        }));

        if (format === 'json') {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            downloadFile(blob, `sentrikat-vulnerabilities-${new Date().toISOString().split('T')[0]}.json`);
        } else if (format === 'csv') {
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            downloadFile(blob, `sentrikat-vulnerabilities-${new Date().toISOString().split('T')[0]}.csv`);
        }
        showToast(`✓ Exported ${data.length} vulnerabilities as ${format.toUpperCase()}`, 'success');
    }

    function convertToCSV(data) {
        if (data.length === 0) return '';
        const headers = Object.keys(data[0]).join(',');
        const rows = data.map(row =>
            Object.values(row).map(val =>
                `"${String(val).replace(/"/g, '""')}"`
            ).join(',')
        );
        return [headers, ...rows].join('\n');
    }

    function downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check for shared CVE in URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const sharedCVE = urlParams.get('cve');

        if (sharedCVE) {
            // Auto-fill CVE filter and apply
            document.getElementById('filterCVE').value = sharedCVE;
        }

        // Check if Jira integration is enabled
        loadJiraEnabled();

        // Always use grouped view by default
        loadGroupedVulnerabilities();
        loadStats();
        loadLastSync();

        // Auto-refresh stats every 5 minutes
        setInterval(loadStats, 300000);
    });

    // Initialize issue tracker state (supports multiple simultaneous trackers)
    window.jiraEnabled = false;  // Legacy - kept for backward compat
    window.issueTrackerType = 'disabled';
    window.issueTrackerName = '';
    window.enabledTrackers = [];  // Array of {type, name, icon}

    async function loadJiraEnabled() {
        try {
            const response = await fetch('/api/integrations/issue-tracker/config');
            if (response.ok) {
                const config = await response.json();
                window.issueTrackerType = config.type || 'disabled';
                window.jiraEnabled = config.enabled;

                // Multi-tracker: store all enabled trackers
                window.enabledTrackers = config.trackers || [];

                // Legacy single-tracker name (first enabled)
                if (window.enabledTrackers.length > 0) {
                    window.issueTrackerName = window.enabledTrackers[0].name;
                }
            }
        } catch (error) {
            console.warn('Could not load issue tracker settings:', error);
        }
    }

    // Build issue tracker buttons HTML for a vulnerability
    function getTrackerButtonsHtml(vulnId, productId, cveId, vulnName) {
        if (!window.enabledTrackers || window.enabledTrackers.length === 0) return '';
        return window.enabledTrackers.map(tracker => {
            const safeName = escapeHtml(vulnName);
            const safeType = escapeHtml(tracker.type);
            const safeCveId = escapeHtml(cveId);
            return `<button class="btn btn-sm btn-outline-secondary" onclick="createTrackerIssue(${parseInt(vulnId)}, ${productId ? parseInt(productId) : 'null'}, '${safeCveId}', '${safeName.replace(/'/g, "\\'")}', '${safeType}')" title="Create ${escapeHtml(tracker.name)} Issue">
                <i class="bi ${escapeHtml(tracker.icon)}"></i> ${escapeHtml(tracker.name)}
            </button>`;
        }).join('\n');
    }

    // Create issue on a specific tracker
    async function createTrackerIssue(vulnId, productId, cveId, vulnName, trackerType) {
        const tracker = window.enabledTrackers.find(t => t.type === trackerType);
        const trackerName = tracker ? tracker.name : 'Issue';

        const confirmed = await showConfirm(
            `Create a ${trackerName} issue for ${cveId}?\n\n"${vulnName}"`,
            `Create ${trackerName} Issue`,
            'Create Issue',
            'btn-primary'
        );

        if (!confirmed) return;

        try {
            showLoading();
            const response = await fetch('/api/integrations/issue-tracker/create-issue', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    vulnerability_id: vulnId,
                    product_id: productId,
                    tracker_type: trackerType
                })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                const issueId = result.issue_key || 'Issue';
                const toastOpts = result.issue_url ? { actionUrl: result.issue_url, actionText: issueId } : {};
                showToast(`${escapeHtml(trackerName)} issue created:`, 'success', 8000, toastOpts);
            } else {
                showToast(`Failed to create issue: ${escapeHtml(result.error || result.message)}`, 'danger');
            }
        } catch (error) {
            showToast(`Error creating issue: ${escapeHtml(error.message)}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    // Legacy wrapper for backward compatibility
    function createJiraIssue(vulnId, productId, cveId, vulnName) {
        if (!window.jiraEnabled) {
            showToast('Issue tracker not configured. Go to Admin Panel > Integrations > Issue Trackers.', 'warning');
            return;
        }
        // Use first enabled tracker if no specific type
        const trackerType = window.enabledTrackers.length > 0 ? window.enabledTrackers[0].type : null;
        createTrackerIssue(vulnId, productId, cveId, vulnName, trackerType);
    }

    // Handle Enter key in filter inputs - trigger reload on Enter (reset to page 1)
    document.querySelectorAll('#filterCVE, #filterVendor, #filterProduct').forEach(input => {
        input.addEventListener('change', resetAndLoadVulnerabilities);  // Also trigger on blur/change
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                resetAndLoadVulnerabilities();
            }
        });
    });

    // Reset pagination and load - used when filters change
    function resetAndLoadVulnerabilities() {
        currentPage = 1;
        loadGroupedVulnerabilities();
    }

    // Filter by effective priority when clicking priority alert cards
    function filterBySeverity(severity) {
        const priorityFilter = document.getElementById('filterPriority');
        const priorityValue = severity.toLowerCase();  // API expects lowercase
        // Toggle: if already filtering by this priority, clear it
        if (priorityFilter.value === priorityValue) {
            priorityFilter.value = '';
        } else {
            priorityFilter.value = priorityValue;
        }
        // Clear zero-day filter and severity filter to avoid conflict
        zeroDayFilterActive = false;
        document.getElementById('filterSeverity').value = '';
        // Highlight active card
        document.querySelectorAll('.alert-card').forEach(card => card.classList.remove('active-filter'));
        if (priorityFilter.value) {
            const cardClass = 'alert-card-' + priorityValue;
            const activeCard = document.querySelector('.' + cardClass);
            if (activeCard) activeCard.classList.add('active-filter');
        }
        // Scroll to vulnerability list
        document.getElementById('vulnerabilitiesContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        resetAndLoadVulnerabilities();
    }

    function filterByZeroDay() {
        // Toggle zero-day filter
        zeroDayFilterActive = !zeroDayFilterActive;
        // Clear priority filter to avoid conflict
        document.getElementById('filterPriority').value = '';
        document.getElementById('filterSeverity').value = '';
        // Highlight active card
        document.querySelectorAll('.alert-card').forEach(card => card.classList.remove('active-filter'));
        if (zeroDayFilterActive) {
            const zdCard = document.querySelector('.alert-card-zeroday');
            if (zdCard) zdCard.classList.add('active-filter');
        }
        // Scroll to vulnerability list
        document.getElementById('vulnerabilitiesContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        resetAndLoadVulnerabilities();
    }

    // Handle filter changes - use grouped view (reset to page 1)
    document.getElementById('filterPriority').addEventListener('change', function() {
        // Sync card highlight with dropdown
        document.querySelectorAll('.alert-card').forEach(card => card.classList.remove('active-filter'));
        if (this.value) {
            const activeCard = document.querySelector('.alert-card-' + this.value);
            if (activeCard) activeCard.classList.add('active-filter');
        }
        resetAndLoadVulnerabilities();
    });
    document.getElementById('filterSeverity').addEventListener('change', resetAndLoadVulnerabilities);
    document.getElementById('filterUrgency').addEventListener('change', resetAndLoadVulnerabilities);
    document.getElementById('filterAge').addEventListener('change', resetAndLoadVulnerabilities);
    document.getElementById('filterPlatform').addEventListener('change', resetAndLoadVulnerabilities);
    document.getElementById('filterEpss').addEventListener('change', resetAndLoadVulnerabilities);

    // ============================================================================
    // Shared Filtered Views
    // ============================================================================

    /**
     * Get current filter state
     */
    function getCurrentFilters() {
        return {
            priority: document.getElementById('filterPriority').value,
            zero_day: zeroDayFilterActive,
            severity: document.getElementById('filterSeverity').value,
            urgency: document.getElementById('filterUrgency').value,
            age: document.getElementById('filterAge').value,
            cve: document.getElementById('filterCVE').value,
            vendor: document.getElementById('filterVendor').value,
            product: document.getElementById('filterProduct').value,
            platform: document.getElementById('filterPlatform').value,
            ransomware: document.getElementById('filterRansomware').checked,
            unack: document.getElementById('filterUnack').checked
        };
    }

    /**
     * Show share modal with current filters
     */
    function shareFilteredView() {
        const filters = getCurrentFilters();

        // Build summary of active filters
        let summary = [];
        if (filters.priority) summary.push(`Priority: ${filters.priority}`);
        if (filters.severity) summary.push(`Severity: ${filters.severity}`);
        if (filters.urgency) summary.push(`Urgency: ${filters.urgency}`);
        if (filters.age) summary.push(`Age: ${filters.age}`);
        if (filters.cve) summary.push(`CVE: ${filters.cve}`);
        if (filters.vendor) summary.push(`Vendor: ${filters.vendor}`);
        if (filters.product) summary.push(`Product: ${filters.product}`);
        if (filters.ransomware) summary.push('Ransomware vulnerabilities only');
        if (filters.unack) summary.push('Unacknowledged only');

        if (summary.length === 0) {
            summary.push('No filters applied (all vulnerabilities)');
        }

        document.getElementById('shareFiltersSummary').innerHTML = summary.map(s => `• ${s}`).join('<br>');

        // Reset modal state
        document.getElementById('shareName').value = '';
        document.getElementById('shareDescription').value = '';
        document.getElementById('shareExpiration').value = '30';
        document.getElementById('shareResult').style.display = 'none';
        document.getElementById('createShareBtn').style.display = 'block';

        // Show modal
        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('shareModal'));
        modal.show();
    }

    /**
     * Create share link via API
     */
    async function createShareLink() {
        const btn = document.getElementById('createShareBtn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';

        try {
            const filters = getCurrentFilters();
            const name = document.getElementById('shareName').value;
            const description = document.getElementById('shareDescription').value;
            const expiresDays = document.getElementById('shareExpiration').value;

            const response = await fetch('/api/shared/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name || null,
                    description: description || null,
                    filters: filters,
                    is_public: true,
                    expires_days: expiresDays ? parseInt(expiresDays) : null
                })
            });

            if (response.ok) {
                const result = await response.json();
                document.getElementById('shareUrl').value = result.share_url;
                document.getElementById('shareResult').style.display = 'block';
                btn.style.display = 'none';
            } else {
                const error = await response.json();
                showToast(`Error creating share link: ${error.error}`, 'danger');
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        } catch (error) {
            console.error('Error creating share link:', error);
            showToast('Error creating share link. Please try again.', 'danger');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    /**
     * Copy share URL to clipboard
     */
    function copyShareUrl() {
        const input = document.getElementById('shareUrl');
        input.select();
        document.execCommand('copy');

        // Show feedback
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        setTimeout(() => {
            btn.innerHTML = originalHtml;
        }, 2000);
    }

    /**
     * Share a single CVE with NVD link - copies to clipboard automatically
     */
    async function shareSingleCVE(cveId, vulnName) {
        const nvdUrl = `https://nvd.nist.gov/vuln/detail/${encodeURIComponent(cveId)}`;

        try {
            // Try modern clipboard API first
            await navigator.clipboard.writeText(nvdUrl);
            showToast(`NVD link copied to clipboard`, 'success');
        } catch (error) {
            // Fallback for older browsers or non-HTTPS
            const textArea = document.createElement('textarea');
            textArea.value = nvdUrl;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast(`NVD link copied to clipboard`, 'success');
            } catch (e) {
                showToast(`Could not copy. URL: ${nvdUrl}`, 'warning');
            }
            document.body.removeChild(textArea);
        }
    }

    /**
     * Load shared view if share_token is present
     */
    function dismissUnmappedWarning() {
        const warning = document.getElementById('unmappedWarning');
        if (warning) warning.classList.add('d-none');
        const count = document.getElementById('unmappedCount')?.textContent || '0';
        localStorage.setItem('unmappedWarningDismissed', Date.now().toString());
        localStorage.setItem('unmappedWarningDismissedCount', count);
    }

    let _cpeApplyPollTimer = null;

    async function autoFixCpe() {
        const btn = document.getElementById('autoFixCpeBtn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Starting...';
        }
        try {
            const response = await fetch('/api/products/apply-cpe', { method: 'POST' });
            if (!response.ok && response.status !== 202) throw new Error(`Server error: ${response.status}`);
            const data = await response.json();
            if (data.status === 'started') {
                showToast('CPE auto-detection started in background...', 'info');
                // Start polling for status
                _pollCpeApplyStatus();
                return;
            } else if (data.updated > 0) {
                showToast(`CPE mapped for ${data.updated} products. Coverage: ${data.coverage?.coverage_percent || '?'}%`, 'success');
                loadStats();
            } else {
                showToast('No additional CPE mappings could be auto-detected. These products may need manual mapping.', 'info');
            }
        } catch (error) {
            showToast(`Error: ${escapeHtml(error.message)}`, 'danger');
        } finally {
            if (btn && !btn.disabled) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-magic me-1"></i>Auto-Detect CPE';
            }
        }
    }

    async function _pollCpeApplyStatus() {
        const btn = document.getElementById('autoFixCpeBtn');
        try {
            const resp = await fetch('/api/products/cpe-apply-status');
            if (!resp.ok) return;
            const data = await resp.json();

            if (data.status === 'downloading') {
                if (btn) btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Downloading CPE dictionary...';
                _cpeApplyPollTimer = setTimeout(_pollCpeApplyStatus, 5000);
            } else if (data.status === 'mapping') {
                if (btn) btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Mapping products...';
                _cpeApplyPollTimer = setTimeout(_pollCpeApplyStatus, 5000);
            } else if (data.status === 'complete') {
                showToast(data.message || 'CPE auto-detection complete!', 'success');
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-magic me-1"></i>Auto-Detect CPE'; }
                loadStats();
            } else if (data.status === 'error') {
                showToast('CPE auto-detection failed: ' + (data.message || 'Unknown error'), 'danger');
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-magic me-1"></i>Auto-Detect CPE'; }
            } else {
                // started or unknown - keep polling
                _cpeApplyPollTimer = setTimeout(_pollCpeApplyStatus, 5000);
            }
        } catch (e) {
            // Network error - retry
            _cpeApplyPollTimer = setTimeout(_pollCpeApplyStatus, 10000);
        }
    }

    async function loadSharedView() {
        const shareToken = '{{ share_token | default("") }}';
        if (!shareToken) return;

        try {
            const response = await fetch(`/api/shared/view/${shareToken}`);
            if (response.ok) {
                const result = await response.json();
                const filters = result.shared_view.filters;

                // Apply filters to form
                if (filters.priority) document.getElementById('filterPriority').value = filters.priority;
                if (filters.zero_day) { zeroDayFilterActive = true; document.querySelector('.alert-card-zeroday')?.classList.add('active-filter'); }
                if (filters.severity) document.getElementById('filterSeverity').value = filters.severity;
                if (filters.urgency) document.getElementById('filterUrgency').value = filters.urgency;
                if (filters.age) document.getElementById('filterAge').value = filters.age;
                if (filters.cve) document.getElementById('filterCVE').value = filters.cve || '';
                if (filters.vendor) document.getElementById('filterVendor').value = filters.vendor || '';
                if (filters.product) document.getElementById('filterProduct').value = filters.product || '';
                document.getElementById('filterRansomware').checked = filters.ransomware || false;
                document.getElementById('filterUnack').checked = filters.unack || false;

                // Show notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-info alert-dismissible fade show';
                notification.innerHTML = `
                    <i class="bi bi-share me-2"></i>
                    <strong>Viewing shared filtered view:</strong> ${result.shared_view.name || 'Untitled'}
                    ${result.shared_view.description ? `<br><small>${result.shared_view.description}</small>` : ''}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                const fadeInContainer = document.querySelector('.fade-in');
                if (fadeInContainer) {
                    fadeInContainer.insertBefore(notification, fadeInContainer.firstChild);
                }

                // Load vulnerabilities with these filters
                loadGroupedVulnerabilities();
            } else if (response.status === 410) {
                showToast('This shared link has expired.', 'warning');
            } else {
                const error = await response.json();
                showToast(`Error loading shared view: ${error.error}`, 'danger');
            }
        } catch (error) {
            console.error('Error loading shared view:', error);
        }
    }

    // Load shared view on page load if token present
    loadSharedView();

    // Load grouped vulnerabilities from API
    async function loadGroupedVulnerabilities() {
        showLoading();
        const container = document.getElementById('vulnerabilitiesContainer');
        selectedVulns.clear();
        updateBulkActions();

        try {
            const params = new URLSearchParams();
            const cve = document.getElementById('filterCVE').value;
            const ransomware = document.getElementById('filterRansomware').checked;
            const unack = document.getElementById('filterUnack').checked;
            const priority = document.getElementById('filterPriority').value;
            const severity = document.getElementById('filterSeverity').value;
            const urgency = document.getElementById('filterUrgency').value;
            const age = document.getElementById('filterAge').value;
            const vendor = document.getElementById('filterVendor').value;
            const product = document.getElementById('filterProduct').value;
            const platform = document.getElementById('filterPlatform').value;

            if (cve) params.append('search', cve);
            if (ransomware) params.append('ransomware_only', 'true');
            if (unack) params.append('acknowledged', 'false');
            if (priority) params.append('priority', priority);
            if (zeroDayFilterActive) params.append('zero_day', 'true');
            if (severity) params.append('severity', severity);
            if (urgency) params.append('urgency', urgency);
            if (age) params.append('age', age);
            if (vendor) params.append('vendor', vendor);
            if (product) params.append('product', product);
            if (platform) params.append('platform', platform);
            if (dashboardSourceFilter === 'containers') {
                params.append('source_type', 'container');
            } else if (dashboardSourceFilter === 'dependencies') {
                params.append('source_type', 'code_library');
                params.append('include_extensions', 'true');
            } else if (dashboardSourceFilter) {
                params.append('source_key_type', dashboardSourceFilter);
            }
            params.append('page', currentPage);
            params.append('per_page', pageSize === Infinity ? 100 : pageSize);

            const response = await fetchWithRetry(`/api/vulnerabilities/grouped?${params}`, {}, 3, 1000);

            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();
            currentGroupedVulnerabilities = data.items;

            document.getElementById('vulnCount').textContent = data.total;
            renderGroupedPage(data);
        } catch (error) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Error loading vulnerabilities: ${escapeHtml(error.message)}
                </div>
            `;
        } finally {
            hideLoading();
        }
    }

    function renderGroupedPage(data) {
        const container = document.getElementById('vulnerabilitiesContainer');

        if (data.items.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-shield-check text-success" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">No Vulnerabilities Found</h4>
                    <p class="text-muted">No matches found with the current filter criteria.</p>
                </div>
            `;
            // Hide both pagination controls
            ['paginationControlsTop', 'paginationControlsBottom'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            return;
        }

        container.innerHTML = data.items.map(group => createGroupedCVECard(group)).join('');

        // Update pagination (use shared function with grouped page function)
        const start = (data.page - 1) * data.per_page + 1;
        const end = Math.min(data.page * data.per_page, data.total);
        currentPage = data.page;  // Sync currentPage for the shared function
        updatePaginationControls(data.pages, data.total, start - 1, end, 'goToGroupedPage');
    }

    function goToGroupedPage(page) {
        currentPage = page;
        loadGroupedVulnerabilities();
        document.getElementById('vulnerabilitiesContainer').scrollIntoView({ behavior: 'smooth' });
    }

    function createGroupedCVECard(group) {
        const vuln = group.vulnerability;
        const priority = group.highest_priority;
        const cardId = vuln.cve_id.replace(/[^a-zA-Z0-9]/g, '');

        // Calculate due date urgency
        let dueUrgency = '';
        let dueUrgencyClass = '';
        if (vuln.due_date) {
            const dueDate = new Date(vuln.due_date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                dueUrgency = `OVERDUE by ${Math.abs(diffDays)} days`;
                dueUrgencyClass = 'bg-danger text-white';
            } else if (diffDays === 0) {
                dueUrgency = 'DUE TODAY';
                dueUrgencyClass = 'bg-danger text-white';
            } else if (diffDays <= 7) {
                dueUrgency = `Due in ${diffDays} days`;
                dueUrgencyClass = 'bg-warning text-dark';
            } else if (diffDays <= 30) {
                dueUrgency = `Due in ${diffDays} days`;
                dueUrgencyClass = 'bg-info text-white';
            } else {
                dueUrgency = `Due: ${formatDate(vuln.due_date)}`;
                dueUrgencyClass = 'bg-secondary text-white';
            }
        }

        // Risk header color and icon based on priority
        const riskConfig = {
            'critical': { bg: 'bg-danger', icon: 'bi-exclamation-triangle-fill', label: 'CRITICAL RISK' },
            'high': { bg: 'bg-warning', icon: 'bi-exclamation-diamond-fill', label: 'HIGH RISK', textClass: 'text-dark' },
            'medium': { bg: 'bg-info', icon: 'bi-info-circle-fill', label: 'MEDIUM RISK' },
            'low': { bg: 'bg-success', icon: 'bi-shield-check', label: 'LOW RISK' }
        };
        const risk = riskConfig[priority] || riskConfig['medium'];

        // CVSS Score visualization
        const cvssScore = vuln.cvss_score || 0;
        const cvssPercent = (cvssScore / 10) * 100;
        const cvssColor = cvssScore >= 9 ? '#dc2626' : cvssScore >= 7 ? '#ea580c' : cvssScore >= 4 ? '#eab308' : '#22c55e';

        // EPSS visualization
        const epssScore = vuln.epss_score;
        const epssPercent = epssScore ? (epssScore * 100) : null;
        const epssPercentile = vuln.epss_percentile;
        const epssRank = epssPercentile ? Math.round((1 - epssPercentile) * 100) : null;
        const epssColor = epssPercentile >= 0.95 ? '#dc2626' : epssPercentile >= 0.85 ? '#ea580c' : epssPercentile >= 0.70 ? '#3b82f6' : '#22c55e';

        // Build fix version info from CVE CPE data - compact inline badges
        const fixVersions = vuln.fix_versions || [];
        let fixVersionHtml = '';
        if (fixVersions.length > 0) {
            const fixBadges = fixVersions.slice(0, 4).map(fv => {
                const fixLabel = fv.fix_type === 'excluding' ? escapeHtml(fv.fix_version) : `> ${escapeHtml(fv.fix_version)}`;
                return `<span class="badge bg-success me-1 mb-1" title="${escapeHtml(fv.vendor)} ${escapeHtml(fv.product)}: upgrade to ${escapeHtml(fv.fix_version)}"><i class="bi bi-arrow-up-circle me-1"></i>${escapeHtml(fv.product)} ${fixLabel}</span>`;
            }).join('');
            const moreCount = fixVersions.length > 4 ? `<span class="badge bg-secondary mb-1">+${fixVersions.length - 4} more</span>` : '';
            fixVersionHtml = `
                <div class="mb-2">
                    <small class="text-muted fw-semibold me-2">FIX:</small>${fixBadges}${moreCount}
                </div>`;
        } else if (vuln.has_cpe_data) {
            fixVersionHtml = `
                <div class="mb-2">
                    <small class="text-muted fw-semibold me-2">FIX:</small>
                    <span class="badge bg-secondary"><i class="bi bi-info-circle me-1"></i>Check vendor advisory</span>
                    <a href="https://nvd.nist.gov/vuln/detail/${encodeURIComponent(vuln.cve_id)}" target="_blank" class="badge bg-light text-dark text-decoration-none border ms-1"><i class="bi bi-box-arrow-up-right me-1"></i>NVD</a>
                </div>`;
        }

        // Build affected products list with assets
        const productsHtml = group.affected_products.map(prod => {
            // Three-tier confidence: red (affected) / green (verified) / amber (likely resolved)
            let ackIcon, statusText;
            if (prod.resolution_reason === 'vendor_fix' && prod.vendor_fix_confidence === 'medium' && !prod.acknowledged) {
                // AMBER: medium confidence vendor fix - needs verification
                ackIcon = '<i class="bi bi-shield-exclamation" style="color: #d97706; font-size: 1.1em;"></i>';
                statusText = 'Likely Resolved - Verify';
            } else if (prod.resolution_reason === 'vendor_fix' && prod.vendor_fix_confidence === 'high' && prod.acknowledged) {
                // GREEN: high confidence vendor fix - verified
                ackIcon = '<i class="bi bi-shield-fill-check text-success" style="font-size: 1.1em;"></i>';
                statusText = 'Resolved - Vendor Patched';
            } else if (prod.acknowledged) {
                ackIcon = '<i class="bi bi-check-circle-fill text-success"></i>';
                statusText = 'Resolved';
            } else {
                // RED: no vendor fix info - actively affected
                ackIcon = '<i class="bi bi-exclamation-circle-fill text-danger"></i>';
                statusText = 'Affected';
            }

            // Show product version
            const versionBadge = prod.version ? `<span class="badge bg-secondary ms-1">v${escapeHtml(prod.version)}</span>` : '';

            // Find matching fix version for this product
            let fixBadge = '';
            if (fixVersions.length > 0) {
                const matchingFix = fixVersions.find(fv =>
                    fv.vendor.toLowerCase() === (prod.vendor || '').toLowerCase() &&
                    fv.product.toLowerCase() === (prod.product_name || '').toLowerCase()
                ) || fixVersions[0];  // fallback to first fix version
                if (matchingFix) {
                    const fixLabel = matchingFix.fix_type === 'excluding'
                        ? escapeHtml(matchingFix.fix_version)
                        : `> ${escapeHtml(matchingFix.fix_version)}`;
                    fixBadge = `<span class="badge bg-success ms-1" title="Fix version"><i class="bi bi-arrow-up-circle me-1"></i>${fixLabel}</span>`;
                }
            }

            // Build assets list for this product with OS type icons
            const assetsCount = prod.affected_assets_count || 0;
            const assetsList = (prod.affected_assets || []).map(a => {
                const osIcon = getAssetOsIcon(a.type);
                return `<span class="badge bg-secondary me-1 mb-1" title="${escapeHtml(a.ip || 'No IP')} (${escapeHtml(a.type || 'unknown')})">
                    <i class="bi ${osIcon} me-1"></i>${escapeHtml(a.hostname)}</span>`;
            }).join('');
            const moreAssets = assetsCount > 10 ? `<span class="badge bg-light text-dark">+${assetsCount - 10} more</span>` : '';

            return `
                <div class="py-2 border-bottom">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            ${ackIcon}
                            <div class="ms-2">
                                <div class="fw-semibold">${escapeHtml(prod.vendor)} ${escapeHtml(prod.product_name)} ${versionBadge} ${fixBadge}</div>
                                <small class="text-muted">${statusText}</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            ${assetsCount > 0 ? `<span class="badge bg-info text-dark" title="Affected endpoints"><i class="bi bi-hdd-network me-1"></i>${assetsCount} endpoint${assetsCount > 1 ? 's' : ''}</span>` : ''}
                            ${prod.resolution_reason === 'vendor_fix' && prod.vendor_fix_confidence === 'medium' && !prod.acknowledged
                                ? `<span class="badge" style="background-color: #d97706; color: white;" title="Vendor fix detected but needs manual verification"><i class="bi bi-shield-exclamation"></i> Verify Fix</span>
                                   <button class="btn btn-sm btn-success" onclick="acknowledgeMatch(${prod.match_id})" title="Confirm fix applied">
                                       <i class="bi bi-check-lg"></i>
                                   </button>`
                                : !prod.acknowledged
                                    ? `<button class="btn btn-sm btn-success" onclick="acknowledgeMatch(${prod.match_id})" title="Mark as resolved">
                                           <i class="bi bi-check-lg"></i>
                                       </button>`
                                    : `${prod.resolution_reason === 'vendor_fix'
                                        ? '<span class="badge bg-success" title="Verified: vendor patch confirmed via distro-native comparison"><i class="bi bi-shield-fill-check"></i> Verified Fix</span>'
                                        : ''}
                                       <button class="btn btn-sm btn-outline-secondary" onclick="unacknowledgeMatch(${prod.match_id})" title="Reopen">
                                           <i class="bi bi-arrow-counterclockwise"></i>
                                       </button>`
                            }
                        </div>
                    </div>
                    ${assetsCount > 0 ? `<div class="mt-2 ms-4">${assetsList}${moreAssets}</div>` : ''}
                </div>
            `;
        }).join('');

        // Get all match IDs for this CVE group (for bulk selection)
        const matchIds = group.affected_products.map(p => p.match_id);
        const matchIdsJson = JSON.stringify(matchIds);

        // Issue tracker buttons (one per enabled tracker)
        const trackerBtn = getTrackerButtonsHtml(vuln.id, null, vuln.cve_id, vuln.vulnerability_name);

        return `
            <div class="card vuln-card-v2 mb-4 shadow-sm overflow-hidden" data-match-ids='${matchIdsJson}'>
                <!-- Risk Header -->
                <div class="${risk.bg} ${risk.textClass || 'text-white'} px-3 py-2 d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <input class="form-check-input me-2" type="checkbox"
                               onchange="toggleCveSelection(this, ${matchIdsJson})"
                               style="width: 1.2em; height: 1.2em;">
                        <i class="bi ${risk.icon} me-2 fs-5"></i>
                        <span class="fw-bold">${risk.label}</span>
                        ${vuln.known_ransomware ? '<span class="badge bg-dark ms-2"><i class="bi bi-shield-lock-fill"></i> RANSOMWARE</span>' : ''}
                    </div>
                    ${dueUrgency ? `<span class="badge ${dueUrgencyClass}"><i class="bi bi-clock"></i> ${dueUrgency}</span>` : ''}
                </div>

                <div class="card-body py-2 px-3">
                    <!-- CVE Title (always visible) -->
                    <div class="d-flex align-items-start justify-content-between mb-2">
                        <div>
                            <a href="https://nvd.nist.gov/vuln/detail/${encodeURIComponent(vuln.cve_id)}" target="_blank" class="text-decoration-none">
                                <span class="badge bg-dark fs-6 me-1">${escapeHtml(vuln.cve_id)}</span>
                            </a>
                            <span class="badge bg-secondary" style="font-size: 0.7rem;"><i class="bi bi-calendar3"></i> ${formatDate(vuln.date_added)}</span>
                            ${vuln.is_zero_day ? '<span class="badge" style="background: linear-gradient(135deg, #6d47a8, #9b4d7c); color: white; font-size: 0.7rem;" title="Zero-day: detected by SentriKat before CISA KEV publication"><i class="bi bi-lightning-fill me-1"></i>0-DAY</span>' : ''}
                            ${vuln.nvd_data_incomplete ? `<span class="badge bg-warning text-dark" style="font-size: 0.7rem;" title="NVD status: ${escapeHtml(vuln.nvd_status || 'Unknown')} — CPE data may be incomplete"><i class="bi bi-hourglass-split me-1"></i>${escapeHtml(vuln.nvd_status || 'Pending')}</span>` : ''}
                            ${vuln.source === 'euvd' ? '<span class="badge" style="background-color: #3b5998; font-size: 0.7rem;" title="Detected via ENISA EUVD — not yet in CISA KEV"><i class="bi bi-shield-exclamation me-1"></i>EUVD</span>' : vuln.source === 'cisa_kev+euvd' ? '<span class="badge" style="background-color: #4a6fa5; font-size: 0.7rem;" title="Confirmed by both CISA KEV and ENISA EUVD"><i class="bi bi-shield-check me-1"></i>KEV+EUVD</span>' : vuln.source === 'nvd' ? '<span class="badge" style="background-color: #6d47a8; font-size: 0.7rem;" title="Detected via NVD early import — not yet in CISA KEV"><i class="bi bi-database me-1"></i>NVD Early</span>' : '<span class="badge" style="background-color: #3d7a4f; font-size: 0.7rem;" title="Source: CISA Known Exploited Vulnerabilities"><i class="bi bi-shield-check me-1"></i>CISA KEV</span>'}
                        </div>
                    </div>
                    <h6 class="mb-2 fw-semibold" style="line-height: 1.3;">${escapeHtml(vuln.vulnerability_name)}</h6>

                    <!-- Compact badge row: scores + exposure + platform icons -->
                    <div class="d-flex flex-wrap gap-1 mb-2 align-items-center">
                        ${vuln.cvss_score ? `
                        <span class="badge rounded-pill" style="background-color: ${cvssColor}; font-size: 0.75rem;" title="${vuln.cvss_source ? 'Source: ' + ({'nvd': 'NVD', 'cve_org': 'CVE.org/Vulnrichment', 'euvd': 'ENISA EUVD'}[vuln.cvss_source] || 'Unknown') : ''}">
                            CVSS ${escapeHtml(String(vuln.cvss_score))}
                        </span>` : ''}
                        ${epssScore != null ? `
                        <span class="badge rounded-pill" style="background-color: ${epssColor}; font-size: 0.75rem;" title="Top ${epssRank}% most likely to be exploited">
                            <i class="bi bi-lightning-charge"></i> EPSS ${epssPercent.toFixed(1)}%
                        </span>` : ''}
                        <span class="badge rounded-pill ${group.unacknowledged_count > 0 ? 'bg-warning text-dark' : 'bg-success'}" style="font-size: 0.75rem;">
                            ${group.product_count} product${group.product_count > 1 ? 's' : ''}${group.unacknowledged_count > 0 ? ` (${group.unacknowledged_count} open)` : ''}
                        </span>
                        ${group.total_affected_assets > 0 ? `
                        <a href="/admin#endpointsPane?cve=${encodeURIComponent(group.cve_id)}" class="badge rounded-pill bg-info text-dark text-decoration-none" style="font-size: 0.75rem; cursor: pointer;" title="View all endpoints affected by ${escapeHtml(group.cve_id)}" onclick="event.preventDefault(); event.stopPropagation(); window.location.href='/admin#endpointsPane?cve=${encodeURIComponent(group.cve_id)}';">
                            <i class="bi bi-hdd-network"></i> ${group.total_affected_assets} endpoint${group.total_affected_assets > 1 ? 's' : ''}
                        </a>` : ''}
                        ${getPlatformSummary(group)}
                    </div>

                    <!-- Expandable sections row -->
                    <div class="d-flex gap-1 mb-2">
                        <button class="btn btn-sm btn-outline-secondary flex-fill d-flex justify-content-between align-items-center py-1" type="button" data-bs-toggle="collapse" data-bs-target="#details-${cardId}" aria-expanded="false">
                            <span><i class="bi bi-info-circle me-1"></i>Details & Fix</span>
                            <i class="bi bi-chevron-down" style="font-size: 0.7rem;"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary flex-fill d-flex justify-content-between align-items-center py-1" type="button" data-bs-toggle="collapse" data-bs-target="#products-${cardId}" aria-expanded="false">
                            <span><i class="bi bi-box-seam me-1"></i>Products <span class="badge ${group.unacknowledged_count > 0 ? 'bg-warning text-dark' : 'bg-success'} ms-1" style="font-size: 0.65rem;">${group.product_count}</span></span>
                            <i class="bi bi-chevron-down" style="font-size: 0.7rem;"></i>
                        </button>
                    </div>

                    <!-- Collapsible: Details & Fix -->
                    <div class="collapse" id="details-${cardId}">
                        <div class="border rounded p-2 mb-2 small">
                            <p class="text-secondary mb-2">${escapeHtml(vuln.short_description)}</p>
                            <div class="p-2 bg-light border-start border-3 border-success rounded-end">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-wrench-adjustable text-success me-2 mt-1"></i>
                                    <div>
                                        <span class="fw-medium">${escapeHtml(vuln.required_action)}</span>
                                        ${fixVersionHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Collapsible: Affected Products -->
                    <div class="collapse" id="products-${cardId}">
                        <div class="border rounded p-2 mb-2">
                            ${productsHtml}
                        </div>
                    </div>

                    <!-- Action Buttons (always visible, compact) -->
                    <div class="d-flex gap-1 flex-wrap justify-content-between align-items-center">
                        <div class="d-flex gap-1">
                            ${group.unacknowledged_count > 0 ?
                                `<button class="btn btn-sm btn-success py-0 px-2" onclick="acknowledgeCVE('${escapeHtml(vuln.cve_id).replace(/'/g, "\\'")}')">
                                    <i class="bi bi-check-all me-1"></i>Resolve (${group.unacknowledged_count})
                                </button>` :
                                `<button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="unacknowledgeCVE('${escapeHtml(vuln.cve_id).replace(/'/g, "\\'")}')">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reopen
                                </button>`
                            }
                            ${trackerBtn}
                        </div>
                        <div class="btn-group">
                            <a href="https://nvd.nist.gov/vuln/detail/${encodeURIComponent(vuln.cve_id)}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-2">
                                <i class="bi bi-box-arrow-up-right"></i> NVD
                            </a>
                            <button class="btn btn-sm btn-outline-info py-0 px-2" onclick="shareSingleCVE('${escapeHtml(vuln.cve_id).replace(/'/g, "\\'")}', '${escapeHtml(vuln.vulnerability_name).replace(/'/g, "\\'")}')">
                                <i class="bi bi-share"></i> Share
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Acknowledge all product matches for a CVE
    async function acknowledgeCVE(cveId) {
        try {
            showLoading();
            const response = await fetch(`/api/matches/acknowledge-by-cve/${cveId}`, { method: 'POST' });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to acknowledge CVE');
            }

            const result = await response.json();
            showToast(`Acknowledged ${result.acknowledged_count} product(s) for ${cveId}`, 'success');

            // Refresh the view
            loadGroupedVulnerabilities();
            loadStats();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    // Unacknowledge all product matches for a CVE (reopen)
    async function unacknowledgeCVE(cveId) {
        const confirmed = await showConfirm(
            `Reopen ${cveId}? This will mark all affected products as unacknowledged.`,
            'Reopen CVE',
            'Reopen',
            'btn-warning'
        );

        if (!confirmed) return;

        try {
            showLoading();
            const response = await fetch(`/api/matches/unacknowledge-by-cve/${cveId}`, { method: 'POST' });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to unacknowledge CVE');
            }

            const result = await response.json();
            showToast(`Reopened ${result.unacknowledged_count} product(s) for ${cveId}`, 'info');

            // Refresh the view
            loadGroupedVulnerabilities();
            loadStats();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

</script>
{% endblock %}
