{% extends "base.html" %}

{% block title %}Dashboard - SentriKat{% endblock %}

{% block content %}
<style>
    /* Priority Alert Cards */
    .alert-card {
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.3s ease;
        border: 1px solid transparent;
        background: linear-gradient(135deg, var(--card-bg-start) 0%, var(--card-bg-end) 100%);
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        height: 100%;
    }

    .alert-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }

    .alert-card-critical {
        --card-bg-start: #fef2f2;
        --card-bg-end: #fee2e2;
        border-left: 4px solid #dc2626;
    }

    .alert-card-high {
        --card-bg-start: #fef3c7;
        --card-bg-end: #fde68a;
        border-left: 4px solid #f59e0b;
    }

    .alert-card-medium {
        --card-bg-start: #dbeafe;
        --card-bg-end: #bfdbfe;
        border-left: 4px solid #3b82f6;
    }

    .alert-card-low {
        --card-bg-start: #f0fdf4;
        --card-bg-end: #dcfce7;
        border-left: 4px solid #10b981;
    }

    .alert-card-label {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
        color: #374151;
    }

    .alert-card-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.25rem;
    }

    .alert-card-critical .alert-card-value { color: #dc2626; }
    .alert-card-high .alert-card-value { color: #f59e0b; }
    .alert-card-medium .alert-card-value { color: #3b82f6; }
    .alert-card-low .alert-card-value { color: #10b981; }

    .alert-card i {
        color: inherit;
    }
</style>
<div class="fade-in">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 fw-bold text-dark mb-2">
                <i class="bi bi-speedometer2 me-2"></i>Vulnerability Dashboard
            </h1>
            <p class="text-muted mb-0">Real-time monitoring of known exploited vulnerabilities affecting your infrastructure</p>
        </div>
    </div>

    <!-- Priority Alert Cards -->
    <div class="row g-3 mb-4" id="priorityAlerts">
        <div class="col-xl-3 col-md-6">
            <div class="alert-card alert-card-critical">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="alert-card-label">Critical Priority</div>
                        <div class="alert-card-value" id="criticalCount">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </div>
                        <small class="text-muted">Immediate action required</small>
                    </div>
                    <i class="bi bi-exclamation-octagon-fill" style="font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="alert-card alert-card-high">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="alert-card-label">High Priority</div>
                        <div class="alert-card-value" id="highCount">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </div>
                        <small class="text-muted">Urgent attention needed</small>
                    </div>
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="alert-card alert-card-medium">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="alert-card-label">Medium Priority</div>
                        <div class="alert-card-value" id="mediumCount">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </div>
                        <small class="text-muted">Plan remediation</small>
                    </div>
                    <i class="bi bi-info-circle-fill" style="font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="alert-card alert-card-low">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="alert-card-label">Low Priority</div>
                        <div class="alert-card-value" id="lowCount">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </div>
                        <small class="text-muted">Monitor and review</small>
                    </div>
                    <i class="bi bi-shield-check" style="font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-4" id="statsContainer">
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card" style="border-left-color: #3b82f6;">
                <div class="card-body position-relative">
                    <i class="bi bi-database stat-icon"></i>
                    <div class="stat-label">Total Vulnerabilities</div>
                    <div class="stat-value text-primary" id="totalVulns">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                    </div>
                    <small class="text-muted">In CISA KEV Catalog</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card" style="border-left-color: #ef4444;">
                <div class="card-body position-relative">
                    <i class="bi bi-exclamation-triangle stat-icon"></i>
                    <div class="stat-label">Affecting Your Products</div>
                    <div class="stat-value text-danger" id="totalMatches">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                    </div>
                    <small class="text-muted">Direct matches found</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card" style="border-left-color: #f59e0b;">
                <div class="card-body position-relative">
                    <i class="bi bi-clock-history stat-icon"></i>
                    <div class="stat-label">Needs Review</div>
                    <div class="stat-value text-warning" id="unacknowledged">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                    </div>
                    <small class="text-muted">Unacknowledged items</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card" style="border-left-color: #10b981;">
                <div class="card-body position-relative">
                    <i class="bi bi-gear-fill stat-icon"></i>
                    <div class="stat-label">Products Tracked</div>
                    <div class="stat-value text-success" id="productsTracked">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                    </div>
                    <small class="text-muted">Active inventory items</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Filters Panel -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-funnel me-2"></i>Advanced Filters</span>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
                <i class="bi bi-arrow-counterclockwise"></i> Reset
            </button>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Priority Level</label>
                    <select class="form-select" id="filterPriority">
                        <option value="">All Priorities</option>
                        <option value="critical">Critical Only</option>
                        <option value="high">High & Above</option>
                        <option value="medium">Medium & Above</option>
                        <option value="low">Low & Above</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">CVE Severity (CVSS)</label>
                    <select class="form-select" id="filterSeverity">
                        <option value="">All Severities</option>
                        <option value="CRITICAL">Critical (CVSS 9.0-10.0)</option>
                        <option value="HIGH">High (CVSS 7.0-8.9)</option>
                        <option value="MEDIUM">Medium (CVSS 4.0-6.9)</option>
                        <option value="LOW">Low (CVSS 0.1-3.9)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">CISA Urgency</label>
                    <select class="form-select" id="filterUrgency">
                        <option value="">All Urgency Levels</option>
                        <option value="critical">Critical - Due ≤7 Days</option>
                        <option value="high">High - Due ≤30 Days</option>
                        <option value="has_due_date">Has Due Date</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">CVE Age</label>
                    <select class="form-select" id="filterAge">
                        <option value="">All Ages</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="180">Last 6 Months</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">CVE ID</label>
                    <input type="text" class="form-control" id="filterCVE" placeholder="e.g., CVE-2024-1234">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Vendor</label>
                    <input type="text" class="form-control" id="filterVendor" placeholder="e.g., Microsoft">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Product</label>
                    <input type="text" class="form-control" id="filterProduct" placeholder="e.g., Windows">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Sort By</label>
                    <select class="form-select" id="sortBy">
                        <option value="priority">Priority (Highest First)</option>
                        <option value="date_desc">Date Added (Newest)</option>
                        <option value="date_asc">Date Added (Oldest)</option>
                        <option value="cve_desc">CVE ID (Desc)</option>
                        <option value="cve_asc">CVE ID (Asc)</option>
                    </select>
                </div>
                <div class="col-md-12">
                    <div class="d-flex gap-3 flex-wrap">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="filterRansomware">
                            <label class="form-check-label fw-semibold" for="filterRansomware">
                                <i class="bi bi-shield-exclamation text-danger"></i> Ransomware Only
                            </label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="filterUnack">
                            <label class="form-check-label fw-semibold" for="filterUnack">
                                <i class="bi bi-circle text-warning"></i> Unacknowledged Only
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="loadVulnerabilities()">
                            <i class="bi bi-search"></i> Apply Filters
                        </button>
                        <button type="button" class="btn btn-info" onclick="shareFilteredView()">
                            <i class="bi bi-share"></i> Share Filtered View
                        </button>
                        <div class="dropdown export-dropdown">
                            <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-download"></i> Export
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="exportData('csv')">
                                    <i class="bi bi-filetype-csv"></i> Export as CSV
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportData('json')">
                                    <i class="bi bi-filetype-json"></i> Export as JSON
                                </a></li>
                            </ul>
                        </div>
                        <button class="btn btn-outline-secondary" onclick="bulkAcknowledge()" id="bulkAckBtn" disabled>
                            <i class="bi bi-check-all"></i> Bulk Acknowledge (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vulnerabilities List -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span><i class="bi bi-shield-exclamation me-2"></i>Matched Vulnerabilities (<span id="vulnCount">0</span>)</span>
            <div class="d-flex align-items-center gap-3">
                <!-- Export Report Dropdown -->
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Export Report">
                        <i class="bi bi-file-earmark-pdf"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 280px;">
                        <h6 class="dropdown-header px-0">Export PDF Report</h6>
                        <div class="mb-2">
                            <select class="form-select form-select-sm" id="reportType" onchange="toggleReportDateFields()">
                                <option value="monthly">Monthly Report</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                        </div>
                        <div class="row g-2 mb-2" id="monthlyFields">
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="reportMonth">
                                    <option value="1">Jan</option>
                                    <option value="2">Feb</option>
                                    <option value="3">Mar</option>
                                    <option value="4">Apr</option>
                                    <option value="5">May</option>
                                    <option value="6">Jun</option>
                                    <option value="7">Jul</option>
                                    <option value="8">Aug</option>
                                    <option value="9">Sep</option>
                                    <option value="10">Oct</option>
                                    <option value="11">Nov</option>
                                    <option value="12">Dec</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="reportYear"></select>
                            </div>
                        </div>
                        <div class="row g-2 mb-2" id="customFields" style="display: none;">
                            <div class="col-6">
                                <input type="date" class="form-control form-control-sm" id="reportStartDate" placeholder="Start">
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control form-control-sm" id="reportEndDate" placeholder="End">
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm w-100" onclick="exportReport()">
                            <i class="bi bi-download me-1"></i>Download PDF
                        </button>
                    </div>
                </div>
                <!-- Page Size -->
                <select class="form-select form-select-sm" id="pageSize" style="width: 75px;" onchange="changePageSize()" title="Items per page">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="all">All</option>
                </select>
                <div class="form-check mb-0">
                    <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                    <label class="form-check-label" for="selectAll">Select All</label>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="vulnerabilitiesContainer" class="p-3"></div>
            <!-- Pagination Controls -->
            <div id="paginationControls" class="d-flex justify-content-between align-items-center p-3 border-top" style="display: none !important;">
                <div class="text-muted small" id="paginationInfo">Showing 1-50 of 0</div>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="paginationNav"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Last Sync Info -->
    <div class="card mt-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Last Synchronization</h6>
                    <p class="text-muted mb-0 mt-1" id="lastSync">Loading...</p>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-outline-primary" onclick="viewSyncHistory()">
                        <i class="bi bi-clock-history"></i> View Sync History
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sync History Modal -->
<div class="modal fade" id="syncHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-clock-history me-2"></i>Synchronization History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Status</th>
                                <th>Vulnerabilities</th>
                                <th>Matches Found</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody id="syncHistoryTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Filtered View Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Share Filtered View</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name (Optional)</label>
                        <input type="text" class="form-control" id="shareName" placeholder="e.g., Critical Windows Vulnerabilities">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="shareDescription" rows="2" placeholder="Brief description of this filtered view"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Link Expiration</label>
                        <select class="form-select" id="shareExpiration">
                            <option value="">Never expires</option>
                            <option value="7">7 days</option>
                            <option value="30" selected>30 days</option>
                            <option value="90">90 days</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Current Filters:</strong>
                        <div id="shareFiltersSummary" class="mt-2 small">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    <div id="shareResult" style="display: none;">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Shareable link created!</strong>
                            <div class="input-group mt-2">
                                <input type="text" class="form-control" id="shareUrl" readonly>
                                <button class="btn btn-outline-secondary" onclick="copyShareUrl()">
                                    <i class="bi bi-clipboard"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="createShareLink()" id="createShareBtn">
                        <i class="bi bi-share"></i> Create Share Link
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Helper functions for priority styling
    function getPriorityBadgeClass(priority) {
        const classes = {
            'critical': 'bg-danger',
            'high': 'bg-warning text-dark',
            'medium': 'bg-info text-dark',
            'low': 'bg-secondary'
        };
        return classes[priority?.toLowerCase()] || 'bg-secondary';
    }

    function getPriorityIcon(priority) {
        const icons = {
            'critical': 'bi-exclamation-triangle-fill',
            'high': 'bi-exclamation-circle-fill',
            'medium': 'bi-info-circle-fill',
            'low': 'bi-dash-circle'
        };
        return icons[priority?.toLowerCase()] || 'bi-circle';
    }

    function getPriorityColor(priority) {
        const colors = {
            'critical': '#dc2626',
            'high': '#f59e0b',
            'medium': '#3b82f6',
            'low': '#6b7280'
        };
        return colors[priority?.toLowerCase()] || '#6b7280';
    }

    // Report Export Functions
    function initReportFields() {
        // Populate year dropdown
        const yearSelect = document.getElementById('reportYear');
        const currentYear = new Date().getFullYear();
        for (let year = currentYear; year >= currentYear - 5; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }

        // Set current month and year
        const currentMonth = new Date().getMonth() + 1;
        document.getElementById('reportMonth').value = currentMonth;

        // Set default date range for custom reports (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);

        document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
        document.getElementById('reportStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    }

    function toggleReportDateFields() {
        const reportType = document.getElementById('reportType').value;
        const monthlyFields = document.getElementById('monthlyFields');
        const customFields = document.getElementById('customFields');

        if (reportType === 'monthly') {
            monthlyFields.style.display = 'flex';
            customFields.style.display = 'none';
        } else {
            monthlyFields.style.display = 'none';
            customFields.style.display = 'flex';
        }
    }

    async function exportReport() {
        const reportType = document.getElementById('reportType').value;
        let url;

        if (reportType === 'monthly') {
            const month = document.getElementById('reportMonth').value;
            const year = document.getElementById('reportYear').value;
            url = `/api/reports/monthly?month=${month}&year=${year}`;
        } else {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            if (!startDate || !endDate) {
                showToast('Please select both start and end dates', 'warning');
                return;
            }

            url = `/api/reports/custom?start_date=${startDate}&end_date=${endDate}`;
        }

        try {
            showLoading();
            showToast('Generating report...', 'info');

            const response = await fetch(url);

            if (!response.ok) {
                // Try to parse error as JSON, fallback to status text
                let errorMessage = 'Failed to generate report';
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        errorMessage = error.error || errorMessage;
                    } else {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                } catch (e) {
                    errorMessage = `Server error: ${response.status}`;
                }
                throw new Error(errorMessage);
            }

            // Download the PDF
            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;

            // Get filename from Content-Disposition header or generate one
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'SentriKat_Report.pdf';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename="(.+)"/);
                if (match) filename = match[1];
            }

            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(downloadUrl);

            showToast('Report downloaded successfully!', 'success');
        } catch (error) {
            console.error('Error generating report:', error);
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    // Initialize report fields on page load
    document.addEventListener('DOMContentLoaded', function() {
        initReportFields();
    });

    let currentVulnerabilities = [];
    let selectedVulns = new Set();
    let currentPage = 1;
    let pageSize = 50;

    function changePageSize() {
        const select = document.getElementById('pageSize');
        pageSize = select.value === 'all' ? Infinity : parseInt(select.value);
        currentPage = 1;
        renderCurrentPage();
    }

    function goToPage(page) {
        currentPage = page;
        renderCurrentPage();
        // Scroll to top of vulnerabilities container
        document.getElementById('vulnerabilitiesContainer').scrollIntoView({ behavior: 'smooth' });
    }

    function renderCurrentPage() {
        const container = document.getElementById('vulnerabilitiesContainer');
        const total = currentVulnerabilities.length;

        if (total === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-shield-check text-success" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">No vulnerabilities found</h4>
                    <p class="text-muted">No matches found with the current filter criteria.</p>
                </div>
            `;
            document.getElementById('paginationControls').style.display = 'none';
            return;
        }

        const effectivePageSize = pageSize === Infinity ? total : pageSize;
        const totalPages = Math.ceil(total / effectivePageSize);
        const startIdx = (currentPage - 1) * effectivePageSize;
        const endIdx = Math.min(startIdx + effectivePageSize, total);
        const pageItems = currentVulnerabilities.slice(startIdx, endIdx);

        container.innerHTML = pageItems.map(match => createVulnCard(match)).join('');

        // Update pagination info and controls
        const paginationControls = document.getElementById('paginationControls');
        const paginationInfo = document.getElementById('paginationInfo');
        const paginationNav = document.getElementById('paginationNav');

        if (totalPages > 1) {
            paginationControls.style.display = 'flex';
            paginationInfo.textContent = `Showing ${startIdx + 1}-${endIdx} of ${total}`;

            // Build pagination nav
            let navHtml = '';

            // Previous button
            navHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">&laquo;</a>
            </li>`;

            // Page numbers (show max 5 pages around current)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                navHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1); return false;">1</a></li>`;
                if (startPage > 2) navHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                navHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
                </li>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) navHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                navHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${totalPages}); return false;">${totalPages}</a></li>`;
            }

            // Next button
            navHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">&raquo;</a>
            </li>`;

            paginationNav.innerHTML = navHtml;
        } else {
            paginationControls.style.display = 'none';
        }
    }

    async function loadStats() {
        try {
            const response = await fetch('/api/vulnerabilities/stats');
            const stats = await response.json();

            document.getElementById('totalVulns').textContent = formatNumber(stats.total_vulnerabilities);
            document.getElementById('totalMatches').textContent = formatNumber(stats.total_matches);
            document.getElementById('unacknowledged').textContent = formatNumber(stats.unacknowledged);
            document.getElementById('productsTracked').textContent = formatNumber(stats.products_tracked);

            // Update priority counts
            document.getElementById('criticalCount').textContent = formatNumber(stats.critical_count || 0);
            document.getElementById('highCount').textContent = formatNumber(stats.high_count || 0);
            document.getElementById('mediumCount').textContent = formatNumber(stats.medium_count || 0);
            document.getElementById('lowCount').textContent = formatNumber(stats.low_count || 0);
        } catch (error) {
            console.error('Error loading stats:', error);
            showToast('Failed to load statistics', 'danger');
        }
    }

    async function loadVulnerabilities() {
        showLoading();
        const container = document.getElementById('vulnerabilitiesContainer');
        selectedVulns.clear();
        updateBulkActions();

        try {
            const params = new URLSearchParams();
            const cve = document.getElementById('filterCVE').value;
            const vendor = document.getElementById('filterVendor').value;
            const product = document.getElementById('filterProduct').value;
            const ransomware = document.getElementById('filterRansomware').checked;
            const unack = document.getElementById('filterUnack').checked;

            if (cve) params.append('cve_id', cve);
            if (vendor) params.append('vendor', vendor);
            if (product) params.append('product', product);
            if (ransomware) params.append('ransomware_only', 'true');
            if (unack) params.append('acknowledged', 'false');

            const response = await fetch(`/api/vulnerabilities?${params}`);
            currentVulnerabilities = await response.json();

            // Apply client-side filtering for priority and age
            applyClientFilters();

            // Apply sorting
            sortVulnerabilities();

            document.getElementById('vulnCount').textContent = currentVulnerabilities.length;

            // Reset to page 1 and render
            currentPage = 1;
            renderCurrentPage();
        } catch (error) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Error loading vulnerabilities: ${error.message}
                </div>
            `;
        } finally {
            hideLoading();
        }
    }

    function applyClientFilters() {
        // Filter by priority
        const priorityFilter = document.getElementById('filterPriority').value;
        if (priorityFilter) {
            const priorityOrder = {'critical': 4, 'high': 3, 'medium': 2, 'low': 1};
            const minLevel = priorityOrder[priorityFilter];
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const effectivePriority = match.effective_priority;
                return priorityOrder[effectivePriority] >= minLevel;
            });
        }

        // Filter by CVE severity (from CVSS score)
        const severityFilter = document.getElementById('filterSeverity').value;
        if (severityFilter) {
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const vuln = match.vulnerability;
                return vuln.severity === severityFilter;
            });
        }

        // Filter by CISA urgency (based on due date)
        const urgencyFilter = document.getElementById('filterUrgency').value;
        if (urgencyFilter) {
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const vuln = match.vulnerability;

                // If urgency filter is active, CVEs MUST have a due date
                if (!vuln.due_date) {
                    return false;
                }

                // Calculate days until due
                const today = new Date();
                const dueDate = new Date(vuln.due_date);
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                switch(urgencyFilter) {
                    case 'critical':
                        // Critical: Due within 7 days OR ransomware
                        return daysUntilDue <= 7 || vuln.known_ransomware;
                    case 'high':
                        // High: Due within 30 days
                        return daysUntilDue <= 30;
                    case 'has_due_date':
                        // Any CVE with a due date
                        return true;
                    default:
                        return true;
                }
            });
        }

        // Filter by age
        const ageFilter = document.getElementById('filterAge').value;
        if (ageFilter) {
            const maxDays = parseInt(ageFilter);
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const daysOld = match.vulnerability.days_old || 0;
                return daysOld <= maxDays;
            });
        }
    }

    function sortVulnerabilities() {
        const sortBy = document.getElementById('sortBy').value;
        const priorityOrder = {'critical': 4, 'high': 3, 'medium': 2, 'low': 1};

        switch(sortBy) {
            case 'priority':
                currentVulnerabilities.sort((a, b) => {
                    const priorityDiff = priorityOrder[b.effective_priority] - priorityOrder[a.effective_priority];
                    if (priorityDiff !== 0) return priorityDiff;
                    // If same priority, sort by date (newest first)
                    return new Date(b.vulnerability.date_added) - new Date(a.vulnerability.date_added);
                });
                break;
            case 'date_desc':
                currentVulnerabilities.sort((a, b) =>
                    new Date(b.vulnerability.date_added) - new Date(a.vulnerability.date_added));
                break;
            case 'date_asc':
                currentVulnerabilities.sort((a, b) =>
                    new Date(a.vulnerability.date_added) - new Date(b.vulnerability.date_added));
                break;
            case 'cve_desc':
                currentVulnerabilities.sort((a, b) =>
                    b.vulnerability.cve_id.localeCompare(a.vulnerability.cve_id));
                break;
            case 'cve_asc':
                currentVulnerabilities.sort((a, b) =>
                    a.vulnerability.cve_id.localeCompare(b.vulnerability.cve_id));
                break;
        }
    }

    function createVulnCard(match) {
        const vuln = match.vulnerability;
        const product = match.product;
        const priority = match.effective_priority;
        const productCriticality = match.product_criticality;

        const ransomwareBadge = vuln.known_ransomware ?
            '<span class="badge badge-critical"><i class="bi bi-shield-exclamation"></i> Ransomware</span>' : '';
        const ackBadge = match.acknowledged ?
            '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Acknowledged</span>' :
            '<span class="badge bg-warning text-dark"><i class="bi bi-circle"></i> Needs Review</span>';
        const priorityBadge = `<span class="badge ${getPriorityBadgeClass(priority)}"><i class="bi ${getPriorityIcon(priority)}"></i> ${priority.toUpperCase()} Priority</span>`;
        const criticalityBadge = `<span class="badge ${getPriorityBadgeClass(productCriticality)} badge-outline">${productCriticality.toUpperCase()} Criticality Product</span>`;

        // CVSS Severity Badge
        const severityBadge = vuln.severity ?
            `<span class="badge ${getPriorityBadgeClass(vuln.severity.toLowerCase())}"><i class="bi bi-graph-up"></i> CVSS: ${vuln.severity} ${vuln.cvss_score ? `(${vuln.cvss_score})` : ''}</span>` :
            '<span class="badge bg-secondary"><i class="bi bi-question-circle"></i> No CVSS Data</span>';

        return `
            <div class="card vuln-card mb-3" id="match-${match.id}" style="border-left: 4px solid ${getPriorityColor(priority)};">
                <div class="card-body">
                    <div class="row">
                        <div class="col-auto">
                            <input class="form-check-input" type="checkbox" value="${match.id}"
                                   onchange="toggleSelection(${match.id}, this.checked)">
                        </div>
                        <div class="col">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="card-title mb-2">
                                        <span class="badge bg-dark">${vuln.cve_id}</span>
                                        ${vuln.vulnerability_name}
                                    </h5>
                                    <div class="mb-2">
                                        ${priorityBadge}
                                        ${severityBadge}
                                        ${ransomwareBadge}
                                        ${ackBadge}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-calendar3"></i> Added: ${formatDate(vuln.date_added)} (${vuln.days_old} days ago)
                                        </span>
                                        ${vuln.due_date ? `<span class="badge bg-danger">
                                            <i class="bi bi-alarm"></i> Due: ${formatDate(vuln.due_date)}
                                        </span>` : ''}
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <small class="text-muted fw-semibold">AFFECTED PRODUCT</small>
                                    <p class="mb-0"><strong>${vuln.vendor_project}</strong> - ${vuln.product}</p>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted fw-semibold">YOUR PRODUCT</small>
                                    <p class="mb-0">
                                        <strong>${product.vendor}</strong> - ${product.product_name}
                                        ${product.version ? `<span class="badge bg-info">v${product.version}</span>` : ''}
                                        ${criticalityBadge}
                                    </p>
                                </div>
                            </div>

                            <div class="mb-2">
                                <small class="text-muted fw-semibold">DESCRIPTION</small>
                                <p class="mb-0">${vuln.short_description}</p>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted fw-semibold">REQUIRED ACTION</small>
                                <p class="mb-0 fw-medium text-danger">${vuln.required_action}</p>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted fw-semibold">MATCH REASON</small>
                                <p class="mb-0 text-primary">${match.match_reason}</p>
                            </div>

                            <div class="btn-group" role="group">
                                ${!match.acknowledged ?
                                    `<button class="btn btn-sm btn-success" onclick="acknowledgeMatch(${match.id})">
                                        <i class="bi bi-check-circle"></i> Acknowledge
                                    </button>` :
                                    `<button class="btn btn-sm btn-outline-secondary" onclick="unacknowledgeMatch(${match.id})">
                                        <i class="bi bi-arrow-counterclockwise"></i> Unacknowledge
                                    </button>`
                                }
                                <a href="https://nvd.nist.gov/vuln/detail/${vuln.cve_id}" target="_blank"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-box-arrow-up-right"></i> View in NVD
                                </a>
                                <button class="btn btn-sm btn-outline-info" onclick="shareSingleCVE('${vuln.cve_id}', '${escapeHtml(vuln.vulnerability_name)}')">
                                    <i class="bi bi-share"></i> Share
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function toggleSelection(matchId, selected) {
        if (selected) {
            selectedVulns.add(matchId);
        } else {
            selectedVulns.delete(matchId);
            document.getElementById('selectAll').checked = false;
        }
        updateBulkActions();
    }

    function toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll('.vuln-card input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = checkbox.checked;
            const matchId = parseInt(cb.value);
            if (checkbox.checked) {
                selectedVulns.add(matchId);
            } else {
                selectedVulns.delete(matchId);
            }
        });
        updateBulkActions();
    }

    function updateBulkActions() {
        const count = selectedVulns.size;
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('bulkAckBtn').disabled = count === 0;
    }

    async function bulkAcknowledge() {
        if (selectedVulns.size === 0) return;

        const confirmed = await showConfirm(
            `Acknowledge ${selectedVulns.size} vulnerabilities?`,
            'Bulk Acknowledge',
            'Acknowledge',
            'btn-primary'
        );

        if (!confirmed) return;

        showLoading();
        let success = 0;
        let failed = 0;

        for (const matchId of selectedVulns) {
            try {
                await fetch(`/api/matches/${matchId}/acknowledge`, { method: 'POST' });
                success++;
            } catch {
                failed++;
            }
        }

        hideLoading();
        showToast(`✓ Acknowledged ${success} vulnerabilities${failed > 0 ? `, ${failed} failed` : ''}`, success > 0 ? 'success' : 'danger');
        selectedVulns.clear();
        loadVulnerabilities();
        loadStats();
    }

    async function acknowledgeMatch(matchId) {
        try {
            await fetch(`/api/matches/${matchId}/acknowledge`, { method: 'POST' });
            showToast('✓ Vulnerability acknowledged', 'success');
            loadVulnerabilities();
            loadStats();
        } catch (error) {
            showToast(`✗ Error: ${error.message}`, 'danger');
        }
    }

    async function unacknowledgeMatch(matchId) {
        try {
            await fetch(`/api/matches/${matchId}/unacknowledge`, { method: 'POST' });
            showToast('Vulnerability unacknowledged', 'info');
            loadVulnerabilities();
            loadStats();
        } catch (error) {
            showToast(`✗ Error: ${error.message}`, 'danger');
        }
    }

    async function loadLastSync() {
        try {
            const response = await fetch('/api/sync/status');
            const sync = await response.json();

            if (sync.sync_date) {
                const date = new Date(sync.sync_date);
                const statusBadge = sync.status === 'success' ?
                    '<span class="badge bg-success">Success</span>' :
                    '<span class="badge bg-danger">Failed</span>';
                document.getElementById('lastSync').innerHTML = `
                    ${date.toLocaleString()} ${statusBadge} |
                    ${sync.matches_found || 0} matches found in ${(sync.duration_seconds || 0).toFixed(2)}s
                `;
            }
        } catch (error) {
            console.error('Error loading sync status:', error);
        }
    }

    async function viewSyncHistory() {
        try {
            const response = await fetch('/api/sync/history?limit=20');
            const history = await response.json();

            const tbody = document.getElementById('syncHistoryTable');
            tbody.innerHTML = history.map(sync => {
                const date = new Date(sync.sync_date);
                const statusBadge = sync.status === 'success' ?
                    '<span class="badge bg-success">Success</span>' :
                    '<span class="badge bg-danger">Failed</span>';

                return `
                    <tr>
                        <td>${date.toLocaleString()}</td>
                        <td>${statusBadge}</td>
                        <td>${sync.vulnerabilities_count || 0}</td>
                        <td>${sync.matches_found || 0}</td>
                        <td>${(sync.duration_seconds || 0).toFixed(2)}s</td>
                    </tr>
                `;
            }).join('');

            new bootstrap.Modal(document.getElementById('syncHistoryModal')).show();
        } catch (error) {
            showToast('Failed to load sync history', 'danger');
        }
    }

    function resetFilters() {
        document.getElementById('filterPriority').value = '';
        document.getElementById('filterSeverity').value = '';
        document.getElementById('filterUrgency').value = '';
        document.getElementById('filterAge').value = '';
        document.getElementById('filterCVE').value = '';
        document.getElementById('filterVendor').value = '';
        document.getElementById('filterProduct').value = '';
        document.getElementById('filterRansomware').checked = false;
        document.getElementById('filterUnack').checked = false;
        document.getElementById('sortBy').value = 'priority';
        loadVulnerabilities();
    }

    function exportData(format) {
        const data = currentVulnerabilities.map(match => ({
            priority: match.effective_priority,
            cve_id: match.vulnerability.cve_id,
            vulnerability_name: match.vulnerability.vulnerability_name,
            vendor_project: match.vulnerability.vendor_project,
            product: match.vulnerability.product,
            date_added: match.vulnerability.date_added,
            days_old: match.vulnerability.days_old,
            due_date: match.vulnerability.due_date,
            description: match.vulnerability.short_description,
            required_action: match.vulnerability.required_action,
            ransomware: match.vulnerability.known_ransomware,
            your_product: `${match.product.vendor} - ${match.product.product_name}`,
            product_criticality: match.product_criticality,
            acknowledged: match.acknowledged,
            match_reason: match.match_reason
        }));

        if (format === 'json') {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            downloadFile(blob, `sentrikat-vulnerabilities-${new Date().toISOString().split('T')[0]}.json`);
        } else if (format === 'csv') {
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            downloadFile(blob, `sentrikat-vulnerabilities-${new Date().toISOString().split('T')[0]}.csv`);
        }
        showToast(`✓ Exported ${data.length} vulnerabilities as ${format.toUpperCase()}`, 'success');
    }

    function convertToCSV(data) {
        if (data.length === 0) return '';
        const headers = Object.keys(data[0]).join(',');
        const rows = data.map(row =>
            Object.values(row).map(val =>
                `"${String(val).replace(/"/g, '""')}"`
            ).join(',')
        );
        return [headers, ...rows].join('\n');
    }

    function downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check for shared CVE in URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const sharedCVE = urlParams.get('cve');

        if (sharedCVE) {
            // Auto-fill CVE filter and apply
            document.getElementById('filterCVE').value = sharedCVE;
            loadVulnerabilities();
        } else {
            loadVulnerabilities();
        }

        loadStats();
        loadLastSync();

        // Auto-refresh stats every 5 minutes
        setInterval(loadStats, 300000);
    });

    // Handle Enter key in filter inputs
    document.querySelectorAll('#filterCVE, #filterVendor, #filterProduct').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadVulnerabilities();
            }
        });
    });

    // Handle filter changes
    document.getElementById('filterPriority').addEventListener('change', loadVulnerabilities);
    document.getElementById('filterSeverity').addEventListener('change', loadVulnerabilities);
    document.getElementById('filterUrgency').addEventListener('change', loadVulnerabilities);
    document.getElementById('filterAge').addEventListener('change', loadVulnerabilities);

    // Handle sort change
    document.getElementById('sortBy').addEventListener('change', function() {
        if (currentVulnerabilities.length > 0) {
            sortVulnerabilities();
            document.getElementById('vulnerabilitiesContainer').innerHTML =
                currentVulnerabilities.map(match => createVulnCard(match)).join('');
        }
    });

    // ============================================================================
    // Shared Filtered Views
    // ============================================================================

    /**
     * Get current filter state
     */
    function getCurrentFilters() {
        return {
            priority: document.getElementById('filterPriority').value,
            severity: document.getElementById('filterSeverity').value,
            urgency: document.getElementById('filterUrgency').value,
            age: document.getElementById('filterAge').value,
            cve: document.getElementById('filterCVE').value,
            vendor: document.getElementById('filterVendor').value,
            product: document.getElementById('filterProduct').value,
            ransomware: document.getElementById('filterRansomware').checked,
            unack: document.getElementById('filterUnack').checked
        };
    }

    /**
     * Show share modal with current filters
     */
    function shareFilteredView() {
        const filters = getCurrentFilters();

        // Build summary of active filters
        let summary = [];
        if (filters.priority) summary.push(`Priority: ${filters.priority}`);
        if (filters.severity) summary.push(`Severity: ${filters.severity}`);
        if (filters.urgency) summary.push(`Urgency: ${filters.urgency}`);
        if (filters.age) summary.push(`Age: ${filters.age}`);
        if (filters.cve) summary.push(`CVE: ${filters.cve}`);
        if (filters.vendor) summary.push(`Vendor: ${filters.vendor}`);
        if (filters.product) summary.push(`Product: ${filters.product}`);
        if (filters.ransomware) summary.push('Ransomware vulnerabilities only');
        if (filters.unack) summary.push('Unacknowledged only');

        if (summary.length === 0) {
            summary.push('No filters applied (all vulnerabilities)');
        }

        document.getElementById('shareFiltersSummary').innerHTML = summary.map(s => `• ${s}`).join('<br>');

        // Reset modal state
        document.getElementById('shareName').value = '';
        document.getElementById('shareDescription').value = '';
        document.getElementById('shareExpiration').value = '30';
        document.getElementById('shareResult').style.display = 'none';
        document.getElementById('createShareBtn').style.display = 'block';

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('shareModal'));
        modal.show();
    }

    /**
     * Create share link via API
     */
    async function createShareLink() {
        const btn = document.getElementById('createShareBtn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';

        try {
            const filters = getCurrentFilters();
            const name = document.getElementById('shareName').value;
            const description = document.getElementById('shareDescription').value;
            const expiresDays = document.getElementById('shareExpiration').value;

            const response = await fetch('/api/shared/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name || null,
                    description: description || null,
                    filters: filters,
                    is_public: true,
                    expires_days: expiresDays ? parseInt(expiresDays) : null
                })
            });

            if (response.ok) {
                const result = await response.json();
                document.getElementById('shareUrl').value = result.share_url;
                document.getElementById('shareResult').style.display = 'block';
                btn.style.display = 'none';
            } else {
                const error = await response.json();
                showToast(`Error creating share link: ${error.error}`, 'danger');
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        } catch (error) {
            console.error('Error creating share link:', error);
            showToast('Error creating share link. Please try again.', 'danger');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    /**
     * Copy share URL to clipboard
     */
    function copyShareUrl() {
        const input = document.getElementById('shareUrl');
        input.select();
        document.execCommand('copy');

        // Show feedback
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        setTimeout(() => {
            btn.innerHTML = originalHtml;
        }, 2000);
    }

    /**
     * Share a single CVE with NVD link - copies to clipboard automatically
     */
    async function shareSingleCVE(cveId, vulnName) {
        const nvdUrl = `https://nvd.nist.gov/vuln/detail/${encodeURIComponent(cveId)}`;

        try {
            // Try modern clipboard API first
            await navigator.clipboard.writeText(nvdUrl);
            showToast(`NVD link copied to clipboard`, 'success');
        } catch (error) {
            // Fallback for older browsers or non-HTTPS
            const textArea = document.createElement('textarea');
            textArea.value = nvdUrl;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast(`NVD link copied to clipboard`, 'success');
            } catch (e) {
                showToast(`Could not copy. URL: ${nvdUrl}`, 'warning');
            }
            document.body.removeChild(textArea);
        }
    }

    /**
     * Load shared view if share_token is present
     */
    async function loadSharedView() {
        const shareToken = '{{ share_token | default("") }}';
        if (!shareToken) return;

        try {
            const response = await fetch(`/api/shared/view/${shareToken}`);
            if (response.ok) {
                const result = await response.json();
                const filters = result.shared_view.filters;

                // Apply filters to form
                if (filters.priority) document.getElementById('filterPriority').value = filters.priority;
                if (filters.severity) document.getElementById('filterSeverity').value = filters.severity;
                if (filters.urgency) document.getElementById('filterUrgency').value = filters.urgency;
                if (filters.age) document.getElementById('filterAge').value = filters.age;
                if (filters.cve) document.getElementById('filterCVE').value = filters.cve || '';
                if (filters.vendor) document.getElementById('filterVendor').value = filters.vendor || '';
                if (filters.product) document.getElementById('filterProduct').value = filters.product || '';
                document.getElementById('filterRansomware').checked = filters.ransomware || false;
                document.getElementById('filterUnack').checked = filters.unack || false;

                // Show notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-info alert-dismissible fade show';
                notification.innerHTML = `
                    <i class="bi bi-share me-2"></i>
                    <strong>Viewing shared filtered view:</strong> ${result.shared_view.name || 'Untitled'}
                    ${result.shared_view.description ? `<br><small>${result.shared_view.description}</small>` : ''}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.fade-in').insertBefore(notification, document.querySelector('.fade-in').firstChild);

                // Load vulnerabilities with these filters
                loadVulnerabilities();
            } else if (response.status === 410) {
                showToast('This shared link has expired.', 'warning');
            } else {
                const error = await response.json();
                showToast(`Error loading shared view: ${error.error}`, 'danger');
            }
        } catch (error) {
            console.error('Error loading shared view:', error);
        }
    }

    // Load shared view on page load if token present
    loadSharedView();
</script>
{% endblock %}
