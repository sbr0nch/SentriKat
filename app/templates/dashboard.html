{% extends "base.html" %}

{% block title %}Dashboard - SentriKat{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">Dashboard</li>
{% endblock %}

{% block content %}
<style>
    /* Priority Alert Cards - Compact */
    .alert-card {
        border-radius: 8px;
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        background: linear-gradient(135deg, var(--card-bg-start) 0%, var(--card-bg-end) 100%);
        box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        height: 100%;
    }

    .alert-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .alert-card-critical {
        --card-bg-start: #fef2f2;
        --card-bg-end: #fee2e2;
        border-left: 3px solid #dc2626;
    }

    .alert-card-high {
        --card-bg-start: #fef3c7;
        --card-bg-end: #fde68a;
        border-left: 3px solid #f59e0b;
    }

    .alert-card-medium {
        --card-bg-start: #dbeafe;
        --card-bg-end: #bfdbfe;
        border-left: 3px solid #3b82f6;
    }

    .alert-card-low {
        --card-bg-start: #f0fdf4;
        --card-bg-end: #dcfce7;
        border-left: 3px solid #10b981;
    }

    .alert-card-label {
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: 0.25rem;
        color: #374151;
    }

    .alert-card-value {
        font-size: 2.25rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.15rem;
    }

    .alert-card-critical .alert-card-value { color: #dc2626; }
    .alert-card-high .alert-card-value { color: #f59e0b; }
    .alert-card-medium .alert-card-value { color: #3b82f6; }
    .alert-card-low .alert-card-value { color: #10b981; }

    .alert-card i.alert-icon {
        font-size: 1.5rem;
        opacity: 0.4;
    }

    .alert-card small {
        font-size: 0.75rem;
    }

    /* Compact Stat Cards */
    .stat-card-compact {
        border-radius: 8px;
    }

    .stat-label-sm {
        font-size: 0.8rem;
        font-weight: 600;
        color: #6b7280;
        letter-spacing: 0.02em;
        margin-bottom: 0.15rem;
    }

    .stat-value-sm {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1.1;
        margin-bottom: 0.1rem;
    }

    /* Compact Filters */
    .filters-compact .form-label {
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
    }
    .filters-compact .form-select,
    .filters-compact .form-control {
        font-size: 0.875rem;
        padding: 0.35rem 0.5rem;
    }
    .filters-compact .form-check-label {
        font-size: 0.875rem;
    }

    .stat-icon-sm {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.25rem;
        opacity: 0.15;
    }

    /* CVE Card Scroll Performance Optimizations */
    #vulnerabilitiesContainer {
        contain: layout style;
    }

    .vuln-card {
        content-visibility: auto;
        contain-intrinsic-size: 0 350px;
        contain: layout style paint;
    }

    .vuln-card .card-body {
        will-change: auto;
    }

    /* Reduce paint complexity */
    .vuln-card .badge {
        will-change: auto;
    }
</style>
<div class="fade-in">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 fw-bold text-dark mb-2">
                <i class="bi bi-speedometer2 me-2"></i>Vulnerability Dashboard
            </h1>
            <p class="text-muted mb-0">Real-time monitoring of known exploited vulnerabilities affecting your infrastructure</p>
        </div>
    </div>

    <!-- Priority Alert Cards -->
    <div class="row g-2 mb-3" id="priorityAlerts">
        <div class="col-xl-3 col-md-6">
            <div class="alert-card alert-card-critical">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="alert-card-label">Critical</div>
                        <div class="alert-card-value"><span id="criticalCves">-</span> <small class="text-muted fw-normal" style="font-size: 0.9rem;">(<span id="criticalCount">-</span>)</small></div>
                        <small class="text-muted">CVEs (matches)</small>
                    </div>
                    <i class="bi bi-exclamation-octagon-fill alert-icon"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="alert-card alert-card-high">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="alert-card-label">High</div>
                        <div class="alert-card-value"><span id="highCves">-</span> <small class="text-muted fw-normal" style="font-size: 0.9rem;">(<span id="highCount">-</span>)</small></div>
                        <small class="text-muted">CVEs (matches)</small>
                    </div>
                    <i class="bi bi-exclamation-triangle-fill alert-icon"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="alert-card alert-card-medium">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="alert-card-label">Medium</div>
                        <div class="alert-card-value"><span id="mediumCves">-</span> <small class="text-muted fw-normal" style="font-size: 0.9rem;">(<span id="mediumCount">-</span>)</small></div>
                        <small class="text-muted">CVEs (matches)</small>
                    </div>
                    <i class="bi bi-info-circle-fill alert-icon"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="alert-card alert-card-low">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="alert-card-label">Low</div>
                        <div class="alert-card-value"><span id="lowCves">-</span> <small class="text-muted fw-normal" style="font-size: 0.9rem;">(<span id="lowCount">-</span>)</small></div>
                        <small class="text-muted">CVEs (matches)</small>
                    </div>
                    <i class="bi bi-shield-check alert-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-2 mb-3" id="statsContainer">
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card stat-card-compact" style="border-left-color: #3b82f6;">
                <div class="card-body py-2 px-3 position-relative">
                    <i class="bi bi-database stat-icon-sm"></i>
                    <div class="stat-label-sm text-uppercase">Total Vulnerabilities</div>
                    <div class="stat-value-sm text-primary" id="totalVulns">-</div>
                    <small class="text-muted" style="font-size: 0.75rem;">In CISA KEV Catalog</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card stat-card-compact" style="border-left-color: #ef4444;">
                <div class="card-body py-2 px-3 position-relative">
                    <i class="bi bi-exclamation-triangle stat-icon-sm"></i>
                    <div class="stat-label-sm text-uppercase">Affecting Products</div>
                    <div class="stat-value-sm text-danger" id="totalMatches">-</div>
                    <small class="text-muted" style="font-size: 0.75rem;">Direct matches found</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card stat-card-compact" style="border-left-color: #f59e0b;">
                <div class="card-body py-2 px-3 position-relative">
                    <i class="bi bi-clock-history stat-icon-sm"></i>
                    <div class="stat-label-sm text-uppercase">Needs Review</div>
                    <div class="stat-value-sm text-warning" id="unacknowledged">-</div>
                    <small class="text-muted" style="font-size: 0.75rem;">Unacknowledged items</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card stat-card-compact" style="border-left-color: #10b981;">
                <div class="card-body py-2 px-3 position-relative">
                    <i class="bi bi-gear-fill stat-icon-sm"></i>
                    <div class="stat-label-sm text-uppercase">Products Tracked</div>
                    <div class="stat-value-sm text-success" id="productsTracked">-</div>
                    <small class="text-muted" style="font-size: 0.75rem;">Active inventory</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Unmapped Products Warning -->
    <div id="unmappedWarning" class="alert alert-warning d-none mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong><span id="unmappedCount">0</span> products without CPE mapping</strong> -
        These cannot be checked for vulnerabilities.
        <a href="/admin#products" class="alert-link">Review and assign CPE mappings</a> to ensure complete coverage.
    </div>

    <!-- Advanced Filters Panel -->
    <div class="card mb-3">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span><i class="bi bi-funnel me-2"></i>Filters</span>
            <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="resetFilters()">
                <i class="bi bi-arrow-counterclockwise"></i> Reset
            </button>
        </div>
        <div class="card-body py-2 filters-compact">
            <div class="row g-2">
                <div class="col-6 col-md-2">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="filterPriority">
                        <option value="">All</option>
                        <option value="critical">Critical</option>
                        <option value="high">High+</option>
                        <option value="medium">Medium+</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Severity</label>
                    <select class="form-select" id="filterSeverity">
                        <option value="">All</option>
                        <option value="CRITICAL">Critical</option>
                        <option value="HIGH">High</option>
                        <option value="MEDIUM">Medium</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Urgency</label>
                    <select class="form-select" id="filterUrgency">
                        <option value="">All</option>
                        <option value="critical">≤7 Days</option>
                        <option value="high">≤30 Days</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Age</label>
                    <select class="form-select" id="filterAge">
                        <option value="">All</option>
                        <option value="30">30 Days</option>
                        <option value="90">90 Days</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">CVE ID</label>
                    <input type="text" class="form-control" id="filterCVE" placeholder="CVE-...">
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Sort</label>
                    <select class="form-select" id="sortBy">
                        <option value="priority">Priority</option>
                        <option value="date_desc">Newest</option>
                        <option value="date_asc">Oldest</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Vendor</label>
                    <input type="text" class="form-control" id="filterVendor" placeholder="Microsoft">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Product</label>
                    <input type="text" class="form-control" id="filterProduct" placeholder="Windows">
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-3 align-items-center h-100">
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="filterRansomware">
                            <label class="form-check-label" for="filterRansomware">Ransomware</label>
                        </div>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="filterUnack">
                            <label class="form-check-label" for="filterUnack">Unacknowledged</label>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="loadGroupedVulnerabilities()">
                            <i class="bi bi-search"></i> Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vulnerabilities List -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span><i class="bi bi-shield-exclamation me-2"></i>Vulnerabilities (<span id="vulnCount">0</span> CVEs)</span>
            <div class="d-flex align-items-center gap-3">
                <!-- Export Report Dropdown -->
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Export Report">
                        <i class="bi bi-file-earmark-pdf me-1"></i>Export
                    </button>
                    <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 280px;">
                        <h6 class="dropdown-header px-0">Export PDF Report</h6>
                        <div class="mb-2">
                            <select class="form-select form-select-sm" id="reportType" onchange="toggleReportDateFields()">
                                <option value="monthly">Monthly Report</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                        </div>
                        <div class="row g-2 mb-2" id="monthlyFields">
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="reportMonth">
                                    <option value="1">Jan</option>
                                    <option value="2">Feb</option>
                                    <option value="3">Mar</option>
                                    <option value="4">Apr</option>
                                    <option value="5">May</option>
                                    <option value="6">Jun</option>
                                    <option value="7">Jul</option>
                                    <option value="8">Aug</option>
                                    <option value="9">Sep</option>
                                    <option value="10">Oct</option>
                                    <option value="11">Nov</option>
                                    <option value="12">Dec</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="reportYear"></select>
                            </div>
                        </div>
                        <div class="row g-2 mb-2" id="customFields" style="display: none;">
                            <div class="col-6">
                                <input type="date" class="form-control form-control-sm" id="reportStartDate" placeholder="Start">
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control form-control-sm" id="reportEndDate" placeholder="End">
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm w-100" onclick="exportReport()">
                            <i class="bi bi-download me-1"></i>Download PDF
                        </button>
                    </div>
                </div>
                <!-- Sort By -->
                <select class="form-select form-select-sm" id="sortBy" style="width: auto;" onchange="loadVulnerabilities()" title="Sort by">
                    <option value="priority-asc">Priority (Critical first)</option>
                    <option value="priority-desc">Priority (Low first)</option>
                    <option value="cve-asc">CVE ID (A-Z)</option>
                    <option value="cve-desc">CVE ID (Z-A)</option>
                    <option value="product-asc">Product (A-Z)</option>
                    <option value="product-desc">Product (Z-A)</option>
                    <option value="due-asc">Due Date (Soonest)</option>
                    <option value="due-desc">Due Date (Latest)</option>
                    <option value="date-asc">Date Added (Oldest)</option>
                    <option value="date-desc">Date Added (Newest)</option>
                </select>
                <!-- Page Size -->
                <select class="form-select form-select-sm" id="pageSize" style="width: 75px;" onchange="changePageSize()" title="Items per page">
                    <option value="15" selected>15</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="all">All</option>
                </select>
                <div class="form-check mb-0">
                    <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                    <label class="form-check-label" for="selectAll">Select All</label>
                </div>
            </div>
        </div>
        <!-- Bulk Actions Toolbar (hidden until selection made) -->
        <div id="bulkActionsBar" class="card-body bg-primary bg-opacity-10 border-bottom py-2" style="display: none;">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-primary"><span id="selectedCount">0</span> selected</span>
                    <button class="btn btn-sm btn-success" id="bulkAckBtn" onclick="bulkAcknowledge()" disabled>
                        <i class="bi bi-check-circle me-1"></i>Acknowledge
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-warning dropdown-toggle" id="bulkSnoozeBtn" data-bs-toggle="dropdown" disabled>
                            <i class="bi bi-clock me-1"></i>Snooze
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="bulkSnooze(24); return false;">24 hours</a></li>
                            <li><a class="dropdown-item" href="#" onclick="bulkSnooze(72); return false;">3 days</a></li>
                            <li><a class="dropdown-item" href="#" onclick="bulkSnooze(168); return false;">1 week</a></li>
                        </ul>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" id="bulkUnackBtn" onclick="bulkUnacknowledge()" disabled>
                        <i class="bi bi-x-circle me-1"></i>Unacknowledge
                    </button>
                    <button class="btn btn-sm btn-outline-primary" id="bulkExportBtn" onclick="bulkExport()" disabled>
                        <i class="bi bi-download me-1"></i>Export Selected
                    </button>
                </div>
                <button class="btn btn-sm btn-link text-decoration-none" onclick="clearSelection()">
                    <i class="bi bi-x me-1"></i>Clear Selection
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="vulnerabilitiesContainer" class="p-3"></div>
            <!-- Pagination Controls -->
            <div id="paginationControls" class="d-flex justify-content-between align-items-center p-3 border-top" style="display: none !important;">
                <div class="text-muted small" id="paginationInfo">Showing 1-50 of 0</div>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="paginationNav"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Last Sync Info -->
    <div class="card mt-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Last Synchronization</h6>
                    <p class="text-muted mb-0 mt-1" id="lastSync">Loading...</p>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-outline-primary" onclick="viewSyncHistory()">
                        <i class="bi bi-clock-history"></i> View Sync History
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sync History Modal -->
<div class="modal fade" id="syncHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-clock-history me-2"></i>Synchronization History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Status</th>
                                <th>Vulnerabilities</th>
                                <th>Matches Found</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody id="syncHistoryTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Filtered View Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Share Filtered View</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name (Optional)</label>
                        <input type="text" class="form-control" id="shareName" placeholder="e.g., Critical Windows Vulnerabilities">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="shareDescription" rows="2" placeholder="Brief description of this filtered view"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Link Expiration</label>
                        <select class="form-select" id="shareExpiration">
                            <option value="">Never expires</option>
                            <option value="7">7 days</option>
                            <option value="30" selected>30 days</option>
                            <option value="90">90 days</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Current Filters:</strong>
                        <div id="shareFiltersSummary" class="mt-2 small">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    <div id="shareResult" style="display: none;">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Shareable link created!</strong>
                            <div class="input-group mt-2">
                                <input type="text" class="form-control" id="shareUrl" readonly>
                                <button class="btn btn-outline-secondary" onclick="copyShareUrl()">
                                    <i class="bi bi-clipboard"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="createShareLink()" id="createShareBtn">
                        <i class="bi bi-share"></i> Create Share Link
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Helper functions for priority styling
    function getPriorityBadgeClass(priority) {
        const classes = {
            'critical': 'bg-danger',
            'high': 'bg-warning text-dark',
            'medium': 'bg-info text-dark',
            'low': 'bg-secondary'
        };
        return classes[priority?.toLowerCase()] || 'bg-secondary';
    }

    function getPriorityIcon(priority) {
        const icons = {
            'critical': 'bi-exclamation-triangle-fill',
            'high': 'bi-exclamation-circle-fill',
            'medium': 'bi-info-circle-fill',
            'low': 'bi-dash-circle'
        };
        return icons[priority?.toLowerCase()] || 'bi-circle';
    }

    function getPriorityColor(priority) {
        const colors = {
            'critical': '#dc2626',
            'high': '#f59e0b',
            'medium': '#3b82f6',
            'low': '#6b7280'
        };
        return colors[priority?.toLowerCase()] || '#6b7280';
    }

    // Report Export Functions
    function initReportFields() {
        // Populate year dropdown
        const yearSelect = document.getElementById('reportYear');
        const currentYear = new Date().getFullYear();
        for (let year = currentYear; year >= currentYear - 5; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }

        // Set current month and year
        const currentMonth = new Date().getMonth() + 1;
        document.getElementById('reportMonth').value = currentMonth;

        // Set default date range for custom reports (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);

        document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
        document.getElementById('reportStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    }

    function toggleReportDateFields() {
        const reportType = document.getElementById('reportType').value;
        const monthlyFields = document.getElementById('monthlyFields');
        const customFields = document.getElementById('customFields');

        if (reportType === 'monthly') {
            monthlyFields.style.display = 'flex';
            customFields.style.display = 'none';
        } else {
            monthlyFields.style.display = 'none';
            customFields.style.display = 'flex';
        }
    }

    async function exportReport() {
        const reportType = document.getElementById('reportType').value;
        let url;

        if (reportType === 'monthly') {
            const month = document.getElementById('reportMonth').value;
            const year = document.getElementById('reportYear').value;
            url = `/api/reports/monthly?month=${month}&year=${year}`;
        } else {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            if (!startDate || !endDate) {
                showToast('Please select both start and end dates', 'warning');
                return;
            }

            url = `/api/reports/custom?start_date=${startDate}&end_date=${endDate}`;
        }

        try {
            showLoading();
            showToast('Generating report...', 'info');

            const response = await fetch(url);

            if (!response.ok) {
                // Try to parse error as JSON, fallback to status text
                let errorMessage = 'Failed to generate report';
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        errorMessage = error.error || errorMessage;
                    } else {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                } catch (e) {
                    errorMessage = `Server error: ${response.status}`;
                }
                throw new Error(errorMessage);
            }

            // Download the PDF
            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;

            // Get filename from Content-Disposition header or generate one
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'SentriKat_Report.pdf';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename="(.+)"/);
                if (match) filename = match[1];
            }

            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(downloadUrl);

            showToast('Report downloaded successfully!', 'success');
        } catch (error) {
            console.error('Error generating report:', error);
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    // Initialize report fields on page load
    document.addEventListener('DOMContentLoaded', function() {
        initReportFields();
    });

    // Retry utility for API calls during startup
    async function fetchWithRetry(url, options = {}, maxRetries = 3, delayMs = 800) {
        let lastError;
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const response = await fetch(url, options);
                if (response.status >= 500 && attempt < maxRetries) {
                    console.warn(`[Retry ${attempt}/${maxRetries}] Server error ${response.status} for ${url}`);
                    await new Promise(r => setTimeout(r, delayMs * attempt));
                    continue;
                }
                return response;
            } catch (error) {
                lastError = error;
                console.warn(`[Retry ${attempt}/${maxRetries}] Network error for ${url}: ${error.message}`);
                if (attempt < maxRetries) {
                    await new Promise(r => setTimeout(r, delayMs * attempt));
                }
            }
        }
        throw lastError || new Error(`Failed to fetch ${url} after ${maxRetries} attempts`);
    }

    let currentVulnerabilities = [];
    let currentGroupedVulnerabilities = [];
    let selectedVulns = new Set();
    let currentPage = 1;
    let pageSize = 15;

    function changePageSize() {
        const select = document.getElementById('pageSize');
        pageSize = select.value === 'all' ? Infinity : parseInt(select.value);
        currentPage = 1;
        renderCurrentPage();
    }

    function goToPage(page) {
        currentPage = page;
        renderCurrentPage();
        // Scroll to top of vulnerabilities container
        document.getElementById('vulnerabilitiesContainer').scrollIntoView({ behavior: 'smooth' });
    }

    function renderCurrentPage() {
        const container = document.getElementById('vulnerabilitiesContainer');
        const total = currentVulnerabilities.length;

        if (total === 0) {
            // Check if we have any products tracked
            const productsTracked = document.getElementById('productsTracked').textContent;
            const hasProducts = productsTracked && productsTracked !== '-' && parseInt(productsTracked) > 0;

            if (!hasProducts) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-box-seam text-primary" style="font-size: 4rem;"></i>
                        <h4 class="mt-3">No Products Configured</h4>
                        <p class="text-muted">Add products to your inventory to start tracking vulnerabilities.</p>
                        <a href="/products" class="btn btn-primary mt-2">
                            <i class="bi bi-plus-circle me-2"></i>Add Products
                        </a>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-shield-check text-success" style="font-size: 4rem;"></i>
                        <h4 class="mt-3">No Vulnerabilities Found</h4>
                        <p class="text-muted">No matches found with the current filter criteria. Your tracked products appear to be secure!</p>
                    </div>
                `;
            }
            document.getElementById('paginationControls').style.display = 'none';
            return;
        }

        const effectivePageSize = pageSize === Infinity ? total : pageSize;
        const totalPages = Math.ceil(total / effectivePageSize);
        const startIdx = (currentPage - 1) * effectivePageSize;
        const endIdx = Math.min(startIdx + effectivePageSize, total);
        const pageItems = currentVulnerabilities.slice(startIdx, endIdx);

        // Use requestAnimationFrame for smoother rendering
        requestAnimationFrame(() => {
            // Build HTML in chunks to prevent blocking
            const fragment = document.createDocumentFragment();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = pageItems.map(match => createVulnCard(match)).join('');

            while (tempDiv.firstChild) {
                fragment.appendChild(tempDiv.firstChild);
            }

            container.innerHTML = '';
            container.appendChild(fragment);
        });

        // Update pagination info and controls
        const paginationControls = document.getElementById('paginationControls');
        const paginationInfo = document.getElementById('paginationInfo');
        const paginationNav = document.getElementById('paginationNav');

        if (totalPages > 1) {
            paginationControls.style.display = 'flex';
            paginationInfo.textContent = `Showing ${startIdx + 1}-${endIdx} of ${total}`;

            // Build pagination nav
            let navHtml = '';

            // Previous button
            navHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">&laquo;</a>
            </li>`;

            // Page numbers (show max 5 pages around current)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                navHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1); return false;">1</a></li>`;
                if (startPage > 2) navHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                navHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
                </li>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) navHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                navHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${totalPages}); return false;">${totalPages}</a></li>`;
            }

            // Next button
            navHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">&raquo;</a>
            </li>`;

            paginationNav.innerHTML = navHtml;
        } else {
            paginationControls.style.display = 'none';
        }
    }

    async function loadStats() {
        try {
            const response = await fetchWithRetry('/api/vulnerabilities/stats', {}, 4, 1000);

            // Check if response is OK before parsing
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`Server error: ${response.status}`);
            }

            const stats = await response.json();

            document.getElementById('totalVulns').textContent = formatNumber(stats.total_vulnerabilities);
            document.getElementById('totalMatches').textContent = formatNumber(stats.total_matches);
            document.getElementById('unacknowledged').textContent = formatNumber(stats.unacknowledged_cves || stats.unacknowledged);
            document.getElementById('productsTracked').textContent = formatNumber(stats.products_tracked);

            // Show/hide unmapped products warning
            const unmappedWarning = document.getElementById('unmappedWarning');
            const unmappedCount = document.getElementById('unmappedCount');
            if (unmappedWarning && stats.products_unmapped > 0) {
                unmappedCount.textContent = stats.products_unmapped;
                unmappedWarning.classList.remove('d-none');
            } else if (unmappedWarning) {
                unmappedWarning.classList.add('d-none');
            }

            // Update priority counts - CVE counts and match counts
            document.getElementById('criticalCves').textContent = formatNumber(stats.critical_cves || 0);
            document.getElementById('criticalCount').textContent = formatNumber(stats.critical_count || 0);
            document.getElementById('highCves').textContent = formatNumber(stats.high_cves || 0);
            document.getElementById('highCount').textContent = formatNumber(stats.high_count || 0);
            document.getElementById('mediumCves').textContent = formatNumber(stats.medium_cves || 0);
            document.getElementById('mediumCount').textContent = formatNumber(stats.medium_count || 0);
            document.getElementById('lowCves').textContent = formatNumber(stats.low_cves || 0);
            document.getElementById('lowCount').textContent = formatNumber(stats.low_count || 0);
        } catch (error) {
            console.error('Error loading stats:', error);
            // Show error in cards instead of just toast
            document.getElementById('totalVulns').textContent = '-';
            document.getElementById('totalMatches').textContent = '-';
            document.getElementById('unacknowledged').textContent = '-';
            document.getElementById('productsTracked').textContent = '-';
            document.getElementById('criticalCves').textContent = '-';
            document.getElementById('criticalCount').textContent = '-';
            document.getElementById('highCves').textContent = '-';
            document.getElementById('highCount').textContent = '-';
            document.getElementById('mediumCves').textContent = '-';
            document.getElementById('mediumCount').textContent = '-';
            document.getElementById('lowCves').textContent = '-';
            document.getElementById('lowCount').textContent = '-';
            showToast('Failed to load statistics. Try refreshing.', 'danger');
        }
    }

    async function loadVulnerabilities() {
        showLoading();
        const container = document.getElementById('vulnerabilitiesContainer');
        selectedVulns.clear();
        updateBulkActions();

        try {
            const params = new URLSearchParams();
            const cve = document.getElementById('filterCVE').value;
            const vendor = document.getElementById('filterVendor').value;
            const product = document.getElementById('filterProduct').value;
            const ransomware = document.getElementById('filterRansomware').checked;
            const unack = document.getElementById('filterUnack').checked;

            if (cve) params.append('cve_id', cve);
            if (vendor) params.append('vendor', vendor);
            if (product) params.append('product', product);
            if (ransomware) params.append('ransomware_only', 'true');
            if (unack) params.append('acknowledged', 'false');

            const response = await fetchWithRetry(`/api/vulnerabilities?${params}`, {}, 3, 1000);

            // Check if response is OK before parsing
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`Server error: ${response.status}`);
            }

            currentVulnerabilities = await response.json();

            // Apply client-side filtering for priority and age
            applyClientFilters();

            // Apply sorting
            sortVulnerabilities();

            document.getElementById('vulnCount').textContent = currentVulnerabilities.length;

            // Reset to page 1 and render
            currentPage = 1;
            renderCurrentPage();
        } catch (error) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Error loading vulnerabilities: ${error.message}
                </div>
            `;
        } finally {
            hideLoading();
        }
    }

    function applyClientFilters() {
        // Filter by priority
        const priorityFilter = document.getElementById('filterPriority').value;
        if (priorityFilter) {
            const priorityOrder = {'critical': 4, 'high': 3, 'medium': 2, 'low': 1};
            const minLevel = priorityOrder[priorityFilter];
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const effectivePriority = match.effective_priority;
                return priorityOrder[effectivePriority] >= minLevel;
            });
        }

        // Filter by CVE severity (from CVSS score)
        const severityFilter = document.getElementById('filterSeverity').value;
        if (severityFilter) {
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const vuln = match.vulnerability;
                return vuln.severity === severityFilter;
            });
        }

        // Filter by CISA urgency (based on due date)
        const urgencyFilter = document.getElementById('filterUrgency').value;
        if (urgencyFilter) {
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const vuln = match.vulnerability;

                // If urgency filter is active, CVEs MUST have a due date
                if (!vuln.due_date) {
                    return false;
                }

                // Calculate days until due
                const today = new Date();
                const dueDate = new Date(vuln.due_date);
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                switch(urgencyFilter) {
                    case 'critical':
                        // Critical: Due within 7 days OR ransomware
                        return daysUntilDue <= 7 || vuln.known_ransomware;
                    case 'high':
                        // High: Due within 30 days
                        return daysUntilDue <= 30;
                    case 'has_due_date':
                        // Any CVE with a due date
                        return true;
                    default:
                        return true;
                }
            });
        }

        // Filter by age
        const ageFilter = document.getElementById('filterAge').value;
        if (ageFilter) {
            const maxDays = parseInt(ageFilter);
            currentVulnerabilities = currentVulnerabilities.filter(match => {
                const daysOld = match.vulnerability.days_old || 0;
                return daysOld <= maxDays;
            });
        }
    }

    function sortVulnerabilities() {
        const sortBy = document.getElementById('sortBy')?.value || 'priority-asc';
        const priorityOrder = {'critical': 4, 'high': 3, 'medium': 2, 'low': 1};

        switch(sortBy) {
            case 'priority-asc': // Critical first
                currentVulnerabilities.sort((a, b) => {
                    const priorityDiff = priorityOrder[b.effective_priority] - priorityOrder[a.effective_priority];
                    if (priorityDiff !== 0) return priorityDiff;
                    return new Date(b.vulnerability.date_added) - new Date(a.vulnerability.date_added);
                });
                break;
            case 'priority-desc': // Low first
                currentVulnerabilities.sort((a, b) => {
                    const priorityDiff = priorityOrder[a.effective_priority] - priorityOrder[b.effective_priority];
                    if (priorityDiff !== 0) return priorityDiff;
                    return new Date(a.vulnerability.date_added) - new Date(b.vulnerability.date_added);
                });
                break;
            case 'cve-asc':
                currentVulnerabilities.sort((a, b) =>
                    a.vulnerability.cve_id.localeCompare(b.vulnerability.cve_id));
                break;
            case 'cve-desc':
                currentVulnerabilities.sort((a, b) =>
                    b.vulnerability.cve_id.localeCompare(a.vulnerability.cve_id));
                break;
            case 'product-asc':
                currentVulnerabilities.sort((a, b) => {
                    const aName = `${a.product?.vendor || ''} ${a.product?.product_name || ''}`.trim().toLowerCase();
                    const bName = `${b.product?.vendor || ''} ${b.product?.product_name || ''}`.trim().toLowerCase();
                    return aName.localeCompare(bName);
                });
                break;
            case 'product-desc':
                currentVulnerabilities.sort((a, b) => {
                    const aName = `${a.product?.vendor || ''} ${a.product?.product_name || ''}`.trim().toLowerCase();
                    const bName = `${b.product?.vendor || ''} ${b.product?.product_name || ''}`.trim().toLowerCase();
                    return bName.localeCompare(aName);
                });
                break;
            case 'due-asc': // Soonest first
                currentVulnerabilities.sort((a, b) => {
                    const aDue = a.vulnerability.due_date ? new Date(a.vulnerability.due_date) : new Date('2999-12-31');
                    const bDue = b.vulnerability.due_date ? new Date(b.vulnerability.due_date) : new Date('2999-12-31');
                    return aDue - bDue;
                });
                break;
            case 'due-desc': // Latest first
                currentVulnerabilities.sort((a, b) => {
                    const aDue = a.vulnerability.due_date ? new Date(a.vulnerability.due_date) : new Date('1970-01-01');
                    const bDue = b.vulnerability.due_date ? new Date(b.vulnerability.due_date) : new Date('1970-01-01');
                    return bDue - aDue;
                });
                break;
            case 'date-asc': // Oldest first
                currentVulnerabilities.sort((a, b) =>
                    new Date(a.vulnerability.date_added) - new Date(b.vulnerability.date_added));
                break;
            case 'date-desc': // Newest first
                currentVulnerabilities.sort((a, b) =>
                    new Date(b.vulnerability.date_added) - new Date(a.vulnerability.date_added));
                break;
        }
    }

    function createVulnCard(match) {
        const vuln = match.vulnerability;
        const product = match.product;
        const priority = match.effective_priority;

        const ransomwareBadge = vuln.known_ransomware ?
            '<span class="badge badge-critical"><i class="bi bi-shield-exclamation"></i> Ransomware</span>' : '';
        const ackBadge = match.acknowledged ?
            '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Acknowledged</span>' :
            '<span class="badge bg-warning text-dark"><i class="bi bi-circle"></i> Needs Review</span>';
        const priorityBadge = `<span class="badge ${getPriorityBadgeClass(priority)}"><i class="bi ${getPriorityIcon(priority)}"></i> ${priority.toUpperCase()} Severity</span>`;

        // CVSS Severity Badge
        const severityBadge = vuln.severity ?
            `<span class="badge ${getPriorityBadgeClass(vuln.severity.toLowerCase())}"><i class="bi bi-graph-up"></i> CVSS: ${vuln.severity} ${vuln.cvss_score ? `(${vuln.cvss_score})` : ''}</span>` :
            '<span class="badge bg-secondary"><i class="bi bi-question-circle"></i> No CVSS Data</span>';

        return `
            <div class="card vuln-card mb-3" id="match-${match.id}" style="border-left: 4px solid ${getPriorityColor(priority)};">
                <div class="card-body">
                    <div class="row">
                        <div class="col-auto">
                            <input class="form-check-input" type="checkbox" value="${match.id}"
                                   onchange="toggleSelection(${match.id}, this.checked)">
                        </div>
                        <div class="col">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="card-title mb-2">
                                        <span class="badge bg-dark">${vuln.cve_id}</span>
                                        ${vuln.vulnerability_name}
                                    </h5>
                                    <div class="mb-2">
                                        ${priorityBadge}
                                        ${severityBadge}
                                        ${ransomwareBadge}
                                        ${ackBadge}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-calendar3"></i> Added: ${formatDate(vuln.date_added)} (${vuln.days_old} days ago)
                                        </span>
                                        ${vuln.due_date ? `<span class="badge bg-danger">
                                            <i class="bi bi-alarm"></i> Due: ${formatDate(vuln.due_date)}
                                        </span>` : ''}
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <small class="text-muted fw-semibold">AFFECTED PRODUCT</small>
                                    <p class="mb-0"><strong>${vuln.vendor_project}</strong> - ${vuln.product}</p>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted fw-semibold">YOUR PRODUCT</small>
                                    <p class="mb-0">
                                        <strong>${product.vendor}</strong> - ${product.product_name}
                                        ${product.version ? `<span class="badge bg-info">v${product.version}</span>` : ''}
                                    </p>
                                </div>
                            </div>

                            <div class="mb-2">
                                <small class="text-muted fw-semibold">DESCRIPTION</small>
                                <p class="mb-0">${vuln.short_description}</p>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted fw-semibold">REQUIRED ACTION</small>
                                <p class="mb-0 fw-medium text-danger">${vuln.required_action}</p>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted fw-semibold">MATCH REASON</small>
                                <p class="mb-0 text-primary">${match.match_reason}</p>
                            </div>

                            <div class="btn-group" role="group">
                                ${!match.acknowledged ?
                                    `<button class="btn btn-sm btn-success" onclick="acknowledgeMatch(${match.id})">
                                        <i class="bi bi-check-circle"></i> Acknowledge
                                    </button>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="bi bi-clock"></i> Snooze
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="snoozeMatch(${match.id}, 24); return false;">24 hours</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="snoozeMatch(${match.id}, 72); return false;">3 days</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="snoozeMatch(${match.id}, 168); return false;">1 week</a></li>
                                        </ul>
                                    </div>` :
                                    `<button class="btn btn-sm btn-outline-secondary" onclick="unacknowledgeMatch(${match.id})">
                                        <i class="bi bi-arrow-counterclockwise"></i> Unacknowledge
                                    </button>`
                                }
                                <a href="https://nvd.nist.gov/vuln/detail/${vuln.cve_id}" target="_blank"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-box-arrow-up-right"></i> View in NVD
                                </a>
                                <button class="btn btn-sm btn-outline-info" onclick="shareSingleCVE('${vuln.cve_id}', '${escapeHtml(vuln.vulnerability_name)}')">
                                    <i class="bi bi-share"></i> Share
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function toggleSelection(matchId, selected) {
        if (selected) {
            selectedVulns.add(matchId);
        } else {
            selectedVulns.delete(matchId);
            document.getElementById('selectAll').checked = false;
        }
        updateBulkActions();
    }

    function toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll('.vuln-card input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = checkbox.checked;
            const matchId = parseInt(cb.value);
            if (checkbox.checked) {
                selectedVulns.add(matchId);
            } else {
                selectedVulns.delete(matchId);
            }
        });
        updateBulkActions();
    }

    function updateBulkActions() {
        const count = selectedVulns.size;
        const bulkActionsBar = document.getElementById('bulkActionsBar');
        const selectedCountEl = document.getElementById('selectedCount');
        const bulkAckBtnEl = document.getElementById('bulkAckBtn');
        const bulkUnackBtnEl = document.getElementById('bulkUnackBtn');
        const bulkExportBtnEl = document.getElementById('bulkExportBtn');
        const bulkSnoozeBtnEl = document.getElementById('bulkSnoozeBtn');

        // Show/hide bulk actions bar
        if (bulkActionsBar) {
            bulkActionsBar.style.display = count > 0 ? 'block' : 'none';
        }

        if (selectedCountEl) selectedCountEl.textContent = count;
        if (bulkAckBtnEl) bulkAckBtnEl.disabled = count === 0;
        if (bulkUnackBtnEl) bulkUnackBtnEl.disabled = count === 0;
        if (bulkExportBtnEl) bulkExportBtnEl.disabled = count === 0;
        if (bulkSnoozeBtnEl) bulkSnoozeBtnEl.disabled = count === 0;
    }

    function clearSelection() {
        selectedVulns.clear();
        document.querySelectorAll('.vuln-card input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        document.getElementById('selectAll').checked = false;
        updateBulkActions();
    }

    async function bulkAcknowledge() {
        if (selectedVulns.size === 0) return;

        const confirmed = await showConfirm(
            `Acknowledge ${selectedVulns.size} vulnerabilities?`,
            'Bulk Acknowledge',
            'Acknowledge',
            'btn-primary'
        );

        if (!confirmed) return;

        showLoading();
        let success = 0;
        let failed = 0;

        for (const matchId of selectedVulns) {
            try {
                await fetch(`/api/matches/${matchId}/acknowledge`, { method: 'POST' });
                success++;
            } catch {
                failed++;
            }
        }

        hideLoading();
        showToast(`Acknowledged ${success} vulnerabilities${failed > 0 ? `, ${failed} failed` : ''}`, success > 0 ? 'success' : 'danger');
        selectedVulns.clear();
        updateBulkActions();
        loadVulnerabilities();
        loadStats();

    }

    async function bulkUnacknowledge() {
        if (selectedVulns.size === 0) return;

        const confirmed = await showConfirm(
            `Unacknowledge ${selectedVulns.size} vulnerabilities?`,
            'Bulk Unacknowledge',
            'Unacknowledge',
            'btn-secondary'
        );

        if (!confirmed) return;

        showLoading();
        let success = 0;
        let failed = 0;

        for (const matchId of selectedVulns) {
            try {
                await fetch(`/api/matches/${matchId}/unacknowledge`, { method: 'POST' });
                success++;
            } catch {
                failed++;
            }
        }

        hideLoading();
        showToast(`Unacknowledged ${success} vulnerabilities${failed > 0 ? `, ${failed} failed` : ''}`, success > 0 ? 'info' : 'danger');
        selectedVulns.clear();
        updateBulkActions();
        loadVulnerabilities();
        loadStats();
    }

    async function bulkSnooze(hours) {
        if (selectedVulns.size === 0) return;

        const timeLabel = hours >= 168 ? '1 week' : hours >= 72 ? '3 days' : '24 hours';
        const confirmed = await showConfirm(
            `Snooze ${selectedVulns.size} vulnerabilities for ${timeLabel}?`,
            'Bulk Snooze',
            'Snooze',
            'btn-warning'
        );

        if (!confirmed) return;

        showLoading();
        let success = 0;
        let failed = 0;

        for (const matchId of selectedVulns) {
            try {
                const response = await fetch(`/api/matches/${matchId}/snooze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hours: hours })
                });
                if (response.ok) {
                    success++;
                } else {
                    failed++;
                }
            } catch {
                failed++;
            }
        }

        hideLoading();
        showToast(`Snoozed ${success} vulnerabilities for ${timeLabel}${failed > 0 ? `, ${failed} failed` : ''}`, success > 0 ? 'warning' : 'danger');
        selectedVulns.clear();
        updateBulkActions();
        loadVulnerabilities();
    }

    async function bulkExport() {
        if (selectedVulns.size === 0) return;

        showLoading();
        try {
            // Get match IDs as comma-separated list
            const matchIds = Array.from(selectedVulns).join(',');

            // Trigger PDF export with selected match IDs
            const response = await fetch(`/api/reports/export?match_ids=${matchIds}`);

            if (!response.ok) {
                throw new Error('Export failed');
            }

            // Download the PDF
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vulnerabilities_selected_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

            showToast(`Exported ${selectedVulns.size} vulnerabilities to PDF`, 'success');
        } catch (error) {
            showToast(`Export failed: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function acknowledgeMatch(matchId) {
        try {
            await fetch(`/api/matches/${matchId}/acknowledge`, { method: 'POST' });
            showToast('✓ Vulnerability acknowledged', 'success');
            loadVulnerabilities();
            loadStats();
        } catch (error) {
            showToast(`✗ Error: ${error.message}`, 'danger');
        }
    }

    async function unacknowledgeMatch(matchId) {
        try {
            await fetch(`/api/matches/${matchId}/unacknowledge`, { method: 'POST' });
            showToast('Vulnerability unacknowledged', 'info');
            loadVulnerabilities();
            loadStats();
        } catch (error) {
            showToast(`✗ Error: ${error.message}`, 'danger');
        }
    }

    async function snoozeMatch(matchId, hours) {
        try {
            const response = await fetch(`/api/matches/${matchId}/snooze`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hours: hours })
            });
            if (!response.ok) throw new Error('Failed to snooze');
            const data = await response.json();
            const snoozeUntil = new Date(data.snoozed_until);
            showToast(`✓ Snoozed until ${snoozeUntil.toLocaleString()}`, 'warning');
            loadVulnerabilities();
        } catch (error) {
            showToast(`✗ Error: ${error.message}`, 'danger');
        }
    }

    async function loadLastSync() {
        try {
            const response = await fetch('/api/sync/status');
            const sync = await response.json();

            if (sync.sync_date) {
                const date = new Date(sync.sync_date);
                const statusBadge = sync.status === 'success' ?
                    '<span class="badge bg-success">Success</span>' :
                    '<span class="badge bg-danger">Failed</span>';
                document.getElementById('lastSync').innerHTML = `
                    ${date.toLocaleString()} ${statusBadge} |
                    ${sync.matches_found || 0} matches found in ${(sync.duration_seconds || 0).toFixed(2)}s
                `;
            }
        } catch (error) {
            console.error('Error loading sync status:', error);
        }
    }

    async function viewSyncHistory() {
        try {
            const response = await fetch('/api/sync/history?limit=20');
            const history = await response.json();

            const tbody = document.getElementById('syncHistoryTable');
            tbody.innerHTML = history.map(sync => {
                const date = new Date(sync.sync_date);
                const statusBadge = sync.status === 'success' ?
                    '<span class="badge bg-success">Success</span>' :
                    '<span class="badge bg-danger">Failed</span>';

                return `
                    <tr>
                        <td>${date.toLocaleString()}</td>
                        <td>${statusBadge}</td>
                        <td>${sync.vulnerabilities_count || 0}</td>
                        <td>${sync.matches_found || 0}</td>
                        <td>${(sync.duration_seconds || 0).toFixed(2)}s</td>
                    </tr>
                `;
            }).join('');

            bootstrap.Modal.getOrCreateInstance(document.getElementById('syncHistoryModal')).show();
        } catch (error) {
            showToast('Failed to load sync history', 'danger');
        }
    }

    function resetFilters() {
        document.getElementById('filterPriority').value = '';
        document.getElementById('filterSeverity').value = '';
        document.getElementById('filterUrgency').value = '';
        document.getElementById('filterAge').value = '';
        document.getElementById('filterCVE').value = '';
        document.getElementById('filterVendor').value = '';
        document.getElementById('filterProduct').value = '';
        document.getElementById('filterRansomware').checked = false;
        document.getElementById('filterUnack').checked = false;
        document.getElementById('sortBy').value = 'priority';
        loadVulnerabilities();
    }

    function exportData(format) {
        const data = currentVulnerabilities.map(match => ({
            priority: match.effective_priority,
            cve_id: match.vulnerability.cve_id,
            vulnerability_name: match.vulnerability.vulnerability_name,
            vendor_project: match.vulnerability.vendor_project,
            product: match.vulnerability.product,
            date_added: match.vulnerability.date_added,
            days_old: match.vulnerability.days_old,
            due_date: match.vulnerability.due_date,
            description: match.vulnerability.short_description,
            required_action: match.vulnerability.required_action,
            ransomware: match.vulnerability.known_ransomware,
            your_product: `${match.product.vendor} - ${match.product.product_name}`,
            acknowledged: match.acknowledged,
            match_reason: match.match_reason
        }));

        if (format === 'json') {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            downloadFile(blob, `sentrikat-vulnerabilities-${new Date().toISOString().split('T')[0]}.json`);
        } else if (format === 'csv') {
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            downloadFile(blob, `sentrikat-vulnerabilities-${new Date().toISOString().split('T')[0]}.csv`);
        }
        showToast(`✓ Exported ${data.length} vulnerabilities as ${format.toUpperCase()}`, 'success');
    }

    function convertToCSV(data) {
        if (data.length === 0) return '';
        const headers = Object.keys(data[0]).join(',');
        const rows = data.map(row =>
            Object.values(row).map(val =>
                `"${String(val).replace(/"/g, '""')}"`
            ).join(',')
        );
        return [headers, ...rows].join('\n');
    }

    function downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check for shared CVE in URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const sharedCVE = urlParams.get('cve');

        if (sharedCVE) {
            // Auto-fill CVE filter and apply
            document.getElementById('filterCVE').value = sharedCVE;
        }

        // Always use grouped view by default
        loadGroupedVulnerabilities();
        loadStats();
        loadLastSync();

        // Auto-refresh stats every 5 minutes
        setInterval(loadStats, 300000);
    });

    // Handle Enter key in filter inputs
    document.querySelectorAll('#filterCVE, #filterVendor, #filterProduct').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadGroupedVulnerabilities();
            }
        });
    });

    // Handle filter changes - use grouped view
    document.getElementById('filterPriority').addEventListener('change', loadGroupedVulnerabilities);
    document.getElementById('filterSeverity').addEventListener('change', loadGroupedVulnerabilities);
    document.getElementById('filterUrgency').addEventListener('change', loadGroupedVulnerabilities);
    document.getElementById('filterAge').addEventListener('change', loadGroupedVulnerabilities);

    // Handle sort change
    document.getElementById('sortBy').addEventListener('change', function() {
        if (currentGroupedVulnerabilities.length > 0) {
            loadGroupedVulnerabilities();
        }
    });

    // ============================================================================
    // Shared Filtered Views
    // ============================================================================

    /**
     * Get current filter state
     */
    function getCurrentFilters() {
        return {
            priority: document.getElementById('filterPriority').value,
            severity: document.getElementById('filterSeverity').value,
            urgency: document.getElementById('filterUrgency').value,
            age: document.getElementById('filterAge').value,
            cve: document.getElementById('filterCVE').value,
            vendor: document.getElementById('filterVendor').value,
            product: document.getElementById('filterProduct').value,
            ransomware: document.getElementById('filterRansomware').checked,
            unack: document.getElementById('filterUnack').checked
        };
    }

    /**
     * Show share modal with current filters
     */
    function shareFilteredView() {
        const filters = getCurrentFilters();

        // Build summary of active filters
        let summary = [];
        if (filters.priority) summary.push(`Priority: ${filters.priority}`);
        if (filters.severity) summary.push(`Severity: ${filters.severity}`);
        if (filters.urgency) summary.push(`Urgency: ${filters.urgency}`);
        if (filters.age) summary.push(`Age: ${filters.age}`);
        if (filters.cve) summary.push(`CVE: ${filters.cve}`);
        if (filters.vendor) summary.push(`Vendor: ${filters.vendor}`);
        if (filters.product) summary.push(`Product: ${filters.product}`);
        if (filters.ransomware) summary.push('Ransomware vulnerabilities only');
        if (filters.unack) summary.push('Unacknowledged only');

        if (summary.length === 0) {
            summary.push('No filters applied (all vulnerabilities)');
        }

        document.getElementById('shareFiltersSummary').innerHTML = summary.map(s => `• ${s}`).join('<br>');

        // Reset modal state
        document.getElementById('shareName').value = '';
        document.getElementById('shareDescription').value = '';
        document.getElementById('shareExpiration').value = '30';
        document.getElementById('shareResult').style.display = 'none';
        document.getElementById('createShareBtn').style.display = 'block';

        // Show modal
        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('shareModal'));
        modal.show();
    }

    /**
     * Create share link via API
     */
    async function createShareLink() {
        const btn = document.getElementById('createShareBtn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';

        try {
            const filters = getCurrentFilters();
            const name = document.getElementById('shareName').value;
            const description = document.getElementById('shareDescription').value;
            const expiresDays = document.getElementById('shareExpiration').value;

            const response = await fetch('/api/shared/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name || null,
                    description: description || null,
                    filters: filters,
                    is_public: true,
                    expires_days: expiresDays ? parseInt(expiresDays) : null
                })
            });

            if (response.ok) {
                const result = await response.json();
                document.getElementById('shareUrl').value = result.share_url;
                document.getElementById('shareResult').style.display = 'block';
                btn.style.display = 'none';
            } else {
                const error = await response.json();
                showToast(`Error creating share link: ${error.error}`, 'danger');
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        } catch (error) {
            console.error('Error creating share link:', error);
            showToast('Error creating share link. Please try again.', 'danger');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    /**
     * Copy share URL to clipboard
     */
    function copyShareUrl() {
        const input = document.getElementById('shareUrl');
        input.select();
        document.execCommand('copy');

        // Show feedback
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        setTimeout(() => {
            btn.innerHTML = originalHtml;
        }, 2000);
    }

    /**
     * Share a single CVE with NVD link - copies to clipboard automatically
     */
    async function shareSingleCVE(cveId, vulnName) {
        const nvdUrl = `https://nvd.nist.gov/vuln/detail/${encodeURIComponent(cveId)}`;

        try {
            // Try modern clipboard API first
            await navigator.clipboard.writeText(nvdUrl);
            showToast(`NVD link copied to clipboard`, 'success');
        } catch (error) {
            // Fallback for older browsers or non-HTTPS
            const textArea = document.createElement('textarea');
            textArea.value = nvdUrl;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast(`NVD link copied to clipboard`, 'success');
            } catch (e) {
                showToast(`Could not copy. URL: ${nvdUrl}`, 'warning');
            }
            document.body.removeChild(textArea);
        }
    }

    /**
     * Load shared view if share_token is present
     */
    async function loadSharedView() {
        const shareToken = '{{ share_token | default("") }}';
        if (!shareToken) return;

        try {
            const response = await fetch(`/api/shared/view/${shareToken}`);
            if (response.ok) {
                const result = await response.json();
                const filters = result.shared_view.filters;

                // Apply filters to form
                if (filters.priority) document.getElementById('filterPriority').value = filters.priority;
                if (filters.severity) document.getElementById('filterSeverity').value = filters.severity;
                if (filters.urgency) document.getElementById('filterUrgency').value = filters.urgency;
                if (filters.age) document.getElementById('filterAge').value = filters.age;
                if (filters.cve) document.getElementById('filterCVE').value = filters.cve || '';
                if (filters.vendor) document.getElementById('filterVendor').value = filters.vendor || '';
                if (filters.product) document.getElementById('filterProduct').value = filters.product || '';
                document.getElementById('filterRansomware').checked = filters.ransomware || false;
                document.getElementById('filterUnack').checked = filters.unack || false;

                // Show notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-info alert-dismissible fade show';
                notification.innerHTML = `
                    <i class="bi bi-share me-2"></i>
                    <strong>Viewing shared filtered view:</strong> ${result.shared_view.name || 'Untitled'}
                    ${result.shared_view.description ? `<br><small>${result.shared_view.description}</small>` : ''}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                const fadeInContainer = document.querySelector('.fade-in');
                if (fadeInContainer) {
                    fadeInContainer.insertBefore(notification, fadeInContainer.firstChild);
                }

                // Load vulnerabilities with these filters
                loadVulnerabilities();
            } else if (response.status === 410) {
                showToast('This shared link has expired.', 'warning');
            } else {
                const error = await response.json();
                showToast(`Error loading shared view: ${error.error}`, 'danger');
            }
        } catch (error) {
            console.error('Error loading shared view:', error);
        }
    }

    // Load shared view on page load if token present
    loadSharedView();

    // Load grouped vulnerabilities from API
    async function loadGroupedVulnerabilities() {
        showLoading();
        const container = document.getElementById('vulnerabilitiesContainer');
        selectedVulns.clear();
        updateBulkActions();

        try {
            const params = new URLSearchParams();
            const cve = document.getElementById('filterCVE').value;
            const ransomware = document.getElementById('filterRansomware').checked;
            const unack = document.getElementById('filterUnack').checked;
            const priority = document.getElementById('filterPriority').value;

            if (cve) params.append('search', cve);
            if (ransomware) params.append('ransomware_only', 'true');
            if (unack) params.append('acknowledged', 'false');
            if (priority) params.append('priority', priority);
            params.append('page', currentPage);
            params.append('per_page', pageSize === Infinity ? 100 : pageSize);

            const response = await fetchWithRetry(`/api/vulnerabilities/grouped?${params}`, {}, 3, 1000);

            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();
            currentGroupedVulnerabilities = data.items;

            document.getElementById('vulnCount').textContent = data.total;
            renderGroupedPage(data);
        } catch (error) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Error loading vulnerabilities: ${error.message}
                </div>
            `;
        } finally {
            hideLoading();
        }
    }

    function renderGroupedPage(data) {
        const container = document.getElementById('vulnerabilitiesContainer');

        if (data.items.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-shield-check text-success" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">No Vulnerabilities Found</h4>
                    <p class="text-muted">No matches found with the current filter criteria.</p>
                </div>
            `;
            document.getElementById('paginationControls').style.display = 'none';
            return;
        }

        container.innerHTML = data.items.map(group => createGroupedCVECard(group)).join('');

        // Update pagination
        const paginationControls = document.getElementById('paginationControls');
        const paginationInfo = document.getElementById('paginationInfo');
        const paginationNav = document.getElementById('paginationNav');

        if (data.pages > 1) {
            paginationControls.style.display = 'flex';
            const start = (data.page - 1) * data.per_page + 1;
            const end = Math.min(data.page * data.per_page, data.total);
            paginationInfo.textContent = `Showing ${start}-${end} of ${data.total} CVEs`;

            let navHtml = '';
            navHtml += `<li class="page-item ${data.page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToGroupedPage(${data.page - 1}); return false;">&laquo;</a>
            </li>`;

            const startPage = Math.max(1, data.page - 2);
            const endPage = Math.min(data.pages, data.page + 2);

            if (startPage > 1) {
                navHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToGroupedPage(1); return false;">1</a></li>`;
                if (startPage > 2) navHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                navHtml += `<li class="page-item ${i === data.page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToGroupedPage(${i}); return false;">${i}</a>
                </li>`;
            }

            if (endPage < data.pages) {
                if (endPage < data.pages - 1) navHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                navHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToGroupedPage(${data.pages}); return false;">${data.pages}</a></li>`;
            }

            navHtml += `<li class="page-item ${data.page === data.pages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToGroupedPage(${data.page + 1}); return false;">&raquo;</a>
            </li>`;

            paginationNav.innerHTML = navHtml;
        } else {
            paginationControls.style.display = 'none';
        }
    }

    function goToGroupedPage(page) {
        currentPage = page;
        loadGroupedVulnerabilities();
        document.getElementById('vulnerabilitiesContainer').scrollIntoView({ behavior: 'smooth' });
    }

    function createGroupedCVECard(group) {
        const vuln = group.vulnerability;
        const priority = group.highest_priority;

        const ransomwareBadge = vuln.known_ransomware ?
            '<span class="badge badge-critical"><i class="bi bi-shield-exclamation"></i> Ransomware</span>' : '';
        const priorityBadge = `<span class="badge ${getPriorityBadgeClass(priority)}"><i class="bi ${getPriorityIcon(priority)}"></i> ${priority.toUpperCase()} Priority</span>`;

        const severityBadge = vuln.severity ?
            `<span class="badge ${getPriorityBadgeClass(vuln.severity.toLowerCase())}"><i class="bi bi-graph-up"></i> CVSS: ${vuln.severity} ${vuln.cvss_score ? `(${vuln.cvss_score})` : ''}</span>` :
            '<span class="badge bg-secondary"><i class="bi bi-question-circle"></i> No CVSS</span>';

        // Build affected products list
        const productsHtml = group.affected_products.map(prod => {
            const prodPriorityBadge = `<span class="badge ${getPriorityBadgeClass(prod.effective_priority)} badge-sm">${prod.effective_priority}</span>`;
            const ackIcon = prod.acknowledged ?
                '<i class="bi bi-check-circle-fill text-success" title="Acknowledged"></i>' :
                '<i class="bi bi-circle text-warning" title="Needs Review"></i>';
            return `
                <div class="d-flex align-items-center justify-content-between py-1 border-bottom">
                    <div>
                        ${ackIcon}
                        <strong class="ms-2">${prod.vendor}</strong> - ${prod.product_name}
                    </div>
                    <div>
                        ${prodPriorityBadge}
                        ${!prod.acknowledged ?
                            `<button class="btn btn-sm btn-outline-success ms-2" onclick="acknowledgeMatch(${prod.match_id})" title="Acknowledge">
                                <i class="bi bi-check"></i>
                            </button>` :
                            `<button class="btn btn-sm btn-outline-secondary ms-2" onclick="unacknowledgeMatch(${prod.match_id})" title="Unacknowledge">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>`
                        }
                    </div>
                </div>
            `;
        }).join('');

        return `
            <div class="card vuln-card mb-3" style="border-left: 4px solid ${getPriorityColor(priority)};">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h5 class="card-title mb-2">
                                <span class="badge bg-dark">${vuln.cve_id}</span>
                                ${vuln.vulnerability_name}
                            </h5>
                            <div class="mb-2">
                                ${priorityBadge}
                                ${severityBadge}
                                ${ransomwareBadge}
                                <span class="badge bg-info">
                                    <i class="bi bi-box-seam"></i> ${group.product_count} product${group.product_count > 1 ? 's' : ''} affected
                                </span>
                                <span class="badge ${group.unacknowledged_count > 0 ? 'bg-warning text-dark' : 'bg-success'}">
                                    ${group.unacknowledged_count > 0 ? `${group.unacknowledged_count} need review` : 'All acknowledged'}
                                </span>
                                <span class="badge bg-secondary">
                                    <i class="bi bi-calendar3"></i> ${formatDate(vuln.date_added)} (${vuln.days_old} days ago)
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-2">
                        <small class="text-muted fw-semibold">DESCRIPTION</small>
                        <p class="mb-0">${vuln.short_description}</p>
                    </div>

                    <div class="mb-3">
                        <small class="text-muted fw-semibold">REQUIRED ACTION</small>
                        <p class="mb-0 fw-medium text-danger">${vuln.required_action}</p>
                    </div>

                    <div class="mb-2">
                        <small class="text-muted fw-semibold d-flex justify-content-between align-items-center">
                            AFFECTED PRODUCTS IN YOUR INVENTORY
                            <button class="btn btn-sm btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#products-${vuln.cve_id.replace(/[^a-zA-Z0-9]/g, '')}" aria-expanded="true">
                                <i class="bi bi-chevron-down"></i> Toggle
                            </button>
                        </small>
                        <div class="collapse show" id="products-${vuln.cve_id.replace(/[^a-zA-Z0-9]/g, '')}">
                            <div class="border rounded p-2 bg-light mt-1">
                                ${productsHtml}
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 flex-wrap">
                        ${group.unacknowledged_count > 0 ?
                            `<button class="btn btn-sm btn-success" onclick="acknowledgeCVE('${vuln.cve_id}')">
                                <i class="bi bi-check-all"></i> Acknowledge CVE (${group.unacknowledged_count})
                            </button>` :
                            `<button class="btn btn-sm btn-outline-secondary" onclick="unacknowledgeCVE('${vuln.cve_id}')">
                                <i class="bi bi-arrow-counterclockwise"></i> Reopen CVE
                            </button>`
                        }
                        <div class="btn-group" role="group">
                            <a href="https://nvd.nist.gov/vuln/detail/${vuln.cve_id}" target="_blank"
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-box-arrow-up-right"></i> NVD
                            </a>
                            <button class="btn btn-sm btn-outline-info" onclick="shareSingleCVE('${vuln.cve_id}', '${escapeHtml(vuln.vulnerability_name)}')">
                                <i class="bi bi-share"></i> Share
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Acknowledge all product matches for a CVE
    async function acknowledgeCVE(cveId) {
        try {
            showLoading();
            const response = await fetch(`/api/matches/acknowledge-by-cve/${cveId}`, { method: 'POST' });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to acknowledge CVE');
            }

            const result = await response.json();
            showToast(`Acknowledged ${result.acknowledged_count} product(s) for ${cveId}`, 'success');

            // Refresh the view
            loadGroupedVulnerabilities();
            loadStats();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    // Unacknowledge all product matches for a CVE (reopen)
    async function unacknowledgeCVE(cveId) {
        const confirmed = await showConfirm(
            `Reopen ${cveId}? This will mark all affected products as unacknowledged.`,
            'Reopen CVE',
            'Reopen',
            'btn-warning'
        );

        if (!confirmed) return;

        try {
            showLoading();
            const response = await fetch(`/api/matches/unacknowledge-by-cve/${cveId}`, { method: 'POST' });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to unacknowledge CVE');
            }

            const result = await response.json();
            showToast(`Reopened ${result.unacknowledged_count} product(s) for ${cveId}`, 'info');

            // Refresh the view
            loadGroupedVulnerabilities();
            loadStats();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }
</script>
{% endblock %}
