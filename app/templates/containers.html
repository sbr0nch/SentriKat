{% extends 'base.html' %}

{% block title %}Container Security - SentriKat{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page"><i class="bi bi-box-seam me-1"></i>Container Security</li>
{% endblock %}

{% block extra_css %}
<style>
    .severity-bar { display: flex; height: 6px; border-radius: 3px; overflow: hidden; min-width: 120px; }
    .severity-bar .critical { background: var(--danger-color); }
    .severity-bar .high { background: #fd7e14; }
    .severity-bar .medium { background: var(--warning-color); }
    .severity-bar .low { background: var(--info-color); }

    .image-card { border-left: 4px solid var(--border-color); transition: all 0.2s; cursor: pointer; }
    .image-card:hover { border-left-color: var(--primary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .image-card.critical-border { border-left-color: var(--danger-color); }
    .image-card.high-border { border-left-color: #fd7e14; }

    .stat-card { text-align: center; padding: 1rem; border-radius: 0.5rem; background: var(--gray-50); border: 1px solid var(--border-color); }
    .stat-card .number { font-size: 2rem; font-weight: 700; line-height: 1; }
    .stat-card .label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .stat-card.critical .number { color: var(--danger-color); }
    .stat-card.high .number { color: #fd7e14; }
    .stat-card.fixable .number { color: var(--success-color); }

    .vuln-row td { font-size: 0.875rem; }
    .severity-badge { font-size: 0.7rem; padding: 0.2em 0.5em; font-weight: 600; text-transform: uppercase; }
    .fix-badge { font-size: 0.7rem; }

    .epss-bar { display: inline-block; height: 6px; border-radius: 3px; background: var(--gray-200); width: 50px; vertical-align: middle; }
    .epss-bar .fill { height: 100%; border-radius: 3px; }

    .detail-panel { display: none; }
    .detail-panel.active { display: block; }

    [data-theme="dark"] .stat-card { background: var(--surface-color); border-color: var(--border-color); }
    [data-theme="dark"] .image-card { background: var(--surface-color); border-color: var(--border-color); }
    [data-theme="dark"] .image-card .card-body { background: var(--surface-color); }
    [data-theme="dark"] .image-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    [data-theme="dark"] #detailMeta { background-color: var(--surface-color) !important; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h4 class="mb-0">Container Security</h4>
        <small class="text-muted">Container image vulnerabilities from Trivy scans</small>
    </div>
    <div class="d-flex gap-2 flex-wrap">
        <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search images, tags, registries..." style="width: 220px;" oninput="debouncedLoad()">
        <select id="severityFilter" class="form-select form-select-sm" style="width: 140px;" onchange="loadImages()">
            <option value="">All severities</option>
            <option value="critical">Critical</option>
            <option value="high">High+</option>
            <option value="medium">Medium+</option>
        </select>
        <select id="fixFilter" class="form-select form-select-sm" style="width: 140px;" onchange="loadImages()">
            <option value="">All fix status</option>
            <option value="fixable">Has fixes</option>
            <option value="unfixable">No fixes</option>
        </select>
    </div>
</div>

<!-- Stats -->
<div class="d-flex gap-3 flex-wrap mb-3" id="statsRow">
    <div class="stat-card flex-fill"><div class="number" id="totalImages">-</div><div class="label">Images</div></div>
    <div class="stat-card critical flex-fill"><div class="number" id="totalCritical">-</div><div class="label">Critical</div></div>
    <div class="stat-card high flex-fill"><div class="number" id="totalHigh">-</div><div class="label">High</div></div>
    <div class="stat-card flex-fill"><div class="number" id="totalVulns">-</div><div class="label">Total Vulns</div></div>
    <div class="stat-card fixable flex-fill"><div class="number" id="totalFixable">-</div><div class="label">Fixable</div></div>
</div>

<!-- Image List -->
<div id="imageList"></div>

<!-- Detail Panel (slides in when an image is selected) -->
<div id="detailPanel" class="detail-panel mt-3">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0" id="detailTitle">Image Details</h6>
            <button class="btn btn-sm btn-outline-secondary" onclick="closeDetail()"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="card-body p-0">
            <div class="p-3 bg-light border-bottom" id="detailMeta"></div>
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead><tr>
                        <th style="width:80px">Severity</th>
                        <th style="width:140px">CVE</th>
                        <th>Package</th>
                        <th style="width:100px">Installed</th>
                        <th style="width:100px">Fixed</th>
                        <th style="width:60px">CVSS</th>
                        <th style="width:80px">EPSS</th>
                        <th style="width:50px" title="CISA KEV / Active Exploitation">KEV</th>
                    </tr></thead>
                    <tbody id="vulnTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Empty state -->
<div id="emptyState" class="text-center py-5 d-none">
    <i class="bi bi-box-seam text-muted" style="font-size:3rem"></i>
    <h5 class="mt-3 text-muted">No container images found</h5>
    <p class="text-muted">Container scans from push agents will appear here.</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allImages = [];
let debounceTimer;

function debouncedLoad() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(loadImages, 300);
}

async function loadImages() {
    const search = document.getElementById('searchInput').value;
    const severity = document.getElementById('severityFilter').value;
    const fixStatus = document.getElementById('fixFilter').value;
    let url = '/api/containers?';
    if (search) url += `search=${encodeURIComponent(search)}&`;
    if (severity) url += `severity=${encodeURIComponent(severity)}&`;
    if (fixStatus) url += `fix_status=${encodeURIComponent(fixStatus)}&`;

    try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        allImages = data.images || [];
        const stats = data.stats || {};

        document.getElementById('totalImages').textContent = stats.total_images || 0;
        document.getElementById('totalCritical').textContent = stats.total_critical || 0;
        document.getElementById('totalHigh').textContent = stats.total_high || 0;
        document.getElementById('totalVulns').textContent = stats.total_vulnerabilities || 0;
        document.getElementById('totalFixable').textContent = stats.total_fixable || 0;

        renderImages(allImages);
    } catch (e) {
        console.error('Failed to load containers:', e);
        document.getElementById('imageList').innerHTML = `<div class="alert alert-warning">Failed to load container data: ${e.message}</div>`;
    }
}

function renderImages(images) {
    const container = document.getElementById('imageList');
    const empty = document.getElementById('emptyState');

    if (!images.length) {
        container.innerHTML = '';
        empty.classList.remove('d-none');
        return;
    }
    empty.classList.add('d-none');

    container.innerHTML = images.map(img => {
        const sev = img.severity || {};
        const total = img.total_vulnerabilities || 0;
        const borderClass = sev.critical > 0 ? 'critical-border' : (sev.high > 0 ? 'high-border' : '');

        const barParts = [];
        if (sev.critical) barParts.push(`<div class="critical" style="width:${(sev.critical/total*100)}%"></div>`);
        if (sev.high) barParts.push(`<div class="high" style="width:${(sev.high/total*100)}%"></div>`);
        if (sev.medium) barParts.push(`<div class="medium" style="width:${(sev.medium/total*100)}%"></div>`);
        if (sev.low) barParts.push(`<div class="low" style="width:${(sev.low/total*100)}%"></div>`);

        const scanAge = img.last_scan_at ? timeAgo(new Date(img.last_scan_at)) : 'never';
        const fixable = img.fixed_count || 0;

        return `<div class="card image-card mb-2 ${borderClass}" onclick="showDetail(${img.id})">
            <div class="card-body py-2 px-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${escHtml(img.full_name || img.image_name)}</strong>
                        ${img.os_family ? `<span class="badge bg-secondary ms-2" style="font-size:0.65rem">${escHtml(img.os_family)}</span>` : ''}
                        ${img.running ? '<span class="badge bg-success ms-1" style="font-size:0.65rem">Running</span>' : ''}
                        ${img.registry && img.registry !== 'docker.io' ? `<span class="badge bg-light text-dark border ms-1" style="font-size:0.6rem">${escHtml(img.registry)}</span>` : ''}
                        ${img.asset_hostname ? `<br><small class="text-muted"><i class="bi bi-pc-display"></i> ${escHtml(img.asset_hostname)}</small>` : ''}
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="text-end" style="min-width:200px">
                            <div class="d-flex gap-1 justify-content-end mb-1">
                                ${sev.critical ? `<span class="badge bg-danger severity-badge">${sev.critical} CRIT</span>` : ''}
                                ${sev.high ? `<span class="badge severity-badge" style="background:#fd7e14">${sev.high} HIGH</span>` : ''}
                                ${sev.medium ? `<span class="badge bg-warning text-dark severity-badge">${sev.medium} MED</span>` : ''}
                                ${sev.low ? `<span class="badge bg-info severity-badge">${sev.low} LOW</span>` : ''}
                                ${total === 0 ? '<span class="badge bg-success severity-badge">Clean</span>' : ''}
                                ${fixable > 0 ? `<span class="badge bg-success-subtle text-success severity-badge" title="${fixable} vulnerabilities with available fixes">${fixable} fix</span>` : ''}
                            </div>
                            ${total > 0 ? `<div class="severity-bar">${barParts.join('')}</div>` : ''}
                        </div>
                        <small class="text-muted" style="white-space:nowrap">Scanned ${scanAge}</small>
                    </div>
                </div>
            </div>
        </div>`;
    }).join('');
}

async function showDetail(imageId) {
    try {
        const res = await fetch(`/api/containers/${imageId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const img = data.image;
        const vulns = data.vulnerabilities || [];

        document.getElementById('detailTitle').innerHTML =
            `<i class="bi bi-box-seam me-2"></i>${escHtml(img.full_name || img.image_name)}`;

        document.getElementById('detailMeta').innerHTML = `
            <div class="d-flex gap-4 flex-wrap" style="font-size:0.85rem">
                ${img.os_family ? `<div><strong>OS:</strong> ${escHtml(img.os_family)} ${escHtml(img.os_version||'')}</div>` : ''}
                ${img.registry ? `<div><strong>Registry:</strong> ${escHtml(img.registry)}</div>` : ''}
                ${img.architecture ? `<div><strong>Arch:</strong> ${escHtml(img.architecture)}</div>` : ''}
                ${img.scanner_version ? `<div><strong>Scanner:</strong> ${escHtml(img.scanner_version)}</div>` : ''}
                <div><strong>Total:</strong> ${img.total_vulnerabilities} vulns (${img.fixed_count||0} fixable)</div>
                ${img.image_digest ? `<div><strong>Digest:</strong> <code style="font-size:0.75rem">${escHtml(img.image_digest.substring(0,19))}...</code></div>` : ''}
            </div>`;

        const tbody = document.getElementById('vulnTableBody');
        if (!vulns.length) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3"><i class="bi bi-shield-check me-1"></i>No vulnerabilities found</td></tr>';
        } else {
            tbody.innerHTML = vulns.map(v => {
                const sevClass = {'CRITICAL':'bg-danger','HIGH':'bg-warning text-dark','MEDIUM':'bg-secondary','LOW':'bg-info'}[v.severity] || 'bg-secondary';
                const fixBadge = v.fixed_version
                    ? `<span class="badge bg-success fix-badge">${escHtml(v.fixed_version)}</span>`
                    : '<span class="badge bg-secondary fix-badge">No fix</span>';

                // EPSS data (from KEV cross-reference)
                let epssHtml = '-';
                if (v.epss_score != null) {
                    const pct = (v.epss_score * 100).toFixed(1);
                    const epssColor = v.epss_score >= 0.1 ? '#dc3545' : v.epss_score >= 0.01 ? '#fd7e14' : '#6c757d';
                    epssHtml = `<div class="epss-bar"><div class="fill" style="width:${Math.max(2, v.epss_score * 100)}%;background:${epssColor}"></div></div> <small>${pct}%</small>`;
                }

                // KEV / Active exploitation
                let kevHtml = '';
                if (v.is_actively_exploited) {
                    kevHtml = '<span class="badge bg-danger" title="CISA KEV - Actively Exploited"><i class="bi bi-exclamation-triangle-fill"></i></span>';
                }
                if (v.known_ransomware) {
                    kevHtml += ' <span class="badge bg-dark" title="Known Ransomware"><i class="bi bi-bug-fill"></i></span>';
                }
                if (v.in_kev && !v.is_actively_exploited) {
                    kevHtml = '<span class="badge bg-warning text-dark" title="In CISA KEV catalog"><i class="bi bi-exclamation-circle"></i></span>';
                }

                return `<tr class="vuln-row">
                    <td><span class="badge ${sevClass} severity-badge">${escHtml(v.severity||'?')}</span></td>
                    <td>${v.primary_url ? `<a href="${escHtml(v.primary_url)}" target="_blank" rel="noopener">${escHtml(v.vuln_id)}</a>` : escHtml(v.vuln_id)}</td>
                    <td><code>${escHtml(v.pkg_name)}</code> <small class="text-muted">${escHtml(v.pkg_type||'')}</small></td>
                    <td><code>${escHtml(v.pkg_version||'-')}</code></td>
                    <td>${fixBadge}</td>
                    <td>${v.cvss_score ? `<strong>${v.cvss_score.toFixed(1)}</strong>` : '-'}</td>
                    <td>${epssHtml}</td>
                    <td>${kevHtml || '<span class="text-muted">-</span>'}</td>
                </tr>`;
            }).join('');
        }

        document.getElementById('detailPanel').classList.add('active');
        document.getElementById('detailPanel').scrollIntoView({behavior:'smooth', block:'start'});
    } catch (e) {
        console.error('Failed to load image detail:', e);
    }
}

function closeDetail() {
    document.getElementById('detailPanel').classList.remove('active');
}

function escHtml(s) {
    if (!s) return '';
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

function timeAgo(date) {
    const s = Math.floor((Date.now() - date.getTime()) / 1000);
    if (s < 60) return 'just now';
    if (s < 3600) return Math.floor(s/60) + 'm ago';
    if (s < 86400) return Math.floor(s/3600) + 'h ago';
    return Math.floor(s/86400) + 'd ago';
}

loadImages();
</script>
{% endblock %}
