{% extends 'base.html' %}

{% block title %}Alert Rules - SentriKat{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page"><i class="bi bi-bell me-1"></i>Alert Rules</li>
{% endblock %}

{% block extra_css %}
<style>
    .org-override-row { font-size: 0.85rem; }
    .org-override-row .badge { font-size: 0.7rem; }
    .override-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 4px;
    }
    .override-indicator.overridden { background: var(--warning-color); }
    .override-indicator.inherited { background: var(--gray-300); }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="h4 fw-bold mb-1"><i class="bi bi-bell me-2"></i>Alert Rules</h2>
        <p class="text-muted mb-0 small">Configure which vulnerability events trigger alerts across all organizations</p>
    </div>
</div>

<!-- Alert Rules Card -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-funnel me-2"></i>Global Alert Rules
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            These rules apply to <strong>all organizations</strong> by default. Per-organization overrides can be configured in
            <a href="/admin-panel#organizations">Admin Panel &rarr; Organizations</a>.
            Delivery channels (SMTP, Slack, Teams, webhooks) are configured in
            <a href="/admin-panel#settings:email">Email &amp; Alerts settings</a>.
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="ruleCritical" checked>
                    <label class="form-check-label" for="ruleCritical">
                        <strong><span class="badge bg-danger me-1" style="font-size: 0.65rem;">CRITICAL</span> Critical Severity CVEs</strong>
                    </label>
                    <small class="form-text text-muted d-block">CVSS 9.0&ndash;10.0</small>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="ruleHigh">
                    <label class="form-check-label" for="ruleHigh">
                        <strong><span class="badge me-1" style="font-size: 0.65rem; background: var(--high-color);">HIGH</span> High Severity CVEs</strong>
                    </label>
                    <small class="form-text text-muted d-block">CVSS 7.0&ndash;8.9</small>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="ruleNewCve" checked>
                    <label class="form-check-label" for="ruleNewCve">
                        <strong><i class="bi bi-plus-circle text-info me-1"></i> New CVE Discovered</strong>
                    </label>
                    <small class="form-text text-muted d-block">First time a CVE is matched to your products</small>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="ruleRansomware" checked>
                    <label class="form-check-label" for="ruleRansomware">
                        <strong><i class="bi bi-shield-exclamation text-danger me-1"></i> Known Ransomware Exploitation</strong>
                    </label>
                    <small class="form-text text-muted d-block">CVE flagged as used in ransomware campaigns</small>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" checked disabled>
                    <label class="form-check-label text-muted" for="ruleExploited">
                        <strong><i class="bi bi-exclamation-triangle-fill text-danger me-1"></i> Active Exploitation (0-Day)</strong>
                    </label>
                    <small class="form-text text-muted d-block">Always enabled &mdash; CISA KEV, EUVD, and pre-KEV detections</small>
                </div>
            </div>

            <div class="col-12 mt-3">
                <hr>
                <h6 class="text-muted"><i class="bi bi-filter me-1"></i>Confidence Filtering</h6>
            </div>

            <div class="col-md-12">
                <div class="form-check form-switch">
                    <input type="checkbox" class="form-check-input" id="ruleIncludeLowConfidence">
                    <label class="form-check-label fw-semibold" for="ruleIncludeLowConfidence">Include low-confidence matches</label>
                </div>
                <small class="form-text text-muted">Low-confidence matches use keyword-only detection and may produce false positives. By default, only medium and high confidence matches (CPE or vendor+product) trigger alerts.</small>
            </div>

            <div class="col-md-12">
                <hr>
                <button type="button" class="btn btn-primary" onclick="saveAlertRules()">
                    <i class="bi bi-check-circle me-1"></i>Save Alert Rules
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Organization Overrides Card -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-building me-2"></i>Organization Overrides</span>
        <a href="/admin-panel#organizations" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-pencil me-1"></i>Manage
        </a>
    </div>
    <div class="card-body">
        <p class="text-muted small mb-3">
            Summary of per-organization alert settings.
            <span class="override-indicator overridden"></span><strong>Yellow</strong> = custom override,
            <span class="override-indicator inherited"></span><strong>gray</strong> = using global default.
            Edit overrides in <a href="/admin-panel#organizations">Admin Panel &rarr; Organizations</a>.
        </p>

        <div class="table-responsive">
            <table class="table table-hover mb-0" id="orgOverridesTable">
                <thead>
                    <tr>
                        <th class="small fw-semibold">Organization</th>
                        <th class="small fw-semibold text-center">Critical</th>
                        <th class="small fw-semibold text-center">High</th>
                        <th class="small fw-semibold text-center">New CVE</th>
                        <th class="small fw-semibold text-center">Ransomware</th>
                        <th class="small fw-semibold text-center">Alert Mode</th>
                        <th class="small fw-semibold text-center">SMTP</th>
                        <th class="small fw-semibold text-center">Webhook</th>
                        <th class="small fw-semibold text-center">Recipients</th>
                    </tr>
                </thead>
                <tbody id="orgOverridesBody">
                    <tr><td colspan="9" class="text-center text-muted py-4"><i class="bi bi-hourglass-split me-1"></i>Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

function showToast(msg, type) {
    if (window.SK && SK.Toast) {
        SK.Toast.show(msg, type, 5000);
    } else if (typeof window.showToast === 'function' && window.showToast !== showToast) {
        window.showToast(msg, type);
    } else {
        // Styled fallback if core JS not loaded
        const container = document.getElementById('toast-container') || document.body;
        const div = document.createElement('div');
        div.className = `alert alert-${type === 'danger' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
        div.style.cssText = 'top:20px;right:20px;z-index:9999;min-width:300px;';
        div.innerHTML = `${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        container.appendChild(div);
        setTimeout(() => div.remove(), 5000);
    }
}

// ========================================================
// Load settings
// ========================================================
async function loadSettings() {
    try {
        const [notifResp, orgsResp] = await Promise.all([
            fetch('/api/settings/notifications', { headers: { 'X-CSRFToken': csrfToken } }),
            fetch('/api/settings/alerts/org-overrides', { headers: { 'X-CSRFToken': csrfToken } })
        ]);

        if (notifResp.ok) {
            const n = await notifResp.json();
            document.getElementById('ruleCritical').checked = n.notify_on_critical !== false;
            document.getElementById('ruleHigh').checked = n.notify_on_high === true;
            document.getElementById('ruleNewCve').checked = n.notify_on_new_cve !== false;
            document.getElementById('ruleRansomware').checked = n.notify_on_ransomware !== false;
            document.getElementById('ruleIncludeLowConfidence').checked = n.notify_on_low_confidence === true;
        }

        if (orgsResp.ok) {
            renderOrgOverrides(await orgsResp.json());
        }
    } catch (err) {
        console.error('Failed to load alert settings:', err);
        showToast('Failed to load settings', 'danger');
    }
}

// ========================================================
// Save alert rules
// ========================================================
async function saveAlertRules() {
    try {
        const payload = {
            notify_on_critical: document.getElementById('ruleCritical').checked,
            notify_on_high: document.getElementById('ruleHigh').checked,
            notify_on_new_cve: document.getElementById('ruleNewCve').checked,
            notify_on_ransomware: document.getElementById('ruleRansomware').checked,
            notify_on_low_confidence: document.getElementById('ruleIncludeLowConfidence').checked
        };

        const resp = await fetch('/api/settings/notifications', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify(payload)
        });

        const result = await resp.json();
        if (resp.ok && result.success) {
            showToast('Alert rules saved', 'success');
            loadSettings();
        } else {
            showToast(result.error || 'Failed to save', 'danger');
        }
    } catch (err) {
        console.error('Save error:', err);
        showToast('Failed to save alert rules', 'danger');
    }
}

// ========================================================
// Org overrides table
// ========================================================
function renderOrgOverrides(orgs) {
    const tbody = document.getElementById('orgOverridesBody');
    if (!orgs || orgs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">No organizations found</td></tr>';
        return;
    }

    tbody.innerHTML = orgs.map(org => {
        const emailCount = org.notification_email_count || 0;
        return `<tr class="org-override-row">
            <td>
                <strong>${escapeHtml(org.display_name || org.name)}</strong>
                ${!org.active ? '<span class="badge bg-secondary ms-1">Inactive</span>' : ''}
            </td>
            <td class="text-center">${boolBadge(org.alert_on_critical, true)}</td>
            <td class="text-center">${boolBadge(org.alert_on_high, false)}</td>
            <td class="text-center">${boolBadge(org.alert_on_new_cve, true)}</td>
            <td class="text-center">${boolBadge(org.alert_on_ransomware, true)}</td>
            <td class="text-center">
                ${org.alert_mode ? `<span class="override-indicator overridden"></span><span class="badge bg-warning text-dark">${escapeHtml(org.alert_mode)}</span>` : '<span class="override-indicator inherited"></span><span class="text-muted small">Global</span>'}
            </td>
            <td class="text-center">${org.has_smtp ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-dash text-muted"></i>'}</td>
            <td class="text-center">${org.webhook_enabled ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-dash text-muted"></i>'}</td>
            <td class="text-center"><span class="badge ${emailCount > 0 ? 'bg-primary' : 'bg-secondary'}">${emailCount}</span></td>
        </tr>`;
    }).join('');
}

function boolBadge(val, defaultVal) {
    const isDefault = val === defaultVal || val === null || val === undefined;
    const effective = val !== null && val !== undefined ? val : defaultVal;
    const dot = isDefault ? '<span class="override-indicator inherited"></span>' : '<span class="override-indicator overridden"></span>';
    return effective
        ? dot + '<i class="bi bi-check-circle text-success"></i>'
        : dot + '<i class="bi bi-x-circle text-muted"></i>';
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// ========================================================
// Init
// ========================================================
document.addEventListener('DOMContentLoaded', loadSettings);
</script>
{% endblock %}
