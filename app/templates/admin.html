{% extends "base.html" %}

{% block title %}Inventory - SentriKat{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">Inventory</li>
{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="row mb-3">
        <div class="col">
            <h1 class="display-6 fw-bold text-dark mb-2">
                <i class="bi bi-boxes me-2"></i>Inventory
            </h1>
            <p class="text-muted mb-0">Manage your software products and connected endpoints</p>
        </div>
    </div>

    <!-- Inventory Tabs: Products | Endpoints -->
    <ul class="nav nav-tabs mb-3" id="inventoryTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#productsPane" type="button">
                <i class="bi bi-box-seam me-1"></i>Products
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="endpoints-tab" data-bs-toggle="tab" data-bs-target="#endpointsPane" type="button">
                <i class="bi bi-pc-display me-1"></i>Endpoints
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="software-overview-tab" data-bs-toggle="tab" data-bs-target="#softwareOverviewPane" type="button">
                <i class="bi bi-layers me-1"></i>Software Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="import-queue-tab" data-bs-toggle="tab" data-bs-target="#importQueuePane" type="button">
                <i class="bi bi-inbox me-1"></i>Import Queue
                <span class="badge bg-primary ms-1" id="importQueueCount" style="display: none;">0</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="inventoryTabContent">
    <!-- Products Tab -->
    <div class="tab-pane show active" id="productsPane" role="tabpanel">

    {% if current_user and (current_user.role in ['manager', 'org_admin', 'super_admin'] or current_user.is_admin or current_user.can_manage_products) %}
    <!-- Bulk Actions Toolbar (hidden by default) -->
    <div class="alert alert-info mb-3" id="bulkActionsToolbar" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <span>
                <i class="bi bi-check-square me-2"></i>
                <strong><span id="selectedCount">0</span> product(s) selected</strong>
            </span>
            <div class="btn-group btn-group-sm">
                {% if current_user.role in ['org_admin', 'super_admin'] or current_user.is_admin %}
                <button class="btn btn-outline-primary" onclick="bulkAssignOrganization()">
                    <i class="bi bi-building me-1"></i>Assign to Organization
                </button>
                {% endif %}
                <button class="btn btn-outline-success" onclick="bulkActivate()">
                    <i class="bi bi-check-circle me-1"></i>Activate
                </button>
                <button class="btn btn-outline-secondary" onclick="bulkDeactivate()">
                    <i class="bi bi-pause-circle me-1"></i>Deactivate
                </button>
                <button class="btn btn-outline-danger" onclick="bulkDelete()">
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
                <button class="btn btn-outline-secondary" onclick="clearSelection()">
                    <i class="bi bi-x me-1"></i>Clear Selection
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-ul me-2"></i>Product Inventory</span>
            <div class="d-flex gap-2 align-items-center">
                {% if current_user and (current_user.role in ['manager', 'org_admin', 'super_admin'] or current_user.is_admin or current_user.can_manage_products) %}
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" onclick="showAddProduct()">
                    <i class="bi bi-plus-circle me-1"></i>Add Product
                </button>
                {% endif %}
                {% if current_user and current_user.is_super_admin() %}
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-tools me-1"></i>Admin Tools
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><h6 class="dropdown-header">Vulnerability Matching</h6></li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="applyCpeMappings(); return false;">
                                <i class="bi bi-link-45deg me-2"></i>Apply CPE Mappings
                                <small class="text-muted d-block ms-4">Auto-detect CPE identifiers</small>
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="rematchProducts(); return false;">
                                <i class="bi bi-arrow-repeat me-2"></i>Rematch Vulnerabilities
                                <small class="text-muted d-block ms-4">Re-run matching with current logic</small>
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="showCpeCoverage(); return false;">
                                <i class="bi bi-bar-chart me-2"></i>CPE Coverage Stats
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- Search and Filter Bar -->
        <div class="card-body border-bottom py-3">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="productSearch" placeholder="Search vendor, product, version..."
                               oninput="debounceSearch()">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()" title="Clear search">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
                {% if current_user and current_user.is_super_admin() %}
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="filterOrg" onchange="resetAndLoadProducts()">
                        <option value="">All Organizations</option>
                    </select>
                </div>
                {% endif %}
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="filterStatus" onchange="resetAndLoadProducts()">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="filterCpe" onchange="resetAndLoadProducts()">
                        <option value="">All CPE</option>
                        <option value="with_cpe">With CPE</option>
                        <option value="without_cpe">Without CPE ⚠️</option>
                    </select>
                </div>
                <div class="col-md-1 text-end">
                    <span class="text-muted small" id="productCount">-</span>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-compact mb-0" id="productsTableContainer" data-sortable="true" data-enhanced="true">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th data-column="product" data-column-label="Product" data-sort-key="product" data-sort-type="string">Product</th>
                            <th data-column="vendor" data-column-label="Vendor" data-sort-key="vendor" data-sort-type="string">Vendor</th>
                            <th data-column="version" data-column-label="Version" data-sort-key="version" data-sort-type="string">Version</th>
                            <th data-column="cpe" data-column-label="CPE" data-sort-key="cpe" data-sort-type="boolean" title="CPE mapping status">CPE</th>
                            <th data-column="platform" data-column-label="Platform" data-sort-key="platform" data-sort-type="string">Platform</th>
                            <th data-column="organization" data-column-label="Organization" data-sort-key="organization" data-sort-type="string">Organization</th>
                            <th data-column="status" data-column-label="Status" data-sort-key="status" data-sort-type="boolean">Status</th>
                            <th data-column="actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="text-muted mt-2">Loading products...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Pagination Controls -->
        <div class="card-footer d-flex justify-content-between align-items-center" id="paginationContainer" style="display: none;">
            <div class="d-flex align-items-center gap-2">
                <label class="form-label mb-0 small text-muted">Per page:</label>
                <select class="form-select form-select-sm" style="width: auto;" id="perPage" onchange="resetAndLoadProducts()">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <nav aria-label="Products pagination">
                <ul class="pagination pagination-sm mb-0" id="paginationNav">
                </ul>
            </nav>
        </div>
    </div>
    </div><!-- /productsPane -->

    <!-- Endpoints Tab -->
    <div class="tab-pane" id="endpointsPane" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-pc-display me-2"></i>Connected Endpoints</span>
                <div class="d-flex gap-2">
                    <input type="text" class="form-control form-control-sm" id="endpointSearchInput" placeholder="Search endpoints..." style="width: 200px;" onkeyup="if(event.key==='Enter') loadEndpoints()">
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadEndpoints()" title="Refresh">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="endpointsTable">
                        <thead class="table-light">
                            <tr>
                                <th data-sort="hostname" onclick="sortEndpoints('hostname')" style="cursor:pointer;">Hostname <i class="bi bi-arrow-down-up text-muted"></i></th>
                                <th data-sort="ip_address" onclick="sortEndpoints('ip_address')" style="cursor:pointer;">IP Address <i class="bi bi-arrow-down-up text-muted"></i></th>
                                <th data-sort="os_name" onclick="sortEndpoints('os_name')" style="cursor:pointer;">OS <i class="bi bi-arrow-down-up text-muted"></i></th>
                                <th>Organization</th>
                                <th>Products</th>
                                <th data-sort="status" onclick="sortEndpoints('status')" style="cursor:pointer;">Status <i class="bi bi-arrow-down-up text-muted"></i></th>
                                <th data-sort="last_checkin" onclick="sortEndpoints('last_checkin')" style="cursor:pointer;">Last Seen <i class="bi bi-arrow-down-up text-muted"></i></th>
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="endpointsTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-4 text-muted">
                                    <i class="bi bi-pc-display text-primary" style="font-size: 2rem;"></i>
                                    <p class="mt-2 mb-0">Click the Endpoints tab to load data</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted" id="endpointsCount"></small>
                    <nav aria-label="Endpoints pagination">
                        <ul class="pagination pagination-sm mb-0" id="endpointsPagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div><!-- /endpointsPane -->

    <!-- Software Overview Tab -->
    <div class="tab-pane" id="softwareOverviewPane" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-layers me-2"></i>Software Overview <small class="text-muted ms-2">Cross-endpoint software distribution</small></span>
                <div class="d-flex gap-2 align-items-center">
                    <input type="text" class="form-control form-control-sm" id="softwareOverviewSearch" placeholder="Search software..." style="width: 200px;" oninput="filterSoftwareOverview()">
                    <select class="form-select form-select-sm" id="softwareOverviewSort" style="width: 160px;" onchange="loadSoftwareOverview()">
                        <option value="endpoints">Most Endpoints</option>
                        <option value="versions">Most Versions</option>
                        <option value="name">Name A-Z</option>
                    </select>
                    <span class="text-muted small text-nowrap" id="softwareOverviewCount">-</span>
                </div>
            </div>
            <div class="card-body p-0" id="softwareOverviewBody">
                <div class="text-center py-5 text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div> Loading software overview...
                </div>
            </div>
        </div>
    </div><!-- /softwareOverviewPane -->

    <!-- Import Queue Tab -->
    <div class="tab-pane" id="importQueuePane" role="tabpanel">
        <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle me-2"></i>
            Software discovered from agents and integrations appears here for review before being added to your product inventory.
        </div>

        <!-- Bulk Actions -->
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <div class="btn-group">
                <button class="btn btn-success btn-sm" onclick="bulkApproveQueue()" id="bulkApproveBtn" disabled>
                    <i class="bi bi-check-all me-1"></i>Approve Selected
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="bulkRejectQueue()" id="bulkRejectBtn" disabled>
                    <i class="bi bi-x-lg me-1"></i>Reject Selected
                </button>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <select class="form-select form-select-sm d-inline-block w-auto" id="queuePerPage" onchange="loadImportQueue()">
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="200">200 per page</option>
                </select>
                <select class="form-select form-select-sm d-inline-block w-auto" id="queueFilterStatus" onchange="loadImportQueue()">
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="">All</option>
                </select>
            </div>
        </div>

        <!-- Import Queue Table -->
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" class="form-check-input" id="selectAllQueue" onchange="toggleSelectAllQueue()">
                                </th>
                                <th style="cursor: pointer;" onclick="sortImportQueue('vendor')">
                                    Software <span id="importQueueSortVendor"></span>
                                </th>
                                <th style="cursor: pointer;" onclick="sortImportQueue('version')">
                                    Version <span id="importQueueSortVersion"></span>
                                </th>
                                <th style="cursor: pointer;" onclick="sortImportQueue('organization')">
                                    Organization <span id="importQueueSortOrganization"></span>
                                </th>
                                <th style="cursor: pointer;" onclick="sortImportQueue('criticality')">
                                    Criticality <span id="importQueueSortCriticality"></span>
                                </th>
                                <th style="cursor: pointer;" onclick="sortImportQueue('source')">
                                    Source <span id="importQueueSortSource"></span>
                                </th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="importQueueTable">
                            <tr>
                                <td colspan="7" class="text-center py-4 text-muted">
                                    <i class="bi bi-inbox text-primary" style="font-size: 2rem;"></i>
                                    <p class="mb-0 mt-2">Click to load import queue...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer" id="importQueuePagination"></div>
        </div>
    </div><!-- /importQueuePane -->

    </div><!-- /inventoryTabContent -->

</div><!-- /fade-in -->

<!-- Product Modal - Redesigned with cleaner UX -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="productModalTitle">
                    <i class="bi bi-plus-circle me-2"></i>Add Product
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <input type="hidden" id="serviceCatalogId">
                    <input type="hidden" id="cpeVendor">
                    <input type="hidden" id="cpeProduct">
                    <input type="hidden" id="cpeUri">

                    <!-- Step 1: Find Product -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary rounded-circle me-2" style="width: 24px; height: 24px; line-height: 16px;">1</span>
                            <h6 class="mb-0 fw-bold">Find Your Product</h6>
                        </div>

                        <!-- CPE missing hint (shown when editing product without CPE) -->
                        <div id="noCpeHint" class="alert alert-warning py-2 px-3 mb-2 small" style="display: none;">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i>
                            <strong>No CPE assigned</strong> — Search below and select a match to enable vulnerability tracking.
                            Press <kbd>Search</kbd> or hit <kbd>Enter</kbd>.
                        </div>

                        <!-- NVD Search -->
                        <div class="input-group mb-1">
                            <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="nvdSearchInput"
                                   placeholder="Search (e.g., 'apache tomcat', 'windows server')..."
                                   oninput="debounceNVDSearch()" onkeydown="if(event.key==='Enter'){event.preventDefault();performNVDSearchNow();}">
                            <button class="btn btn-primary" type="button" onclick="performNVDSearchNow()">
                                Search
                            </button>
                        </div>

                        <div id="nvdSearchStatus" class="small text-muted mt-1" style="display: none;"></div>

                        <!-- Search Results with inline version selection -->
                        <div id="nvdResultsList" class="border rounded mt-2" style="max-height: 300px; overflow-y: auto; display: none;">
                            <!-- NVD Results populated here -->
                        </div>

                        <!-- Selected Product Display with Version -->
                        <div id="nvdSelectedProduct" class="card bg-success bg-opacity-10 border-success mt-2 mb-0" style="display: none;">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-check-circle-fill text-success me-1"></i>
                                        <strong id="nvdSelectedName"></strong>
                                        <span id="nvdSelectedVersion" class="badge bg-primary ms-1"></span>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearNVDSelection()">
                                        <i class="bi bi-x"></i> Change
                                    </button>
                                </div>
                                <small class="text-muted" id="nvdSelectedCpe"></small>
                            </div>
                        </div>

                        <!-- Or Manual Entry Toggle -->
                        <div class="text-center mt-2" id="manualEntryToggle">
                            <small class="text-muted">- or -</small>
                            <a href="#" class="small" onclick="toggleManualEntry(); return false;">Enter manually</a>
                        </div>
                    </div>

                    <!-- Step 2: Product Details (hidden fields for manual entry) -->
                    <div id="manualFieldsSection" style="display: none;">
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label for="vendor" class="form-label small">Vendor <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-sm" id="vendor" required
                                       placeholder="e.g., Microsoft, Cisco, Apache">
                            </div>
                            <div class="col-md-6">
                                <label for="productName" class="form-label small">Product <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-sm" id="productName" required
                                       placeholder="e.g., Windows Server, IOS, Tomcat">
                            </div>
                            <div class="col-12">
                                <label for="version" class="form-label small">Version <span class="text-muted">(optional)</span></label>
                                <input type="text" class="form-control form-control-sm" id="version"
                                       placeholder="Leave empty for ALL versions" list="versionSuggestions">
                                <datalist id="versionSuggestions"></datalist>
                            </div>
                        </div>
                    </div>

                    <!-- Settings (always visible) -->
                    <div class="mb-3" id="productSettingsSection">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary rounded-circle me-2" style="width: 24px; height: 24px; line-height: 16px;">2</span>
                            <h6 class="mb-0 fw-bold">Settings</h6>
                        </div>
                        <div class="row g-2">
                            <div class="col-12">
                                <label for="productOrganization" class="form-label small">Organization</label>
                                <select class="form-select form-select-sm" id="productOrganization">
                                    <option value="">All / Global</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden toggle for active status -->
                    <input type="hidden" id="active" value="true">

                    <!-- Advanced Options (Collapsed by Default) -->
                    <div class="border-top pt-3">
                        <button class="btn btn-link text-decoration-none p-0 text-muted" type="button"
                                data-bs-toggle="collapse" data-bs-target="#advancedOptionsCollapse">
                            <i class="bi bi-gear me-1"></i>Advanced Options
                            <i class="bi bi-chevron-down ms-1 small"></i>
                        </button>

                        <div id="advancedOptionsCollapse" class="collapse mt-3">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="matchType" class="form-label">Matching Strategy</label>
                                    <select class="form-select form-select-sm" id="matchType">
                                        <option value="auto">Auto (CPE if available, else keywords)</option>
                                        <option value="cpe">CPE Only</option>
                                        <option value="keyword">Keywords Only</option>
                                        <option value="both">Both CPE and Keywords</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label for="keywords" class="form-label">Additional Keywords</label>
                                    <input type="text" class="form-control form-control-sm" id="keywords"
                                           placeholder="Comma-separated (e.g., httpd, apache2)">
                                </div>

                                <div class="col-12">
                                    <label for="description" class="form-label">Notes</label>
                                    <textarea class="form-control form-control-sm" id="description" rows="2"
                                              placeholder="Optional notes about this product"></textarea>
                                </div>

                                <!-- CPE Status -->
                                <div class="col-12" id="cpeStatusSection">
                                    <div class="alert alert-light py-2 mb-0 small">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong><i class="bi bi-link-45deg me-1"></i>CPE Status:</strong>
                                                <span id="cpeSelectedInfo" style="display: none;">
                                                    <span class="badge bg-success">Linked</span>
                                                    <code id="cpeDisplayUri" class="ms-1"></code>
                                                </span>
                                                <span id="cpeNotLinkedInfo">
                                                    <span class="badge bg-secondary">Not linked</span>
                                                    <span class="text-muted ms-1">Use NVD search for better accuracy</span>
                                                </span>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary py-0" onclick="clearCPE()" id="clearCpeBtn" style="display: none;">
                                                Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Legacy Static Catalog -->
                                <div class="col-12">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showServiceCatalog()">
                                        <i class="bi bi-archive me-1"></i>Browse Static Catalog (Legacy)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <small class="text-muted me-auto"><span class="text-danger">*</span> Required fields</small>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">
                    <i class="bi bi-check-circle me-1"></i>Save Product
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Service Catalog Modal -->
<div class="modal fade" id="serviceCatalogModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-archive me-2"></i>Service Catalog Browser
                    <span class="badge bg-primary ms-2" id="catalogSelectionCount" style="display: none;">0 selected</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="catalogSearch"
                               placeholder="Search services by vendor, product, or keywords..."
                               oninput="filterCatalog(this.value)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small mb-1">Assign to Organizations (optional)</label>
                        <select class="form-select" id="catalogOrgSelect" multiple size="3">
                            <option value="" disabled>Loading organizations...</option>
                        </select>
                        <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead class="sticky-top">
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" class="form-check-input" id="catalogSelectAll" onchange="toggleCatalogSelectAll()">
                                </th>
                                <th>Product</th>
                                <th>Vendor</th>
                                <th>Version</th>
                                <th>Category</th>
                            </tr>
                        </thead>
                        <tbody id="catalogTable">
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted mt-2">Loading service catalog...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="addSelectedBtn" onclick="addSelectedFromCatalog()" disabled>
                    <i class="bi bi-plus-circle me-1"></i>Add Selected Products
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirm Action
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">
                    <i class="bi bi-check-circle me-1"></i>Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Organization Management Modal -->
<div class="modal fade" id="orgManagementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-building me-2"></i>Manage Organizations
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p class="text-muted">Product: <strong id="orgModalProductName"></strong></p>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Assigned Organizations</label>
                    <div id="assignedOrgsList" class="border rounded p-2" style="min-height: 100px; max-height: 200px; overflow-y: auto;">
                        <div class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Add Organizations</label>
                    <select class="form-select" id="addOrgSelect" multiple size="5">
                        <option value="">Loading...</option>
                    </select>
                    <small class="text-muted">Hold Ctrl/Cmd to select multiple organizations</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="assignOrganizations()">
                    <i class="bi bi-check-circle me-1"></i>Assign Selected
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Admin Tools Result Modal -->
<div class="modal fade" id="adminResultModal" tabindex="-1" aria-labelledby="adminResultModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adminResultModalLabel">
                    <i class="bi bi-info-circle me-2" id="adminResultIcon"></i>
                    <span id="adminResultTitle">Result</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="adminResultBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Admin Tools Confirm Modal -->
<div class="modal fade" id="adminConfirmModal" tabindex="-1" aria-labelledby="adminConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adminConfirmModalLabel">
                    <i class="bi bi-question-circle me-2 text-warning"></i>
                    <span id="adminConfirmTitle">Confirm Action</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="adminConfirmBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="adminConfirmOk">Proceed</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // User permission flags for UI visibility
    const userPermissions = {
        canManageProducts: {% if current_user and (current_user.role in ['manager', 'org_admin', 'super_admin'] or current_user.is_admin or current_user.can_manage_products) %}true{% else %}false{% endif %},
        canAssignOrgs: {% if current_user and (current_user.role in ['org_admin', 'super_admin'] or current_user.is_admin) %}true{% else %}false{% endif %},
        isSuperAdmin: {% if current_user and current_user.is_super_admin() %}true{% else %}false{% endif %}
    };

    let currentProductId = null;
    let serviceCatalog = [];
    let selectedCatalogItems = new Set();
    let selectedVersions = {};  // Store selected versions by catalog ID
    let currentPage = 1;
    let searchTimeout = null;

    // Debounce search input
    function debounceSearch() {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1; // Reset to first page on search
            loadProducts();
        }, 300);
    }

    function clearSearch() {
        document.getElementById('productSearch').value = '';
        currentPage = 1;
        loadProducts();
    }

    // Reset pagination and load - used when filters change
    function resetAndLoadProducts() {
        currentPage = 1;
        loadProducts();
    }

    function goToPage(page) {
        currentPage = page;
        loadProducts();
    }

    function renderPagination(total, currentPage, pages, perPage) {
        const container = document.getElementById('paginationContainer');
        const nav = document.getElementById('paginationNav');
        const countEl = document.getElementById('productCount');

        // Update count display
        const start = (currentPage - 1) * perPage + 1;
        const end = Math.min(currentPage * perPage, total);
        countEl.textContent = total > 0 ? `Showing ${start}-${end} of ${total} products` : 'No products found';

        // Show/hide pagination
        if (pages <= 1) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'flex';

        let html = '';

        // Previous button
        html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>`;

        // Page numbers
        const maxVisible = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let endPage = Math.min(pages, startPage + maxVisible - 1);

        if (endPage - startPage + 1 < maxVisible) {
            startPage = Math.max(1, endPage - maxVisible + 1);
        }

        if (startPage > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1); return false;">1</a></li>`;
            if (startPage > 2) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
            </li>`;
        }

        if (endPage < pages) {
            if (endPage < pages - 1) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${pages}); return false;">${pages}</a></li>`;
        }

        // Next button
        html += `<li class="page-item ${currentPage === pages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>`;

        nav.innerHTML = html;
    }

    async function loadProducts() {
        // Clear any existing selection when reloading products
        clearSelection();
        showLoading();
        const tbody = document.getElementById('productsTable');

        // Build query parameters
        const params = new URLSearchParams();

        const search = document.getElementById('productSearch')?.value?.trim();
        if (search) params.append('search', search);

        const filterOrgEl = document.getElementById('filterOrg');
        if (filterOrgEl && filterOrgEl.value) params.append('filter_org', filterOrgEl.value);

        const status = document.getElementById('filterStatus')?.value;
        if (status) params.append('status', status);

        const cpeFilter = document.getElementById('filterCpe')?.value;
        if (cpeFilter) params.append('cpe_filter', cpeFilter);

        const perPage = parseInt(document.getElementById('perPage')?.value || '25');
        params.append('page', currentPage);
        params.append('per_page', perPage);
        params.append('grouped', 'true');  // Use grouped mode

        try {
            const response = await fetch(`/api/products?${params.toString()}`);
            const data = await response.json();

            // Handle paginated response
            const products = data.products || data;
            const total = data.total || products.length;
            const pages = data.pages || 1;

            // Update count and pagination
            if (data.products) {
                renderPagination(total, data.page, pages, perPage);
            } else {
                // Non-paginated response (backward compatibility)
                document.getElementById('productCount').textContent = `${products.length} products`;
                document.getElementById('paginationContainer').style.display = 'none';
            }

            if (products.length === 0) {
                const hasFilters = search || status || cpeFilter || (filterOrgEl && filterOrgEl.value);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <i class="bi bi-${hasFilters ? 'search' : 'inbox'} text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3 text-muted">${hasFilters ? 'No products match your filters' : 'No products added yet'}</h5>
                            <p class="text-muted">${hasFilters ? 'Try adjusting your search or filters.' : 'Click "Add Product" to start tracking vulnerabilities for your software inventory.'}</p>
                            ${hasFilters ? '<button class="btn btn-outline-secondary btn-sm" onclick="resetFilters()"><i class="bi bi-x me-1"></i>Clear Filters</button>' : ''}
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = products.map(group => {
                    // For grouped products
                    const statusBadge = group.active
                        ? '<span class="badge badge-status-active">Active</span>'
                        : '<span class="badge badge-status-inactive">Inactive</span>';

                    // Display organizations
                    let orgDisplay;
                    if (group.organization_names && group.organization_names.length > 0) {
                        orgDisplay = group.organization_names.map(name =>
                            `<span class="badge bg-primary me-1">${escapeHtml(name)}</span>`
                        ).join('');
                    } else {
                        orgDisplay = '<span class="text-muted">-</span>';
                    }

                    // Build version badges - show vulnerable versions in red
                    const versions = group.versions || [];
                    let versionDisplay;
                    if (versions.length === 0) {
                        versionDisplay = '<span class="text-muted">-</span>';
                    } else if (versions.length === 1) {
                        const v = versions[0];
                        const badgeClass = v.is_vulnerable ? 'bg-danger' : 'bg-info';
                        const vulnIcon = v.is_vulnerable ? '<i class="bi bi-exclamation-triangle-fill me-1"></i>' : '';
                        versionDisplay = `<span class="badge ${badgeClass}" title="${v.is_vulnerable ? 'Vulnerable' : 'OK'}">${vulnIcon}${escapeHtml(v.version)}</span>`;
                    } else {
                        // Multiple versions - show compact with expand option
                        const vulnerableVersions = versions.filter(v => v.is_vulnerable);
                        const safeVersions = versions.filter(v => !v.is_vulnerable);

                        let badges = [];
                        // Show vulnerable versions first (up to 2)
                        vulnerableVersions.slice(0, 2).forEach(v => {
                            badges.push(`<span class="badge bg-danger" title="Vulnerable: ${escapeHtml(v.version)}"><i class="bi bi-exclamation-triangle-fill me-1"></i>${escapeHtml(v.version)}</span>`);
                        });
                        // Then safe versions (up to 2 if space)
                        const safeSlots = Math.max(0, 3 - badges.length);
                        safeVersions.slice(0, safeSlots).forEach(v => {
                            badges.push(`<span class="badge bg-info" title="${escapeHtml(v.version)}">${escapeHtml(v.version)}</span>`);
                        });

                        const remaining = versions.length - badges.length;
                        if (remaining > 0) {
                            badges.push(`<span class="badge bg-secondary" title="Click to see all versions">+${remaining} more</span>`);
                        }

                        versionDisplay = `<div class="d-flex flex-wrap gap-1">${badges.join('')}</div>`;
                    }

                    // Get the first version ID for actions (or use a group identifier)
                    const firstVersionId = versions.length > 0 ? versions[0].id : null;
                    const allVersionIds = versions.map(v => v.id);
                    const groupKey = `${escapeHtml(group.vendor)}|${escapeHtml(group.product_name)}`;

                    // Build CPE status indicator
                    const hasCpe = group.has_cpe;
                    const cpeDisplay = hasCpe
                        ? '<span class="badge bg-success" title="CPE mapped - vulnerability matching active"><i class="bi bi-check-circle-fill"></i></span>'
                        : `<a href="#" class="badge bg-warning text-dark text-decoration-none" title="No CPE mapping - click to assign" onclick="event.preventDefault(); event.stopPropagation(); assignCpe(${firstVersionId}, '${escapeHtml(group.product_name)}')"><i class="bi bi-exclamation-triangle-fill me-1"></i>Assign</a>`;

                    // Build platform display
                    const platforms = group.platforms || [];
                    let platformDisplay;
                    if (platforms.length === 0) {
                        platformDisplay = '<span class="text-muted">-</span>';
                    } else {
                        // Map supports both lowercase (from backend) and capitalized versions
                        const platformIcons = {
                            'windows': '<i class="bi bi-windows text-info" title="Windows"></i>',
                            'linux': '<i class="bi bi-ubuntu text-warning" title="Linux"></i>',
                            'macos': '<i class="bi bi-apple text-secondary" title="macOS"></i>',
                            'bsd': '<i class="bi bi-terminal text-danger" title="BSD"></i>',
                            'unix': '<i class="bi bi-terminal-fill text-success" title="Unix"></i>'
                        };
                        platformDisplay = platforms.map(p => {
                            // Normalize to lowercase for lookup
                            const icon = platformIcons[p.toLowerCase()] || `<span class="badge bg-secondary">${escapeHtml(p)}</span>`;
                            return icon;
                        }).join(' ');
                    }

                    return `
                        <tr data-group-key="${groupKey}" data-version-ids="${allVersionIds.join(',')}" style="cursor: pointer;">
                            <td onclick="event.stopPropagation();">
                                <input type="checkbox" class="form-check-input product-checkbox"
                                       data-product-ids="${allVersionIds.join(',')}"
                                       onchange="toggleGroupSelect('${allVersionIds.join(',')}', this)">
                            </td>
                            <td data-column="product" class="fw-semibold">
                                ${escapeHtml(group.product_name)}
                                ${group.has_vulnerable_version ? '<i class="bi bi-exclamation-triangle-fill text-danger ms-1" title="Has vulnerable versions"></i>' : ''}
                            </td>
                            <td data-column="vendor">${escapeHtml(group.vendor)}</td>
                            <td data-column="version">${versionDisplay}</td>
                            <td data-column="cpe" data-sort-value="${hasCpe ? 'true' : 'false'}">${cpeDisplay}</td>
                            <td data-column="platform">${platformDisplay}</td>
                            <td data-column="organization">${orgDisplay}</td>
                            <td data-column="status">${statusBadge}</td>
                            <td data-column="actions" onclick="event.stopPropagation();">
                                <div class="d-flex gap-1">
                                    ${versions.length > 1 ? `
                                    <button class="btn-action btn-action-edit" onclick="showVersionsModal('${escapeHtml(group.vendor)}', '${escapeHtml(group.product_name)}', ${JSON.stringify(versions).replace(/"/g, '&quot;')})" title="Manage Versions">
                                        <i class="bi bi-layers"></i>
                                    </button>` : ''}
                                    ${userPermissions.canManageProducts && firstVersionId ? `
                                    <button class="btn-action btn-action-edit" onclick="editProduct(${firstVersionId})" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>` : ''}
                                    ${userPermissions.canManageProducts && firstVersionId ? `
                                    <button class="btn-action btn-action-delete" onclick="deleteProductGroup('${allVersionIds.join(',')}', '${escapeHtml(group.vendor)} ${escapeHtml(group.product_name)}')" title="Delete All Versions">
                                        <i class="bi bi-trash3"></i>
                                    </button>` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle"></i> Error loading products: ${error.message}
                    </td>
                </tr>
            `;
        } finally {
            hideLoading();
            // Re-initialize sortable table after dynamic content load
            SortableTable.init('productsTableContainer');
            // Restore table enhancements (column visibility, widths)
            TableEnhancements.refresh('productsTableContainer');
        }
    }

    function resetFilters() {
        document.getElementById('productSearch').value = '';
        const filterOrgEl = document.getElementById('filterOrg');
        if (filterOrgEl) filterOrgEl.value = '';
        document.getElementById('filterStatus').value = '';
        const filterCpeEl = document.getElementById('filterCpe');
        if (filterCpeEl) filterCpeEl.value = '';
        currentPage = 1;
        loadProducts();
    }

    // Load organizations for filter dropdown (super admin only)
    async function loadFilterOrganizations() {
        const filterOrgEl = document.getElementById('filterOrg');
        if (!filterOrgEl) return; // Not super admin

        try {
            const response = await fetch('/api/organizations');
            const orgs = await response.json();

            filterOrgEl.innerHTML = '<option value="">All Organizations</option>' +
                orgs.map(org => `<option value="${org.id}">${escapeHtml(org.display_name)}</option>`).join('');
        } catch (error) {
            console.error('Failed to load organizations for filter:', error);
        }
    }

    // Safe DOM helpers - use SK.DOM if available, otherwise fallback to native
    function safeSetValue(id, value) {
        const el = document.getElementById(id);
        if (el) el.value = value ?? '';
    }
    function safeSetHtml(id, html) {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html ?? '';
    }
    function safeSetChecked(id, checked) {
        const el = document.getElementById(id);
        if (el) el.checked = !!checked;
    }
    function safeSetDisplay(id, display) {
        const el = document.getElementById(id);
        if (el) el.style.display = display;
    }
    function safeSetText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text ?? '';
    }

    async function showAddProduct() {
        currentProductId = null;
        safeSetHtml('productModalTitle', '<i class="bi bi-plus-circle me-2"></i>Add Product');

        const productForm = document.getElementById('productForm');
        if (productForm) productForm.reset();

        safeSetChecked('active', true);
        safeSetValue('criticality', 'medium');
        safeSetValue('matchType', 'auto');

        // Reset NVD search UI (primary method)
        resetNVDSearch();

        // Reset legacy CPE form
        resetCPEForm();

        // Collapse advanced options
        const advancedCollapse = document.getElementById('advancedOptionsCollapse');
        if (advancedCollapse) advancedCollapse.classList.remove('show');

        // Show manual entry toggle
        safeSetDisplay('manualEntryToggle', 'block');

        // Check NVD API key status and show rate limit warning if needed
        checkNvdApiKeyStatus();

        // Load organizations into dropdown
        await loadOrganizationsIntoProductForm();

        // Show the modal - reuse or create instance
        const modalEl = document.getElementById('productModal');
        if (modalEl) {
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        }
    }

    async function checkNvdApiKeyStatus() {
        const warningEl = document.getElementById('nvdRateLimitWarning');
        if (!warningEl) return;

        try {
            const response = await fetch('/api/cpe/stats');
            if (response.ok) {
                const data = await response.json();
                if (data.api && !data.api.nvd_api_key_configured) {
                    warningEl.style.display = 'block';
                } else {
                    warningEl.style.display = 'none';
                }
            }
        } catch (error) {
            // Silently fail - don't block the modal
        }
    }

    async function editProduct(productId) {
        currentProductId = productId;
        safeSetHtml('productModalTitle', '<i class="bi bi-pencil me-2"></i>Edit Product');

        // Reset NVD search UI
        resetNVDSearch();

        try {
            // Load organizations first
            await loadOrganizationsIntoProductForm();

            const response = await fetch(`/api/products/${productId}`);
            const product = await response.json();

            safeSetValue('vendor', product.vendor);
            safeSetValue('productName', product.product_name);
            safeSetValue('version', product.version || '');
            safeSetValue('criticality', product.criticality || 'medium');
            safeSetValue('keywords', product.keywords || '');
            safeSetValue('description', product.description || '');
            safeSetChecked('active', product.active);
            safeSetValue('productOrganization', product.organization_id || '');

            // Load CPE data and update NVD selection display
            loadCPEIntoForm(product);

            // Hide manual entry toggle when editing (data is already filled)
            safeSetDisplay('manualEntryToggle', 'none');

            // If product has no CPE, pre-fill NVD search with product name as hint
            const hasCpe = product.cpe_vendor && product.cpe_product;
            const hasEffectiveCpe = product.effective_cpe_vendor && product.effective_cpe_product;
            if (!hasCpe && !hasEffectiveCpe) {
                const searchInput = document.getElementById('nvdSearchInput');
                if (searchInput) {
                    searchInput.value = product.product_name || '';
                    searchInput.setAttribute('placeholder', 'Search NVD to assign CPE for vulnerability matching...');
                }
                // Show the no-CPE hint banner
                safeSetDisplay('noCpeHint', 'block');
            } else {
                safeSetDisplay('noCpeHint', 'none');
            }

            // Collapse advanced options by default
            const advancedCollapse = document.getElementById('advancedOptionsCollapse');
            if (advancedCollapse) advancedCollapse.classList.remove('show');

            // Show the modal - reuse or create instance
            const modalEl = document.getElementById('productModal');
            if (modalEl) {
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            }
        } catch (error) {
            showToast(`Error loading product: ${error.message}`, 'danger');
        }
    }

    // Open product modal focused on CPE assignment with auto-search
    async function assignCpe(productId, productName) {
        await editProduct(productId);
        // After modal opens, pre-fill NVD search and trigger it
        setTimeout(() => {
            const searchInput = document.getElementById('nvdSearchInput');
            if (searchInput && productName) {
                searchInput.value = productName;
                searchInput.focus();
                // Highlight the search area to draw attention
                searchInput.classList.add('border-warning');
                searchInput.setAttribute('placeholder', 'Search NVD to assign CPE...');
                setTimeout(() => searchInput.classList.remove('border-warning'), 3000);
                // Auto-trigger the search
                performNVDSearchNow();
            }
        }, 400);
    }

    async function saveProduct() {
        // Clear previous validation
        clearFormValidation('productForm');

        const vendor = document.getElementById('vendor').value.trim();
        const productName = document.getElementById('productName').value.trim();

        // Validate required fields
        let isValid = true;
        if (!vendor) {
            setFieldInvalid('vendor', 'Vendor is required');
            isValid = false;
        }
        if (!productName) {
            setFieldInvalid('productName', 'Product name is required');
            isValid = false;
        }

        if (!isValid) {
            showToast('Please fill in all required fields', 'warning');
            return;
        }

        const orgId = document.getElementById('productOrganization').value;

        const productData = {
            vendor: vendor,
            product_name: productName,
            version: document.getElementById('version').value.trim(),
            keywords: document.getElementById('keywords').value.trim(),
            description: document.getElementById('description').value.trim(),
            active: document.getElementById('active').checked,
            // CPE fields
            cpe_vendor: document.getElementById('cpeVendor').value.trim() || null,
            cpe_product: document.getElementById('cpeProduct').value.trim() || null,
            cpe_uri: document.getElementById('cpeUri').value.trim() || null,
            match_type: document.getElementById('matchType').value || 'auto'
        };

        if (orgId) {
            productData.organization_id = parseInt(orgId);
        }

        showLoading();
        try {
            let response;
            if (currentProductId) {
                response = await fetch(`/api/products/${currentProductId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
            } else {
                response = await fetch('/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
            }

            if (response.ok) {
                const result = await response.json();

                // Check if CPE was matched (for new products only)
                if (!currentProductId && !result.cpe_matched) {
                    // Show warning toast for no CPE match
                    showToast(
                        `⚠️ Product added but NO CPE mapping found. Vulnerabilities may not be detected. Edit the product to assign CPE manually.`,
                        'warning',
                        8000  // Show longer
                    );
                } else {
                    showToast(
                        currentProductId ? '✓ Product updated successfully' : '✓ Product added successfully',
                        'success'
                    );
                }

                // Safely close modal
                const modalEl = document.getElementById('productModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) {
                    modal.hide();
                }
                loadProducts();
            } else {
                // Safely parse error response - handle non-JSON responses
                let errorMessage = 'Unknown error occurred';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorData.message || 'Request failed';
                } catch (parseError) {
                    // Response was not JSON (could be HTML error page or empty)
                    console.error('Failed to parse error response:', parseError);
                    errorMessage = `Server error (${response.status}: ${response.statusText})`;
                }
                // Show warning for duplicates, danger for other errors
                const toastType = response.status === 409 ? 'warning' : 'danger';
                showToast(`${errorMessage}`, toastType);
            }
        } catch (error) {
            console.error('Error saving product:', error);
            showToast(`Error saving product: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function deleteProduct(productId, productName) {
        const confirmed = await showConfirm(
            `Are you sure you want to delete "<strong>${escapeHtml(productName)}</strong>"?<br><br>This will remove the product and all its vulnerability matches.`,
            'Delete Product',
            'Delete',
            'btn-danger'
        );

        if (!confirmed) {
            return;
        }

        showLoading();
        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('✓ Product deleted successfully', 'success');
                loadProducts();
            } else {
                showToast('✗ Error deleting product', 'danger');
            }
        } catch (error) {
            showToast(`✗ Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    // Delete all versions of a product group
    async function deleteProductGroup(versionIds, productName) {
        const ids = versionIds.split(',').filter(id => id);
        const versionCount = ids.length;

        const confirmed = await showConfirm(
            `Are you sure you want to delete "<strong>${escapeHtml(productName)}</strong>"?<br><br>This will remove <strong>${versionCount} version(s)</strong> and all vulnerability matches.`,
            'Delete Product',
            'Delete All',
            'btn-danger'
        );

        if (!confirmed) {
            return;
        }

        showLoading();
        let deleted = 0;
        let errors = 0;

        for (const id of ids) {
            try {
                const response = await fetch(`/api/products/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    deleted++;
                } else {
                    errors++;
                }
            } catch (error) {
                errors++;
            }
        }

        hideLoading();

        if (errors === 0) {
            showToast(`✓ Deleted ${deleted} version(s) successfully`, 'success');
        } else {
            showToast(`Deleted ${deleted} version(s), ${errors} failed`, 'warning');
        }

        loadProducts();
    }

    // Toggle selection for a group of products
    function toggleGroupSelect(versionIds, checkbox) {
        const ids = versionIds.split(',').filter(id => id);
        ids.forEach(idStr => {
            const id = parseInt(idStr);
            if (checkbox.checked) {
                // Get product info from the row
                const row = checkbox.closest('tr');
                const statusBadge = row ? row.querySelector('.badge-status-active, .badge-status-inactive') : null;
                const isActive = statusBadge ? statusBadge.classList.contains('badge-status-active') : true;
                const vendorCell = row ? row.querySelector('td[data-column="vendor"]') : null;
                const productCell = row ? row.querySelector('td[data-column="product"]') : null;
                const name = `${vendorCell?.textContent || ''} ${productCell?.textContent || ''}`.trim();
                selectedProducts.set(id, { id: id, active: isActive, name: name });
            } else {
                selectedProducts.delete(id);
            }
        });
        updateBulkToolbar();
    }

    // Show modal with all versions of a product
    function showVersionsModal(vendor, productName, versions) {
        // Create or get modal
        let modalEl = document.getElementById('versionsModal');
        if (!modalEl) {
            modalEl = document.createElement('div');
            modalEl.id = 'versionsModal';
            modalEl.className = 'modal fade';
            modalEl.tabIndex = -1;
            modalEl.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="bi bi-layers me-2"></i>Product Versions</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="versionsModalBody"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modalEl);
        }

        const modalBody = document.getElementById('versionsModalBody');
        modalBody.innerHTML = `
            <h6 class="mb-3">${escapeHtml(vendor)} - ${escapeHtml(productName)}</h6>
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Version</th>
                            <th>Status</th>
                            <th>Vulnerabilities</th>
                            <th>Source</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${versions.map(v => `
                            <tr>
                                <td>
                                    <span class="badge ${v.is_vulnerable ? 'bg-danger' : 'bg-info'}">
                                        ${v.is_vulnerable ? '<i class="bi bi-exclamation-triangle-fill me-1"></i>' : ''}
                                        ${escapeHtml(v.version)}
                                    </span>
                                </td>
                                <td>${v.active ? '<span class="badge badge-status-active">Active</span>' : '<span class="badge badge-status-inactive">Inactive</span>'}</td>
                                <td>${v.vulnerability_count > 0 ? `<span class="badge bg-danger">${v.vulnerability_count} CVEs</span>` : '<span class="text-success">None</span>'}</td>
                                <td><span class="badge bg-secondary">${escapeHtml(v.source || 'manual')}</span></td>
                                <td>
                                    <div class="d-flex gap-1">
                                        ${userPermissions.canManageProducts ? `
                                        <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${v.id}); bootstrap.Modal.getInstance(document.getElementById('versionsModal')).hide();" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteVersionFromModal(${v.id}, '${escapeHtml(v.version)}')" title="Delete">
                                            <i class="bi bi-trash3"></i>
                                        </button>` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    // Delete a single version from the versions modal
    async function deleteVersionFromModal(versionId, versionName) {
        const confirmed = await showConfirm(
            `Delete version "<strong>${escapeHtml(versionName)}</strong>"?`,
            'Delete Version',
            'Delete',
            'btn-danger'
        );

        if (!confirmed) return;

        showLoading();
        try {
            const response = await fetch(`/api/products/${versionId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('✓ Version deleted', 'success');
                // Close modal and refresh
                const modalEl = document.getElementById('versionsModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
                loadProducts();
            } else {
                showToast('✗ Error deleting version', 'danger');
            }
        } catch (error) {
            showToast(`✗ Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function loadOrganizationsIntoProductForm() {
        const select = document.getElementById('productOrganization');
        if (!select) return;

        select.innerHTML = '<option value="">Loading...</option>';
        select.disabled = true;

        try {
            const response = await fetch('/api/organizations', {
                method: 'GET',
                credentials: 'same-origin',
                headers: { 'Accept': 'application/json' }
            });

            if (response.ok) {
                const orgs = await response.json();
                if (Array.isArray(orgs) && orgs.length > 0) {
                    select.innerHTML = '<option value="">Select organization (optional)...</option>' +
                        orgs.map(org => `<option value="${org.id}">${escapeHtml(org.display_name || org.name)}</option>`).join('');
                } else {
                    select.innerHTML = '<option value="">No organizations available</option>';
                }
            } else {
                select.innerHTML = `<option value="">Failed to load (${response.status})</option>`;
            }
        } catch (error) {
            select.innerHTML = '<option value="">Network error</option>';
        } finally {
            select.disabled = false;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Service Catalog Functions
    async function showServiceCatalog() {
        // Clear previous selection state
        selectedCatalogItems.clear();
        updateCatalogSelectionUI();

        // Load catalog if not already loaded
        if (serviceCatalog.length === 0) {
            await loadServiceCatalog();
        } else {
            // Re-render to clear visual checkboxes
            renderCatalog(serviceCatalog);
        }

        // Load organizations into dropdown
        try {
            const response = await fetch('/api/organizations');
            if (response.ok) {
                const orgs = await response.json();
                const select = document.getElementById('catalogOrgSelect');
                select.innerHTML = orgs.map(org =>
                    `<option value="${org.id}">${escapeHtml(org.display_name)}</option>`
                ).join('');
            }
        } catch (error) {
            console.error('Error loading organizations:', error);
        }

        // Show modal - reuse existing instance or create new one
        const modalElement = document.getElementById('serviceCatalogModal');
        let modal = bootstrap.Modal.getInstance(modalElement);
        if (!modal) {
            modal = new bootstrap.Modal(modalElement);
        }
        modal.show();
    }

    async function loadServiceCatalog() {
        const tbody = document.getElementById('catalogTable');

        try {
            const response = await fetch('/api/catalog');
            serviceCatalog = await response.json();

            renderCatalog(serviceCatalog);
        } catch (error) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle"></i> Error loading catalog: ${error.message}
                    </td>
                </tr>
            `;
        }
    }

    function renderCatalog(catalog) {
        const tbody = document.getElementById('catalogTable');

        if (catalog.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4 text-muted">
                        No services found matching your search
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = catalog.map(service => {
            const isChecked = selectedCatalogItems.has(service.id);
            let versions = [];
            try {
                versions = service.typical_versions ? JSON.parse(service.typical_versions) : [];
            } catch (e) {
                versions = [];
            }

            // Build version dropdown options
            const selectedVersion = selectedVersions[service.id] || (versions.length > 0 ? versions[0] : '');
            const versionOptions = versions.length > 0
                ? versions.map(v => `<option value="${escapeHtml(v)}" ${v === selectedVersion ? 'selected' : ''}>${escapeHtml(v)}</option>`).join('')
                : '<option value="">N/A</option>';

            return `
                <tr onclick="toggleCatalogRow(${service.id}, event)" style="cursor: pointer;">
                    <td onclick="event.stopPropagation();">
                        <input type="checkbox"
                               class="form-check-input catalog-item-checkbox"
                               data-catalog-id="${service.id}"
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleCatalogSelection(${service.id}, event)">
                    </td>
                    <td class="fw-semibold">${escapeHtml(service.product_name)}</td>
                    <td>${escapeHtml(service.vendor)}</td>
                    <td onclick="event.stopPropagation();">
                        <select class="form-select form-select-sm version-select"
                                data-catalog-id="${service.id}"
                                onchange="updateSelectedVersion(${service.id}, this.value)"
                                style="min-width: 100px;">
                            ${versionOptions}
                        </select>
                    </td>
                    <td><small class="text-muted">${escapeHtml(service.category || '')}</small></td>
                </tr>
            `;
        }).join('');
    }

    function updateSelectedVersion(catalogId, version) {
        selectedVersions[catalogId] = version;
    }

    function filterCatalog(query) {
        const lowerQuery = query.toLowerCase();

        const filtered = serviceCatalog.filter(service => {
            return service.vendor.toLowerCase().includes(lowerQuery) ||
                   service.product_name.toLowerCase().includes(lowerQuery) ||
                   (service.keywords && service.keywords.toLowerCase().includes(lowerQuery));
        });

        renderCatalog(filtered);
    }

    function toggleCatalogSelection(catalogId, event) {
        // Toggle selection state
        if (selectedCatalogItems.has(catalogId)) {
            selectedCatalogItems.delete(catalogId);
        } else {
            selectedCatalogItems.add(catalogId);
        }

        // Update UI
        updateCatalogSelectionUI();
    }

    function toggleCatalogRow(catalogId, event) {
        if (event) event.stopPropagation();
        const checkbox = document.querySelector(`.catalog-item-checkbox[data-catalog-id="${catalogId}"]`);
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            toggleCatalogSelection(catalogId, event);
        }
    }

    function toggleCatalogSelectAll() {
        const selectAllCheckbox = document.getElementById('catalogSelectAll');
        const checkboxes = document.querySelectorAll('.catalog-item-checkbox');

        checkboxes.forEach(checkbox => {
            const catalogId = parseInt(checkbox.dataset.catalogId);
            if (selectAllCheckbox.checked) {
                selectedCatalogItems.add(catalogId);
                checkbox.checked = true;
            } else {
                selectedCatalogItems.delete(catalogId);
                checkbox.checked = false;
            }
        });

        updateCatalogSelectionUI();
    }

    function updateCatalogSelectionUI() {
        const count = selectedCatalogItems.size;
        const countBadge = document.getElementById('catalogSelectionCount');
        const addBtn = document.getElementById('addSelectedBtn');

        if (count > 0) {
            countBadge.textContent = `${count} selected`;
            countBadge.style.display = 'inline-block';
            addBtn.disabled = false;
        } else {
            countBadge.style.display = 'none';
            addBtn.disabled = true;
        }
    }

    async function addSelectedFromCatalog() {
        if (selectedCatalogItems.size === 0) {
            showToast('Please select at least one service', 'warning');
            return;
        }

        const orgSelect = document.getElementById('catalogOrgSelect');
        const selectedOrgIds = Array.from(orgSelect.selectedOptions).map(opt => parseInt(opt.value)).filter(id => !isNaN(id));

        const addBtn = document.getElementById('addSelectedBtn');
        const originalText = addBtn.innerHTML;

        addBtn.disabled = true;
        addBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Adding...';

        try {
            let successCount = 0;
            let duplicateCount = 0;
            let failCount = 0;

            // Create products for all selected services in parallel for better performance
            const requests = Array.from(selectedCatalogItems).map(async catalogId => {
                const service = serviceCatalog.find(s => s.id === catalogId);
                if (!service) return { status: 'failed' };

                try {
                    // Get selected version for this catalog item
                    let versions = [];
                    try {
                        versions = service.typical_versions ? JSON.parse(service.typical_versions) : [];
                    } catch (e) {
                        versions = [];
                    }
                    const version = selectedVersions[catalogId] || (versions.length > 0 ? versions[0] : '');

                    const productData = {
                        vendor: service.vendor,
                        product_name: service.product_name,
                        version: version,
                        keywords: service.keywords || '',
                        service_catalog_id: catalogId,
                        active: true
                    };

                    // Don't set organization_id when creating - we'll use multi-org assignment
                    const response = await fetch('/api/products', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });

                    if (response.ok) {
                        const product = await response.json();

                        // If organizations were selected, assign the product to them
                        if (selectedOrgIds.length > 0) {
                            await fetch(`/api/products/${product.id}/organizations`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ organization_ids: selectedOrgIds })
                            });
                        }

                        return { status: 'success' };
                    } else if (response.status === 409) {
                        return { status: 'duplicate' };
                    } else {
                        return { status: 'failed' };
                    }
                } catch (error) {
                    return { status: 'failed' };
                }
            });

            // Wait for all requests to complete
            const results = await Promise.all(requests);

            results.forEach(result => {
                if (result.status === 'success') successCount++;
                else if (result.status === 'duplicate') duplicateCount++;
                else if (result.status === 'failed') failCount++;
            });

            // Clear selection and close modals
            selectedCatalogItems.clear();
            updateCatalogSelectionUI();
            bootstrap.Modal.getInstance(document.getElementById('serviceCatalogModal')).hide();

            // Also close the product modal if it's open
            const productModal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            if (productModal) {
                productModal.hide();
            }

            // Show results with detailed message
            let message = '';
            if (successCount > 0) {
                message = `✓ Successfully added ${successCount} product(s)`;
                if (duplicateCount > 0) message += `, ${duplicateCount} already existed`;
                if (failCount > 0) message += `, ${failCount} failed`;
                showToast(message, 'success');
                loadProducts();
            } else if (duplicateCount > 0) {
                showToast(`⚠ ${duplicateCount} product(s) already existed`, 'warning');
            } else {
                showToast('Failed to add products', 'danger');
            }
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            addBtn.disabled = false;
            addBtn.innerHTML = originalText;
        }
    }

    async function selectFromCatalog(catalogId) {
        try {
            const response = await fetch(`/api/catalog/${catalogId}`);
            const service = await response.json();

            // Fill form fields with catalog data
            document.getElementById('vendor').value = service.vendor;
            document.getElementById('productName').value = service.product_name;
            document.getElementById('keywords').value = service.keywords || '';
            document.getElementById('serviceCatalogId').value = catalogId;

            // Close catalog modal
            bootstrap.Modal.getInstance(document.getElementById('serviceCatalogModal')).hide();

            // Automatically save the product and close the form modal
            setTimeout(async () => {
                await saveProduct();
            }, 300);
        } catch (error) {
            showToast(`Error loading service: ${error.message}`, 'danger');
        }
    }

    async function searchVendors(query) {
        if (!query || query.length < 2) {
            document.getElementById('vendorSuggestions').innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/api/catalog/search?type=vendor&q=${encodeURIComponent(query)}`);
            const vendors = await response.json();

            const datalist = document.getElementById('vendorSuggestions');
            datalist.innerHTML = vendors.map(vendor =>
                `<option value="${escapeHtml(vendor)}">`
            ).join('');
        } catch (error) {
            console.error('Error searching vendors:', error);
        }
    }

    async function searchProducts(query) {
        if (!query || query.length < 2) {
            document.getElementById('productSuggestions').innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/api/catalog/search?type=product&q=${encodeURIComponent(query)}`);
            const products = await response.json();

            const datalist = document.getElementById('productSuggestions');
            datalist.innerHTML = products.map(product =>
                `<option value="${escapeHtml(product)}">`
            ).join('');
        } catch (error) {
            console.error('Error searching products:', error);
        }
    }

    // ============================================================================
    // Bulk Operations
    // ============================================================================

    let selectedProducts = new Map(); // Map of productId -> { id, active, name }

    function updateBulkToolbar() {
        const toolbar = document.getElementById('bulkActionsToolbar');
        const count = selectedProducts.size;
        document.getElementById('selectedCount').textContent = count;

        if (count > 0) {
            toolbar.style.display = 'block';

            // Check active states of selected products
            const activeCount = Array.from(selectedProducts.values()).filter(p => p.active).length;
            const inactiveCount = count - activeCount;

            // Update Activate button
            const activateBtn = toolbar.querySelector('button[onclick="bulkActivate()"]');
            if (activateBtn) {
                if (inactiveCount === 0) {
                    // All selected are already active
                    activateBtn.disabled = true;
                    activateBtn.title = 'All selected products are already active';
                } else {
                    activateBtn.disabled = false;
                    activateBtn.title = inactiveCount < count
                        ? `Activate ${inactiveCount} inactive product(s)`
                        : `Activate ${count} product(s)`;
                }
            }

            // Update Deactivate button
            const deactivateBtn = toolbar.querySelector('button[onclick="bulkDeactivate()"]');
            if (deactivateBtn) {
                if (activeCount === 0) {
                    // All selected are already inactive
                    deactivateBtn.disabled = true;
                    deactivateBtn.title = 'All selected products are already inactive';
                } else {
                    deactivateBtn.disabled = false;
                    deactivateBtn.title = activeCount < count
                        ? `Deactivate ${activeCount} active product(s)`
                        : `Deactivate ${count} product(s)`;
                }
            }
        } else {
            toolbar.style.display = 'none';
        }
    }

    function toggleProductSelect(productId, checkbox) {
        if (checkbox.checked) {
            // Get the product's active status from the row
            const row = checkbox.closest('tr');
            const statusBadge = row.querySelector('.badge-status-active, .badge-status-inactive');
            const isActive = statusBadge ? statusBadge.classList.contains('badge-status-active') : true;
            const vendorCell = row.querySelector('td[data-column="vendor"]');
            const productCell = row.querySelector('td[data-column="product"]');
            const name = `${vendorCell?.textContent || ''} ${productCell?.textContent || ''}`.trim();

            selectedProducts.set(productId, { id: productId, active: isActive, name: name });
        } else {
            selectedProducts.delete(productId);
        }
        updateBulkToolbar();
    }

    function toggleProductRow(productIds, event) {
        if (event) event.stopPropagation();
        const checkbox = document.querySelector(`.product-checkbox[data-product-ids="${productIds}"]`);
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            toggleGroupSelect(productIds, checkbox);
        }
    }

    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (!selectAllCheckbox) {
            console.error('Select all checkbox not found');
            return;
        }

        const checkboxes = document.querySelectorAll('.product-checkbox');

        if (checkboxes.length === 0) {
            console.warn('No product checkboxes found');
            return;
        }

        const isChecked = selectAllCheckbox.checked;

        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            // data-product-ids contains comma-separated IDs for grouped products
            const productIdsStr = checkbox.dataset.productIds || '';
            const productIds = productIdsStr.split(',').filter(id => id).map(id => parseInt(id));

            productIds.forEach(productId => {
                if (!isNaN(productId)) {
                    if (isChecked) {
                        // Get product info from the row
                        const row = checkbox.closest('tr');
                        const statusBadge = row ? row.querySelector('.badge-status-active, .badge-status-inactive') : null;
                        const isActive = statusBadge ? statusBadge.classList.contains('badge-status-active') : true;
                        const vendorCell = row ? row.querySelector('td[data-column="vendor"]') : null;
                        const productCell = row ? row.querySelector('td[data-column="product"]') : null;
                        const name = `${vendorCell?.textContent || ''} ${productCell?.textContent || ''}`.trim();

                        selectedProducts.set(productId, { id: productId, active: isActive, name: name });
                    } else {
                        selectedProducts.delete(productId);
                    }
                }
            });
        });

        updateBulkToolbar();
    }

    function clearSelection() {
        selectedProducts.clear();
        document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAllCheckbox').checked = false;
        updateBulkToolbar();
    }

    async function bulkAssignOrganization() {
        if (selectedProducts.size === 0) return;

        // Load organizations for selection
        const response = await fetch('/api/organizations');
        const orgs = await response.json();

        const orgList = orgs.map((o, i) => `${i + 1}. ${escapeHtml(o.display_name)} (ID: ${o.id})`).join('<br>');

        const orgId = await showPrompt(
            `Assign ${selectedProducts.size} product(s) to organization:<br><br>${orgList}<br><br>Enter Organization ID:`,
            '',
            'Assign to Organization'
        );

        if (!orgId) return;

        showLoading();
        try {
            const promises = Array.from(selectedProducts.keys()).map(productId =>
                fetch(`/api/products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ organization_id: parseInt(orgId) })
                })
            );

            await Promise.all(promises);
            showToast(`${selectedProducts.size} product(s) assigned successfully`, 'success');
            clearSelection();
            loadProducts();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function bulkActivate() {
        if (selectedProducts.size === 0) return;

        // Separate products by current status
        const toActivate = Array.from(selectedProducts.values()).filter(p => !p.active);
        const alreadyActive = Array.from(selectedProducts.values()).filter(p => p.active);

        if (toActivate.length === 0) {
            showToast('All selected products are already active', 'info');
            return;
        }

        // Build confirmation message
        let message = '';
        if (alreadyActive.length > 0) {
            message += `<div class="mb-3"><strong>Already active (${alreadyActive.length}):</strong><ul class="mb-0 text-muted small">`;
            alreadyActive.slice(0, 5).forEach(p => {
                message += `<li>${escapeHtml(p.name)}</li>`;
            });
            if (alreadyActive.length > 5) message += `<li>...and ${alreadyActive.length - 5} more</li>`;
            message += `</ul></div>`;
        }

        message += `<div><strong>Will be activated (${toActivate.length}):</strong><ul class="mb-0">`;
        toActivate.slice(0, 5).forEach(p => {
            message += `<li>${escapeHtml(p.name)}</li>`;
        });
        if (toActivate.length > 5) message += `<li>...and ${toActivate.length - 5} more</li>`;
        message += `</ul></div>`;

        const confirmed = await showConfirm(
            message,
            'Activate Products',
            `Activate ${toActivate.length}`,
            'btn-success'
        );

        if (!confirmed) return;

        showLoading();
        try {
            const promises = toActivate.map(product =>
                fetch(`/api/products/${product.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active: true })
                })
            );

            await Promise.all(promises);
            showToast(`${toActivate.length} product(s) activated`, 'success');
            clearSelection();
            loadProducts();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function bulkDeactivate() {
        if (selectedProducts.size === 0) return;

        // Separate products by current status
        const toDeactivate = Array.from(selectedProducts.values()).filter(p => p.active);
        const alreadyInactive = Array.from(selectedProducts.values()).filter(p => !p.active);

        if (toDeactivate.length === 0) {
            showToast('All selected products are already inactive', 'info');
            return;
        }

        // Build confirmation message
        let message = '';
        if (alreadyInactive.length > 0) {
            message += `<div class="mb-3"><strong>Already inactive (${alreadyInactive.length}):</strong><ul class="mb-0 text-muted small">`;
            alreadyInactive.slice(0, 5).forEach(p => {
                message += `<li>${escapeHtml(p.name)}</li>`;
            });
            if (alreadyInactive.length > 5) message += `<li>...and ${alreadyInactive.length - 5} more</li>`;
            message += `</ul></div>`;
        }

        message += `<div><strong>Will be deactivated (${toDeactivate.length}):</strong><ul class="mb-0">`;
        toDeactivate.slice(0, 5).forEach(p => {
            message += `<li>${escapeHtml(p.name)}</li>`;
        });
        if (toDeactivate.length > 5) message += `<li>...and ${toDeactivate.length - 5} more</li>`;
        message += `</ul></div>`;

        const confirmed = await showConfirm(
            message,
            'Deactivate Products',
            `Deactivate ${toDeactivate.length}`,
            'btn-warning'
        );

        if (!confirmed) return;

        showLoading();
        try {
            const promises = toDeactivate.map(product =>
                fetch(`/api/products/${product.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active: false })
                })
            );

            await Promise.all(promises);
            showToast(`${toDeactivate.length} product(s) deactivated`, 'success');
            clearSelection();
            loadProducts();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function bulkDelete() {
        if (selectedProducts.size === 0) return;

        // Build list of products to delete
        const products = Array.from(selectedProducts.values());
        let message = `<strong>⚠️ DELETE ${selectedProducts.size} product(s)?</strong><br><br>`;
        message += `<ul class="mb-0">`;
        products.slice(0, 5).forEach(p => {
            message += `<li>${escapeHtml(p.name)}</li>`;
        });
        if (products.length > 5) message += `<li>...and ${products.length - 5} more</li>`;
        message += `</ul><br>This action cannot be undone.`;

        const confirmed = await showConfirm(
            message,
            'Delete Products',
            'Delete All',
            'btn-danger'
        );

        if (!confirmed) return;

        showLoading();
        const productIds = Array.from(selectedProducts.keys());
        let successCount = 0;
        let failCount = 0;

        try {
            // Process in batches of 10 to avoid overwhelming the server
            const batchSize = 10;
            let rateLimited = false;

            for (let i = 0; i < productIds.length; i += batchSize) {
                // If we got rate limited, stop processing
                if (rateLimited) break;

                const batch = productIds.slice(i, i + batchSize);
                const results = await Promise.all(
                    batch.map(async (productId) => {
                        try {
                            const response = await fetch(`/api/products/${productId}`, { method: 'DELETE' });
                            if (response.status === 429) {
                                rateLimited = true;
                                return { ok: false, rateLimited: true };
                            }
                            return { ok: response.ok, rateLimited: false };
                        } catch {
                            return { ok: false, rateLimited: false };
                        }
                    })
                );
                successCount += results.filter(r => r.ok).length;
                failCount += results.filter(r => !r.ok && !r.rateLimited).length;
            }

            if (rateLimited) {
                showToast(`Rate limit reached. Deleted ${successCount} products. Please wait a minute and try again.`, 'warning');
            } else if (failCount === 0) {
                showToast(`${successCount} product(s) deleted successfully`, 'success');
            } else if (successCount === 0) {
                showToast(`Failed to delete ${failCount} product(s)`, 'danger');
            } else {
                showToast(`Deleted ${successCount}, failed ${failCount}`, 'warning');
            }
            clearSelection();
            loadProducts();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    // Organization management functions
    let currentOrgProductId = null;
    let currentOrgProductName = '';
    let allOrganizations = [];

    async function manageOrganizations(productId) {
        currentOrgProductId = productId;

        // Clean up any existing backdrops first
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');

        // Get product details
        try {
            const productResponse = await fetch(`/api/products/${productId}`);
            const product = await productResponse.json();
            currentOrgProductName = `${product.vendor} ${product.product_name}`;
            document.getElementById('orgModalProductName').textContent = currentOrgProductName;

            // Load assigned organizations
            await loadAssignedOrganizations(productId);

            // Load all organizations
            await loadAllOrganizations();

            // Dispose of any existing modal instance and create fresh
            const modalElement = document.getElementById('orgManagementModal');
            const existingModal = bootstrap.Modal.getInstance(modalElement);
            if (existingModal) {
                existingModal.dispose();
            }

            // Create and show new modal
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement, {
                backdrop: true,
                keyboard: true
            });
            modal.show();
        } catch (error) {
            showToast(`Error loading organizations: ${error.message}`, 'danger');
        }
    }

    async function loadAssignedOrganizations(productId) {
        const container = document.getElementById('assignedOrgsList');
        container.innerHTML = '<div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm"></div></div>';

        try {
            const response = await fetch(`/api/products/${productId}/organizations`);
            const data = await response.json();
            const assignedOrgs = data.organizations || [];

            if (assignedOrgs.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">No organizations assigned</div>';
            } else {
                container.innerHTML = assignedOrgs.map(org => `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom" id="org-item-${org.id}">
                        <span><i class="bi bi-building text-primary me-2"></i>${escapeHtml(org.display_name)}</span>
                        <div class="btn-group btn-group-sm" id="org-actions-${org.id}">
                            <button class="btn btn-sm btn-outline-danger" onclick="showRemoveConfirm(${org.id}, '${escapeHtml(org.display_name)}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            container.innerHTML = '<div class="text-center text-danger py-3">Error loading assigned organizations</div>';
        }
    }

    async function loadAllOrganizations() {
        try {
            const response = await fetch('/api/organizations');
            allOrganizations = await response.json();

            // Get currently assigned organization IDs
            const assignedResponse = await fetch(`/api/products/${currentOrgProductId}/organizations`);
            const assignedData = await assignedResponse.json();
            const assignedOrgIds = new Set((assignedData.organizations || []).map(org => org.id));

            // Filter out already-assigned organizations
            const availableOrgs = allOrganizations.filter(org => !assignedOrgIds.has(org.id));

            const select = document.getElementById('addOrgSelect');
            if (availableOrgs.length === 0) {
                select.innerHTML = '<option value="" disabled>All organizations already assigned</option>';
            } else {
                select.innerHTML = availableOrgs.map(org =>
                    `<option value="${org.id}">${escapeHtml(org.display_name)}</option>`
                ).join('');
            }
        } catch (error) {
            showToast(`Error loading organizations: ${error.message}`, 'danger');
        }
    }

    async function assignOrganizations() {
        const select = document.getElementById('addOrgSelect');
        const selectedOptions = Array.from(select.selectedOptions);
        const orgIds = selectedOptions.map(opt => parseInt(opt.value));

        if (orgIds.length === 0) {
            showToast('Please select at least one organization', 'warning');
            return;
        }

        try {
            showLoading();
            const response = await fetch(`/api/products/${currentOrgProductId}/organizations`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ organization_ids: orgIds })
            });

            const data = await response.json();

            if (response.ok) {
                showToast(data.message || 'Organizations assigned successfully', 'success');
                await loadAssignedOrganizations(currentOrgProductId);
                loadProducts(); // Refresh product list
            } else {
                showToast(data.error || 'Failed to assign organizations', 'danger');
            }
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    function showConfirmation(message, onConfirm) {
        document.getElementById('confirmationMessage').textContent = message;

        // Reuse existing modal instance or create new one
        const modalElement = document.getElementById('confirmationModal');
        let modal = bootstrap.Modal.getInstance(modalElement);
        if (!modal) {
            modal = new bootstrap.Modal(modalElement);
        }

        const confirmBtn = document.getElementById('confirmActionBtn');

        // Remove any existing event listeners by cloning the button
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        // Add new event listener
        newConfirmBtn.addEventListener('click', () => {
            modal.hide();
            onConfirm();
        });

        modal.show();
    }

    function showRemoveConfirm(orgId, orgName) {
        // Show inline confirmation buttons
        const actionsDiv = document.getElementById(`org-actions-${orgId}`);
        actionsDiv.innerHTML = `
            <div class="alert alert-danger p-2 mb-0 d-flex align-items-center" style="font-size: 0.875rem;">
                <span class="me-2">Remove? Org admins will be notified.</span>
                <button class="btn btn-danger btn-sm me-1" onclick="confirmRemoveOrganization(${orgId})">
                    <i class="bi bi-check2"></i> Yes
                </button>
                <button class="btn btn-secondary btn-sm" onclick="loadAssignedOrganizations(${currentOrgProductId})">
                    <i class="bi bi-x"></i> Cancel
                </button>
            </div>
        `;
    }

    async function confirmRemoveOrganization(orgId, forceDelete = false) {
        try {
            showLoading();
            let url = `/api/products/${currentOrgProductId}/organizations/${orgId}`;
            if (forceDelete) {
                url += '?confirm_delete=true';
            }

            const response = await fetch(url, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                showToast(data.message || 'Organization removed successfully', 'success');

                // If product was deleted (no orgs left), close the modal
                if (data.product_deleted) {
                    const modalElement = document.getElementById('orgManagementModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                } else {
                    // Just reload the org list
                    await loadAssignedOrganizations(currentOrgProductId);
                }

                loadProducts(); // Refresh product list
            } else if (data.requires_confirmation) {
                // This is the last organization - show confirmation dialog
                hideLoading();
                showLastOrgConfirmation(orgId, data.message);
            } else {
                showToast(data.error || 'Failed to remove organization', 'danger');
            }
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    function showLastOrgConfirmation(orgId, message) {
        // Show a modal asking user what to do with the last organization
        const actionsDiv = document.getElementById(`org-actions-${orgId}`);
        actionsDiv.innerHTML = `
            <div class="alert alert-warning p-2 mb-0" style="font-size: 0.875rem;">
                <div class="mb-2"><i class="bi bi-exclamation-triangle"></i> <strong>Last Organization</strong></div>
                <div class="mb-2">${message}</div>
                <div class="d-flex gap-1">
                    <button class="btn btn-danger btn-sm" onclick="confirmRemoveOrganization(${orgId}, true)">
                        <i class="bi bi-trash"></i> Delete Product
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="loadAssignedOrganizations(${currentOrgProductId})">
                        <i class="bi bi-x"></i> Cancel
                    </button>
                </div>
            </div>
        `;
    }

    // =========================================================================
    // NVD Search Functions (Primary Method for Adding Products)
    // =========================================================================

    let nvdSearchTimeout = null;
    let nvdSelectedVendor = null;
    let nvdSelectedProduct = null;

    function debounceNVDSearch() {
        if (nvdSearchTimeout) clearTimeout(nvdSearchTimeout);
        const statusEl = document.getElementById('nvdSearchStatus');
        statusEl.textContent = 'Typing...';
        statusEl.style.display = 'block';

        nvdSearchTimeout = setTimeout(() => {
            const query = document.getElementById('nvdSearchInput').value.trim();
            if (query.length >= 2) {
                performNVDSearchNow();
            } else {
                statusEl.textContent = 'Enter at least 2 characters to search';
                document.getElementById('nvdResultsList').style.display = 'none';
            }
        }, 400);
    }

    async function performNVDSearchNow() {
        const query = document.getElementById('nvdSearchInput').value.trim();
        const statusEl = document.getElementById('nvdSearchStatus');
        const resultsList = document.getElementById('nvdResultsList');

        if (query.length < 2) {
            statusEl.textContent = 'Enter at least 2 characters to search';
            statusEl.style.display = 'block';
            resultsList.style.display = 'none';
            return;
        }

        statusEl.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Searching NVD database...';
        statusEl.style.display = 'block';
        resultsList.style.display = 'block';
        resultsList.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

        try {
            const response = await fetch(`/api/cpe/search?q=${encodeURIComponent(query)}&grouped=true&limit=50`);
            const data = await response.json();

            if (!response.ok) {
                statusEl.textContent = data.error || 'Search failed';
                statusEl.className = 'small text-danger mb-2';
                resultsList.innerHTML = '';
                resultsList.style.display = 'none';
                return;
            }

            const vendors = data.vendors || {};
            const vendorKeys = Object.keys(vendors);
            const totalProducts = vendorKeys.reduce((sum, v) => sum + Object.keys(vendors[v].products || {}).length, 0);

            if (vendorKeys.length === 0) {
                statusEl.textContent = 'No products found. Try different search terms.';
                statusEl.className = 'small text-muted mb-2';
                resultsList.innerHTML = `
                    <div class="p-4 text-center text-muted">
                        <i class="bi bi-search" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No results found in NVD database.</p>
                        <small>Try searching for vendor names like "microsoft", "apache", "cisco"</small>
                    </div>
                `;
                return;
            }

            statusEl.textContent = `Found ${totalProducts} product(s) from ${vendorKeys.length} vendor(s) - Click to select`;
            statusEl.className = 'small text-success mb-2';

            let html = '';
            for (const vendorKey of vendorKeys) {
                const vendorData = vendors[vendorKey];
                const products = vendorData.products || {};

                // Format vendor name for display
                const formattedVendor = vendorKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                for (const [productKey, productData] of Object.entries(products)) {
                    const versions = productData.versions || [];
                    const displayName = productData.display_name || productData.title || productKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const versionCount = versions.length;
                    const productId = `nvd_${vendorKey}_${productKey}`.replace(/[^a-zA-Z0-9_]/g, '_');

                    // Create clear full product name: "Vendor - Product Name"
                    const fullProductName = `${formattedVendor} - ${displayName}`;

                    // Get version hint for context
                    const versionHint = versions.length > 0 ? versions[0] : '';

                    html += `
                        <div class="nvd-product-group" id="${productId}">
                            <div class="p-2 border-bottom nvd-result-item" style="cursor: pointer;"
                                 onclick="toggleVersionPicker('${productId}', '${escapeHtml(vendorKey)}', '${escapeHtml(productKey)}', '${escapeHtml(displayName)}', ${JSON.stringify(versions).replace(/"/g, '&quot;')})">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="fw-bold text-primary">${escapeHtml(fullProductName)}</div>
                                        <small class="text-muted font-monospace">cpe:${escapeHtml(vendorKey)}:${escapeHtml(productKey)}</small>
                                        ${versionHint ? `<small class="text-muted ms-2">(e.g. ${escapeHtml(versionHint)})</small>` : ''}
                                    </div>
                                    <span class="badge bg-primary"><i class="bi bi-chevron-down"></i> ${versionCount} ver</span>
                                </div>
                            </div>
                            <div class="version-picker bg-light p-2" style="display: none;">
                                <!-- Versions populated on click -->
                            </div>
                        </div>
                    `;
                }
            }

            resultsList.innerHTML = html;

            // Add hover effect
            document.querySelectorAll('.nvd-result-item').forEach(item => {
                item.addEventListener('mouseenter', () => item.classList.add('bg-light'));
                item.addEventListener('mouseleave', () => item.classList.remove('bg-light'));
            });

        } catch (error) {
            statusEl.textContent = `Error: ${error.message}`;
            statusEl.className = 'small text-danger mb-2';
            resultsList.innerHTML = '';
            resultsList.style.display = 'none';
        }
    }

    let currentExpandedProduct = null;

    function toggleVersionPicker(productId, vendor, product, displayName, versions) {
        const group = document.getElementById(productId);
        const picker = group.querySelector('.version-picker');

        // Close any other open picker
        if (currentExpandedProduct && currentExpandedProduct !== productId) {
            const prevGroup = document.getElementById(currentExpandedProduct);
            if (prevGroup) {
                prevGroup.querySelector('.version-picker').style.display = 'none';
            }
        }

        // Toggle current picker
        if (picker.style.display === 'none') {
            // Build version buttons
            let html = `
                <div class="mb-1"><small class="text-muted fw-bold">Select version:</small></div>
                <div class="d-flex flex-wrap gap-1">
                    <button type="button" class="btn btn-sm btn-outline-primary"
                            onclick="selectNVDProduct('${escapeHtml(vendor)}', '${escapeHtml(product)}', '${escapeHtml(displayName)}', '')">
                        <i class="bi bi-asterisk"></i> All Versions
                    </button>
            `;

            // Show up to 15 most recent versions
            const showVersions = versions.slice(0, 15);
            for (const ver of showVersions) {
                html += `
                    <button type="button" class="btn btn-sm btn-outline-secondary"
                            onclick="selectNVDProduct('${escapeHtml(vendor)}', '${escapeHtml(product)}', '${escapeHtml(displayName)}', '${escapeHtml(ver)}')">
                        ${escapeHtml(ver)}
                    </button>
                `;
            }

            if (versions.length > 15) {
                html += `<span class="badge bg-light text-muted align-self-center">+${versions.length - 15} more</span>`;
            }

            html += '</div>';
            picker.innerHTML = html;
            picker.style.display = 'block';
            currentExpandedProduct = productId;
        } else {
            picker.style.display = 'none';
            currentExpandedProduct = null;
        }
    }

    function selectNVDProduct(vendor, product, displayName, version) {
        nvdSelectedVendor = vendor;
        nvdSelectedProduct = product;

        const versionStr = version || '*';

        // Format vendor name for display
        const formattedVendor = vendor.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

        // Set hidden CPE fields
        safeSetValue('cpeVendor', vendor);
        safeSetValue('cpeProduct', product);
        safeSetValue('cpeUri', `cpe:2.3:a:${vendor}:${product}:${versionStr}:*:*:*:*:*:*:*`);

        // Show selected product card with full vendor - product name
        const fullSelectedName = `${formattedVendor} - ${displayName}`;
        safeSetText('nvdSelectedName', fullSelectedName);
        const versionBadge = document.getElementById('nvdSelectedVersion');
        if (versionBadge) {
            versionBadge.textContent = version ? `v${version}` : 'All versions';
            versionBadge.className = version ? 'badge bg-primary ms-1' : 'badge bg-secondary ms-1';
        }
        safeSetText('nvdSelectedCpe', `CPE: ${vendor}:${product}:${versionStr}`);
        safeSetDisplay('nvdSelectedProduct', 'block');

        // Hide search results, manual entry toggle, and CPE hint
        safeSetDisplay('nvdResultsList', 'none');
        safeSetDisplay('nvdSearchStatus', 'none');
        safeSetDisplay('manualEntryToggle', 'none');
        safeSetDisplay('noCpeHint', 'none');

        // Auto-fill vendor and product name fields
        // Format product for display (capitalize words, replace underscores)
        const formattedProduct = product.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

        safeSetValue('vendor', formattedVendor);
        safeSetValue('productName', formattedProduct);
        safeSetValue('version', version || '');

        // Update CPE status in advanced options
        safeSetDisplay('cpeSelectedInfo', 'block');
        safeSetText('cpeDisplayUri', `${vendor}:${product}`);
        safeSetDisplay('cpeNotLinkedInfo', 'none');
        safeSetDisplay('clearCpeBtn', 'inline-block');

        currentExpandedProduct = null;
    }

    function clearNVDSelection() {
        nvdSelectedVendor = null;
        nvdSelectedProduct = null;

        // Clear hidden fields
        safeSetValue('cpeVendor', '');
        safeSetValue('cpeProduct', '');
        safeSetValue('cpeUri', '');

        // Hide selected product card
        safeSetDisplay('nvdSelectedProduct', 'none');
        safeSetText('nvdSelectedName', '');
        safeSetText('nvdSelectedCpe', '');
        const versionBadge = document.getElementById('nvdSelectedVersion');
        if (versionBadge) versionBadge.textContent = '';

        // Clear form fields
        safeSetValue('vendor', '');
        safeSetValue('productName', '');
        safeSetValue('version', '');
        const versionSuggestions = document.getElementById('versionSuggestions');
        if (versionSuggestions) versionSuggestions.innerHTML = '';
        safeSetDisplay('loadVersionsBtn', 'none');

        // Reset CPE status in advanced options
        safeSetDisplay('cpeSelectedInfo', 'none');
        safeSetDisplay('cpeNotLinkedInfo', 'block');
        safeSetDisplay('clearCpeBtn', 'none');

        // Show search input and results (don't clear, let user refine)
        safeSetDisplay('nvdSearchStatus', 'block');
        safeSetDisplay('nvdResultsList', 'block');

        // Hide manual fields section
        safeSetDisplay('manualFieldsSection', 'none');

        // Show manual entry toggle again
        safeSetDisplay('manualEntryToggle', 'block');

        currentExpandedProduct = null;
    }

    function toggleManualEntry() {
        // Hide the toggle button
        const toggle = document.getElementById('manualEntryToggle');
        if (toggle) toggle.style.display = 'none';

        // Show manual fields section
        const manualFields = document.getElementById('manualFieldsSection');
        if (manualFields) manualFields.style.display = 'block';

        // Focus on the vendor field for manual entry
        const vendorInput = document.getElementById('vendor');
        if (vendorInput) {
            vendorInput.focus();
        }
    }

    async function loadVersionsFromNVD() {
        if (!nvdSelectedVendor || !nvdSelectedProduct) {
            showToast('Please select a product from NVD search first', 'warning');
            return;
        }

        const btn = document.getElementById('loadVersionsBtn');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/cpe/versions?vendor=${encodeURIComponent(nvdSelectedVendor)}&product=${encodeURIComponent(nvdSelectedProduct)}`);
            const data = await response.json();

            if (response.ok && data.versions) {
                const datalist = document.getElementById('versionSuggestions');
                datalist.innerHTML = data.versions.map(v => `<option value="${escapeHtml(v)}">`).join('');
                showToast(`Loaded ${data.versions.length} versions`, 'success');
            } else {
                showToast(data.error || 'Failed to load versions', 'warning');
            }
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

    function resetNVDSearch() {
        nvdSelectedVendor = null;
        nvdSelectedProduct = null;

        // Safe element access with null checks
        // Use different names to avoid shadowing the state variables
        const nvdSearchInputEl = document.getElementById('nvdSearchInput');
        const nvdSearchStatusEl = document.getElementById('nvdSearchStatus');
        const nvdResultsListEl = document.getElementById('nvdResultsList');
        const nvdSelectedProductEl = document.getElementById('nvdSelectedProduct');
        const versionSuggestionsEl = document.getElementById('versionSuggestions');
        const loadVersionsBtnEl = document.getElementById('loadVersionsBtn');
        const cpeSelectedInfoEl = document.getElementById('cpeSelectedInfo');
        const cpeNotLinkedInfoEl = document.getElementById('cpeNotLinkedInfo');
        const clearCpeBtnEl = document.getElementById('clearCpeBtn');
        const toggleEl = document.getElementById('manualEntryToggle');

        if (nvdSearchInputEl) {
            nvdSearchInputEl.value = '';
            nvdSearchInputEl.setAttribute('placeholder', "Search (e.g., 'apache tomcat', 'windows server')...");
            nvdSearchInputEl.classList.remove('border-warning');
        }
        if (nvdSearchStatusEl) nvdSearchStatusEl.style.display = 'none';
        // Hide CPE hint banner
        const noCpeHintEl = document.getElementById('noCpeHint');
        if (noCpeHintEl) noCpeHintEl.style.display = 'none';
        if (nvdResultsListEl) {
            nvdResultsListEl.style.display = 'none';
            nvdResultsListEl.innerHTML = '';
        }
        if (nvdSelectedProductEl) nvdSelectedProductEl.style.display = 'none';
        if (versionSuggestionsEl) versionSuggestionsEl.innerHTML = '';
        if (loadVersionsBtnEl) loadVersionsBtnEl.style.display = 'none';

        // Reset CPE status display
        if (cpeSelectedInfoEl) cpeSelectedInfoEl.style.display = 'none';
        if (cpeNotLinkedInfoEl) cpeNotLinkedInfoEl.style.display = 'block';
        if (clearCpeBtnEl) clearCpeBtnEl.style.display = 'none';

        // Show manual entry toggle
        if (toggleEl) toggleEl.style.display = 'block';
    }

    // =========================================================================
    // CPE (Common Platform Enumeration) Search Functions
    // =========================================================================

    let cpeSearchTimeout = null;

    function searchCPE() {
        // Pre-populate search with vendor + product name
        const vendor = document.getElementById('vendor').value.trim();
        const productName = document.getElementById('productName').value.trim();
        const searchInput = document.getElementById('cpeSearchInput');

        searchInput.value = `${vendor} ${productName}`.trim();

        document.getElementById('cpeSearchResults').style.display = 'block';
        document.getElementById('cpeResultsList').innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="ms-2 small">Searching NVD database...</span>
            </div>
        `;

        if (searchInput.value.length >= 2) {
            performCPESearch(searchInput.value);
        }
    }

    function closeCPESearch() {
        document.getElementById('cpeSearchResults').style.display = 'none';
    }

    function debounceCPESearch() {
        if (cpeSearchTimeout) clearTimeout(cpeSearchTimeout);
        cpeSearchTimeout = setTimeout(() => {
            const query = document.getElementById('cpeSearchInput').value.trim();
            if (query.length >= 2) {
                performCPESearch(query);
            }
        }, 400);
    }

    async function performCPESearch(query) {
        const resultsList = document.getElementById('cpeResultsList');

        try {
            const response = await fetch(`/api/cpe/search?q=${encodeURIComponent(query)}&grouped=true&limit=50`);
            const data = await response.json();

            if (!response.ok) {
                resultsList.innerHTML = `<div class="p-3 text-danger small">${data.error || 'Search failed'}</div>`;
                return;
            }

            const vendors = data.vendors || {};
            const vendorKeys = Object.keys(vendors);

            if (vendorKeys.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-3 text-muted small text-center">
                        <i class="bi bi-search me-1"></i>No products found in NVD database.
                        <br><small>Try a different search term or use keyword matching.</small>
                    </div>
                `;
                return;
            }

            let html = '<div class="list-group list-group-flush">';

            for (const vendorKey of vendorKeys) {
                const vendorData = vendors[vendorKey];
                const products = vendorData.products || {};

                for (const [productKey, productData] of Object.entries(products)) {
                    const versions = productData.versions || [];
                    const displayName = productData.display_name || productData.title || `${vendorKey}/${productKey}`;
                    const versionPreview = versions.slice(0, 5).join(', ');

                    html += `
                        <div class="list-group-item list-group-item-action py-2" style="cursor: pointer;"
                             onclick="selectCPE('${escapeHtml(vendorKey)}', '${escapeHtml(productKey)}', '${escapeHtml(displayName)}')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-semibold">${escapeHtml(displayName)}</div>
                                    <small class="text-muted">
                                        <code>cpe:2.3:a:${escapeHtml(vendorKey)}:${escapeHtml(productKey)}:*</code>
                                    </small>
                                </div>
                                <span class="badge bg-secondary">${versions.length} versions</span>
                            </div>
                            ${versionPreview ? `<small class="text-muted">Versions: ${escapeHtml(versionPreview)}${versions.length > 5 ? '...' : ''}</small>` : ''}
                        </div>
                    `;
                }
            }

            html += '</div>';
            resultsList.innerHTML = html;

        } catch (error) {
            resultsList.innerHTML = `<div class="p-3 text-danger small">Error: ${error.message}</div>`;
        }
    }

    function selectCPE(vendor, product, displayName) {
        // Set hidden fields
        document.getElementById('cpeVendor').value = vendor;
        document.getElementById('cpeProduct').value = product;
        document.getElementById('cpeUri').value = `cpe:2.3:a:${vendor}:${product}:*:*:*:*:*:*:*:*`;

        // Show selected info
        document.getElementById('cpeSelectedInfo').style.display = 'block';
        document.getElementById('cpeDisplayUri').textContent = `${vendor}:${product}`;

        // Hide search results
        document.getElementById('cpeSearchResults').style.display = 'none';

        // If vendor/product fields are empty, populate them
        const vendorInput = document.getElementById('vendor');
        const productInput = document.getElementById('productName');

        if (!vendorInput.value.trim()) {
            vendorInput.value = vendor.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        if (!productInput.value.trim()) {
            productInput.value = product.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        showToast('CPE linked: ' + displayName, 'success');
    }

    function clearCPE() {
        const cpeVendor = document.getElementById('cpeVendor');
        const cpeProduct = document.getElementById('cpeProduct');
        const cpeUri = document.getElementById('cpeUri');
        const cpeSelectedInfo = document.getElementById('cpeSelectedInfo');
        const matchType = document.getElementById('matchType');

        if (cpeVendor) cpeVendor.value = '';
        if (cpeProduct) cpeProduct.value = '';
        if (cpeUri) cpeUri.value = '';
        if (cpeSelectedInfo) cpeSelectedInfo.style.display = 'none';
        if (matchType) matchType.value = 'auto';
    }

    function resetCPEForm() {
        clearCPE();
        const cpeSearchResults = document.getElementById('cpeSearchResults');
        const cpeSearchInput = document.getElementById('cpeSearchInput');
        const cpeResultsList = document.getElementById('cpeResultsList');

        if (cpeSearchResults) cpeSearchResults.style.display = 'none';
        if (cpeSearchInput) cpeSearchInput.value = '';
        if (cpeResultsList) cpeResultsList.innerHTML = '';
    }

    function loadCPEIntoForm(product) {
        // Load CPE data when editing a product
        if (product.cpe_vendor && product.cpe_product) {
            // Set global variables for version loading
            nvdSelectedVendor = product.cpe_vendor;
            nvdSelectedProduct = product.cpe_product;

            // Set hidden fields
            safeSetValue('cpeVendor', product.cpe_vendor);
            safeSetValue('cpeProduct', product.cpe_product);
            safeSetValue('cpeUri', product.cpe_uri || '');

            // Show NVD selected product display (primary UI)
            const displayName = `${product.vendor} ${product.product_name}`;
            safeSetText('nvdSelectedName', displayName);
            safeSetText('nvdSelectedCpe', `cpe:2.3:a:${product.cpe_vendor}:${product.cpe_product}:*`);
            safeSetDisplay('nvdSelectedProduct', 'block');
            safeSetDisplay('loadVersionsBtn', 'inline-block');

            // Update CPE status in advanced options
            safeSetDisplay('cpeSelectedInfo', 'block');
            safeSetText('cpeDisplayUri', `${product.cpe_vendor}:${product.cpe_product}`);
            safeSetDisplay('cpeNotLinkedInfo', 'none');
            safeSetDisplay('clearCpeBtn', 'inline-block');
        } else if (product.effective_cpe_vendor && product.effective_cpe_product) {
            // Show effective CPE from catalog (linked via ServiceCatalog)
            nvdSelectedVendor = product.effective_cpe_vendor;
            nvdSelectedProduct = product.effective_cpe_product;

            const displayName = `${product.vendor} ${product.product_name}`;
            safeSetText('nvdSelectedName', `${displayName} (from catalog)`);
            safeSetText('nvdSelectedCpe', `cpe:2.3:a:${product.effective_cpe_vendor}:${product.effective_cpe_product}:*`);
            safeSetDisplay('nvdSelectedProduct', 'block');
            safeSetDisplay('loadVersionsBtn', 'inline-block');

            // Update CPE status in advanced options
            safeSetDisplay('cpeSelectedInfo', 'block');
            safeSetText('cpeDisplayUri', `${product.effective_cpe_vendor}:${product.effective_cpe_product} (from catalog)`);
            safeSetDisplay('cpeNotLinkedInfo', 'none');
        } else {
            // No CPE data - show manual entry state
            resetNVDSearch();
            resetCPEForm();
        }

        safeSetValue('matchType', product.match_type || 'auto');
    }

    // Admin Tools Modal Functions
    function showAdminResult(title, body, type = 'success') {
        const modal = document.getElementById('adminResultModal');
        const icon = document.getElementById('adminResultIcon');
        const titleEl = document.getElementById('adminResultTitle');
        const bodyEl = document.getElementById('adminResultBody');

        titleEl.textContent = title;
        bodyEl.innerHTML = body;

        // Set icon based on type
        icon.className = 'bi me-2';
        if (type === 'success') {
            icon.classList.add('bi-check-circle-fill', 'text-success');
        } else if (type === 'error') {
            icon.classList.add('bi-exclamation-triangle-fill', 'text-danger');
        } else {
            icon.classList.add('bi-info-circle-fill', 'text-info');
        }

        const bsModal = bootstrap.Modal.getOrCreateInstance(modal);
        bsModal.show();
    }

    function showAdminConfirm(title, body, onConfirm) {
        const modal = document.getElementById('adminConfirmModal');
        const titleEl = document.getElementById('adminConfirmTitle');
        const bodyEl = document.getElementById('adminConfirmBody');
        const okBtn = document.getElementById('adminConfirmOk');

        titleEl.textContent = title;
        bodyEl.innerHTML = body;

        const bsModal = bootstrap.Modal.getOrCreateInstance(modal);

        // Remove old event listeners
        const newOkBtn = okBtn.cloneNode(true);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);

        newOkBtn.addEventListener('click', () => {
            bsModal.hide();
            onConfirm();
        });

        bsModal.show();
    }

    // Admin Tools Functions
    function applyCpeMappings() {
        showAdminConfirm(
            'Apply CPE Mappings',
            `<p>This will apply CPE auto-mappings to all products without CPE identifiers.</p>
             <p class="mb-0 text-muted"><i class="bi bi-info-circle me-1"></i>CPE mappings improve vulnerability matching accuracy by using standardized product identifiers.</p>`,
            async () => {
                try {
                    const response = await fetch('/api/products/apply-cpe', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                        }
                    });
                    const data = await response.json();

                    if (data.status === 'success') {
                        showAdminResult('CPE Mappings Applied', `
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-check-circle-fill text-success fs-1 me-3"></i>
                                <div>
                                    <h5 class="mb-1">Successfully Updated</h5>
                                    <p class="mb-0 text-muted">${data.updated} products now have CPE identifiers</p>
                                </div>
                            </div>
                            <div class="bg-light rounded p-3">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="fs-4 fw-bold text-primary">${data.coverage.total_products}</div>
                                        <small class="text-muted">Total Products</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="fs-4 fw-bold text-success">${data.coverage.with_cpe}</div>
                                        <small class="text-muted">With CPE</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="fs-4 fw-bold text-info">${data.coverage.coverage_percent}%</div>
                                        <small class="text-muted">Coverage</small>
                                    </div>
                                </div>
                            </div>
                        `, 'success');
                        loadProducts();
                    } else {
                        showAdminResult('Error', `<p class="text-danger">${data.message}</p>`, 'error');
                    }
                } catch (error) {
                    showAdminResult('Error', `<p class="text-danger">Failed to apply CPE mappings: ${error.message}</p>`, 'error');
                }
            }
        );
    }

    function rematchProducts() {
        showAdminConfirm(
            'Rematch Vulnerabilities',
            `<p>This will re-run vulnerability matching with the current logic.</p>
             <p class="mb-0 text-muted"><i class="bi bi-info-circle me-1"></i>Invalid matches will be removed and new valid matches will be added.</p>`,
            async () => {
                try {
                    const response = await fetch('/api/products/rematch', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                        }
                    });
                    const data = await response.json();

                    if (data.status === 'success') {
                        showAdminResult('Vulnerability Rematch Complete', `
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-arrow-repeat text-primary fs-1 me-3"></i>
                                <div>
                                    <h5 class="mb-1">Matching Complete</h5>
                                    <p class="mb-0 text-muted">Vulnerability matches have been updated</p>
                                </div>
                            </div>
                            <div class="bg-light rounded p-3">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="fs-4 fw-bold text-danger">${data.removed}</div>
                                        <small class="text-muted">Removed Invalid</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="fs-4 fw-bold text-success">${data.added}</div>
                                        <small class="text-muted">Added New</small>
                                    </div>
                                </div>
                            </div>
                        `, 'success');
                        loadProducts();
                    } else {
                        showAdminResult('Error', `<p class="text-danger">${data.message}</p>`, 'error');
                    }
                } catch (error) {
                    showAdminResult('Error', `<p class="text-danger">Failed to rematch: ${error.message}</p>`, 'error');
                }
            }
        );
    }

    async function showCpeCoverage() {
        try {
            const response = await fetch('/api/products/cpe-suggestions');
            const data = await response.json();

            if (data.status === 'success') {
                let suggestionsHtml = '';
                if (data.suggestions.length > 0) {
                    suggestionsHtml = `
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="bi bi-lightbulb me-2"></i>
                            <strong>${data.suggestions.length} products</strong> can be auto-mapped to CPE identifiers.
                            <br><small>Use "Apply CPE Mappings" to automatically apply these.</small>
                        </div>
                    `;
                }

                showAdminResult('CPE Coverage Statistics', `
                    <div class="bg-light rounded p-3 mb-3">
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="fs-4 fw-bold text-primary">${data.coverage.total_products}</div>
                                <small class="text-muted">Total</small>
                            </div>
                            <div class="col-3">
                                <div class="fs-4 fw-bold text-success">${data.coverage.with_cpe}</div>
                                <small class="text-muted">With CPE</small>
                            </div>
                            <div class="col-3">
                                <div class="fs-4 fw-bold text-warning">${data.coverage.without_cpe}</div>
                                <small class="text-muted">Without CPE</small>
                            </div>
                            <div class="col-3">
                                <div class="fs-4 fw-bold text-info">${data.coverage.coverage_percent}%</div>
                                <small class="text-muted">Coverage</small>
                            </div>
                        </div>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" style="width: ${data.coverage.coverage_percent}%">${data.coverage.coverage_percent}%</div>
                    </div>
                    ${suggestionsHtml}
                `, 'info');
            } else {
                showAdminResult('Error', `<p class="text-danger">${data.message}</p>`, 'error');
            }
        } catch (error) {
            showAdminResult('Error', `<p class="text-danger">Failed to get CPE stats: ${error.message}</p>`, 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadFilterOrganizations(); // Load org filter dropdown (super admin only)
        loadProducts();
        // TableEnhancements auto-initializes via data-enhanced="true"

        // Load organizations when product modal is shown (backup trigger)
        const productModal = document.getElementById('productModal');
        if (productModal) {
            productModal.addEventListener('shown.bs.modal', function() {
                // Retry loading organizations if still showing "Loading"
                const select = document.getElementById('productOrganization');
                if (select && select.innerHTML.includes('Loading')) {
                    loadOrganizationsIntoProductForm();
                }
            });
        }
    });

    // ========================================================================
    // ENDPOINTS TAB - Connected Endpoints Management
    // ========================================================================
    let endpointsLoaded = false;
    let endpointsPage = 1;
    const endpointsPerPage = 20;
    let endpointsSortColumn = 'hostname';
    let endpointsSortDirection = 'asc';

    function sortEndpoints(column) {
        if (endpointsSortColumn === column) {
            endpointsSortDirection = endpointsSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            endpointsSortColumn = column;
            endpointsSortDirection = 'asc';
        }
        loadEndpoints(1);
    }

    function formatRelativeTime(dateStr) {
        if (!dateStr) return 'Never';
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 30) return `${diffDays}d ago`;
        return date.toLocaleDateString();
    }

    async function loadEndpoints(page = 1) {
        endpointsPage = page;
        const tbody = document.getElementById('endpointsTableBody');
        const countEl = document.getElementById('endpointsCount');
        const paginationEl = document.getElementById('endpointsPagination');
        if (!tbody) return;

        const search = document.getElementById('endpointSearchInput')?.value || '';

        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary"></div>
            <span class="ms-2">Loading endpoints...</span>
        </td></tr>`;

        try {
            const params = new URLSearchParams({
                page: page,
                per_page: endpointsPerPage,
                order: endpointsSortColumn,
                direction: endpointsSortDirection
            });
            if (search) params.set('search', search);

            const response = await fetch(`/api/assets?${params}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            const assets = data.assets || [];
            const total = data.total || 0;
            const pages = Math.ceil(total / endpointsPerPage);

            if (countEl) countEl.textContent = `Showing ${assets.length} of ${total} endpoints`;

            if (assets.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted">
                    <i class="bi bi-pc-display text-primary" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">No endpoints discovered</p>
                    <p class="small">Endpoints appear when agents report their inventory</p>
                </td></tr>`;
                if (paginationEl) paginationEl.innerHTML = '';
            } else {
                const statusBadges = {
                    'online': '<span class="badge bg-success"><i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>Online</span>',
                    'offline': '<span class="badge bg-secondary"><i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>Offline</span>',
                    'stale': '<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle me-1"></i>Stale</span>',
                    'decommissioned': '<span class="badge bg-dark"><i class="bi bi-x-circle me-1"></i>Decommissioned</span>'
                };

                tbody.innerHTML = assets.map(asset => {
                    const statusBadge = statusBadges[asset.status] || `<span class="badge bg-secondary">${escapeHtml(asset.status || 'Unknown')}</span>`;
                    const vulnCount = asset.total_vulnerabilities || 0;
                    const vulnBadge = vulnCount > 0 ? `<span class="badge bg-danger ms-1" title="${vulnCount} vulnerabilities">${vulnCount} CVEs</span>` : '';
                    const lastSeen = asset.last_checkin || asset.last_inventory_at;
                    const lastSeenDisplay = lastSeen ? formatRelativeTime(lastSeen) : '<span class="text-muted">Never</span>';

                    return `<tr>
                        <td><strong>${escapeHtml(asset.hostname)}</strong></td>
                        <td><code>${escapeHtml(asset.ip_address || '-')}</code></td>
                        <td>${escapeHtml(asset.os_name || '-')} ${escapeHtml(asset.os_version || '')}</td>
                        <td>${escapeHtml(asset.organization_name || 'Unknown')}</td>
                        <td><span class="badge bg-primary">${asset.product_count || 0}</span>${vulnBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${lastSeenDisplay}</td>
                        <td>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteEndpoint(${parseInt(asset.id)}, '${escapeHtml(String(asset.hostname || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'"))}')" title="Delete endpoint">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                }).join('');

                // Build pagination
                if (paginationEl && pages > 1) {
                    let html = `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="loadEndpoints(${page - 1}); return false;">&laquo;</a></li>`;
                    for (let i = 1; i <= pages; i++) {
                        if (i === 1 || i === pages || (i >= page - 2 && i <= page + 2)) {
                            html += `<li class="page-item ${i === page ? 'active' : ''}">
                                <a class="page-link" href="#" onclick="loadEndpoints(${i}); return false;">${i}</a></li>`;
                        } else if (i === page - 3 || i === page + 3) {
                            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                        }
                    }
                    html += `<li class="page-item ${page === pages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="loadEndpoints(${page + 1}); return false;">&raquo;</a></li>`;
                    paginationEl.innerHTML = html;
                } else if (paginationEl) {
                    paginationEl.innerHTML = '';
                }
            }
            endpointsLoaded = true;

            // Update sort indicators
            document.querySelectorAll('#endpointsTable th[data-sort]').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === endpointsSortColumn) {
                    th.classList.add(endpointsSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        } catch (error) {
            console.error('Error loading endpoints:', error);
            tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>Error loading endpoints: ${escapeHtml(error.message)}
            </td></tr>`;
        }
    }

    async function deleteEndpoint(assetId, hostname) {
        if (!confirm(`Delete endpoint "${hostname}"? This will remove the asset and its inventory data.`)) return;
        try {
            const response = await fetch(`/api/assets/${assetId}`, { method: 'DELETE' });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            showToast(`Endpoint "${hostname}" deleted`, 'success');
            loadEndpoints(endpointsPage);
        } catch (error) {
            showToast(`Failed to delete endpoint: ${escapeHtml(error.message)}`, 'danger');
        }
    }

    // Load endpoints when tab is shown (lazy load)
    document.getElementById('endpoints-tab')?.addEventListener('shown.bs.tab', function() {
        if (!endpointsLoaded) loadEndpoints();
    });

    // Sync sidebar active state and URL hash when tabs change
    document.querySelectorAll('#inventoryTabs button[data-bs-toggle="tab"]').forEach(btn => {
        btn.addEventListener('shown.bs.tab', function(e) {
            const hashMap = {
                'products-tab': '',
                'endpoints-tab': '#endpoints',
                'software-overview-tab': '#software-overview',
                'import-queue-tab': '#import-queue'
            };
            const hash = hashMap[e.target.id] || '';
            history.replaceState(null, '', '/admin' + hash);
            // Update sidebar sub-links
            document.querySelectorAll('.sidebar-submenu .sidebar-sublink').forEach(link => {
                const href = link.getAttribute('href') || '';
                const isMatch = hash ? href.endsWith(hash) : href === '/admin';
                link.classList.toggle('active', isMatch);
            });
        });
    });

    // Unified hash-based tab navigation
    function activateTabFromHash() {
        const hash = window.location.hash;
        const tabMap = {
            '#endpoints': 'endpoints-tab',
            '#software-overview': 'software-overview-tab',
            '#import-queue': 'import-queue-tab'
        };
        const tabId = tabMap[hash];
        if (tabId) {
            const tabEl = document.getElementById(tabId);
            if (tabEl) {
                const tab = new bootstrap.Tab(tabEl);
                tab.show();
                window.scrollTo(0, 0);
            }
        }
    }
    // Activate on page load
    activateTabFromHash();
    // Also activate on hash change (e.g., sidebar link clicked while already on page)
    window.addEventListener('hashchange', activateTabFromHash);

    // =========================================================================
    // SOFTWARE OVERVIEW TAB
    // =========================================================================
    let softwareOverviewLoaded = false;
    let softwareOverviewData = [];

    async function loadSoftwareOverview() {
        const body = document.getElementById('softwareOverviewBody');
        if (!body) return;

        try {
            const response = await fetch('/api/products?grouped=true&per_page=500&status=active');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            const products = data.products || [];

            // Map to normalized structure
            softwareOverviewData = products.map(p => {
                const versions = (p.versions || []).map(v => v.version || 'Any');
                const uniqueVersions = [...new Set(versions)];
                return {
                    vendor: p.vendor || 'Unknown',
                    product_name: p.product_name || 'Unknown',
                    versions: uniqueVersions,
                    version_count: uniqueVersions.length,
                    has_cpe: p.has_cpe || false,
                    cpe_vendor: p.cpe_vendor || '',
                    cpe_product: p.cpe_product || '',
                    platform_counts: p.platform_counts || {},
                    platforms_list: p.platforms || [],
                    total_installations: p.total_installations || 0,
                    total_vulnerabilities: p.total_vulnerabilities || 0,
                    has_vulnerable_version: p.has_vulnerable_version || false,
                    criticality: p.criticality || 'medium',
                    source: p.source || 'manual',
                    organization_names: p.organization_names || [],
                    endpoint_hostnames: p.endpoint_hostnames || []
                };
            });

            renderSoftwareOverview();
            softwareOverviewLoaded = true;
        } catch (error) {
            console.error('Error loading software overview:', error);
            body.innerHTML = `<div class="text-center py-4 text-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>Error loading software overview: ${escapeHtml(error.message)}
            </div>`;
        }
    }

    function filterSoftwareOverview() {
        renderSoftwareOverview();
    }

    function renderSoftwareOverview() {
        const body = document.getElementById('softwareOverviewBody');
        const countEl = document.getElementById('softwareOverviewCount');
        const searchTerm = (document.getElementById('softwareOverviewSearch')?.value || '').toLowerCase();
        const sortBy = document.getElementById('softwareOverviewSort')?.value || 'endpoints';

        let filtered = softwareOverviewData;

        // Apply search filter
        if (searchTerm) {
            filtered = filtered.filter(p =>
                p.vendor.toLowerCase().includes(searchTerm) ||
                p.product_name.toLowerCase().includes(searchTerm) ||
                (p.cpe_vendor || '').toLowerCase().includes(searchTerm) ||
                (p.cpe_product || '').toLowerCase().includes(searchTerm)
            );
        }

        // Sort
        if (sortBy === 'endpoints') {
            filtered.sort((a, b) => b.total_installations - a.total_installations);
        } else if (sortBy === 'versions') {
            filtered.sort((a, b) => b.version_count - a.version_count);
        } else {
            filtered.sort((a, b) => `${a.vendor} ${a.product_name}`.localeCompare(`${b.vendor} ${b.product_name}`));
        }

        if (countEl) countEl.textContent = `${filtered.length} products`;

        if (filtered.length === 0) {
            body.innerHTML = `<div class="text-center py-5 text-muted">
                <i class="bi bi-layers" style="font-size: 2rem;"></i>
                <p class="mt-2 mb-0">${searchTerm ? 'No matching software found' : 'No software data available'}</p>
            </div>`;
            return;
        }

        // Calculate stats
        const multiVersionCount = filtered.filter(p => p.version_count > 1).length;
        const agentSourceCount = filtered.filter(p => p.source === 'agent').length;
        const noCpeCount = filtered.filter(p => !p.has_cpe).length;

        // Build stats bar
        const statsBar = `
            <div class="d-flex gap-3 p-3 bg-light border-bottom">
                <span class="badge bg-primary rounded-pill">${filtered.length} Products</span>
                ${multiVersionCount > 0 ? `<span class="badge bg-warning text-dark rounded-pill" title="Products with multiple versions across endpoints"><i class="bi bi-exclamation-triangle me-1"></i>${multiVersionCount} Version Sprawl</span>` : ''}
                ${agentSourceCount > 0 ? `<span class="badge bg-info text-dark rounded-pill"><i class="bi bi-robot me-1"></i>${agentSourceCount} Agent-Reported</span>` : ''}
                ${noCpeCount > 0 ? `<span class="badge bg-secondary rounded-pill"><i class="bi bi-shield-x me-1"></i>${noCpeCount} No CPE</span>` : ''}
            </div>`;

        // Build cards
        const cards = filtered.slice(0, 100).map(p => {
            const platformIcons = {
                linux: '<i class="bi bi-ubuntu text-warning" title="Linux"></i>',
                windows: '<i class="bi bi-windows text-info" title="Windows"></i>',
                macos: '<i class="bi bi-apple text-secondary" title="macOS"></i>',
                other: '<i class="bi bi-question-circle text-muted" title="Other"></i>'
            };
            const platformHtml = Object.entries(p.platform_counts || {})
                .filter(([, count]) => count > 0)
                .map(([platform, count]) => `${platformIcons[platform] || platformIcons.other} <small>${count}</small>`)
                .join(' ');

            const versionBadges = (p.versions || []).slice(0, 5).map(v =>
                `<span class="badge bg-light text-dark border me-1 mb-1">${escapeHtml(v)}</span>`
            ).join('');
            const moreVersions = p.version_count > 5 ? `<span class="badge bg-secondary mb-1">+${p.version_count - 5} more</span>` : '';

            const versionSprawl = p.version_count > 1
                ? `<span class="badge bg-warning text-dark ms-1" title="${p.version_count} different versions found"><i class="bi bi-exclamation-triangle"></i> ${p.version_count} versions</span>`
                : '';

            const vulnBadge = p.total_vulnerabilities > 0
                ? `<span class="badge bg-danger ms-1">${p.total_vulnerabilities} CVEs</span>`
                : '';

            const cpeBadge = p.has_cpe
                ? `<span class="badge bg-success ms-1" title="${escapeHtml(p.cpe_vendor)}:${escapeHtml(p.cpe_product)}"><i class="bi bi-shield-check"></i> CPE</span>`
                : `<span class="badge bg-secondary ms-1"><i class="bi bi-shield-x"></i> No CPE</span>`;

            const sourceBadge = p.source === 'agent'
                ? '<span class="badge bg-info text-dark"><i class="bi bi-robot"></i> Agent</span>'
                : '<span class="badge bg-light text-dark border"><i class="bi bi-person"></i> Manual</span>';

            // Build endpoint hostnames display
            const endpoints = p.endpoint_hostnames || [];
            let endpointHtml = '';
            if (endpoints.length > 0) {
                const shown = endpoints.slice(0, 5).map(h => `<span class="badge bg-light text-dark border me-1"><i class="bi bi-pc-display me-1"></i>${escapeHtml(h)}</span>`).join('');
                const more = endpoints.length > 5 ? `<span class="badge bg-secondary">+${endpoints.length - 5} more</span>` : '';
                endpointHtml = `<div class="mt-1 d-flex flex-wrap align-items-center gap-1">
                    <small class="text-muted me-1">Found on:</small>${shown}${more}
                </div>`;
            }

            return `
            <div class="d-flex align-items-start gap-3 p-3 border-bottom software-overview-row" style="cursor: default;">
                <div class="text-center" style="min-width: 50px;">
                    <div class="fs-4 fw-bold text-primary">${p.total_installations}</div>
                    <small class="text-muted">endpoint${p.total_installations !== 1 ? 's' : ''}</small>
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <strong>${escapeHtml(p.vendor)}</strong>
                        <span class="text-muted">/</span>
                        <strong>${escapeHtml(p.product_name)}</strong>
                        ${versionSprawl}${vulnBadge}${cpeBadge}
                    </div>
                    <div class="mt-1 d-flex flex-wrap align-items-center gap-1">
                        ${versionBadges}${moreVersions}
                    </div>
                    ${endpointHtml}
                    <div class="mt-1 d-flex align-items-center gap-3 text-muted small">
                        ${platformHtml ? `<span>Platforms: ${platformHtml}</span>` : ''}
                        ${sourceBadge}
                    </div>
                </div>
            </div>`;
        }).join('');

        const moreMessage = filtered.length > 100
            ? `<div class="text-center py-3 text-muted small">Showing 100 of ${filtered.length} products. Use search to narrow results.</div>`
            : '';

        body.innerHTML = statsBar + cards + moreMessage;
    }

    // Lazy load software overview on tab show
    document.getElementById('software-overview-tab')?.addEventListener('shown.bs.tab', function() {
        if (!softwareOverviewLoaded) loadSoftwareOverview();
    });

    // =========================================================================
    // IMPORT QUEUE TAB
    // =========================================================================
    let importQueueLoaded = false;
    let selectedQueueItems = new Set();
    let importQueueData = [];
    let importQueuePage = 1;
    let importQueuePageSize = 25;
    let importQueueSortField = 'vendor';
    let importQueueSortDir = 'asc';
    let importQueueOrganizations = [];

    // Load organizations for import queue dropdowns
    async function loadImportQueueOrgs() {
        try {
            const response = await fetch('/api/organizations');
            if (response.ok) {
                const data = await response.json();
                importQueueOrganizations = Array.isArray(data) ? data : (data.organizations || []);
            }
        } catch (e) { console.error('Failed to load orgs for queue:', e); }
    }

    async function loadImportQueueCount() {
        try {
            const response = await fetch('/api/import/queue/count');
            if (response.ok) {
                const data = await response.json();
                const count = data.pending || 0;
                const countEl = document.getElementById('importQueueCount');
                if (countEl) {
                    countEl.textContent = count;
                    countEl.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }
        } catch (e) { console.error('Error loading queue count:', e); }
    }

    function sortImportQueue(field) {
        if (importQueueSortField === field) {
            importQueueSortDir = importQueueSortDir === 'asc' ? 'desc' : 'asc';
        } else {
            importQueueSortField = field;
            importQueueSortDir = 'asc';
        }
        importQueuePage = 1;
        renderImportQueue();
    }

    function changeImportQueuePage(newPage) {
        importQueuePage = newPage;
        renderImportQueue();
    }

    function renderImportQueue() {
        const tbody = document.getElementById('importQueueTable');
        const paginationContainer = document.getElementById('importQueuePagination');
        if (!tbody) return;

        if (importQueueData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted"><i class="bi bi-inbox text-success" style="font-size: 2rem;"></i><p class="mb-0 mt-2">No items in queue</p></td></tr>';
            if (paginationContainer) paginationContainer.innerHTML = '';
            return;
        }

        const sortedData = [...importQueueData].sort((a, b) => {
            let aVal, bVal;
            switch (importQueueSortField) {
                case 'vendor': aVal = `${a.vendor || ''} ${a.product_name || ''}`.toLowerCase(); bVal = `${b.vendor || ''} ${b.product_name || ''}`.toLowerCase(); break;
                case 'version': aVal = (a.detected_version || '').toLowerCase(); bVal = (b.detected_version || '').toLowerCase(); break;
                case 'organization': aVal = (a.organization_name || '').toLowerCase(); bVal = (b.organization_name || '').toLowerCase(); break;
                case 'source': aVal = (a.integration_name || 'zzz').toLowerCase(); bVal = (b.integration_name || 'zzz').toLowerCase(); break;
                default: aVal = ''; bVal = '';
            }
            if (aVal < bVal) return importQueueSortDir === 'asc' ? -1 : 1;
            if (aVal > bVal) return importQueueSortDir === 'asc' ? 1 : -1;
            return 0;
        });

        const totalPages = Math.ceil(sortedData.length / importQueuePageSize);
        const startIdx = (importQueuePage - 1) * importQueuePageSize;
        const pageData = sortedData.slice(startIdx, startIdx + importQueuePageSize);

        tbody.innerHTML = pageData.map(item => {
            const versions = item.available_versions || [];
            const versionOptions = versions.length > 0
                ? versions.map(v => `<option value="${escapeHtml(v)}" ${v === item.selected_version ? 'selected' : ''}>${escapeHtml(v)}</option>`).join('')
                : `<option value="${escapeHtml(item.detected_version || '')}">${escapeHtml(item.detected_version || 'Any')}</option>`;

            return `
                <tr data-queue-id="${item.id}">
                    <td><input type="checkbox" class="form-check-input queue-item-checkbox" data-queue-id="${item.id}" onchange="toggleQueueSelect(${item.id}, this)" ${item.status !== 'pending' ? 'disabled' : ''}></td>
                    <td>
                        <div class="fw-semibold">${escapeHtml(item.vendor)}
                            ${item.cpe_vendor && item.cpe_product
                                ? `<span class="badge bg-success-subtle text-success ms-1" title="CPE matched"><i class="bi bi-shield-check"></i></span>`
                                : `<span class="badge bg-warning-subtle text-warning ms-1" title="No CPE match"><i class="bi bi-shield-exclamation"></i></span>`}
                        </div>
                        <div class="text-muted small">${escapeHtml(item.product_name)}</div>
                    </td>
                    <td>${item.status === 'pending' ? `<select class="form-select form-select-sm" style="width: 120px;" onchange="updateQueueItemVersion(${item.id}, this.value)"><option value="">Any version</option>${versionOptions}</select>` : `<span class="text-muted">${escapeHtml(item.selected_version || item.detected_version || 'Any')}</span>`}</td>
                    <td>${item.status === 'pending' ? `<select class="form-select form-select-sm" style="width: 140px;" onchange="updateQueueItemOrg(${item.id}, this.value)"><option value="">Select org...</option>${importQueueOrganizations.map(o => `<option value="${o.id}" ${o.id === item.organization_id ? 'selected' : ''}>${escapeHtml(o.display_name || o.name)}</option>`).join('')}</select>` : `<span class="text-muted">${escapeHtml(item.organization_name || '-')}</span>`}</td>
                    <td><small class="text-muted">${escapeHtml(item.integration_name || 'Manual')}</small></td>
                    <td>${item.status === 'pending' ? `<button class="btn btn-success btn-sm me-1" onclick="approveQueueItem(${item.id})" title="Approve"><i class="bi bi-check"></i></button><button class="btn btn-outline-danger btn-sm" onclick="rejectQueueItem(${item.id})" title="Reject"><i class="bi bi-x"></i></button>` : `<span class="badge bg-${item.status === 'approved' ? 'success' : 'secondary'}">${item.status}</span>`}</td>
                </tr>`;
        }).join('');

        if (paginationContainer && totalPages > 1) {
            paginationContainer.innerHTML = `<div class="d-flex justify-content-between align-items-center"><small class="text-muted">Showing ${startIdx + 1}-${Math.min(startIdx + importQueuePageSize, sortedData.length)} of ${sortedData.length}</small><nav><ul class="pagination pagination-sm mb-0"><li class="page-item ${importQueuePage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="changeImportQueuePage(${importQueuePage - 1}); return false;">&laquo;</a></li>${Array.from({length: Math.min(5, totalPages)}, (_, i) => { let p; if (totalPages <= 5) p = i+1; else if (importQueuePage <= 3) p = i+1; else if (importQueuePage >= totalPages-2) p = totalPages-4+i; else p = importQueuePage-2+i; return `<li class="page-item ${p === importQueuePage ? 'active' : ''}"><a class="page-link" href="#" onclick="changeImportQueuePage(${p}); return false;">${p}</a></li>`; }).join('')}<li class="page-item ${importQueuePage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="changeImportQueuePage(${importQueuePage + 1}); return false;">&raquo;</a></li></ul></nav></div>`;
        } else if (paginationContainer) {
            paginationContainer.innerHTML = sortedData.length > 0 ? `<small class="text-muted">${sortedData.length} items</small>` : '';
        }
    }

    async function loadImportQueue() {
        const status = document.getElementById('queueFilterStatus')?.value || 'pending';
        const perPage = parseInt(document.getElementById('queuePerPage')?.value) || 25;
        const tbody = document.getElementById('importQueueTable');
        if (!tbody) return;

        importQueuePage = 1;
        importQueuePageSize = perPage;

        const selectAllCheckbox = document.getElementById('selectAllQueue');
        if (selectAllCheckbox) selectAllCheckbox.checked = false;
        selectedQueueItems.clear();
        updateQueueBulkButtons();

        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted"><div class="spinner-border spinner-border-sm me-2"></div>Loading...</td></tr>';

        try {
            if (importQueueOrganizations.length === 0) await loadImportQueueOrgs();
            const response = await fetch(`/api/import/queue?status=${status}`);
            if (!response.ok) throw new Error('Failed to load queue');
            const data = await response.json();
            importQueueData = data.items || [];
            renderImportQueue();
            loadImportQueueCount();
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-danger"><i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i><p class="mb-0 mt-2">Error loading queue: ${escapeHtml(error.message)}</p></td></tr>`;
        }
    }

    function toggleQueueSelect(itemId, checkbox) {
        if (checkbox.checked) selectedQueueItems.add(itemId); else selectedQueueItems.delete(itemId);
        updateQueueBulkButtons();
    }

    function toggleSelectAllQueue() {
        const selectAll = document.getElementById('selectAllQueue');
        document.querySelectorAll('.queue-item-checkbox:not(:disabled)').forEach(cb => {
            cb.checked = selectAll.checked;
            const id = parseInt(cb.dataset.queueId);
            if (selectAll.checked) selectedQueueItems.add(id); else selectedQueueItems.delete(id);
        });
        updateQueueBulkButtons();
    }

    function updateQueueBulkButtons() {
        const count = selectedQueueItems.size;
        const approveBtn = document.getElementById('bulkApproveBtn');
        const rejectBtn = document.getElementById('bulkRejectBtn');
        if (approveBtn) approveBtn.disabled = count === 0;
        if (rejectBtn) rejectBtn.disabled = count === 0;
    }

    async function updateQueueItemVersion(itemId, version) {
        try { await fetch(`/api/import/queue/${itemId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ selected_version: version || null }) }); } catch (e) { showToast('Error: ' + e.message, 'danger'); }
    }

    async function updateQueueItemOrg(itemId, orgId) {
        try { await fetch(`/api/import/queue/${itemId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ organization_id: orgId ? parseInt(orgId) : null }) }); } catch (e) { showToast('Error: ' + e.message, 'danger'); }
    }

    async function approveQueueItem(itemId) {
        const item = importQueueData.find(i => i.id === itemId);
        if (item && (!item.cpe_vendor || !item.cpe_product)) {
            const confirmed = await showConfirm(
                `<div class="text-start"><div class="alert alert-warning mb-3"><i class="bi bi-shield-exclamation me-2"></i><strong>No CPE mapping found</strong></div><p><strong>${escapeHtml(item.vendor)} ${escapeHtml(item.product_name)}</strong> has no CPE identifier.</p><p class="mb-0 text-muted small">Vulnerabilities will NOT be detected. You can assign CPE later in Products.</p></div>`,
                'Approve Without CPE?', 'Approve Anyway', 'btn-warning'
            );
            if (!confirmed) return;
        }
        try {
            const response = await fetch(`/api/import/queue/${itemId}/approve`, { method: 'POST' });
            if (!response.ok) { const err = await response.json(); throw new Error(err.error || 'Failed'); }
            showToast('Product added successfully', 'success');
            loadImportQueue();
        } catch (e) { showToast('Error: ' + e.message, 'danger'); }
    }

    async function rejectQueueItem(itemId) {
        try {
            const response = await fetch(`/api/import/queue/${itemId}/reject`, { method: 'POST' });
            if (!response.ok) throw new Error('Failed to reject');
            showToast('Item rejected', 'success');
            loadImportQueue();
        } catch (e) { showToast('Error: ' + e.message, 'danger'); }
    }

    async function bulkApproveQueue() {
        if (selectedQueueItems.size === 0) return;
        const selectedItems = importQueueData.filter(i => selectedQueueItems.has(i.id));
        const withoutCpe = selectedItems.filter(i => !i.cpe_vendor || !i.cpe_product).length;
        const msg = withoutCpe > 0
            ? `Approve ${selectedQueueItems.size} item(s)? ${withoutCpe} without CPE mapping.`
            : `Approve ${selectedQueueItems.size} item(s) and add to product inventory?`;
        const confirmed = await showConfirm(msg, 'Bulk Approve', 'Approve All', withoutCpe > 0 ? 'btn-warning' : 'btn-success');
        if (!confirmed) return;
        try {
            const response = await fetch('/api/import/queue/bulk', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'approve', item_ids: Array.from(selectedQueueItems) }) });
            const result = await response.json();
            showToast(`Approved ${result.processed} items`, 'success');
            selectedQueueItems.clear();
            loadImportQueue();
        } catch (e) { showToast('Error: ' + e.message, 'danger'); }
    }

    async function bulkRejectQueue() {
        if (selectedQueueItems.size === 0) return;
        const confirmed = await showConfirm(`Reject ${selectedQueueItems.size} item(s)?`, 'Bulk Reject', 'Reject All', 'btn-danger');
        if (!confirmed) return;
        try {
            const response = await fetch('/api/import/queue/bulk', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'reject', item_ids: Array.from(selectedQueueItems) }) });
            const result = await response.json();
            showToast(`Rejected ${result.processed} items`, 'success');
            selectedQueueItems.clear();
            loadImportQueue();
        } catch (e) { showToast('Error: ' + e.message, 'danger'); }
    }

    // Lazy load import queue on tab show
    document.getElementById('import-queue-tab')?.addEventListener('shown.bs.tab', function() {
        if (!importQueueLoaded) {
            loadImportQueue();
            importQueueLoaded = true;
        }
    });

    // Load import queue count on page load (for badge)
    loadImportQueueCount();

    // Hash-based navigation for all tabs is handled by activateTabFromHash() above
</script>
{% endblock %}
