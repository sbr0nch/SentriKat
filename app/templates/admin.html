{% extends "base.html" %}

{% block title %}Admin - SentriKat{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6 fw-bold text-dark mb-2">
                <i class="bi bi-gear me-2"></i>Product Management
            </h1>
            <p class="text-muted">Manage your software inventory for vulnerability tracking</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" onclick="showAddProduct()">
                <i class="bi bi-plus-circle me-2"></i>Add Product
            </button>
        </div>
    </div>

    <!-- Bulk Actions Toolbar (hidden by default) -->
    <div class="alert alert-info mb-3" id="bulkActionsToolbar" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <span>
                <i class="bi bi-check-square me-2"></i>
                <strong><span id="selectedCount">0</span> product(s) selected</strong>
            </span>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="bulkAssignOrganization()">
                    <i class="bi bi-building me-1"></i>Assign to Organization
                </button>
                <button class="btn btn-outline-success" onclick="bulkActivate()">
                    <i class="bi bi-check-circle me-1"></i>Activate
                </button>
                <button class="btn btn-outline-secondary" onclick="bulkDeactivate()">
                    <i class="bi bi-pause-circle me-1"></i>Deactivate
                </button>
                <button class="btn btn-outline-danger" onclick="bulkDelete()">
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
                <button class="btn btn-outline-secondary" onclick="clearSelection()">
                    <i class="bi bi-x me-1"></i>Clear Selection
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-ul me-2"></i>Product Inventory</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleSelectAll()">
                <i class="bi bi-check-square me-1"></i>Select All
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th>Vendor</th>
                            <th>Product</th>
                            <th>Version</th>
                            <th>Organization</th>
                            <th>Criticality</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="text-muted mt-2">Loading products...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">
                    <i class="bi bi-plus-circle me-2"></i>Add Product
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Service Catalog Quick Select -->
                <div class="alert alert-info mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-lightbulb me-2"></i>
                            <strong>Quick Add:</strong> Select from 80+ pre-configured services
                        </span>
                        <button type="button" class="btn btn-sm btn-primary" onclick="showServiceCatalog()">
                            <i class="bi bi-search me-1"></i>Browse Catalog
                        </button>
                    </div>
                </div>

                <form id="productForm">
                    <input type="hidden" id="productId">
                    <input type="hidden" id="serviceCatalogId">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="vendor" class="form-label fw-semibold">Vendor *</label>
                            <input type="text" class="form-control" id="vendor" required
                                   placeholder="e.g., Microsoft, Cisco, Apache"
                                   list="vendorSuggestions"
                                   oninput="searchVendors(this.value)">
                            <datalist id="vendorSuggestions"></datalist>
                            <small class="form-text text-muted">The vendor/manufacturer name or select from catalog</small>
                        </div>

                        <div class="col-md-6">
                            <label for="productName" class="form-label fw-semibold">Product Name *</label>
                            <input type="text" class="form-control" id="productName" required
                                   placeholder="e.g., Windows Server, IOS, Tomcat"
                                   list="productSuggestions"
                                   oninput="searchProducts(this.value)">
                            <datalist id="productSuggestions"></datalist>
                            <small class="form-text text-muted">The software/product name or select from catalog</small>
                        </div>

                        <div class="col-md-6">
                            <label for="version" class="form-label fw-semibold">Version</label>
                            <input type="text" class="form-control" id="version"
                                   placeholder="e.g., 2022, 15.2, 9.0">
                            <small class="form-text text-muted">Optional: Specific version you're using</small>
                        </div>

                        <div class="col-md-6">
                            <label for="criticality" class="form-label fw-semibold">Criticality Level *</label>
                            <select class="form-select" id="criticality" required>
                                <option value="critical">Critical - Mission Critical Systems</option>
                                <option value="high">High - Important Production Systems</option>
                                <option value="medium" selected>Medium - Standard Systems</option>
                                <option value="low">Low - Non-Critical Systems</option>
                            </select>
                            <small class="form-text text-muted">How critical is this product to your organization?</small>
                        </div>

                        <div class="col-md-6">
                            <label for="productOrganization" class="form-label fw-semibold">Organization</label>
                            <select class="form-select" id="productOrganization">
                                <option value="">Loading organizations...</option>
                            </select>
                            <small class="form-text text-muted">Assign this product to an organization</small>
                        </div>

                        <div class="col-md-12">
                            <label for="keywords" class="form-label fw-semibold">Additional Keywords</label>
                            <input type="text" class="form-control" id="keywords"
                                   placeholder="e.g., Exchange, Webex, Struts">
                            <small class="form-text text-muted">Comma-separated keywords for better matching</small>
                        </div>

                        <div class="col-md-12">
                            <label for="description" class="form-label fw-semibold">Description</label>
                            <textarea class="form-control" id="description" rows="3"
                                      placeholder="Optional notes about this product (e.g., deployment details, business use)"></textarea>
                        </div>

                        <div class="col-md-12">
                            <div class="form-check form-switch">
                                <input type="checkbox" class="form-check-input" id="active" checked>
                                <label class="form-check-label fw-semibold" for="active">
                                    Active (track vulnerabilities for this product)
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">
                    <i class="bi bi-check-circle me-1"></i>Save Product
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Service Catalog Modal -->
<div class="modal fade" id="serviceCatalogModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-archive me-2"></i>Service Catalog Browser
                    <span class="badge bg-primary ms-2" id="catalogSelectionCount" style="display: none;">0 selected</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="catalogSearch"
                               placeholder="Search services by vendor, product, or keywords..."
                               oninput="filterCatalog(this.value)">
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="catalogOrgSelect">
                            <option value="">Assign to Organization (optional)</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" class="form-check-input" id="catalogSelectAll" onchange="toggleCatalogSelectAll()">
                                </th>
                                <th>Vendor</th>
                                <th>Product</th>
                                <th>Keywords</th>
                            </tr>
                        </thead>
                        <tbody id="catalogTable">
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted mt-2">Loading service catalog...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="addSelectedBtn" onclick="addSelectedFromCatalog()" disabled>
                    <i class="bi bi-plus-circle me-1"></i>Add Selected Products
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentProductId = null;
    let serviceCatalog = [];
    let selectedCatalogItems = new Set();

    async function loadProducts() {
        showLoading();
        const tbody = document.getElementById('productsTable');

        try {
            const response = await fetch('/api/products');
            const products = await response.json();

            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3 text-muted">No products added yet</h5>
                            <p class="text-muted">Click "Add Product" to start tracking vulnerabilities for your software inventory.</p>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = products.map(product => {
                    const criticalityBadge = `<span class="badge ${getPriorityBadgeClass(product.criticality || 'medium')}">${(product.criticality || 'medium').toUpperCase()}</span>`;
                    const statusBadge = product.active
                        ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Active</span>'
                        : '<span class="badge bg-secondary"><i class="bi bi-pause-circle"></i> Inactive</span>';

                    const orgDisplay = product.organization_name
                        ? `<span class="badge bg-primary">${escapeHtml(product.organization_name)}</span>`
                        : '<span class="text-muted">-</span>';

                    return `
                        <tr>
                            <td>
                                <input type="checkbox" class="form-check-input product-checkbox"
                                       data-product-id="${product.id}"
                                       onchange="toggleProductSelect(${product.id}, this)">
                            </td>
                            <td class="fw-semibold">${escapeHtml(product.vendor)}</td>
                            <td>${escapeHtml(product.product_name)}</td>
                            <td>${product.version ? `<span class="badge bg-info">${escapeHtml(product.version)}</span>` : '<span class="text-muted">-</span>'}</td>
                            <td>${orgDisplay}</td>
                            <td>${criticalityBadge}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary" onclick="editProduct(${product.id})" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteProduct(${product.id}, '${escapeHtml(product.vendor)} ${escapeHtml(product.product_name)}')" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle"></i> Error loading products: ${error.message}
                    </td>
                </tr>
            `;
        } finally {
            hideLoading();
        }
    }

    async function showAddProduct() {
        currentProductId = null;
        document.getElementById('productModalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Add Product';
        document.getElementById('productForm').reset();
        document.getElementById('active').checked = true;
        document.getElementById('criticality').value = 'medium';

        // Load organizations into dropdown
        await loadOrganizationsIntoProductForm();
    }

    async function editProduct(productId) {
        currentProductId = productId;
        document.getElementById('productModalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Product';

        try {
            // Load organizations first
            await loadOrganizationsIntoProductForm();

            const response = await fetch(`/api/products/${productId}`);
            const product = await response.json();

            document.getElementById('vendor').value = product.vendor;
            document.getElementById('productName').value = product.product_name;
            document.getElementById('version').value = product.version || '';
            document.getElementById('criticality').value = product.criticality || 'medium';
            document.getElementById('keywords').value = product.keywords || '';
            document.getElementById('description').value = product.description || '';
            document.getElementById('active').checked = product.active;
            document.getElementById('productOrganization').value = product.organization_id || '';

            new bootstrap.Modal(document.getElementById('productModal')).show();
        } catch (error) {
            showToast(`Error loading product: ${error.message}`, 'danger');
        }
    }

    async function saveProduct() {
        const vendor = document.getElementById('vendor').value.trim();
        const productName = document.getElementById('productName').value.trim();
        const criticality = document.getElementById('criticality').value;

        if (!vendor || !productName) {
            showToast('Vendor and Product Name are required', 'warning');
            return;
        }

        const orgId = document.getElementById('productOrganization').value;

        const productData = {
            vendor: vendor,
            product_name: productName,
            version: document.getElementById('version').value.trim(),
            criticality: criticality,
            keywords: document.getElementById('keywords').value.trim(),
            description: document.getElementById('description').value.trim(),
            active: document.getElementById('active').checked
        };

        if (orgId) {
            productData.organization_id = parseInt(orgId);
        }

        showLoading();
        try {
            let response;
            if (currentProductId) {
                response = await fetch(`/api/products/${currentProductId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
            } else {
                response = await fetch('/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
            }

            if (response.ok) {
                showToast(
                    currentProductId ? '✓ Product updated successfully' : '✓ Product added successfully',
                    'success'
                );
                bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                loadProducts();
            } else {
                const error = await response.json();
                // Show warning for duplicates, danger for other errors
                const toastType = response.status === 409 ? 'warning' : 'danger';
                showToast(`⚠ ${error.error}`, toastType);
            }
        } catch (error) {
            showToast(`Error saving product: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function deleteProduct(productId, productName) {
        const confirmed = await showConfirm(
            `Are you sure you want to delete "<strong>${escapeHtml(productName)}</strong>"?<br><br>This will remove the product and all its vulnerability matches.`,
            'Delete Product',
            'Delete',
            'btn-danger'
        );

        if (!confirmed) {
            return;
        }

        showLoading();
        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('✓ Product deleted successfully', 'success');
                loadProducts();
            } else {
                showToast('✗ Error deleting product', 'danger');
            }
        } catch (error) {
            showToast(`✗ Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function loadOrganizationsIntoProductForm() {
        try {
            const response = await fetch('/api/organizations');
            if (response.ok) {
                const orgs = await response.json();
                const select = document.getElementById('productOrganization');
                select.innerHTML = '<option value="">No organization (use default)</option>' +
                    orgs.map(org => `<option value="${org.id}">${escapeHtml(org.display_name)}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading organizations for product form:', error);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Service Catalog Functions
    async function showServiceCatalog() {
        // Load catalog if not already loaded
        if (serviceCatalog.length === 0) {
            await loadServiceCatalog();
        }

        // Load organizations into dropdown
        try {
            const response = await fetch('/api/organizations');
            if (response.ok) {
                const orgs = await response.json();
                const select = document.getElementById('catalogOrgSelect');
                select.innerHTML = '<option value="">Assign to Organization (optional)</option>' +
                    orgs.map(org => `<option value="${org.id}">${escapeHtml(org.display_name)}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading organizations:', error);
        }

        // Show modal
        new bootstrap.Modal(document.getElementById('serviceCatalogModal')).show();
    }

    async function loadServiceCatalog() {
        const tbody = document.getElementById('catalogTable');

        try {
            const response = await fetch('/api/catalog');
            serviceCatalog = await response.json();

            renderCatalog(serviceCatalog);
        } catch (error) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle"></i> Error loading catalog: ${error.message}
                    </td>
                </tr>
            `;
        }
    }

    function renderCatalog(catalog) {
        const tbody = document.getElementById('catalogTable');

        if (catalog.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-4 text-muted">
                        No services found matching your search
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = catalog.map(service => {
            const isChecked = selectedCatalogItems.has(service.id);
            return `
                <tr onclick="toggleCatalogSelection(${service.id}, event)" style="cursor: pointer;">
                    <td onclick="event.stopPropagation();">
                        <input type="checkbox"
                               class="form-check-input catalog-item-checkbox"
                               data-catalog-id="${service.id}"
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleCatalogSelection(${service.id}, event)">
                    </td>
                    <td class="fw-semibold">${escapeHtml(service.vendor)}</td>
                    <td>${escapeHtml(service.product_name)}</td>
                    <td><small class="text-muted">${escapeHtml(service.keywords || '')}</small></td>
                </tr>
            `;
        }).join('');
    }

    function filterCatalog(query) {
        const lowerQuery = query.toLowerCase();

        const filtered = serviceCatalog.filter(service => {
            return service.vendor.toLowerCase().includes(lowerQuery) ||
                   service.product_name.toLowerCase().includes(lowerQuery) ||
                   (service.keywords && service.keywords.toLowerCase().includes(lowerQuery));
        });

        renderCatalog(filtered);
    }

    function toggleCatalogSelection(catalogId, event) {
        if (event) {
            event.stopPropagation();
        }

        if (selectedCatalogItems.has(catalogId)) {
            selectedCatalogItems.delete(catalogId);
        } else {
            selectedCatalogItems.add(catalogId);
        }

        updateCatalogSelectionUI();
    }

    function toggleCatalogSelectAll() {
        const selectAllCheckbox = document.getElementById('catalogSelectAll');
        const checkboxes = document.querySelectorAll('.catalog-item-checkbox');

        checkboxes.forEach(checkbox => {
            const catalogId = parseInt(checkbox.dataset.catalogId);
            if (selectAllCheckbox.checked) {
                selectedCatalogItems.add(catalogId);
                checkbox.checked = true;
            } else {
                selectedCatalogItems.delete(catalogId);
                checkbox.checked = false;
            }
        });

        updateCatalogSelectionUI();
    }

    function updateCatalogSelectionUI() {
        const count = selectedCatalogItems.size;
        const countBadge = document.getElementById('catalogSelectionCount');
        const addBtn = document.getElementById('addSelectedBtn');

        if (count > 0) {
            countBadge.textContent = `${count} selected`;
            countBadge.style.display = 'inline-block';
            addBtn.disabled = false;
        } else {
            countBadge.style.display = 'none';
            addBtn.disabled = true;
        }
    }

    async function addSelectedFromCatalog() {
        if (selectedCatalogItems.size === 0) {
            showToast('Please select at least one service', 'warning');
            return;
        }

        const orgId = document.getElementById('catalogOrgSelect').value;
        const addBtn = document.getElementById('addSelectedBtn');
        const originalText = addBtn.innerHTML;

        addBtn.disabled = true;
        addBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Adding...';

        try {
            let successCount = 0;
            let duplicateCount = 0;
            let failCount = 0;

            // Create products for all selected services in parallel for better performance
            const requests = Array.from(selectedCatalogItems).map(async catalogId => {
                const service = serviceCatalog.find(s => s.id === catalogId);
                if (!service) return { status: 'failed' };

                try {
                    const productData = {
                        vendor: service.vendor,
                        product_name: service.product_name,
                        keywords: service.keywords || '',
                        service_catalog_id: catalogId,
                        active: true,
                        criticality: 'medium'
                    };

                    if (orgId) {
                        productData.organization_id = parseInt(orgId);
                    }

                    const response = await fetch('/api/products', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });

                    if (response.ok) {
                        return { status: 'success' };
                    } else if (response.status === 409) {
                        return { status: 'duplicate' };
                    } else {
                        return { status: 'failed' };
                    }
                } catch (error) {
                    return { status: 'failed' };
                }
            });

            // Wait for all requests to complete
            const results = await Promise.all(requests);

            results.forEach(result => {
                if (result.status === 'success') successCount++;
                else if (result.status === 'duplicate') duplicateCount++;
                else if (result.status === 'failed') failCount++;
            });

            // Clear selection and close modal
            selectedCatalogItems.clear();
            updateCatalogSelectionUI();
            bootstrap.Modal.getInstance(document.getElementById('serviceCatalogModal')).hide();

            // Show results with detailed message
            let message = '';
            if (successCount > 0) {
                message = `✓ Successfully added ${successCount} product(s)`;
                if (duplicateCount > 0) message += `, ${duplicateCount} already existed`;
                if (failCount > 0) message += `, ${failCount} failed`;
                showToast(message, 'success');
                loadProducts();
            } else if (duplicateCount > 0) {
                showToast(`⚠ ${duplicateCount} product(s) already existed`, 'warning');
            } else {
                showToast('Failed to add products', 'danger');
            }
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            addBtn.disabled = false;
            addBtn.innerHTML = originalText;
        }
    }

    async function selectFromCatalog(catalogId) {
        try {
            const response = await fetch(`/api/catalog/${catalogId}`);
            const service = await response.json();

            // Fill form fields with catalog data
            document.getElementById('vendor').value = service.vendor;
            document.getElementById('productName').value = service.product_name;
            document.getElementById('keywords').value = service.keywords || '';
            document.getElementById('serviceCatalogId').value = catalogId;

            // Close catalog modal
            bootstrap.Modal.getInstance(document.getElementById('serviceCatalogModal')).hide();

            // Show success toast
            showToast('✓ Service selected from catalog', 'success');
        } catch (error) {
            showToast(`Error loading service: ${error.message}`, 'danger');
        }
    }

    async function searchVendors(query) {
        if (!query || query.length < 2) {
            document.getElementById('vendorSuggestions').innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/api/catalog/search?type=vendor&q=${encodeURIComponent(query)}`);
            const vendors = await response.json();

            const datalist = document.getElementById('vendorSuggestions');
            datalist.innerHTML = vendors.map(vendor =>
                `<option value="${escapeHtml(vendor)}">`
            ).join('');
        } catch (error) {
            console.error('Error searching vendors:', error);
        }
    }

    async function searchProducts(query) {
        if (!query || query.length < 2) {
            document.getElementById('productSuggestions').innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/api/catalog/search?type=product&q=${encodeURIComponent(query)}`);
            const products = await response.json();

            const datalist = document.getElementById('productSuggestions');
            datalist.innerHTML = products.map(product =>
                `<option value="${escapeHtml(product)}">`
            ).join('');
        } catch (error) {
            console.error('Error searching products:', error);
        }
    }

    // ============================================================================
    // Bulk Operations
    // ============================================================================

    let selectedProducts = new Set();

    function updateBulkToolbar() {
        const toolbar = document.getElementById('bulkActionsToolbar');
        const count = selectedProducts.size;
        document.getElementById('selectedCount').textContent = count;

        if (count > 0) {
            toolbar.style.display = 'block';
        } else {
            toolbar.style.display = 'none';
        }
    }

    function toggleProductSelect(productId, checkbox) {
        if (checkbox.checked) {
            selectedProducts.add(productId);
        } else {
            selectedProducts.delete(productId);
        }
        updateBulkToolbar();
    }

    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (!selectAllCheckbox) {
            console.error('Select all checkbox not found');
            return;
        }

        const checkboxes = document.querySelectorAll('.product-checkbox');

        if (checkboxes.length === 0) {
            console.warn('No product checkboxes found');
            return;
        }

        const isChecked = selectAllCheckbox.checked;

        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            const productId = parseInt(checkbox.dataset.productId);

            if (!isNaN(productId)) {
                if (isChecked) {
                    selectedProducts.add(productId);
                } else {
                    selectedProducts.delete(productId);
                }
            }
        });

        updateBulkToolbar();
    }

    function clearSelection() {
        selectedProducts.clear();
        document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAllCheckbox').checked = false;
        updateBulkToolbar();
    }

    async function bulkAssignOrganization() {
        if (selectedProducts.size === 0) return;

        // Load organizations for selection
        const response = await fetch('/api/organizations');
        const orgs = await response.json();

        const orgList = orgs.map((o, i) => `${i + 1}. ${escapeHtml(o.display_name)} (ID: ${o.id})`).join('<br>');

        const orgId = await showPrompt(
            `Assign ${selectedProducts.size} product(s) to organization:<br><br>${orgList}<br><br>Enter Organization ID:`,
            '',
            'Assign to Organization'
        );

        if (!orgId) return;

        showLoading();
        try {
            const promises = Array.from(selectedProducts).map(productId =>
                fetch(`/api/products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ organization_id: parseInt(orgId) })
                })
            );

            await Promise.all(promises);
            showToast(`✓ ${selectedProducts.size} product(s) assigned successfully`, 'success');
            clearSelection();
            loadProducts();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function bulkActivate() {
        if (selectedProducts.size === 0) return;

        const confirmed = await showConfirm(
            `Activate ${selectedProducts.size} product(s)?`,
            'Activate Products',
            'Activate',
            'btn-success'
        );

        if (!confirmed) return;

        showLoading();
        try {
            const promises = Array.from(selectedProducts).map(productId =>
                fetch(`/api/products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active: true })
                })
            );

            await Promise.all(promises);
            showToast(`✓ ${selectedProducts.size} product(s) activated`, 'success');
            clearSelection();
            loadProducts();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function bulkDeactivate() {
        if (selectedProducts.size === 0) return;

        const confirmed = await showConfirm(
            `Deactivate ${selectedProducts.size} product(s)?`,
            'Deactivate Products',
            'Deactivate',
            'btn-warning'
        );

        if (!confirmed) return;

        showLoading();
        try {
            const promises = Array.from(selectedProducts).map(productId =>
                fetch(`/api/products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active: false })
                })
            );

            await Promise.all(promises);
            showToast(`✓ ${selectedProducts.size} product(s) deactivated`, 'success');
            clearSelection();
            loadProducts();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function bulkDelete() {
        if (selectedProducts.size === 0) return;

        const confirmed = await showConfirm(
            `<strong>⚠️ DELETE ${selectedProducts.size} product(s)?</strong><br><br>This action cannot be undone.`,
            'Delete Products',
            'Delete All',
            'btn-danger'
        );

        if (!confirmed) return;

        showLoading();
        try {
            const promises = Array.from(selectedProducts).map(productId =>
                fetch(`/api/products/${productId}`, { method: 'DELETE' })
            );

            await Promise.all(promises);
            showToast(`✓ ${selectedProducts.size} product(s) deleted`, 'success');
            clearSelection();
            loadProducts();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadProducts();
    });
</script>
{% endblock %}
