{% extends "base.html" %}

{% block title %}Admin - SentriKat{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6 fw-bold text-dark mb-2">
                <i class="bi bi-gear me-2"></i>Product Management
            </h1>
            <p class="text-muted">Manage your software inventory for vulnerability tracking</p>
        </div>
        {% if current_user and (current_user.role in ['manager', 'org_admin', 'super_admin'] or current_user.is_admin or current_user.can_manage_products) %}
        <div class="col-auto">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" onclick="showAddProduct()">
                <i class="bi bi-plus-circle me-2"></i>Add Product
            </button>
        </div>
        {% endif %}
    </div>

    {% if current_user and (current_user.role in ['manager', 'org_admin', 'super_admin'] or current_user.is_admin or current_user.can_manage_products) %}
    <!-- Bulk Actions Toolbar (hidden by default) -->
    <div class="alert alert-info mb-3" id="bulkActionsToolbar" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <span>
                <i class="bi bi-check-square me-2"></i>
                <strong><span id="selectedCount">0</span> product(s) selected</strong>
            </span>
            <div class="btn-group btn-group-sm">
                {% if current_user.role in ['org_admin', 'super_admin'] or current_user.is_admin %}
                <button class="btn btn-outline-primary" onclick="bulkAssignOrganization()">
                    <i class="bi bi-building me-1"></i>Assign to Organization
                </button>
                {% endif %}
                <button class="btn btn-outline-success" onclick="bulkActivate()">
                    <i class="bi bi-check-circle me-1"></i>Activate
                </button>
                <button class="btn btn-outline-secondary" onclick="bulkDeactivate()">
                    <i class="bi bi-pause-circle me-1"></i>Deactivate
                </button>
                <button class="btn btn-outline-danger" onclick="bulkDelete()">
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
                <button class="btn btn-outline-secondary" onclick="clearSelection()">
                    <i class="bi bi-x me-1"></i>Clear Selection
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-ul me-2"></i>Product Inventory</span>
            <!-- Column toggle dropdown will be auto-generated by TableEnhancements -->
        </div>
        <!-- Search and Filter Bar -->
        <div class="card-body border-bottom py-3">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="productSearch" placeholder="Search vendor, product, version..."
                               oninput="debounceSearch()">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()" title="Clear search">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
                {% if current_user and current_user.is_super_admin() %}
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="filterOrg" onchange="loadProducts()">
                        <option value="">All Organizations</option>
                    </select>
                </div>
                {% endif %}
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="filterCriticality" onchange="loadProducts()">
                        <option value="">All Criticalities</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="filterStatus" onchange="loadProducts()">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2 text-end">
                    <span class="text-muted small" id="productCount">-</span>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-compact mb-0" id="productsTableContainer" data-sortable="true" data-enhanced="true">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th data-column="vendor" data-column-label="Vendor" data-sort-key="vendor" data-sort-type="string">Vendor</th>
                            <th data-column="product" data-column-label="Product" data-sort-key="product" data-sort-type="string">Product</th>
                            <th data-column="version" data-column-label="Version" data-sort-key="version" data-sort-type="string">Version</th>
                            <th data-column="organization" data-column-label="Organization" data-sort-key="organization" data-sort-type="string">Organization</th>
                            <th data-column="criticality" data-column-label="Criticality" data-sort-key="criticality" data-sort-type="priority">Criticality</th>
                            <th data-column="status" data-column-label="Status" data-sort-key="status" data-sort-type="boolean">Status</th>
                            <th data-column="actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="text-muted mt-2">Loading products...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Pagination Controls -->
        <div class="card-footer d-flex justify-content-between align-items-center" id="paginationContainer" style="display: none;">
            <div class="d-flex align-items-center gap-2">
                <label class="form-label mb-0 small text-muted">Per page:</label>
                <select class="form-select form-select-sm" style="width: auto;" id="perPage" onchange="loadProducts()">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <nav aria-label="Products pagination">
                <ul class="pagination pagination-sm mb-0" id="paginationNav">
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Product Modal - Redesigned with cleaner UX -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="productModalTitle">
                    <i class="bi bi-plus-circle me-2"></i>Add Product
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <input type="hidden" id="serviceCatalogId">
                    <input type="hidden" id="cpeVendor">
                    <input type="hidden" id="cpeProduct">
                    <input type="hidden" id="cpeUri">

                    <!-- Step 1: Find Product -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-primary rounded-circle me-2" style="width: 24px; height: 24px; line-height: 16px;">1</span>
                            <h6 class="mb-0 fw-bold">Find Your Product</h6>
                            <span class="badge bg-success ms-2">Recommended</span>
                        </div>

                        <!-- NVD Search -->
                        <div class="input-group mb-2">
                            <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="nvdSearchInput"
                                   placeholder="Search NVD database (e.g., 'apache tomcat', 'microsoft windows')..."
                                   oninput="debounceNVDSearch()">
                            <button class="btn btn-outline-primary" type="button" onclick="performNVDSearchNow()">
                                Search
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-database me-1"></i>Search 800,000+ products from NIST National Vulnerability Database for accurate CPE matching
                        </small>

                        <!-- Rate Limit Warning (shown when no NVD API key configured) -->
                        <div id="nvdRateLimitWarning" class="alert alert-warning alert-sm py-1 px-2 mt-2 mb-0 small" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <strong>Rate limited:</strong> Searches are slower without NVD API key.
                            <a href="/admin_panel#sync-settings" class="alert-link">Configure API key</a> for faster searches (free).
                        </div>

                        <div id="nvdSearchStatus" class="small text-muted mt-2" style="display: none;"></div>

                        <!-- Search Results -->
                        <div id="nvdResultsList" class="border rounded mt-2" style="max-height: 250px; overflow-y: auto; display: none;">
                            <!-- NVD Results populated here -->
                        </div>

                        <!-- Selected Product Display -->
                        <div id="nvdSelectedProduct" class="alert alert-success mt-3 mb-0" style="display: none;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-bold mb-1">
                                        <i class="bi bi-check-circle-fill me-1"></i>
                                        <span id="nvdSelectedName"></span>
                                    </div>
                                    <small class="text-muted d-block">
                                        CPE Identifier: <code id="nvdSelectedCpe" class="user-select-all"></code>
                                    </small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearNVDSelection()">
                                    <i class="bi bi-x"></i> Clear
                                </button>
                            </div>
                        </div>

                        <!-- Or Manual Entry Toggle -->
                        <div class="text-center my-3" id="manualEntryToggle">
                            <span class="text-muted">- or -</span>
                            <button type="button" class="btn btn-link btn-sm" onclick="toggleManualEntry()">
                                Enter product details manually
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Product Details -->
                    <div class="mb-4" id="productDetailsSection">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-primary rounded-circle me-2" style="width: 24px; height: 24px; line-height: 16px;">2</span>
                            <h6 class="mb-0 fw-bold">Product Details</h6>
                        </div>

                        <div class="row g-3">
                            <!-- Vendor - Required -->
                            <div class="col-md-6">
                                <label for="vendor" class="form-label">
                                    Vendor <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="vendor" required
                                       placeholder="e.g., Microsoft, Cisco, Apache">
                            </div>

                            <!-- Product Name - Required -->
                            <div class="col-md-6">
                                <label for="productName" class="form-label">
                                    Product Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="productName" required
                                       placeholder="e.g., Windows Server, IOS, Tomcat">
                            </div>

                            <!-- Version - Optional with explanation -->
                            <div class="col-md-6">
                                <label for="version" class="form-label">
                                    Version <span class="text-muted small">(optional)</span>
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="version"
                                           placeholder="Leave empty for ALL versions"
                                           list="versionSuggestions">
                                    <datalist id="versionSuggestions"></datalist>
                                    <button class="btn btn-outline-secondary" type="button" id="loadVersionsBtn"
                                            onclick="loadVersionsFromNVD()" title="Load versions from NVD" style="display: none;">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    Empty = matches ALL versions | Specific = matches only that version
                                </small>
                            </div>

                            <!-- Organization - Optional -->
                            <div class="col-md-6">
                                <label for="productOrganization" class="form-label">
                                    Organization <span class="text-muted small">(optional)</span>
                                </label>
                                <select class="form-select" id="productOrganization">
                                    <option value="">Loading organizations...</option>
                                </select>
                            </div>

                            <!-- Criticality - Required -->
                            <div class="col-md-6">
                                <label for="criticality" class="form-label">
                                    Criticality <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="criticality" required>
                                    <option value="critical">Critical - Mission Critical</option>
                                    <option value="high">High - Important Systems</option>
                                    <option value="medium" selected>Medium - Standard</option>
                                    <option value="low">Low - Non-Critical</option>
                                </select>
                            </div>

                            <!-- App Type -->
                            <div class="col-md-6">
                                <label for="appType" class="form-label">
                                    App Type <span class="text-muted small">(optional)</span>
                                </label>
                                <select class="form-select" id="appType">
                                    <option value="unknown" selected>Unknown</option>
                                    <option value="client">Client - End-user Application</option>
                                    <option value="server">Server - Backend Service</option>
                                    <option value="both">Both - Client & Server</option>
                                </select>
                            </div>

                            <!-- Active Toggle -->
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" id="active" checked>
                                    <label class="form-check-label" for="active">
                                        Active - track vulnerabilities
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options (Collapsed by Default) -->
                    <div class="border-top pt-3">
                        <button class="btn btn-link text-decoration-none p-0 text-muted" type="button"
                                data-bs-toggle="collapse" data-bs-target="#advancedOptionsCollapse">
                            <i class="bi bi-gear me-1"></i>Advanced Options
                            <i class="bi bi-chevron-down ms-1 small"></i>
                        </button>

                        <div id="advancedOptionsCollapse" class="collapse mt-3">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="matchType" class="form-label">Matching Strategy</label>
                                    <select class="form-select form-select-sm" id="matchType">
                                        <option value="auto">Auto (CPE if available, else keywords)</option>
                                        <option value="cpe">CPE Only</option>
                                        <option value="keyword">Keywords Only</option>
                                        <option value="both">Both CPE and Keywords</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label for="keywords" class="form-label">Additional Keywords</label>
                                    <input type="text" class="form-control form-control-sm" id="keywords"
                                           placeholder="Comma-separated (e.g., httpd, apache2)">
                                </div>

                                <div class="col-12">
                                    <label for="description" class="form-label">Notes</label>
                                    <textarea class="form-control form-control-sm" id="description" rows="2"
                                              placeholder="Optional notes about this product"></textarea>
                                </div>

                                <!-- CPE Status -->
                                <div class="col-12" id="cpeStatusSection">
                                    <div class="alert alert-light py-2 mb-0 small">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong><i class="bi bi-link-45deg me-1"></i>CPE Status:</strong>
                                                <span id="cpeSelectedInfo" style="display: none;">
                                                    <span class="badge bg-success">Linked</span>
                                                    <code id="cpeDisplayUri" class="ms-1"></code>
                                                </span>
                                                <span id="cpeNotLinkedInfo">
                                                    <span class="badge bg-secondary">Not linked</span>
                                                    <span class="text-muted ms-1">Use NVD search for better accuracy</span>
                                                </span>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary py-0" onclick="clearCPE()" id="clearCpeBtn" style="display: none;">
                                                Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Legacy Static Catalog - Collapsed -->
                                <div class="col-12">
                                    <details class="text-muted small">
                                        <summary class="cursor-pointer">
                                            <i class="bi bi-archive me-1"></i>Browse Static Catalog (Legacy)
                                        </summary>
                                        <div class="mt-2 p-2 bg-light rounded">
                                            <p class="mb-2 small">
                                                <i class="bi bi-info-circle me-1"></i>
                                                <strong>Tip:</strong> For better software inventory, use
                                                <a href="/admin_panel#integrations">Integrations</a>
                                                to import products from PDQ, SCCM, or discovery agents.
                                            </p>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showServiceCatalog()">
                                                <i class="bi bi-archive me-1"></i>Open Static Catalog
                                            </button>
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <small class="text-muted me-auto"><span class="text-danger">*</span> Required fields</small>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">
                    <i class="bi bi-check-circle me-1"></i>Save Product
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Service Catalog Modal -->
<div class="modal fade" id="serviceCatalogModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-archive me-2"></i>Service Catalog Browser
                    <span class="badge bg-primary ms-2" id="catalogSelectionCount" style="display: none;">0 selected</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="catalogSearch"
                               placeholder="Search services by vendor, product, or keywords..."
                               oninput="filterCatalog(this.value)">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small mb-1">Assign to Organizations (optional)</label>
                        <select class="form-select" id="catalogOrgSelect" multiple size="3">
                            <option value="" disabled>Loading organizations...</option>
                        </select>
                        <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" class="form-check-input" id="catalogSelectAll" onchange="toggleCatalogSelectAll()">
                                </th>
                                <th>Vendor</th>
                                <th>Product</th>
                                <th>Version</th>
                                <th>Category</th>
                            </tr>
                        </thead>
                        <tbody id="catalogTable">
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted mt-2">Loading service catalog...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="addSelectedBtn" onclick="addSelectedFromCatalog()" disabled>
                    <i class="bi bi-plus-circle me-1"></i>Add Selected Products
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirm Action
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">
                    <i class="bi bi-check-circle me-1"></i>Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Organization Management Modal -->
<div class="modal fade" id="orgManagementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-building me-2"></i>Manage Organizations
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p class="text-muted">Product: <strong id="orgModalProductName"></strong></p>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Assigned Organizations</label>
                    <div id="assignedOrgsList" class="border rounded p-2" style="min-height: 100px; max-height: 200px; overflow-y: auto;">
                        <div class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Add Organizations</label>
                    <select class="form-select" id="addOrgSelect" multiple size="5">
                        <option value="">Loading...</option>
                    </select>
                    <small class="text-muted">Hold Ctrl/Cmd to select multiple organizations</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="assignOrganizations()">
                    <i class="bi bi-check-circle me-1"></i>Assign Selected
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // User permission flags for UI visibility
    const userPermissions = {
        canManageProducts: {% if current_user and (current_user.role in ['manager', 'org_admin', 'super_admin'] or current_user.is_admin or current_user.can_manage_products) %}true{% else %}false{% endif %},
        canAssignOrgs: {% if current_user and (current_user.role in ['org_admin', 'super_admin'] or current_user.is_admin) %}true{% else %}false{% endif %},
        isSuperAdmin: {% if current_user and current_user.is_super_admin() %}true{% else %}false{% endif %}
    };

    let currentProductId = null;
    let serviceCatalog = [];
    let selectedCatalogItems = new Set();
    let selectedVersions = {};  // Store selected versions by catalog ID
    let currentPage = 1;
    let searchTimeout = null;

    // Debounce search input
    function debounceSearch() {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1; // Reset to first page on search
            loadProducts();
        }, 300);
    }

    function clearSearch() {
        document.getElementById('productSearch').value = '';
        currentPage = 1;
        loadProducts();
    }

    function goToPage(page) {
        currentPage = page;
        loadProducts();
    }

    function renderPagination(total, currentPage, pages, perPage) {
        const container = document.getElementById('paginationContainer');
        const nav = document.getElementById('paginationNav');
        const countEl = document.getElementById('productCount');

        // Update count display
        const start = (currentPage - 1) * perPage + 1;
        const end = Math.min(currentPage * perPage, total);
        countEl.textContent = total > 0 ? `Showing ${start}-${end} of ${total} products` : 'No products found';

        // Show/hide pagination
        if (pages <= 1) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'flex';

        let html = '';

        // Previous button
        html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>`;

        // Page numbers
        const maxVisible = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let endPage = Math.min(pages, startPage + maxVisible - 1);

        if (endPage - startPage + 1 < maxVisible) {
            startPage = Math.max(1, endPage - maxVisible + 1);
        }

        if (startPage > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1); return false;">1</a></li>`;
            if (startPage > 2) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
            </li>`;
        }

        if (endPage < pages) {
            if (endPage < pages - 1) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${pages}); return false;">${pages}</a></li>`;
        }

        // Next button
        html += `<li class="page-item ${currentPage === pages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>`;

        nav.innerHTML = html;
    }

    async function loadProducts() {
        showLoading();
        const tbody = document.getElementById('productsTable');

        // Build query parameters
        const params = new URLSearchParams();

        const search = document.getElementById('productSearch')?.value?.trim();
        if (search) params.append('search', search);

        const filterOrgEl = document.getElementById('filterOrg');
        if (filterOrgEl && filterOrgEl.value) params.append('filter_org', filterOrgEl.value);

        const criticality = document.getElementById('filterCriticality')?.value;
        if (criticality) params.append('criticality', criticality);

        const status = document.getElementById('filterStatus')?.value;
        if (status) params.append('status', status);

        const perPage = parseInt(document.getElementById('perPage')?.value || '25');
        params.append('page', currentPage);
        params.append('per_page', perPage);

        try {
            const response = await fetch(`/api/products?${params.toString()}`);
            const data = await response.json();

            // Handle paginated response
            const products = data.products || data;
            const total = data.total || products.length;
            const pages = data.pages || 1;

            // Update count and pagination
            if (data.products) {
                renderPagination(total, data.page, pages, perPage);
            } else {
                // Non-paginated response (backward compatibility)
                document.getElementById('productCount').textContent = `${products.length} products`;
                document.getElementById('paginationContainer').style.display = 'none';
            }

            if (products.length === 0) {
                const hasFilters = search || criticality || status || (filterOrgEl && filterOrgEl.value);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <i class="bi bi-${hasFilters ? 'search' : 'inbox'} text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3 text-muted">${hasFilters ? 'No products match your filters' : 'No products added yet'}</h5>
                            <p class="text-muted">${hasFilters ? 'Try adjusting your search or filters.' : 'Click "Add Product" to start tracking vulnerabilities for your software inventory.'}</p>
                            ${hasFilters ? '<button class="btn btn-outline-secondary btn-sm" onclick="resetFilters()"><i class="bi bi-x me-1"></i>Clear Filters</button>' : ''}
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = products.map(product => {
                    const criticalityBadge = `<span class="badge ${getPriorityBadgeClass(product.criticality || 'medium')}">${(product.criticality || 'medium').toUpperCase()}</span>`;
                    const statusBadge = product.active
                        ? '<span class="badge badge-status-active">Active</span>'
                        : '<span class="badge badge-status-inactive">Inactive</span>';

                    // Display multiple organizations
                    let orgDisplay;
                    if (product.organizations && product.organizations.length > 0) {
                        orgDisplay = product.organizations.map(org =>
                            `<span class="badge bg-primary me-1">${escapeHtml(org.display_name)}</span>`
                        ).join('');
                    } else if (product.organization_name) {
                        // Legacy single org support
                        orgDisplay = `<span class="badge bg-primary">${escapeHtml(product.organization_name)}</span>`;
                    } else {
                        orgDisplay = '<span class="text-muted">-</span>';
                    }

                    return `
                        <tr onclick="toggleProductRow(${product.id}, event)" style="cursor: pointer;">
                            <td onclick="event.stopPropagation();">
                                <input type="checkbox" class="form-check-input product-checkbox"
                                       data-product-id="${product.id}"
                                       onchange="toggleProductSelect(${product.id}, this)">
                            </td>
                            <td data-column="vendor" class="fw-semibold">${escapeHtml(product.vendor)}</td>
                            <td data-column="product">${escapeHtml(product.product_name)}</td>
                            <td data-column="version">${product.version ? `<span class="badge bg-info">${escapeHtml(product.version)}</span>` : '<span class="text-muted">-</span>'}</td>
                            <td data-column="organization">${orgDisplay}</td>
                            <td data-column="criticality">${criticalityBadge}</td>
                            <td data-column="status">${statusBadge}</td>
                            <td data-column="actions" onclick="event.stopPropagation();">
                                <div class="d-flex gap-1">
                                    ${userPermissions.canManageProducts ? `
                                    <button class="btn-action btn-action-edit" onclick="editProduct(${product.id})" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>` : ''}
                                    ${userPermissions.canAssignOrgs ? `
                                    <button class="btn-action btn-action-edit" onclick="manageOrganizations(${product.id})" title="Organizations">
                                        <i class="bi bi-building"></i>
                                    </button>` : ''}
                                    ${userPermissions.canManageProducts ? `
                                    <button class="btn-action btn-action-delete" onclick="deleteProduct(${product.id}, '${escapeHtml(product.vendor)} ${escapeHtml(product.product_name)}')" title="Delete">
                                        <i class="bi bi-trash3"></i>
                                    </button>` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle"></i> Error loading products: ${error.message}
                    </td>
                </tr>
            `;
        } finally {
            hideLoading();
            // Re-initialize sortable table after dynamic content load
            SortableTable.init('productsTableContainer');
            // Restore table enhancements (column visibility, widths)
            TableEnhancements.refresh('productsTableContainer');
        }
    }

    function resetFilters() {
        document.getElementById('productSearch').value = '';
        const filterOrgEl = document.getElementById('filterOrg');
        if (filterOrgEl) filterOrgEl.value = '';
        document.getElementById('filterCriticality').value = '';
        document.getElementById('filterStatus').value = '';
        currentPage = 1;
        loadProducts();
    }

    // Load organizations for filter dropdown (super admin only)
    async function loadFilterOrganizations() {
        const filterOrgEl = document.getElementById('filterOrg');
        if (!filterOrgEl) return; // Not super admin

        try {
            const response = await fetch('/api/organizations');
            const orgs = await response.json();

            filterOrgEl.innerHTML = '<option value="">All Organizations</option>' +
                orgs.map(org => `<option value="${org.id}">${escapeHtml(org.display_name)}</option>`).join('');
        } catch (error) {
            console.error('Failed to load organizations for filter:', error);
        }
    }

    async function showAddProduct() {
        currentProductId = null;
        document.getElementById('productModalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Add Product';
        document.getElementById('productForm').reset();
        document.getElementById('active').checked = true;
        document.getElementById('criticality').value = 'medium';
        document.getElementById('appType').value = 'unknown';
        document.getElementById('matchType').value = 'auto';

        // Reset NVD search UI (primary method)
        resetNVDSearch();

        // Reset legacy CPE form
        resetCPEForm();

        // Collapse advanced options
        const advancedCollapse = document.getElementById('advancedOptionsCollapse');
        if (advancedCollapse) advancedCollapse.classList.remove('show');

        // Show manual entry toggle
        const toggle = document.getElementById('manualEntryToggle');
        if (toggle) toggle.style.display = 'block';

        // Check NVD API key status and show rate limit warning if needed
        checkNvdApiKeyStatus();

        // Load organizations into dropdown
        await loadOrganizationsIntoProductForm();

        // Show the modal - reuse or create instance
        const modalEl = document.getElementById('productModal');
        let modal = bootstrap.Modal.getInstance(modalEl);
        if (!modal) {
            modal = new bootstrap.Modal(modalEl);
        }
        modal.show();
    }

    async function checkNvdApiKeyStatus() {
        const warningEl = document.getElementById('nvdRateLimitWarning');
        if (!warningEl) return;

        try {
            const response = await fetch('/api/cpe/stats');
            if (response.ok) {
                const data = await response.json();
                if (data.api && !data.api.nvd_api_key_configured) {
                    warningEl.style.display = 'block';
                } else {
                    warningEl.style.display = 'none';
                }
            }
        } catch (error) {
            // Silently fail - don't block the modal
        }
    }

    async function editProduct(productId) {
        currentProductId = productId;
        document.getElementById('productModalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Product';

        // Reset NVD search UI
        resetNVDSearch();

        try {
            // Load organizations first
            await loadOrganizationsIntoProductForm();

            const response = await fetch(`/api/products/${productId}`);
            const product = await response.json();

            document.getElementById('vendor').value = product.vendor;
            document.getElementById('productName').value = product.product_name;
            document.getElementById('version').value = product.version || '';
            document.getElementById('criticality').value = product.criticality || 'medium';
            document.getElementById('appType').value = product.app_type || 'unknown';
            document.getElementById('keywords').value = product.keywords || '';
            document.getElementById('description').value = product.description || '';
            document.getElementById('active').checked = product.active;
            document.getElementById('productOrganization').value = product.organization_id || '';

            // Load CPE data and update NVD selection display
            loadCPEIntoForm(product);

            // Hide manual entry toggle when editing (data is already filled)
            const toggle = document.getElementById('manualEntryToggle');
            if (toggle) toggle.style.display = 'none';

            // Collapse advanced options by default
            const advancedCollapse = document.getElementById('advancedOptionsCollapse');
            if (advancedCollapse) advancedCollapse.classList.remove('show');

            // Show the modal - reuse or create instance
            const modalEl = document.getElementById('productModal');
            let modal = bootstrap.Modal.getInstance(modalEl);
            if (!modal) {
                modal = new bootstrap.Modal(modalEl);
            }
            modal.show();
        } catch (error) {
            showToast(`Error loading product: ${error.message}`, 'danger');
        }
    }

    async function saveProduct() {
        const vendor = document.getElementById('vendor').value.trim();
        const productName = document.getElementById('productName').value.trim();
        const criticality = document.getElementById('criticality').value;

        if (!vendor || !productName) {
            showToast('Vendor and Product Name are required', 'warning');
            return;
        }

        const orgId = document.getElementById('productOrganization').value;

        const productData = {
            vendor: vendor,
            product_name: productName,
            version: document.getElementById('version').value.trim(),
            criticality: criticality,
            app_type: document.getElementById('appType').value || 'unknown',
            keywords: document.getElementById('keywords').value.trim(),
            description: document.getElementById('description').value.trim(),
            active: document.getElementById('active').checked,
            // CPE fields
            cpe_vendor: document.getElementById('cpeVendor').value.trim() || null,
            cpe_product: document.getElementById('cpeProduct').value.trim() || null,
            cpe_uri: document.getElementById('cpeUri').value.trim() || null,
            match_type: document.getElementById('matchType').value || 'auto'
        };

        if (orgId) {
            productData.organization_id = parseInt(orgId);
        }

        showLoading();
        try {
            let response;
            if (currentProductId) {
                response = await fetch(`/api/products/${currentProductId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
            } else {
                response = await fetch('/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
            }

            if (response.ok) {
                showToast(
                    currentProductId ? '✓ Product updated successfully' : '✓ Product added successfully',
                    'success'
                );
                // Safely close modal
                const modalEl = document.getElementById('productModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) {
                    modal.hide();
                }
                loadProducts();
            } else {
                // Safely parse error response - handle non-JSON responses
                let errorMessage = 'Unknown error occurred';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorData.message || 'Request failed';
                } catch (parseError) {
                    // Response was not JSON (could be HTML error page or empty)
                    console.error('Failed to parse error response:', parseError);
                    errorMessage = `Server error (${response.status}: ${response.statusText})`;
                }
                // Show warning for duplicates, danger for other errors
                const toastType = response.status === 409 ? 'warning' : 'danger';
                showToast(`${errorMessage}`, toastType);
            }
        } catch (error) {
            console.error('Error saving product:', error);
            showToast(`Error saving product: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function deleteProduct(productId, productName) {
        const confirmed = await showConfirm(
            `Are you sure you want to delete "<strong>${escapeHtml(productName)}</strong>"?<br><br>This will remove the product and all its vulnerability matches.`,
            'Delete Product',
            'Delete',
            'btn-danger'
        );

        if (!confirmed) {
            return;
        }

        showLoading();
        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('✓ Product deleted successfully', 'success');
                loadProducts();
            } else {
                showToast('✗ Error deleting product', 'danger');
            }
        } catch (error) {
            showToast(`✗ Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function loadOrganizationsIntoProductForm() {
        const select = document.getElementById('productOrganization');
        if (!select) return;

        select.innerHTML = '<option value="">Loading...</option>';
        select.disabled = true;

        try {
            const response = await fetch('/api/organizations', {
                method: 'GET',
                credentials: 'same-origin',
                headers: { 'Accept': 'application/json' }
            });

            if (response.ok) {
                const orgs = await response.json();
                if (Array.isArray(orgs) && orgs.length > 0) {
                    select.innerHTML = '<option value="">Select organization (optional)...</option>' +
                        orgs.map(org => `<option value="${org.id}">${escapeHtml(org.display_name || org.name)}</option>`).join('');
                } else {
                    select.innerHTML = '<option value="">No organizations available</option>';
                }
            } else {
                select.innerHTML = `<option value="">Failed to load (${response.status})</option>`;
            }
        } catch (error) {
            select.innerHTML = '<option value="">Network error</option>';
        } finally {
            select.disabled = false;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Service Catalog Functions
    async function showServiceCatalog() {
        // Clear previous selection state
        selectedCatalogItems.clear();
        updateCatalogSelectionUI();

        // Load catalog if not already loaded
        if (serviceCatalog.length === 0) {
            await loadServiceCatalog();
        } else {
            // Re-render to clear visual checkboxes
            renderCatalog(serviceCatalog);
        }

        // Load organizations into dropdown
        try {
            const response = await fetch('/api/organizations');
            if (response.ok) {
                const orgs = await response.json();
                const select = document.getElementById('catalogOrgSelect');
                select.innerHTML = orgs.map(org =>
                    `<option value="${org.id}">${escapeHtml(org.display_name)}</option>`
                ).join('');
            }
        } catch (error) {
            console.error('Error loading organizations:', error);
        }

        // Show modal - reuse existing instance or create new one
        const modalElement = document.getElementById('serviceCatalogModal');
        let modal = bootstrap.Modal.getInstance(modalElement);
        if (!modal) {
            modal = new bootstrap.Modal(modalElement);
        }
        modal.show();
    }

    async function loadServiceCatalog() {
        const tbody = document.getElementById('catalogTable');

        try {
            const response = await fetch('/api/catalog');
            serviceCatalog = await response.json();

            renderCatalog(serviceCatalog);
        } catch (error) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle"></i> Error loading catalog: ${error.message}
                    </td>
                </tr>
            `;
        }
    }

    function renderCatalog(catalog) {
        const tbody = document.getElementById('catalogTable');

        if (catalog.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4 text-muted">
                        No services found matching your search
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = catalog.map(service => {
            const isChecked = selectedCatalogItems.has(service.id);
            let versions = [];
            try {
                versions = service.typical_versions ? JSON.parse(service.typical_versions) : [];
            } catch (e) {
                versions = [];
            }

            // Build version dropdown options
            const selectedVersion = selectedVersions[service.id] || (versions.length > 0 ? versions[0] : '');
            const versionOptions = versions.length > 0
                ? versions.map(v => `<option value="${escapeHtml(v)}" ${v === selectedVersion ? 'selected' : ''}>${escapeHtml(v)}</option>`).join('')
                : '<option value="">N/A</option>';

            // Build a helpful description line
            const keywords = service.keywords || '';
            const description = service.description || '';
            const helpText = description || keywords;

            return `
                <tr onclick="toggleCatalogRow(${service.id}, event)" style="cursor: pointer;">
                    <td onclick="event.stopPropagation();">
                        <input type="checkbox"
                               class="form-check-input catalog-item-checkbox"
                               data-catalog-id="${service.id}"
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleCatalogSelection(${service.id}, event)">
                    </td>
                    <td class="fw-semibold">${escapeHtml(service.vendor)}</td>
                    <td>
                        <div>${escapeHtml(service.product_name)}</div>
                        ${helpText ? `<small class="text-muted d-block" style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${escapeHtml(helpText)}">${escapeHtml(helpText)}</small>` : ''}
                    </td>
                    <td onclick="event.stopPropagation();">
                        <select class="form-select form-select-sm version-select"
                                data-catalog-id="${service.id}"
                                onchange="updateSelectedVersion(${service.id}, this.value)"
                                style="min-width: 100px;">
                            ${versionOptions}
                        </select>
                    </td>
                    <td><small class="text-muted">${escapeHtml(service.category || '')}</small></td>
                </tr>
            `;
        }).join('');
    }

    function updateSelectedVersion(catalogId, version) {
        selectedVersions[catalogId] = version;
    }

    function filterCatalog(query) {
        const lowerQuery = query.toLowerCase();

        const filtered = serviceCatalog.filter(service => {
            return service.vendor.toLowerCase().includes(lowerQuery) ||
                   service.product_name.toLowerCase().includes(lowerQuery) ||
                   (service.keywords && service.keywords.toLowerCase().includes(lowerQuery));
        });

        renderCatalog(filtered);
    }

    function toggleCatalogSelection(catalogId, event) {
        // Toggle selection state
        if (selectedCatalogItems.has(catalogId)) {
            selectedCatalogItems.delete(catalogId);
        } else {
            selectedCatalogItems.add(catalogId);
        }

        // Update UI
        updateCatalogSelectionUI();
    }

    function toggleCatalogRow(catalogId, event) {
        if (event) event.stopPropagation();
        const checkbox = document.querySelector(`.catalog-item-checkbox[data-catalog-id="${catalogId}"]`);
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            toggleCatalogSelection(catalogId, event);
        }
    }

    function toggleCatalogSelectAll() {
        const selectAllCheckbox = document.getElementById('catalogSelectAll');
        const checkboxes = document.querySelectorAll('.catalog-item-checkbox');

        checkboxes.forEach(checkbox => {
            const catalogId = parseInt(checkbox.dataset.catalogId);
            if (selectAllCheckbox.checked) {
                selectedCatalogItems.add(catalogId);
                checkbox.checked = true;
            } else {
                selectedCatalogItems.delete(catalogId);
                checkbox.checked = false;
            }
        });

        updateCatalogSelectionUI();
    }

    function updateCatalogSelectionUI() {
        const count = selectedCatalogItems.size;
        const countBadge = document.getElementById('catalogSelectionCount');
        const addBtn = document.getElementById('addSelectedBtn');

        if (count > 0) {
            countBadge.textContent = `${count} selected`;
            countBadge.style.display = 'inline-block';
            addBtn.disabled = false;
        } else {
            countBadge.style.display = 'none';
            addBtn.disabled = true;
        }
    }

    async function addSelectedFromCatalog() {
        if (selectedCatalogItems.size === 0) {
            showToast('Please select at least one service', 'warning');
            return;
        }

        const orgSelect = document.getElementById('catalogOrgSelect');
        const selectedOrgIds = Array.from(orgSelect.selectedOptions).map(opt => parseInt(opt.value)).filter(id => !isNaN(id));

        const addBtn = document.getElementById('addSelectedBtn');
        const originalText = addBtn.innerHTML;

        addBtn.disabled = true;
        addBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Adding...';

        try {
            let successCount = 0;
            let duplicateCount = 0;
            let failCount = 0;

            // Create products for all selected services in parallel for better performance
            const requests = Array.from(selectedCatalogItems).map(async catalogId => {
                const service = serviceCatalog.find(s => s.id === catalogId);
                if (!service) return { status: 'failed' };

                try {
                    // Get selected version for this catalog item
                    let versions = [];
                    try {
                        versions = service.typical_versions ? JSON.parse(service.typical_versions) : [];
                    } catch (e) {
                        versions = [];
                    }
                    const version = selectedVersions[catalogId] || (versions.length > 0 ? versions[0] : '');

                    const productData = {
                        vendor: service.vendor,
                        product_name: service.product_name,
                        version: version,
                        keywords: service.keywords || '',
                        service_catalog_id: catalogId,
                        active: true,
                        criticality: 'medium'
                    };

                    // Don't set organization_id when creating - we'll use multi-org assignment
                    const response = await fetch('/api/products', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });

                    if (response.ok) {
                        const product = await response.json();

                        // If organizations were selected, assign the product to them
                        if (selectedOrgIds.length > 0) {
                            await fetch(`/api/products/${product.id}/organizations`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ organization_ids: selectedOrgIds })
                            });
                        }

                        return { status: 'success' };
                    } else if (response.status === 409) {
                        return { status: 'duplicate' };
                    } else {
                        return { status: 'failed' };
                    }
                } catch (error) {
                    return { status: 'failed' };
                }
            });

            // Wait for all requests to complete
            const results = await Promise.all(requests);

            results.forEach(result => {
                if (result.status === 'success') successCount++;
                else if (result.status === 'duplicate') duplicateCount++;
                else if (result.status === 'failed') failCount++;
            });

            // Clear selection and close modals
            selectedCatalogItems.clear();
            updateCatalogSelectionUI();
            bootstrap.Modal.getInstance(document.getElementById('serviceCatalogModal')).hide();

            // Also close the product modal if it's open
            const productModal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            if (productModal) {
                productModal.hide();
            }

            // Show results with detailed message
            let message = '';
            if (successCount > 0) {
                message = `✓ Successfully added ${successCount} product(s)`;
                if (duplicateCount > 0) message += `, ${duplicateCount} already existed`;
                if (failCount > 0) message += `, ${failCount} failed`;
                showToast(message, 'success');
                loadProducts();
            } else if (duplicateCount > 0) {
                showToast(`⚠ ${duplicateCount} product(s) already existed`, 'warning');
            } else {
                showToast('Failed to add products', 'danger');
            }
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            addBtn.disabled = false;
            addBtn.innerHTML = originalText;
        }
    }

    async function selectFromCatalog(catalogId) {
        try {
            const response = await fetch(`/api/catalog/${catalogId}`);
            const service = await response.json();

            // Fill form fields with catalog data
            document.getElementById('vendor').value = service.vendor;
            document.getElementById('productName').value = service.product_name;
            document.getElementById('keywords').value = service.keywords || '';
            document.getElementById('serviceCatalogId').value = catalogId;

            // Close catalog modal
            bootstrap.Modal.getInstance(document.getElementById('serviceCatalogModal')).hide();

            // Automatically save the product and close the form modal
            setTimeout(async () => {
                await saveProduct();
            }, 300);
        } catch (error) {
            showToast(`Error loading service: ${error.message}`, 'danger');
        }
    }

    async function searchVendors(query) {
        if (!query || query.length < 2) {
            document.getElementById('vendorSuggestions').innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/api/catalog/search?type=vendor&q=${encodeURIComponent(query)}`);
            const vendors = await response.json();

            const datalist = document.getElementById('vendorSuggestions');
            datalist.innerHTML = vendors.map(vendor =>
                `<option value="${escapeHtml(vendor)}">`
            ).join('');
        } catch (error) {
            console.error('Error searching vendors:', error);
        }
    }

    async function searchProducts(query) {
        if (!query || query.length < 2) {
            document.getElementById('productSuggestions').innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/api/catalog/search?type=product&q=${encodeURIComponent(query)}`);
            const products = await response.json();

            const datalist = document.getElementById('productSuggestions');
            datalist.innerHTML = products.map(product =>
                `<option value="${escapeHtml(product)}">`
            ).join('');
        } catch (error) {
            console.error('Error searching products:', error);
        }
    }

    // ============================================================================
    // Bulk Operations
    // ============================================================================

    let selectedProducts = new Map(); // Map of productId -> { id, active, name }

    function updateBulkToolbar() {
        const toolbar = document.getElementById('bulkActionsToolbar');
        const count = selectedProducts.size;
        document.getElementById('selectedCount').textContent = count;

        if (count > 0) {
            toolbar.style.display = 'block';

            // Check active states of selected products
            const activeCount = Array.from(selectedProducts.values()).filter(p => p.active).length;
            const inactiveCount = count - activeCount;

            // Update Activate button
            const activateBtn = toolbar.querySelector('button[onclick="bulkActivate()"]');
            if (activateBtn) {
                if (inactiveCount === 0) {
                    // All selected are already active
                    activateBtn.disabled = true;
                    activateBtn.title = 'All selected products are already active';
                } else {
                    activateBtn.disabled = false;
                    activateBtn.title = inactiveCount < count
                        ? `Activate ${inactiveCount} inactive product(s)`
                        : `Activate ${count} product(s)`;
                }
            }

            // Update Deactivate button
            const deactivateBtn = toolbar.querySelector('button[onclick="bulkDeactivate()"]');
            if (deactivateBtn) {
                if (activeCount === 0) {
                    // All selected are already inactive
                    deactivateBtn.disabled = true;
                    deactivateBtn.title = 'All selected products are already inactive';
                } else {
                    deactivateBtn.disabled = false;
                    deactivateBtn.title = activeCount < count
                        ? `Deactivate ${activeCount} active product(s)`
                        : `Deactivate ${count} product(s)`;
                }
            }
        } else {
            toolbar.style.display = 'none';
        }
    }

    function toggleProductSelect(productId, checkbox) {
        if (checkbox.checked) {
            // Get the product's active status from the row
            const row = checkbox.closest('tr');
            const statusBadge = row.querySelector('.badge-status-active, .badge-status-inactive');
            const isActive = statusBadge ? statusBadge.classList.contains('badge-status-active') : true;
            const vendorCell = row.querySelector('td[data-column="vendor"]');
            const productCell = row.querySelector('td[data-column="product"]');
            const name = `${vendorCell?.textContent || ''} ${productCell?.textContent || ''}`.trim();

            selectedProducts.set(productId, { id: productId, active: isActive, name: name });
        } else {
            selectedProducts.delete(productId);
        }
        updateBulkToolbar();
    }

    function toggleProductRow(productId, event) {
        if (event) event.stopPropagation();
        const checkbox = document.querySelector(`.product-checkbox[data-product-id="${productId}"]`);
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            toggleProductSelect(productId, checkbox);
        }
    }

    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (!selectAllCheckbox) {
            console.error('Select all checkbox not found');
            return;
        }

        const checkboxes = document.querySelectorAll('.product-checkbox');

        if (checkboxes.length === 0) {
            console.warn('No product checkboxes found');
            return;
        }

        const isChecked = selectAllCheckbox.checked;

        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            const productId = parseInt(checkbox.dataset.productId);

            if (!isNaN(productId)) {
                if (isChecked) {
                    // Get product info from the row
                    const row = checkbox.closest('tr');
                    const statusBadge = row.querySelector('.badge-status-active, .badge-status-inactive');
                    const isActive = statusBadge ? statusBadge.classList.contains('badge-status-active') : true;
                    const vendorCell = row.querySelector('td[data-column="vendor"]');
                    const productCell = row.querySelector('td[data-column="product"]');
                    const name = `${vendorCell?.textContent || ''} ${productCell?.textContent || ''}`.trim();

                    selectedProducts.set(productId, { id: productId, active: isActive, name: name });
                } else {
                    selectedProducts.delete(productId);
                }
            }
        });

        updateBulkToolbar();
    }

    function clearSelection() {
        selectedProducts.clear();
        document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAllCheckbox').checked = false;
        updateBulkToolbar();
    }

    async function bulkAssignOrganization() {
        if (selectedProducts.size === 0) return;

        // Load organizations for selection
        const response = await fetch('/api/organizations');
        const orgs = await response.json();

        const orgList = orgs.map((o, i) => `${i + 1}. ${escapeHtml(o.display_name)} (ID: ${o.id})`).join('<br>');

        const orgId = await showPrompt(
            `Assign ${selectedProducts.size} product(s) to organization:<br><br>${orgList}<br><br>Enter Organization ID:`,
            '',
            'Assign to Organization'
        );

        if (!orgId) return;

        showLoading();
        try {
            const promises = Array.from(selectedProducts.keys()).map(productId =>
                fetch(`/api/products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ organization_id: parseInt(orgId) })
                })
            );

            await Promise.all(promises);
            showToast(`${selectedProducts.size} product(s) assigned successfully`, 'success');
            clearSelection();
            loadProducts();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function bulkActivate() {
        if (selectedProducts.size === 0) return;

        // Separate products by current status
        const toActivate = Array.from(selectedProducts.values()).filter(p => !p.active);
        const alreadyActive = Array.from(selectedProducts.values()).filter(p => p.active);

        if (toActivate.length === 0) {
            showToast('All selected products are already active', 'info');
            return;
        }

        // Build confirmation message
        let message = '';
        if (alreadyActive.length > 0) {
            message += `<div class="mb-3"><strong>Already active (${alreadyActive.length}):</strong><ul class="mb-0 text-muted small">`;
            alreadyActive.slice(0, 5).forEach(p => {
                message += `<li>${escapeHtml(p.name)}</li>`;
            });
            if (alreadyActive.length > 5) message += `<li>...and ${alreadyActive.length - 5} more</li>`;
            message += `</ul></div>`;
        }

        message += `<div><strong>Will be activated (${toActivate.length}):</strong><ul class="mb-0">`;
        toActivate.slice(0, 5).forEach(p => {
            message += `<li>${escapeHtml(p.name)}</li>`;
        });
        if (toActivate.length > 5) message += `<li>...and ${toActivate.length - 5} more</li>`;
        message += `</ul></div>`;

        const confirmed = await showConfirm(
            message,
            'Activate Products',
            `Activate ${toActivate.length}`,
            'btn-success'
        );

        if (!confirmed) return;

        showLoading();
        try {
            const promises = toActivate.map(product =>
                fetch(`/api/products/${product.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active: true })
                })
            );

            await Promise.all(promises);
            showToast(`${toActivate.length} product(s) activated`, 'success');
            clearSelection();
            loadProducts();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function bulkDeactivate() {
        if (selectedProducts.size === 0) return;

        // Separate products by current status
        const toDeactivate = Array.from(selectedProducts.values()).filter(p => p.active);
        const alreadyInactive = Array.from(selectedProducts.values()).filter(p => !p.active);

        if (toDeactivate.length === 0) {
            showToast('All selected products are already inactive', 'info');
            return;
        }

        // Build confirmation message
        let message = '';
        if (alreadyInactive.length > 0) {
            message += `<div class="mb-3"><strong>Already inactive (${alreadyInactive.length}):</strong><ul class="mb-0 text-muted small">`;
            alreadyInactive.slice(0, 5).forEach(p => {
                message += `<li>${escapeHtml(p.name)}</li>`;
            });
            if (alreadyInactive.length > 5) message += `<li>...and ${alreadyInactive.length - 5} more</li>`;
            message += `</ul></div>`;
        }

        message += `<div><strong>Will be deactivated (${toDeactivate.length}):</strong><ul class="mb-0">`;
        toDeactivate.slice(0, 5).forEach(p => {
            message += `<li>${escapeHtml(p.name)}</li>`;
        });
        if (toDeactivate.length > 5) message += `<li>...and ${toDeactivate.length - 5} more</li>`;
        message += `</ul></div>`;

        const confirmed = await showConfirm(
            message,
            'Deactivate Products',
            `Deactivate ${toDeactivate.length}`,
            'btn-warning'
        );

        if (!confirmed) return;

        showLoading();
        try {
            const promises = toDeactivate.map(product =>
                fetch(`/api/products/${product.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active: false })
                })
            );

            await Promise.all(promises);
            showToast(`${toDeactivate.length} product(s) deactivated`, 'success');
            clearSelection();
            loadProducts();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    async function bulkDelete() {
        if (selectedProducts.size === 0) return;

        // Build list of products to delete
        const products = Array.from(selectedProducts.values());
        let message = `<strong>⚠️ DELETE ${selectedProducts.size} product(s)?</strong><br><br>`;
        message += `<ul class="mb-0">`;
        products.slice(0, 5).forEach(p => {
            message += `<li>${escapeHtml(p.name)}</li>`;
        });
        if (products.length > 5) message += `<li>...and ${products.length - 5} more</li>`;
        message += `</ul><br>This action cannot be undone.`;

        const confirmed = await showConfirm(
            message,
            'Delete Products',
            'Delete All',
            'btn-danger'
        );

        if (!confirmed) return;

        showLoading();
        try {
            const promises = Array.from(selectedProducts.keys()).map(productId =>
                fetch(`/api/products/${productId}`, { method: 'DELETE' })
            );

            await Promise.all(promises);
            showToast(`${selectedProducts.size} product(s) deleted`, 'success');
            clearSelection();
            loadProducts();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    // Organization management functions
    let currentOrgProductId = null;
    let currentOrgProductName = '';
    let allOrganizations = [];

    async function manageOrganizations(productId) {
        currentOrgProductId = productId;

        // Clean up any existing backdrops first
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');

        // Get product details
        try {
            const productResponse = await fetch(`/api/products/${productId}`);
            const product = await productResponse.json();
            currentOrgProductName = `${product.vendor} ${product.product_name}`;
            document.getElementById('orgModalProductName').textContent = currentOrgProductName;

            // Load assigned organizations
            await loadAssignedOrganizations(productId);

            // Load all organizations
            await loadAllOrganizations();

            // Dispose of any existing modal instance and create fresh
            const modalElement = document.getElementById('orgManagementModal');
            const existingModal = bootstrap.Modal.getInstance(modalElement);
            if (existingModal) {
                existingModal.dispose();
            }

            // Create and show new modal
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true
            });
            modal.show();
        } catch (error) {
            showToast(`Error loading organizations: ${error.message}`, 'danger');
        }
    }

    async function loadAssignedOrganizations(productId) {
        const container = document.getElementById('assignedOrgsList');
        container.innerHTML = '<div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm"></div></div>';

        try {
            const response = await fetch(`/api/products/${productId}/organizations`);
            const data = await response.json();
            const assignedOrgs = data.organizations || [];

            if (assignedOrgs.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">No organizations assigned</div>';
            } else {
                container.innerHTML = assignedOrgs.map(org => `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom" id="org-item-${org.id}">
                        <span><i class="bi bi-building text-primary me-2"></i>${escapeHtml(org.display_name)}</span>
                        <div class="btn-group btn-group-sm" id="org-actions-${org.id}">
                            <button class="btn btn-sm btn-outline-danger" onclick="showRemoveConfirm(${org.id}, '${escapeHtml(org.display_name)}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            container.innerHTML = '<div class="text-center text-danger py-3">Error loading assigned organizations</div>';
        }
    }

    async function loadAllOrganizations() {
        try {
            const response = await fetch('/api/organizations');
            allOrganizations = await response.json();

            // Get currently assigned organization IDs
            const assignedResponse = await fetch(`/api/products/${currentOrgProductId}/organizations`);
            const assignedData = await assignedResponse.json();
            const assignedOrgIds = new Set((assignedData.organizations || []).map(org => org.id));

            // Filter out already-assigned organizations
            const availableOrgs = allOrganizations.filter(org => !assignedOrgIds.has(org.id));

            const select = document.getElementById('addOrgSelect');
            if (availableOrgs.length === 0) {
                select.innerHTML = '<option value="" disabled>All organizations already assigned</option>';
            } else {
                select.innerHTML = availableOrgs.map(org =>
                    `<option value="${org.id}">${escapeHtml(org.display_name)}</option>`
                ).join('');
            }
        } catch (error) {
            showToast(`Error loading organizations: ${error.message}`, 'danger');
        }
    }

    async function assignOrganizations() {
        const select = document.getElementById('addOrgSelect');
        const selectedOptions = Array.from(select.selectedOptions);
        const orgIds = selectedOptions.map(opt => parseInt(opt.value));

        if (orgIds.length === 0) {
            showToast('Please select at least one organization', 'warning');
            return;
        }

        try {
            showLoading();
            const response = await fetch(`/api/products/${currentOrgProductId}/organizations`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ organization_ids: orgIds })
            });

            const data = await response.json();

            if (response.ok) {
                showToast(data.message || 'Organizations assigned successfully', 'success');
                await loadAssignedOrganizations(currentOrgProductId);
                loadProducts(); // Refresh product list
            } else {
                showToast(data.error || 'Failed to assign organizations', 'danger');
            }
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    function showConfirmation(message, onConfirm) {
        document.getElementById('confirmationMessage').textContent = message;

        // Reuse existing modal instance or create new one
        const modalElement = document.getElementById('confirmationModal');
        let modal = bootstrap.Modal.getInstance(modalElement);
        if (!modal) {
            modal = new bootstrap.Modal(modalElement);
        }

        const confirmBtn = document.getElementById('confirmActionBtn');

        // Remove any existing event listeners by cloning the button
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        // Add new event listener
        newConfirmBtn.addEventListener('click', () => {
            modal.hide();
            onConfirm();
        });

        modal.show();
    }

    function showRemoveConfirm(orgId, orgName) {
        // Show inline confirmation buttons
        const actionsDiv = document.getElementById(`org-actions-${orgId}`);
        actionsDiv.innerHTML = `
            <div class="alert alert-danger p-2 mb-0 d-flex align-items-center" style="font-size: 0.875rem;">
                <span class="me-2">Remove? Org admins will be notified.</span>
                <button class="btn btn-danger btn-sm me-1" onclick="confirmRemoveOrganization(${orgId})">
                    <i class="bi bi-check2"></i> Yes
                </button>
                <button class="btn btn-secondary btn-sm" onclick="loadAssignedOrganizations(${currentOrgProductId})">
                    <i class="bi bi-x"></i> Cancel
                </button>
            </div>
        `;
    }

    async function confirmRemoveOrganization(orgId, forceDelete = false) {
        try {
            showLoading();
            let url = `/api/products/${currentOrgProductId}/organizations/${orgId}`;
            if (forceDelete) {
                url += '?confirm_delete=true';
            }

            const response = await fetch(url, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                showToast(data.message || 'Organization removed successfully', 'success');

                // If product was deleted (no orgs left), close the modal
                if (data.product_deleted) {
                    const modalElement = document.getElementById('orgManagementModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                } else {
                    // Just reload the org list
                    await loadAssignedOrganizations(currentOrgProductId);
                }

                loadProducts(); // Refresh product list
            } else if (data.requires_confirmation) {
                // This is the last organization - show confirmation dialog
                hideLoading();
                showLastOrgConfirmation(orgId, data.message);
            } else {
                showToast(data.error || 'Failed to remove organization', 'danger');
            }
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }

    function showLastOrgConfirmation(orgId, message) {
        // Show a modal asking user what to do with the last organization
        const actionsDiv = document.getElementById(`org-actions-${orgId}`);
        actionsDiv.innerHTML = `
            <div class="alert alert-warning p-2 mb-0" style="font-size: 0.875rem;">
                <div class="mb-2"><i class="bi bi-exclamation-triangle"></i> <strong>Last Organization</strong></div>
                <div class="mb-2">${message}</div>
                <div class="d-flex gap-1">
                    <button class="btn btn-danger btn-sm" onclick="confirmRemoveOrganization(${orgId}, true)">
                        <i class="bi bi-trash"></i> Delete Product
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="loadAssignedOrganizations(${currentOrgProductId})">
                        <i class="bi bi-x"></i> Cancel
                    </button>
                </div>
            </div>
        `;
    }

    // =========================================================================
    // NVD Search Functions (Primary Method for Adding Products)
    // =========================================================================

    let nvdSearchTimeout = null;
    let nvdSelectedVendor = null;
    let nvdSelectedProduct = null;

    function debounceNVDSearch() {
        if (nvdSearchTimeout) clearTimeout(nvdSearchTimeout);
        const statusEl = document.getElementById('nvdSearchStatus');
        statusEl.textContent = 'Typing...';
        statusEl.style.display = 'block';

        nvdSearchTimeout = setTimeout(() => {
            const query = document.getElementById('nvdSearchInput').value.trim();
            if (query.length >= 2) {
                performNVDSearchNow();
            } else {
                statusEl.textContent = 'Enter at least 2 characters to search';
                document.getElementById('nvdResultsList').style.display = 'none';
            }
        }, 400);
    }

    async function performNVDSearchNow() {
        const query = document.getElementById('nvdSearchInput').value.trim();
        const statusEl = document.getElementById('nvdSearchStatus');
        const resultsList = document.getElementById('nvdResultsList');

        if (query.length < 2) {
            statusEl.textContent = 'Enter at least 2 characters to search';
            statusEl.style.display = 'block';
            resultsList.style.display = 'none';
            return;
        }

        statusEl.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Searching NVD database...';
        statusEl.style.display = 'block';
        resultsList.style.display = 'block';
        resultsList.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

        try {
            const response = await fetch(`/api/cpe/search?q=${encodeURIComponent(query)}&grouped=true&limit=50`);
            const data = await response.json();

            if (!response.ok) {
                statusEl.textContent = data.error || 'Search failed';
                statusEl.className = 'small text-danger mb-2';
                resultsList.innerHTML = '';
                resultsList.style.display = 'none';
                return;
            }

            const vendors = data.vendors || {};
            const vendorKeys = Object.keys(vendors);
            const totalProducts = vendorKeys.reduce((sum, v) => sum + Object.keys(vendors[v].products || {}).length, 0);

            if (vendorKeys.length === 0) {
                statusEl.textContent = 'No products found. Try different search terms.';
                statusEl.className = 'small text-muted mb-2';
                resultsList.innerHTML = `
                    <div class="p-4 text-center text-muted">
                        <i class="bi bi-search" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No results found in NVD database.</p>
                        <small>Try searching for vendor names like "microsoft", "apache", "cisco"</small>
                    </div>
                `;
                return;
            }

            statusEl.textContent = `Found ${totalProducts} product(s) from ${vendorKeys.length} vendor(s) - Click to select`;
            statusEl.className = 'small text-success mb-2';

            let html = '';
            for (const vendorKey of vendorKeys) {
                const vendorData = vendors[vendorKey];
                const products = vendorData.products || {};

                // Format vendor name for display
                const formattedVendor = vendorKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                for (const [productKey, productData] of Object.entries(products)) {
                    const versions = productData.versions || [];
                    // Format the CPE product key as the primary name (e.g., "http_server" → "HTTP Server")
                    const productName = productKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    // Use the full title from NVD as additional context
                    const fullTitle = productData.title || '';
                    const versionCount = versions.length;

                    html += `
                        <div class="p-2 border-bottom nvd-result-item" style="cursor: pointer;"
                             onclick="selectNVDProduct('${escapeHtml(vendorKey)}', '${escapeHtml(productKey)}', '${escapeHtml(formattedVendor)} - ${escapeHtml(productName)}', ${JSON.stringify(versions).replace(/"/g, '&quot;')})">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-secondary me-2">${escapeHtml(formattedVendor)}</span>
                                    <strong>${escapeHtml(productName)}</strong>
                                    ${fullTitle ? `<small class="text-muted ms-2">${escapeHtml(fullTitle)}</small>` : ''}
                                </div>
                                <span class="badge bg-light text-dark">${versionCount} version${versionCount !== 1 ? 's' : ''}</span>
                            </div>
                        </div>
                    `;
                }
            }

            resultsList.innerHTML = html;

            // Add hover effect
            document.querySelectorAll('.nvd-result-item').forEach(item => {
                item.addEventListener('mouseenter', () => item.classList.add('bg-light'));
                item.addEventListener('mouseleave', () => item.classList.remove('bg-light'));
            });

        } catch (error) {
            statusEl.textContent = `Error: ${error.message}`;
            statusEl.className = 'small text-danger mb-2';
            resultsList.innerHTML = '';
            resultsList.style.display = 'none';
        }
    }

    function selectNVDProduct(vendor, product, displayName, versions) {
        nvdSelectedVendor = vendor;
        nvdSelectedProduct = product;

        // Set hidden CPE fields
        document.getElementById('cpeVendor').value = vendor;
        document.getElementById('cpeProduct').value = product;
        document.getElementById('cpeUri').value = `cpe:2.3:a:${vendor}:${product}:*:*:*:*:*:*:*:*`;

        // Show selected product card
        document.getElementById('nvdSelectedName').textContent = displayName;
        document.getElementById('nvdSelectedCpe').textContent = `cpe:2.3:a:${vendor}:${product}:*`;
        document.getElementById('nvdSelectedProduct').style.display = 'block';

        // Hide search results and manual entry toggle
        document.getElementById('nvdResultsList').style.display = 'none';
        document.getElementById('nvdSearchStatus').style.display = 'none';
        const toggle = document.getElementById('manualEntryToggle');
        if (toggle) toggle.style.display = 'none';

        // Auto-fill vendor and product name fields
        const vendorInput = document.getElementById('vendor');
        const productInput = document.getElementById('productName');

        // Format for display (capitalize words, replace underscores)
        const formattedVendor = vendor.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        const formattedProduct = product.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

        vendorInput.value = formattedVendor;
        productInput.value = formattedProduct;

        // Populate version suggestions
        if (versions && versions.length > 0) {
            const datalist = document.getElementById('versionSuggestions');
            datalist.innerHTML = versions.map(v => `<option value="${escapeHtml(v)}">`).join('');
            document.getElementById('loadVersionsBtn').style.display = 'inline-block';
        }

        // Update CPE status in advanced options
        document.getElementById('cpeSelectedInfo').style.display = 'block';
        document.getElementById('cpeDisplayUri').textContent = `${vendor}:${product}`;
        document.getElementById('cpeNotLinkedInfo').style.display = 'none';
        document.getElementById('clearCpeBtn').style.display = 'inline-block';

        showToast(`Selected: ${displayName}`, 'success');
    }

    function clearNVDSelection() {
        nvdSelectedVendor = null;
        nvdSelectedProduct = null;

        // Clear hidden fields
        document.getElementById('cpeVendor').value = '';
        document.getElementById('cpeProduct').value = '';
        document.getElementById('cpeUri').value = '';

        // Hide selected product card
        document.getElementById('nvdSelectedProduct').style.display = 'none';
        document.getElementById('nvdSelectedName').textContent = '';
        document.getElementById('nvdSelectedCpe').textContent = '';

        // Clear form fields
        document.getElementById('vendor').value = '';
        document.getElementById('productName').value = '';
        document.getElementById('version').value = '';
        document.getElementById('versionSuggestions').innerHTML = '';
        document.getElementById('loadVersionsBtn').style.display = 'none';

        // Reset CPE status in advanced options
        document.getElementById('cpeSelectedInfo').style.display = 'none';
        document.getElementById('cpeNotLinkedInfo').style.display = 'block';
        document.getElementById('clearCpeBtn').style.display = 'none';

        // Clear search
        document.getElementById('nvdSearchInput').value = '';
        document.getElementById('nvdSearchStatus').style.display = 'none';
        document.getElementById('nvdResultsList').style.display = 'none';

        // Show manual entry toggle again
        const toggle = document.getElementById('manualEntryToggle');
        if (toggle) toggle.style.display = 'block';
    }

    function toggleManualEntry() {
        // Hide the toggle button and focus on vendor field
        const toggle = document.getElementById('manualEntryToggle');
        if (toggle) toggle.style.display = 'none';

        // Focus on the vendor field for manual entry
        const vendorInput = document.getElementById('vendor');
        if (vendorInput) {
            vendorInput.focus();
        }
    }

    async function loadVersionsFromNVD() {
        if (!nvdSelectedVendor || !nvdSelectedProduct) {
            showToast('Please select a product from NVD search first', 'warning');
            return;
        }

        const btn = document.getElementById('loadVersionsBtn');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/cpe/versions?vendor=${encodeURIComponent(nvdSelectedVendor)}&product=${encodeURIComponent(nvdSelectedProduct)}`);
            const data = await response.json();

            if (response.ok && data.versions) {
                const datalist = document.getElementById('versionSuggestions');
                datalist.innerHTML = data.versions.map(v => `<option value="${escapeHtml(v)}">`).join('');
                showToast(`Loaded ${data.versions.length} versions`, 'success');
            } else {
                showToast(data.error || 'Failed to load versions', 'warning');
            }
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        } finally {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

    function resetNVDSearch() {
        nvdSelectedVendor = null;
        nvdSelectedProduct = null;
        document.getElementById('nvdSearchInput').value = '';
        document.getElementById('nvdSearchStatus').style.display = 'none';
        document.getElementById('nvdResultsList').style.display = 'none';
        document.getElementById('nvdResultsList').innerHTML = '';
        document.getElementById('nvdSelectedProduct').style.display = 'none';
        document.getElementById('versionSuggestions').innerHTML = '';
        document.getElementById('loadVersionsBtn').style.display = 'none';

        // Reset CPE status display
        document.getElementById('cpeSelectedInfo').style.display = 'none';
        document.getElementById('cpeNotLinkedInfo').style.display = 'block';
        document.getElementById('clearCpeBtn').style.display = 'none';

        // Show manual entry toggle
        const toggle = document.getElementById('manualEntryToggle');
        if (toggle) toggle.style.display = 'block';
    }

    // =========================================================================
    // CPE (Common Platform Enumeration) Search Functions
    // =========================================================================

    let cpeSearchTimeout = null;

    function searchCPE() {
        // Pre-populate search with vendor + product name
        const vendor = document.getElementById('vendor').value.trim();
        const productName = document.getElementById('productName').value.trim();
        const searchInput = document.getElementById('cpeSearchInput');

        searchInput.value = `${vendor} ${productName}`.trim();

        document.getElementById('cpeSearchResults').style.display = 'block';
        document.getElementById('cpeResultsList').innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="ms-2 small">Searching NVD database...</span>
            </div>
        `;

        if (searchInput.value.length >= 2) {
            performCPESearch(searchInput.value);
        }
    }

    function closeCPESearch() {
        document.getElementById('cpeSearchResults').style.display = 'none';
    }

    function debounceCPESearch() {
        if (cpeSearchTimeout) clearTimeout(cpeSearchTimeout);
        cpeSearchTimeout = setTimeout(() => {
            const query = document.getElementById('cpeSearchInput').value.trim();
            if (query.length >= 2) {
                performCPESearch(query);
            }
        }, 400);
    }

    async function performCPESearch(query) {
        const resultsList = document.getElementById('cpeResultsList');

        try {
            const response = await fetch(`/api/cpe/search?q=${encodeURIComponent(query)}&grouped=true&limit=50`);
            const data = await response.json();

            if (!response.ok) {
                resultsList.innerHTML = `<div class="p-3 text-danger small">${data.error || 'Search failed'}</div>`;
                return;
            }

            const vendors = data.vendors || {};
            const vendorKeys = Object.keys(vendors);

            if (vendorKeys.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-3 text-muted small text-center">
                        <i class="bi bi-search me-1"></i>No products found in NVD database.
                        <br><small>Try a different search term or use keyword matching.</small>
                    </div>
                `;
                return;
            }

            let html = '<div class="list-group list-group-flush">';

            for (const vendorKey of vendorKeys) {
                const vendorData = vendors[vendorKey];
                const products = vendorData.products || {};

                for (const [productKey, productData] of Object.entries(products)) {
                    const versions = productData.versions || [];
                    const displayName = productData.display_name || productData.title || `${vendorKey}/${productKey}`;
                    const versionPreview = versions.slice(0, 5).join(', ');

                    html += `
                        <div class="list-group-item list-group-item-action py-2" style="cursor: pointer;"
                             onclick="selectCPE('${escapeHtml(vendorKey)}', '${escapeHtml(productKey)}', '${escapeHtml(displayName)}')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-semibold">${escapeHtml(displayName)}</div>
                                    <small class="text-muted">
                                        <code>cpe:2.3:a:${escapeHtml(vendorKey)}:${escapeHtml(productKey)}:*</code>
                                    </small>
                                </div>
                                <span class="badge bg-secondary">${versions.length} versions</span>
                            </div>
                            ${versionPreview ? `<small class="text-muted">Versions: ${escapeHtml(versionPreview)}${versions.length > 5 ? '...' : ''}</small>` : ''}
                        </div>
                    `;
                }
            }

            html += '</div>';
            resultsList.innerHTML = html;

        } catch (error) {
            resultsList.innerHTML = `<div class="p-3 text-danger small">Error: ${error.message}</div>`;
        }
    }

    function selectCPE(vendor, product, displayName) {
        // Set hidden fields
        document.getElementById('cpeVendor').value = vendor;
        document.getElementById('cpeProduct').value = product;
        document.getElementById('cpeUri').value = `cpe:2.3:a:${vendor}:${product}:*:*:*:*:*:*:*:*`;

        // Show selected info
        document.getElementById('cpeSelectedInfo').style.display = 'block';
        document.getElementById('cpeDisplayUri').textContent = `${vendor}:${product}`;

        // Hide search results
        document.getElementById('cpeSearchResults').style.display = 'none';

        // If vendor/product fields are empty, populate them
        const vendorInput = document.getElementById('vendor');
        const productInput = document.getElementById('productName');

        if (!vendorInput.value.trim()) {
            vendorInput.value = vendor.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        if (!productInput.value.trim()) {
            productInput.value = product.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        showToast('CPE linked: ' + displayName, 'success');
    }

    function clearCPE() {
        document.getElementById('cpeVendor').value = '';
        document.getElementById('cpeProduct').value = '';
        document.getElementById('cpeUri').value = '';
        document.getElementById('cpeSelectedInfo').style.display = 'none';
        document.getElementById('matchType').value = 'auto';
    }

    function resetCPEForm() {
        clearCPE();
        document.getElementById('cpeSearchResults').style.display = 'none';
        document.getElementById('cpeSearchInput').value = '';
        document.getElementById('cpeResultsList').innerHTML = '';
    }

    function loadCPEIntoForm(product) {
        // Load CPE data when editing a product
        if (product.cpe_vendor && product.cpe_product) {
            // Set global variables for version loading
            nvdSelectedVendor = product.cpe_vendor;
            nvdSelectedProduct = product.cpe_product;

            // Set hidden fields
            document.getElementById('cpeVendor').value = product.cpe_vendor;
            document.getElementById('cpeProduct').value = product.cpe_product;
            document.getElementById('cpeUri').value = product.cpe_uri || '';

            // Show NVD selected product display (primary UI)
            const displayName = `${product.vendor} ${product.product_name}`;
            document.getElementById('nvdSelectedName').textContent = displayName;
            document.getElementById('nvdSelectedCpe').textContent = `cpe:2.3:a:${product.cpe_vendor}:${product.cpe_product}:*`;
            document.getElementById('nvdSelectedProduct').style.display = 'block';
            document.getElementById('loadVersionsBtn').style.display = 'inline-block';

            // Update CPE status in advanced options
            document.getElementById('cpeSelectedInfo').style.display = 'block';
            document.getElementById('cpeDisplayUri').textContent = `${product.cpe_vendor}:${product.cpe_product}`;
            document.getElementById('cpeNotLinkedInfo').style.display = 'none';
            document.getElementById('clearCpeBtn').style.display = 'inline-block';
        } else if (product.effective_cpe_vendor && product.effective_cpe_product) {
            // Show effective CPE from catalog (linked via ServiceCatalog)
            nvdSelectedVendor = product.effective_cpe_vendor;
            nvdSelectedProduct = product.effective_cpe_product;

            const displayName = `${product.vendor} ${product.product_name}`;
            document.getElementById('nvdSelectedName').textContent = `${displayName} (from catalog)`;
            document.getElementById('nvdSelectedCpe').textContent = `cpe:2.3:a:${product.effective_cpe_vendor}:${product.effective_cpe_product}:*`;
            document.getElementById('nvdSelectedProduct').style.display = 'block';
            document.getElementById('loadVersionsBtn').style.display = 'inline-block';

            // Update CPE status in advanced options
            document.getElementById('cpeSelectedInfo').style.display = 'block';
            document.getElementById('cpeDisplayUri').textContent = `${product.effective_cpe_vendor}:${product.effective_cpe_product} (from catalog)`;
            document.getElementById('cpeNotLinkedInfo').style.display = 'none';
        } else {
            // No CPE data - show manual entry state
            resetNVDSearch();
            resetCPEForm();
        }

        document.getElementById('matchType').value = product.match_type || 'auto';
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadFilterOrganizations(); // Load org filter dropdown (super admin only)
        loadProducts();
        // TableEnhancements auto-initializes via data-enhanced="true"

        // Load organizations when product modal is shown (backup trigger)
        const productModal = document.getElementById('productModal');
        if (productModal) {
            productModal.addEventListener('shown.bs.modal', function() {
                // Retry loading organizations if still showing "Loading"
                const select = document.getElementById('productOrganization');
                if (select && select.innerHTML.includes('Loading')) {
                    loadOrganizationsIntoProductForm();
                }
            });
        }
    });
</script>
{% endblock %}
