{% extends "base.html" %}

{% block title %}Admin Panel - SentriKat{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6 fw-bold text-dark mb-2">
                <i class="bi bi-shield-lock me-2"></i>Administration Panel
            </h1>
            <p class="text-muted">Manage users, organizations, and system settings</p>
        </div>
    </div>

    <!-- Admin Tabs -->
    <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
                <i class="bi bi-people me-2"></i>Users
            </button>
        </li>
        <li class="nav-item" role="presentation" id="ldap-users-tab-item" style="display: none;">
            <button class="nav-link" id="ldap-users-tab" data-bs-toggle="tab" data-bs-target="#ldapUsers" type="button">
                <i class="bi bi-diagram-3 me-2"></i>LDAP Users
                <span class="badge bg-warning text-dark ms-1" style="font-size: 0.6em;">PRO</span>
            </button>
        </li>
        <li class="nav-item" role="presentation" id="ldap-groups-tab-item" style="display: none;">
            <button class="nav-link" id="ldap-groups-tab" data-bs-toggle="tab" data-bs-target="#ldapGroups" type="button">
                <i class="bi bi-diagram-2 me-2"></i>LDAP Groups
                <span class="badge bg-warning text-dark ms-1" style="font-size: 0.6em;">PRO</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="organizations-tab" data-bs-toggle="tab" data-bs-target="#organizations" type="button">
                <i class="bi bi-building me-2"></i>Organizations
            </button>
        </li>
        {% if current_user and current_user.is_super_admin() %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">
                <i class="bi bi-gear me-2"></i>Settings
            </button>
        </li>
        {% endif %}
    </ul>

    <div class="tab-content" id="adminTabsContent">
        <!-- Users Tab -->
        <div class="tab-pane fade show active" id="users" role="tabpanel">
            <div class="alert alert-light border mb-3 small">
                <i class="bi bi-info-circle me-1"></i>
                <strong>Local users</strong> can be created manually below. <strong>LDAP users</strong> are auto-created when they first log in (if Auto-Provision is enabled in LDAP Group Mappings).
            </div>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-people me-2"></i>User Management</span>
                    <button class="btn btn-primary" onclick="showCreateUserModal()">
                        <i class="bi bi-person-plus-fill me-1"></i>Create User
                    </button>
                </div>
                <!-- Bulk Actions Toolbar -->
                <div id="usersBulkActions" class="alert alert-info mx-3 mt-3 mb-0" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-check-square me-2"></i>
                            <strong><span id="usersSelectedCount">0</span> user(s) selected</strong>
                        </span>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" onclick="bulkActivateUsers()">
                                <i class="bi bi-check-circle me-1"></i>Activate
                            </button>
                            <button class="btn btn-outline-secondary" onclick="bulkDeactivateUsers()">
                                <i class="bi bi-pause-circle me-1"></i>Deactivate
                            </button>
                            <button class="btn btn-outline-danger" onclick="bulkDeleteUsers()">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearUserSelection()">
                                <i class="bi bi-x me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTableContainer" data-sortable="true" data-enhanced="true">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" class="form-check-input" id="selectAllUsers" onchange="toggleSelectAllUsers()">
                                    </th>
                                    <th data-column="username" data-column-label="Username" data-sort-key="username" data-sort-type="string">Username</th>
                                    <th data-column="fullname" data-column-label="Full Name" data-sort-key="fullname" data-sort-type="string">Full Name</th>
                                    <th data-column="email" data-column-label="Email" data-sort-key="email" data-sort-type="string">Email</th>
                                    <th data-column="organization" data-column-label="Organization" data-sort-key="organization" data-sort-type="string">Organization</th>
                                    <th data-column="authtype" data-column-label="Auth Type" data-sort-key="authtype" data-sort-type="string">Auth Type</th>
                                    <th data-column="role" data-column-label="Role" data-sort-key="role" data-sort-type="string">Role</th>
                                    <th data-column="status" data-column-label="Status" data-sort-key="status" data-sort-type="boolean">Status</th>
                                    <th data-column="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="text-muted mt-2">Loading users...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- LDAP Users Tab -->
        <div class="tab-pane fade" id="ldapUsers" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <span><i class="bi bi-diagram-3 me-2"></i>LDAP User Discovery & Management</span>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>LDAP User Management:</strong> Search your LDAP/Active Directory to discover users, then invite them to SentriKat.
                        Users will authenticate against your LDAP server when logging in.
                    </div>

                    <!-- Search Interface -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="ldapUserSearchQuery"
                                       placeholder="Search by username, email, or display name..."
                                       onkeypress="if(event.key==='Enter') searchLdapUsersInline()">
                                <button class="btn btn-primary" onclick="searchLdapUsersInline()">
                                    <i class="bi bi-search me-1"></i>Search
                                </button>
                            </div>
                            <small class="text-muted">
                                Examples: "john", "john.doe", "john*", "*admin*"
                            </small>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="ldapSearchPageSize" onchange="searchLdapUsersInline()">
                                <option value="10">10 per page</option>
                                <option value="25" selected>25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>

                    <!-- Search Stats -->
                    <div id="ldapSearchStats" class="mb-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Showing <strong id="ldapResultCount">0</strong> users
                            </span>
                            <div id="ldapPagination" class="btn-group btn-group-sm"></div>
                        </div>
                    </div>

                    <!-- Results Table -->
                    <div id="ldapSearchResultsTable">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-search" style="font-size: 3rem;"></i>
                            <p class="mt-3">Enter a search query above to discover LDAP users</p>
                            <p class="text-muted">You can search by username, email, or display name</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Organizations Tab -->
        <div class="tab-pane fade" id="organizations" role="tabpanel">
            <div class="alert alert-light border mb-3 small">
                <i class="bi bi-info-circle me-1"></i>
                <strong>Organizations</strong> are logical groups (e.g., tenants, departments, teams) that contain users and products. Each organization can have its own SMTP settings for notifications. Users are assigned to one organization, while Super Admins can access all.
            </div>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-building me-2"></i>Organization Management</span>
                    {% if current_user and current_user.is_super_admin() %}
                    <button class="btn btn-primary" onclick="showCreateOrgModal()">
                        <i class="bi bi-building-add me-1"></i>Create Organization
                    </button>
                    {% endif %}
                </div>
                <!-- Bulk Actions Toolbar -->
                <div id="orgsBulkActions" class="alert alert-info mx-3 mt-3 mb-0" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-check-square me-2"></i>
                            <strong><span id="orgsSelectedCount">0</span> organization(s) selected</strong>
                        </span>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" onclick="bulkActivateOrgs()">
                                <i class="bi bi-check-circle me-1"></i>Activate
                            </button>
                            <button class="btn btn-outline-secondary" onclick="bulkDeactivateOrgs()">
                                <i class="bi bi-pause-circle me-1"></i>Deactivate
                            </button>
                            <button class="btn btn-outline-danger" onclick="bulkDeleteOrgs()">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearOrgSelection()">
                                <i class="bi bi-x me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="orgsTableContainer" data-sortable="true" data-enhanced="true">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" class="form-check-input" id="selectAllOrgs" onchange="toggleSelectAllOrgs()">
                                    </th>
                                    <th data-column="name" data-column-label="Name" data-sort-key="name" data-sort-type="string">Name</th>
                                    <th data-column="displayname" data-column-label="Display Name" data-sort-key="displayname" data-sort-type="string">Display Name</th>
                                    <th data-column="users" data-column-label="Users" data-sort-key="users" data-sort-type="number">Users</th>
                                    <th data-column="smtp" data-column-label="SMTP" data-sort-key="smtp" data-sort-type="boolean">SMTP Configured</th>
                                    <th data-column="status" data-column-label="Status" data-sort-key="status" data-sort-type="boolean">Status</th>
                                    <th data-column="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orgsTable">
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="text-muted mt-2">Loading organizations...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- LDAP Groups Tab -->
        <div class="tab-pane fade" id="ldapGroups" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info mb-3">
                        <h6 class="alert-heading mb-2"><i class="bi bi-info-circle me-2"></i>How LDAP Group Mapping Works</h6>
                        <p class="mb-2">Map LDAP/Active Directory groups to SentriKat roles. When users log in via LDAP, they are automatically assigned roles based on their group memberships.</p>
                        <hr class="my-2">
                        <div class="row small">
                            <div class="col-md-4">
                                <strong><i class="bi bi-person-plus me-1"></i>Auto-Provision:</strong><br>
                                Creates user accounts when they <u>first log in</u> via LDAP (if enabled for the mapping).
                            </div>
                            <div class="col-md-4">
                                <strong><i class="bi bi-arrow-repeat me-1"></i>Sync Now:</strong><br>
                                Updates roles/organizations for <u>existing</u> LDAP users based on current group memberships.
                            </div>
                            <div class="col-md-4">
                                <strong><i class="bi bi-people me-1"></i>Members Count:</strong><br>
                                Shows how many users are in the LDAP group (from directory, not SentriKat).
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tabs for LDAP Groups -->
            <ul class="nav nav-pills mb-4" id="ldapGroupsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="group-mappings-tab" data-bs-toggle="pill" data-bs-target="#groupMappings" type="button">
                        <i class="bi bi-link-45deg me-2"></i>Group Mappings
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sync-dashboard-tab" data-bs-toggle="pill" data-bs-target="#syncDashboard" type="button">
                        <i class="bi bi-arrow-repeat me-2"></i>Sync Dashboard
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="ldapGroupsTabContent">
                <!-- Group Mappings Sub-tab -->
                <div class="tab-pane fade show active" id="groupMappings" role="tabpanel">
                    <!-- Group Discovery Panel -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-search me-2"></i>Discover LDAP Groups</span>
                                <button class="btn btn-sm btn-outline-secondary" onclick="toggleGroupDiscovery()">
                                    <i class="bi bi-chevron-down" id="discoveryToggleIcon"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="groupDiscoveryPanel" style="display: none;">
                            <div class="row g-3 mb-3">
                                <div class="col-md-8">
                                    <label class="form-label fw-semibold">Search Base DN</label>
                                    <input type="text" class="form-control" id="groupSearchBaseInline"
                                           placeholder="e.g., OU=Groups,DC=company,DC=com"
                                           onkeypress="if(event.key==='Enter') performGroupDiscoveryInline()">
                                    <small class="text-muted">The base DN where your LDAP groups are located</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">&nbsp;</label>
                                    <button class="btn btn-primary w-100" onclick="performGroupDiscoveryInline()">
                                        <i class="bi bi-search me-1"></i>Search for Groups
                                    </button>
                                </div>
                            </div>
                            <div id="discoveredGroupsContainerInline">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-diagram-2" style="font-size: 2.5rem;"></i>
                                    <p class="mt-3">Enter a search base DN and click Search to discover LDAP groups</p>
                                    <p class="text-muted mb-0">Example: OU=Security Groups,DC=example,DC=com</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Group Mappings Table -->
                    <div class="card">
                        <div class="card-header">
                            <span><i class="bi bi-link-45deg me-2"></i>LDAP Group Mappings</span>
                        </div>
                        <!-- Bulk Actions Toolbar -->
                        <div id="mappingsBulkActions" class="alert alert-info mx-3 mt-3 mb-0" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="bi bi-check-square me-2"></i>
                                    <strong><span id="mappingsSelectedCount">0</span> mapping(s) selected</strong>
                                </span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success" onclick="bulkActivateMappings()">
                                        <i class="bi bi-check-circle me-1"></i>Activate
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="bulkDeactivateMappings()">
                                        <i class="bi bi-pause-circle me-1"></i>Deactivate
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="bulkDeleteMappings()">
                                        <i class="bi bi-trash me-1"></i>Delete
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="clearMappingSelection()">
                                        <i class="bi bi-x me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="groupMappingsTableContainer" data-sortable="true" data-enhanced="true">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" class="form-check-input" id="selectAllMappings" onchange="toggleSelectAllMappings()">
                                            </th>
                                            <th data-column="group" data-column-label="LDAP Group" data-sort-key="group" data-sort-type="string">LDAP Group</th>
                                            <th data-column="organization" data-column-label="Organization" data-sort-key="organization" data-sort-type="string">Organization</th>
                                            <th data-column="role" data-column-label="Role" data-sort-key="role" data-sort-type="string">Role</th>
                                            <th data-column="priority" data-column-label="Priority" data-sort-key="priority" data-sort-type="number">Priority</th>
                                            <th data-column="autoprovision" data-column-label="Auto-Provision" data-sort-key="autoprovision" data-sort-type="boolean">Auto-Provision</th>
                                            <th data-column="members" data-column-label="Members" data-sort-key="members" data-sort-type="number">Members</th>
                                            <th data-column="lastsync" data-column-label="Last Sync" data-sort-key="lastsync" data-sort-type="date">Last Sync</th>
                                            <th data-column="status" data-column-label="Status" data-sort-key="status" data-sort-type="boolean">Status</th>
                                            <th data-column="actions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="groupMappingsTable">
                                        <tr>
                                            <td colspan="10" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status"></div>
                                                <p class="text-muted mt-2">Loading group mappings...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sync Dashboard Sub-tab -->
                <div class="tab-pane fade" id="syncDashboard" role="tabpanel">
                    <div class="alert alert-secondary mb-3">
                        <h6 class="alert-heading mb-2"><i class="bi bi-arrow-repeat me-2"></i>Sync Dashboard</h6>
                        <p class="mb-0 small">
                            <strong>Sync Now</strong> re-evaluates all existing LDAP users' group memberships and updates their roles/organizations accordingly.
                            This does <u>not</u> create new users - use Auto-Provision for that (users are created when they first log in).
                            Run a sync after changing group mappings to apply changes to existing users immediately.
                        </p>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
                                    <h5 class="mt-2" id="syncStatsTotal">-</h5>
                                    <p class="text-muted mb-0">Total LDAP Users</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-clock-history text-info" style="font-size: 2rem;"></i>
                                    <h5 class="mt-2" id="syncStatsLastSync">Never</h5>
                                    <p class="text-muted mb-0">Last Sync</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
                                    <h5 class="mt-2" id="syncStatsSuccess">-</h5>
                                    <p class="text-muted mb-0">Successful Syncs</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 2rem;"></i>
                                    <h5 class="mt-2" id="syncStatsErrors">-</h5>
                                    <p class="text-muted mb-0">Errors</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-arrow-repeat me-2"></i>Manual Synchronization</span>
                            <button class="btn btn-primary btn-sm" onclick="triggerManualSync()" id="syncButton">
                                <i class="bi bi-arrow-repeat me-1"></i>Sync Now
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="syncStatus" class="text-center text-muted py-4">
                                <i class="bi bi-info-circle" style="font-size: 3rem;"></i>
                                <p class="mt-3">Click "Sync Now" to synchronize all LDAP users with their group memberships</p>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <span><i class="bi bi-clock-history me-2"></i>Sync History</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm" id="syncHistoryTableContainer" data-sortable="true" data-enhanced="true">
                                    <thead>
                                        <tr>
                                            <th data-column="syncid" data-column-label="Sync ID" data-sort-key="id" data-sort-type="number">Sync ID</th>
                                            <th data-column="type" data-column-label="Type" data-sort-key="type" data-sort-type="string">Type</th>
                                            <th data-column="started" data-column-label="Started" data-sort-key="started" data-sort-type="date">Started</th>
                                            <th data-column="duration" data-column-label="Duration" data-sort-key="duration" data-sort-type="number">Duration</th>
                                            <th data-column="status" data-column-label="Status" data-sort-key="status" data-sort-type="string">Status</th>
                                            <th data-column="added" data-column-label="Added" data-sort-key="added" data-sort-type="number">Added</th>
                                            <th data-column="updated" data-column-label="Updated" data-sort-key="updated" data-sort-type="number">Updated</th>
                                            <th data-column="deactivated" data-column-label="Deactivated" data-sort-key="deactivated" data-sort-type="number">Deactivated</th>
                                            <th data-column="errors" data-column-label="Errors" data-sort-key="errors" data-sort-type="number">Errors</th>
                                        </tr>
                                    </thead>
                                    <tbody id="syncHistoryTable">
                                        <tr>
                                            <td colspan="9" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status"></div>
                                                <p class="text-muted mt-2">Loading sync history...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <!-- Settings Sub-Tabs -->
            <ul class="nav nav-pills mb-4" id="settingsTabs" role="tablist">
                {% if current_user and current_user.is_super_admin() %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="ldap-settings-tab" data-bs-toggle="pill" data-bs-target="#ldapSettings" type="button">
                        <i class="bi bi-diagram-3 me-2"></i>LDAP / Active Directory
                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.6em;">PRO</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="smtp-settings-tab" data-bs-toggle="pill" data-bs-target="#smtpSettings" type="button">
                        <i class="bi bi-envelope me-2"></i>Global SMTP
                    </button>
                </li>
                {% else %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="smtp-settings-tab" data-bs-toggle="pill" data-bs-target="#smtpSettings" type="button">
                        <i class="bi bi-envelope me-2"></i>Global SMTP
                    </button>
                </li>
                {% endif %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sync-settings-tab" data-bs-toggle="pill" data-bs-target="#syncSettings" type="button">
                        <i class="bi bi-arrow-clockwise me-2"></i>Sync Schedule
                    </button>
                </li>
                {% if current_user and current_user.is_super_admin() %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="proxy-settings-tab" data-bs-toggle="pill" data-bs-target="#proxySettings" type="button">
                        <i class="bi bi-hdd-network me-2"></i>Proxy
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="security-settings-tab" data-bs-toggle="pill" data-bs-target="#securitySettings" type="button">
                        <i class="bi bi-shield-lock me-2"></i>Security
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="notifications-settings-tab" data-bs-toggle="pill" data-bs-target="#notificationsSettings" type="button">
                        <i class="bi bi-bell me-2"></i>Notifications
                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.6em;">PRO</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="branding-settings-tab" data-bs-toggle="pill" data-bs-target="#brandingSettings" type="button">
                        <i class="bi bi-palette me-2"></i>Branding
                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.6em;">PRO</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="retention-settings-tab" data-bs-toggle="pill" data-bs-target="#retentionSettings" type="button">
                        <i class="bi bi-archive me-2"></i>Data Retention
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="audit-logs-tab" data-bs-toggle="pill" data-bs-target="#auditLogs" type="button">
                        <i class="bi bi-journal-text me-2"></i>Audit Logs
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="license-tab" data-bs-toggle="pill" data-bs-target="#licenseSettings" type="button">
                        <i class="bi bi-key me-2"></i>License
                    </button>
                </li>
                {% endif %}
            </ul>

            <div class="tab-content" id="settingsTabContent">
                {% if current_user and current_user.is_super_admin() %}
                <!-- LDAP Settings (Super Admin Only) -->
                <div class="tab-pane fade show active" id="ldapSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-diagram-3 me-2"></i>LDAP / Active Directory Configuration
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>LDAP Authentication Setup:</strong> Configure connection to your Active Directory/LDAP server.
                                LDAP users cannot be created directly - they are discovered when they log in. You need a service account
                                with read permissions to search for users in your directory.
                            </div>

                            <form id="ldapSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="ldapEnabled">
                                            <label class="form-check-label fw-semibold" for="ldapEnabled">
                                                Enable LDAP Authentication
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-8">
                                        <label for="ldapServer" class="form-label fw-semibold">LDAP Server URL *</label>
                                        <input type="text" class="form-control" id="ldapServer" placeholder="ldap://dc3.bonelabs.com:389">
                                        <small class="form-text text-muted">Format: ldap://server:port or ldaps://server:636</small>
                                    </div>

                                    <div class="col-md-4">
                                        <label for="ldapPort" class="form-label fw-semibold">Port</label>
                                        <input type="number" class="form-control" id="ldapPort" value="389">
                                        <small class="form-text text-muted">389 (LDAP) or 636 (LDAPS)</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="ldapBaseDN" class="form-label fw-semibold">Base DN *</label>
                                        <input type="text" class="form-control" id="ldapBaseDN" placeholder="DC=bonelabs,DC=com">
                                        <small class="form-text text-muted">Base Distinguished Name for searches</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="ldapBindDN" class="form-label fw-semibold">Bind DN (Service Account) *</label>
                                        <input type="text" class="form-control" id="ldapBindDN" placeholder="CN=Service Account,OU=Users,DC=bonelabs,DC=com">
                                        <small class="form-text text-muted">Service account for LDAP binds</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="ldapBindPassword" class="form-label fw-semibold">Bind Password *</label>
                                        <input type="password" class="form-control" id="ldapBindPassword" placeholder="••••••••">
                                        <small class="form-text text-muted">Service account password. Leave blank to keep existing. Encrypted and not shown for security.</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="ldapSearchFilter" class="form-label fw-semibold">Search Filter</label>
                                        <input type="text" class="form-control" id="ldapSearchFilter" value="(sAMAccountName={username})">
                                        <small class="form-text text-muted">Use {username} as placeholder for login username</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="ldapUsernamAttr" class="form-label fw-semibold">Username Attribute</label>
                                        <input type="text" class="form-control" id="ldapUsernameAttr" value="sAMAccountName">
                                        <small class="form-text text-muted">AD: sAMAccountName, OpenLDAP: uid</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="ldapEmailAttr" class="form-label fw-semibold">Email Attribute</label>
                                        <input type="text" class="form-control" id="ldapEmailAttr" value="mail">
                                        <small class="form-text text-muted">Attribute containing email address</small>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="ldapUseTLS">
                                            <label class="form-check-label fw-semibold" for="ldapUseTLS">
                                                Use TLS/STARTTLS
                                            </label>
                                        </div>
                                    </div>

                                    <!-- LDAP Sync Scheduling -->
                                    <div class="col-md-12 mt-4">
                                        <hr>
                                        <h6 class="text-muted mb-3">
                                            <i class="bi bi-arrow-repeat me-2"></i>Automatic Synchronization
                                        </h6>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="alert alert-secondary">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Automatic Sync:</strong> Automatically synchronize LDAP users' roles and organizations based on their group memberships at regular intervals.
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="ldapSyncEnabled">
                                            <label class="form-check-label fw-semibold" for="ldapSyncEnabled">
                                                Enable Scheduled LDAP Synchronization
                                            </label>
                                        </div>
                                        <small class="text-muted">When enabled, LDAP users will be automatically synced with group mappings at the specified interval</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="ldapSyncInterval" class="form-label fw-semibold">Sync Interval (hours)</label>
                                        <select class="form-select" id="ldapSyncInterval">
                                            <option value="1">Every 1 hour</option>
                                            <option value="4">Every 4 hours</option>
                                            <option value="8">Every 8 hours</option>
                                            <option value="12">Every 12 hours</option>
                                            <option value="24" selected>Every 24 hours (daily)</option>
                                            <option value="48">Every 48 hours</option>
                                            <option value="168">Every 7 days (weekly)</option>
                                        </select>
                                        <small class="text-muted">How often to automatically sync LDAP users</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Last Scheduled Sync</label>
                                        <div class="form-control bg-light" id="ldapLastScheduledSync">
                                            Never
                                        </div>
                                        <small class="text-muted">Last time the scheduled sync ran</small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary me-2" onclick="saveLDAPSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save LDAP Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testLDAPConnection()">
                                            <i class="bi bi-plug me-1"></i>Test Connection
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Global SMTP Settings -->
                <div class="tab-pane fade {% if not current_user or not current_user.is_super_admin() %}show active{% endif %}" id="smtpSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-envelope me-2"></i>Global SMTP Configuration
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Default SMTP settings for all organizations. Organizations can override these with their own SMTP config.
                            </div>

                            <form id="smtpSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label for="globalSmtpHost" class="form-label fw-semibold">SMTP Server *</label>
                                        <input type="text" class="form-control" id="globalSmtpHost" placeholder="smtp.gmail.com">
                                    </div>

                                    <div class="col-md-4">
                                        <label for="globalSmtpPort" class="form-label fw-semibold">Port *</label>
                                        <input type="number" class="form-control" id="globalSmtpPort" value="587">
                                        <small class="form-text text-muted">587 (TLS) or 465 (SSL)</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="globalSmtpUsername" class="form-label fw-semibold">Username</label>
                                        <input type="text" class="form-control" id="globalSmtpUsername">
                                    </div>

                                    <div class="col-md-6">
                                        <label for="globalSmtpPassword" class="form-label fw-semibold">Password</label>
                                        <input type="password" class="form-control" id="globalSmtpPassword" placeholder="••••••••">
                                        <small class="form-text text-muted">Leave blank to keep existing password. Passwords are encrypted and not shown for security.</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="globalSmtpFromEmail" class="form-label fw-semibold">From Email *</label>
                                        <input type="email" class="form-control" id="globalSmtpFromEmail" placeholder="noreply@company.com">
                                    </div>

                                    <div class="col-md-6">
                                        <label for="globalSmtpFromName" class="form-label fw-semibold">From Name</label>
                                        <input type="text" class="form-control" id="globalSmtpFromName" value="SentriKat Alerts">
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="globalSmtpUseTLS" checked>
                                            <label class="form-check-label fw-semibold" for="globalSmtpUseTLS">
                                                Use TLS/STARTTLS
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary me-2" onclick="saveGlobalSMTPSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save SMTP Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testGlobalSMTP()">
                                            <i class="bi bi-envelope-check me-1"></i>Send Test Email
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Sync Schedule Settings -->
                <div class="tab-pane fade" id="syncSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-arrow-clockwise me-2"></i>CISA KEV Sync Schedule
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Global Sync Schedule:</strong> Configure automatic synchronization with the CISA Known Exploited Vulnerabilities catalog.
                                This applies to all organizations system-wide and keeps the vulnerability database up-to-date.
                            </div>

                            <form id="syncSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="autoSyncEnabled">
                                            <label class="form-check-label fw-semibold" for="autoSyncEnabled">
                                                Enable Automatic Sync
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="syncInterval" class="form-label fw-semibold">Sync Interval</label>
                                        <select class="form-select" id="syncInterval">
                                            <option value="hourly">Every Hour</option>
                                            <option value="4hours">Every 4 Hours</option>
                                            <option value="6hours">Every 6 Hours</option>
                                            <option value="12hours">Every 12 Hours</option>
                                            <option value="daily" selected>Daily</option>
                                            <option value="weekly">Weekly</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="syncTime" class="form-label fw-semibold">Preferred Time (UTC)</label>
                                        <input type="time" class="form-control" id="syncTime" value="02:00">
                                        <small class="form-text text-muted">Time to run daily/weekly syncs</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="nvdApiKey" class="form-label fw-semibold">NVD API Key</label>
                                        <input type="password" class="form-control" id="nvdApiKey" placeholder="Optional - for CVSS enrichment">
                                        <small class="form-text text-muted">Get from <a href="https://nvd.nist.gov/developers/request-an-api-key" target="_blank">NIST NVD</a></small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="cisaKevUrl" class="form-label fw-semibold">CISA KEV URL</label>
                                        <input type="text" class="form-control" id="cisaKevUrl" value="https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json">
                                        <small class="form-text text-muted">Usually leave as default</small>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="alert alert-secondary">
                                            <strong>Last Sync:</strong> <span id="lastSyncTime">Never</span><br>
                                            <strong>Next Scheduled:</strong> <span id="nextSyncTime">Not scheduled</span><br>
                                            <strong>Total Vulnerabilities:</strong> <span id="totalVulns">0</span>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveSyncSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Sync Settings
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Manual Email Alerts -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <i class="bi bi-envelope-exclamation me-2"></i>Manual Alert Triggers
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Manual Alerts:</strong> Use this to manually send critical CVE email alerts to all organizations.
                                This will send emails for all unacknowledged critical and high priority vulnerabilities.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-12">
                                    <button type="button" class="btn btn-danger" onclick="triggerCriticalCVEAlerts()">
                                        <i class="bi bi-envelope-exclamation me-1"></i>Send Critical CVE Alerts Now
                                    </button>
                                    <small class="text-muted ms-2">Sends alert emails to all organizations with unacknowledged critical CVEs</small>
                                </div>

                                <div class="col-md-12" id="alertResultsContainer" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Alert Results</h6>
                                        <div id="alertResultsContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if current_user and current_user.is_super_admin() %}
                <!-- Proxy Settings (Super Admin Only) -->
                <div class="tab-pane fade" id="proxySettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-hdd-network me-2"></i>Proxy & Network Settings
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure proxy settings for external API connections (CISA KEV, NVD). Required if SentriKat is behind a corporate proxy.
                            </div>

                            <form id="proxySettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="verifySSL" checked>
                                            <label class="form-check-label fw-semibold" for="verifySSL">
                                                Verify SSL Certificates
                                            </label>
                                            <small class="form-text text-muted d-block">Disable if behind corporate proxy with SSL inspection (not recommended for production)</small>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="httpProxy" class="form-label fw-semibold">HTTP Proxy</label>
                                        <input type="text" class="form-control" id="httpProxy" placeholder="http://proxy.company.com:3128">
                                        <small class="form-text text-muted">Proxy for HTTP connections</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="httpsProxy" class="form-label fw-semibold">HTTPS Proxy</label>
                                        <input type="text" class="form-control" id="httpsProxy" placeholder="http://proxy.company.com:3128">
                                        <small class="form-text text-muted">Proxy for HTTPS connections</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="noProxy" class="form-label fw-semibold">No Proxy (Bypass List)</label>
                                        <input type="text" class="form-control" id="noProxy" placeholder="localhost,127.0.0.1,.company.com">
                                        <small class="form-text text-muted">Comma-separated hostnames to bypass proxy</small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveProxySettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Proxy Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="testProxyConnection()">
                                            <i class="bi bi-plug me-1"></i>Test Connection
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="tab-pane fade" id="securitySettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-shield-lock me-2"></i>Security Settings
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure session security, login protection, and password policies.
                            </div>

                            <form id="securitySettingsForm">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-clock me-2"></i>Session Settings</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="sessionTimeout" class="form-label fw-semibold">Session Timeout (minutes)</label>
                                        <input type="number" class="form-control" id="sessionTimeout" value="480" min="5" max="10080">
                                        <small class="form-text text-muted">User sessions expire after this period of inactivity (5 min - 7 days)</small>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-lock me-2"></i>Login Protection</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="maxFailedLogins" class="form-label fw-semibold">Max Failed Login Attempts</label>
                                        <input type="number" class="form-control" id="maxFailedLogins" value="5" min="3" max="20">
                                        <small class="form-text text-muted">Lock account after this many failed attempts</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lockoutDuration" class="form-label fw-semibold">Lockout Duration (minutes)</label>
                                        <input type="number" class="form-control" id="lockoutDuration" value="30" min="5" max="1440">
                                        <small class="form-text text-muted">How long account stays locked</small>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-key me-2"></i>Password Policy (Local Users)</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="passwordMinLength" class="form-label fw-semibold">Minimum Password Length</label>
                                        <input type="number" class="form-control" id="passwordMinLength" value="8" min="6" max="32">
                                    </div>
                                    <div class="col-md-6">
                                        <div class="pt-4">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="passwordRequireUppercase" checked>
                                                <label class="form-check-label" for="passwordRequireUppercase">Require uppercase letter (A-Z)</label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="passwordRequireLowercase" checked>
                                                <label class="form-check-label" for="passwordRequireLowercase">Require lowercase letter (a-z)</label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="passwordRequireNumbers" checked>
                                                <label class="form-check-label" for="passwordRequireNumbers">Require number (0-9)</label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="passwordRequireSpecial">
                                                <label class="form-check-label" for="passwordRequireSpecial">Require special character (!@#$%^&*)</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-calendar-x me-2"></i>Password Expiration</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="passwordExpiryDays" class="form-label fw-semibold">Password Expiry (days)</label>
                                        <input type="number" class="form-control" id="passwordExpiryDays" value="0" min="0" max="365">
                                        <small class="form-text text-muted">Set to 0 to disable password expiration. Users must change password after this many days.</small>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-phone me-2"></i>Two-Factor Authentication</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="require2FA">
                                            <label class="form-check-label" for="require2FA">Require 2FA for all users</label>
                                        </div>
                                        <small class="form-text text-muted">When enabled, users must set up TOTP-based two-factor authentication</small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveSecuritySettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Security Settings
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Backup & Restore Card -->
                    <div class="card mt-4" id="backupRestoreCard">
                        <div class="card-header">
                            <i class="bi bi-cloud-download me-2"></i>Backup & Restore
                            <span class="badge bg-warning text-dark ms-1" style="font-size: 0.7em;">PRO</span>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Backup includes settings, organizations, and user accounts (without passwords). Use with caution when restoring.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <i class="bi bi-download display-4 text-primary mb-3"></i>
                                            <h5>Export Backup</h5>
                                            <p class="text-muted small">Download a JSON backup of your settings and configuration</p>
                                            <button type="button" class="btn btn-primary" onclick="downloadBackup()">
                                                <i class="bi bi-cloud-download me-1"></i>Download Backup
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <i class="bi bi-upload display-4 text-secondary mb-3"></i>
                                            <h5>Restore Backup</h5>
                                            <p class="text-muted small">Restore from a previously exported backup file</p>
                                            <input type="file" class="form-control mb-2" id="restoreFile" accept=".json" style="display: none;">
                                            <input type="file" class="form-control mb-2" id="restoreFullFile" accept=".json" style="display: none;">
                                            <div class="d-grid gap-2">
                                                <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('restoreFile').click()">
                                                    <i class="bi bi-sliders me-1"></i>Settings Only
                                                </button>
                                                <button type="button" class="btn btn-outline-primary" onclick="confirmFullRestore()">
                                                    <i class="bi bi-database-up me-1"></i>Full Restore
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Settings -->
                <div class="tab-pane fade" id="notificationsSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-bell me-2"></i>Notification Integrations
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure webhooks to receive vulnerability alerts in Slack or Microsoft Teams.
                            </div>

                            <form id="notificationsSettingsForm">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-slack me-2"></i>Slack Integration</h6>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-check form-switch mb-2">
                                            <input type="checkbox" class="form-check-input" id="slackEnabled">
                                            <label class="form-check-label fw-semibold" for="slackEnabled">Enable Slack Notifications</label>
                                        </div>
                                    </div>
                                    <div class="col-md-10">
                                        <label for="slackWebhookUrl" class="form-label">Slack Webhook URL</label>
                                        <input type="text" class="form-control" id="slackWebhookUrl" placeholder="https://hooks.slack.com/services/...">
                                        <small class="form-text text-muted">Create an incoming webhook in your Slack workspace settings</small>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="button" class="btn btn-outline-secondary w-100" onclick="testWebhook('slack')">
                                            <i class="bi bi-send me-1"></i>Test
                                        </button>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-microsoft-teams me-2"></i>Microsoft Teams Integration</h6>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-check form-switch mb-2">
                                            <input type="checkbox" class="form-check-input" id="teamsEnabled">
                                            <label class="form-check-label fw-semibold" for="teamsEnabled">Enable Teams Notifications</label>
                                        </div>
                                    </div>
                                    <div class="col-md-10">
                                        <label for="teamsWebhookUrl" class="form-label">Teams Webhook URL</label>
                                        <input type="text" class="form-control" id="teamsWebhookUrl" placeholder="https://outlook.office.com/webhook/...">
                                        <small class="form-text text-muted">Create an incoming webhook connector in your Teams channel</small>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="button" class="btn btn-outline-secondary w-100" onclick="testWebhook('teams')">
                                            <i class="bi bi-send me-1"></i>Test
                                        </button>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-webhook me-2"></i>Generic Webhook (RocketChat, Mattermost, Discord, etc.)</h6>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-check form-switch mb-2">
                                            <input type="checkbox" class="form-check-input" id="genericWebhookEnabled">
                                            <label class="form-check-label fw-semibold" for="genericWebhookEnabled">Enable Generic Webhook Notifications</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="genericWebhookName" class="form-label">Webhook Name</label>
                                        <input type="text" class="form-control" id="genericWebhookName" placeholder="RocketChat" value="Custom Webhook">
                                        <small class="form-text text-muted">Display name for this integration</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="genericWebhookFormat" class="form-label">Payload Format</label>
                                        <select class="form-select" id="genericWebhookFormat">
                                            <option value="slack">Slack-compatible (RocketChat, Mattermost)</option>
                                            <option value="discord">Discord</option>
                                            <option value="custom">Custom JSON Template</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="genericWebhookUrl" class="form-label">Webhook URL</label>
                                        <input type="text" class="form-control" id="genericWebhookUrl" placeholder="https://your-server.com/hooks/...">
                                        <small class="form-text text-muted">Incoming webhook URL from your chat platform</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="genericWebhookToken" class="form-label">Auth Token <span class="text-muted">(optional)</span></label>
                                        <input type="password" class="form-control" id="genericWebhookToken" placeholder="Leave empty if not needed">
                                        <small class="form-text text-muted">For webhooks requiring authentication</small>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="button" class="btn btn-outline-secondary w-100" onclick="testWebhook('generic')">
                                            <i class="bi bi-send me-1"></i>Test
                                        </button>
                                    </div>
                                    <div class="col-md-12" id="customTemplateContainer" style="display: none;">
                                        <label for="genericWebhookTemplate" class="form-label">Custom JSON Template</label>
                                        <textarea class="form-control font-monospace" id="genericWebhookTemplate" rows="4" placeholder='{"text": "{{message}}", "title": "{{title}}"}'></textarea>
                                        <small class="form-text text-muted">Use <code>{{message}}</code> and <code>{{title}}</code> as placeholders</small>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-envelope-exclamation me-2"></i>Critical CVE Email Reminders</h6>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-check form-switch mb-2">
                                            <input type="checkbox" class="form-check-input" id="criticalEmailEnabled" checked>
                                            <label class="form-check-label fw-semibold" for="criticalEmailEnabled">Enable Daily Critical CVE Reminder Emails</label>
                                        </div>
                                        <small class="form-text text-muted">Send daily reminder emails about unacknowledged CRITICAL CVEs to organization notification emails</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="criticalEmailTime" class="form-label">Email Time (UTC)</label>
                                        <input type="time" class="form-control" id="criticalEmailTime" value="09:00">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="criticalEmailMaxAge" class="form-label">Max CVE Age (days)</label>
                                        <input type="number" class="form-control" id="criticalEmailMaxAge" value="30" min="7" max="90">
                                        <small class="form-text text-muted">Only include CVEs discovered within this many days</small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Notification Settings
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Branding Settings -->
                <div class="tab-pane fade" id="brandingSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-palette me-2"></i>Branding & Appearance
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Customize the application name and appearance.
                            </div>

                            <form id="brandingSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="appName" class="form-label fw-semibold">Application Name</label>
                                        <input type="text" class="form-control" id="appName" value="SentriKat" maxlength="50">
                                        <small class="form-text text-muted">Displayed in browser title and header</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="supportEmail" class="form-label fw-semibold">Support Email</label>
                                        <input type="email" class="form-control" id="supportEmail" placeholder="support@company.com">
                                        <small class="form-text text-muted">Shown on login page and error messages</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="loginMessage" class="form-label fw-semibold">Login Page Message</label>
                                        <textarea class="form-control" id="loginMessage" rows="2" maxlength="500" placeholder="Welcome message or security notice for users..."></textarea>
                                        <small class="form-text text-muted">Optional message displayed on the login page</small>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="showVersion" checked>
                                            <label class="form-check-label fw-semibold" for="showVersion">Show Version in Footer</label>
                                        </div>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-image me-2"></i>Custom Logo</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Current Logo</label>
                                        <div class="d-flex align-items-center gap-3">
                                            <img id="currentLogoPreview" src="/static/images/favicon-128x128.png" alt="Logo" style="width: 64px; height: 64px; object-fit: contain; border: 1px solid #ddd; border-radius: 8px; padding: 4px;">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteLogo()" id="deleteLogoBtn" style="display: none;">
                                                <i class="bi bi-trash me-1"></i>Remove
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="logoUpload" class="form-label fw-semibold">Upload New Logo</label>
                                        <input type="file" class="form-control" id="logoUpload" accept=".png,.jpg,.jpeg,.gif,.svg,.webp">
                                        <small class="form-text text-muted">Max 2MB. Recommended: 128x128px PNG with transparent background</small>
                                    </div>
                                    <div class="col-md-12">
                                        <button type="button" class="btn btn-outline-primary" onclick="uploadLogo()">
                                            <i class="bi bi-upload me-1"></i>Upload Logo
                                        </button>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveBrandingSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Branding Settings
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Data Retention Settings -->
                <div class="tab-pane fade" id="retentionSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-archive me-2"></i>Data Retention
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Caution:</strong> Data older than the retention period will be permanently deleted during cleanup tasks.
                            </div>

                            <form id="retentionSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="auditLogRetention" class="form-label fw-semibold">Audit Log Retention (days)</label>
                                        <input type="number" class="form-control" id="auditLogRetention" value="365" min="30" max="3650">
                                        <small class="form-text text-muted">User activity and change logs</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="syncHistoryRetention" class="form-label fw-semibold">Sync History Retention (days)</label>
                                        <input type="number" class="form-control" id="syncHistoryRetention" value="90" min="7" max="365">
                                        <small class="form-text text-muted">CISA/NVD sync logs</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="sessionLogRetention" class="form-label fw-semibold">Session Log Retention (days)</label>
                                        <input type="number" class="form-control" id="sessionLogRetention" value="30" min="7" max="365">
                                        <small class="form-text text-muted">User login sessions</small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveRetentionSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Retention Settings
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Audit Logs -->
                <div class="tab-pane fade" id="auditLogs" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-journal-text me-2"></i>Audit Logs</span>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="bi bi-download me-1"></i>Export
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="exportAuditLogs('csv', 30)"><i class="bi bi-filetype-csv me-2"></i>CSV (Last 30 days)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportAuditLogs('csv', 90)"><i class="bi bi-filetype-csv me-2"></i>CSV (Last 90 days)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportAuditLogs('csv', 365)"><i class="bi bi-filetype-csv me-2"></i>CSV (Last year)</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportAuditLogs('json', 30)"><i class="bi bi-filetype-json me-2"></i>JSON (Last 30 days)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportAuditLogs('json', 90)"><i class="bi bi-filetype-json me-2"></i>JSON (Last 90 days)</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                View and export audit logs for compliance and security review. Logs include user actions, configuration changes, and security events.
                            </div>

                            <!-- Search and Filters Row 1 -->
                            <div class="row g-2 mb-2">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="auditSearchInput" placeholder="Search logs..." onkeyup="if(event.key==='Enter') loadAuditLogs()">
                                        <button class="btn btn-outline-secondary" type="button" onclick="loadAuditLogs()">Search</button>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="auditActionFilter" onchange="loadAuditLogs()">
                                        <option value="">All Actions</option>
                                        <option value="CREATE">Create</option>
                                        <option value="UPDATE">Update</option>
                                        <option value="DELETE">Delete</option>
                                        <option value="LOGIN">Login</option>
                                        <option value="LOGOUT">Logout</option>
                                        <option value="LOGIN_FAILED">Login Failed</option>
                                        <option value="BLOCK">Block</option>
                                        <option value="UNBLOCK">Unblock</option>
                                        <option value="UNLOCK">Unlock</option>
                                        <option value="RESET_2FA">Reset 2FA</option>
                                        <option value="FORCE_PASSWORD_CHANGE">Force Password</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="auditResourceFilter" onchange="loadAuditLogs()">
                                        <option value="">All Resources</option>
                                        <option value="users">Users</option>
                                        <option value="products">Products</option>
                                        <option value="organizations">Organizations</option>
                                        <option value="settings">Settings</option>
                                        <option value="ldap">LDAP</option>
                                        <option value="auth">Authentication</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="date" class="form-control" id="auditStartDate" onchange="loadAuditLogs()" title="Start Date">
                                </div>
                                <div class="col-md-2">
                                    <input type="date" class="form-control" id="auditEndDate" onchange="loadAuditLogs()" title="End Date">
                                </div>
                            </div>

                            <!-- Controls Row 2 -->
                            <div class="row g-2 mb-3">
                                <div class="col-md-2">
                                    <select class="form-select form-select-sm" id="auditPerPage" onchange="loadAuditLogs()">
                                        <option value="25">25 per page</option>
                                        <option value="50" selected>50 per page</option>
                                        <option value="100">100 per page</option>
                                        <option value="200">200 per page</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select form-select-sm" id="auditSortField" onchange="loadAuditLogs()">
                                        <option value="timestamp">Sort: Time</option>
                                        <option value="action">Sort: Action</option>
                                        <option value="resource">Sort: Resource</option>
                                        <option value="user_id">Sort: User</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select form-select-sm" id="auditSortOrder" onchange="loadAuditLogs()">
                                        <option value="desc">Newest First</option>
                                        <option value="asc">Oldest First</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAuditFilters()">
                                        <i class="bi bi-x-circle me-1"></i>Clear Filters
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadAuditLogs()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                    </button>
                                </div>
                                <div class="col-md-3 text-end">
                                    <span id="auditLogsInfo" class="text-muted small"></span>
                                </div>
                            </div>

                            <!-- Audit Logs Table -->
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-hover table-sm" id="auditLogsTableContainer">
                                    <thead class="sticky-top bg-light">
                                        <tr>
                                            <th style="width: 160px; cursor: pointer;" onclick="sortAuditLogs('timestamp')">
                                                Timestamp <i class="bi bi-arrow-down-up text-muted"></i>
                                            </th>
                                            <th style="width: 120px; cursor: pointer;" onclick="sortAuditLogs('action')">
                                                Action <i class="bi bi-arrow-down-up text-muted"></i>
                                            </th>
                                            <th style="width: 150px; cursor: pointer;" onclick="sortAuditLogs('resource')">
                                                Resource <i class="bi bi-arrow-down-up text-muted"></i>
                                            </th>
                                            <th style="width: 120px; cursor: pointer;" onclick="sortAuditLogs('user_id')">
                                                User <i class="bi bi-arrow-down-up text-muted"></i>
                                            </th>
                                            <th style="width: 120px;">IP Address</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditLogsTable">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">
                                                <i class="bi bi-arrow-repeat spin me-2"></i>Loading audit logs...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <div class="d-flex justify-content-between align-items-center mt-3" id="auditPaginationContainer">
                                <div>
                                    <span id="auditPaginationInfo" class="text-muted small"></span>
                                </div>
                                <nav>
                                    <ul class="pagination pagination-sm mb-0" id="auditPagination">
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- License Settings -->
                <div class="tab-pane fade" id="licenseSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-key me-2"></i>License Management</span>
                            <span class="badge" id="licenseEditionBadge">Loading...</span>
                        </div>
                        <div class="card-body">
                            <!-- Current License Status -->
                            <div id="licenseStatusCard" class="mb-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h5 class="card-title mb-3">
                                                    <i class="bi bi-shield-check me-2"></i>Current License
                                                </h5>
                                                <div id="licenseDetails">
                                                    <div class="text-center py-3">
                                                        <div class="spinner-border spinner-border-sm text-primary"></div>
                                                        <span class="ms-2">Loading license info...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h5 class="card-title mb-3">
                                                    <i class="bi bi-bar-chart me-2"></i>Usage
                                                </h5>
                                                <div id="licenseUsage">
                                                    <div class="text-center py-3">
                                                        <div class="spinner-border spinner-border-sm text-primary"></div>
                                                        <span class="ms-2">Loading usage data...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- License Key Input -->
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-key-fill me-2"></i>Activate License
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-3">
                                        Enter your license key to activate Professional features. License keys are provided after purchase.
                                    </p>
                                    <div class="mb-3">
                                        <label for="licenseKeyInput" class="form-label fw-semibold">License Key</label>
                                        <textarea class="form-control font-monospace" id="licenseKeyInput" rows="3" placeholder="Paste your license key here..."></textarea>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="activateLicense()">
                                            <i class="bi bi-check-circle me-1"></i>Activate License
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" onclick="removeLicense()" id="removeLicenseBtn" style="display: none;">
                                            <i class="bi bi-x-circle me-1"></i>Remove License
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Feature Comparison -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <i class="bi bi-list-check me-2"></i>Feature Comparison
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th>Feature</th>
                                                <th class="text-center">Community</th>
                                                <th class="text-center">Professional</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Vulnerability Management</td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>CISA KEV Sync</td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Dashboard & Reporting</td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Organizations</td>
                                                <td class="text-center">1</td>
                                                <td class="text-center text-success">Unlimited</td>
                                            </tr>
                                            <tr>
                                                <td>Users</td>
                                                <td class="text-center">3</td>
                                                <td class="text-center text-success">Unlimited</td>
                                            </tr>
                                            <tr>
                                                <td>Products</td>
                                                <td class="text-center">20</td>
                                                <td class="text-center text-success">Unlimited</td>
                                            </tr>
                                            <tr>
                                                <td>LDAP / Active Directory</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Email Alerts</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Full White-Labeling</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>API Access</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Backup & Restore</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Audit Log Export</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">
                    <i class="bi bi-person-plus me-2"></i>Create User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">

                    <!-- Auth Type Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Authentication Type *</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="authType" id="authLocal" value="local" checked onchange="toggleAuthFields()">
                            <label class="btn btn-outline-primary" for="authLocal">
                                <i class="bi bi-key me-1"></i>Local Account
                            </label>
                            <input type="radio" class="btn-check" name="authType" id="authLdap" value="ldap" onchange="toggleAuthFields()">
                            <label class="btn btn-outline-primary" for="authLdap" id="authLdapLabel">
                                <i class="bi bi-diagram-3 me-1"></i>LDAP Account
                            </label>
                        </div>
                        <small class="form-text text-muted">Local: Password stored in database. LDAP: Authenticates against Active Directory</small>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="username" class="form-label fw-semibold">Username *</label>
                            <input type="text" class="form-control" id="username" required>
                            <small class="form-text text-muted" id="usernameHelp">For LDAP: Use AD sAMAccountName</small>
                        </div>

                        <div class="col-md-6">
                            <label for="email" class="form-label fw-semibold">Email *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>

                        <div class="col-md-12">
                            <label for="fullName" class="form-label fw-semibold">Full Name</label>
                            <input type="text" class="form-control" id="fullName">
                        </div>

                        <!-- Password fields (only for local auth) -->
                        <div class="col-md-6" id="passwordField">
                            <label for="password" class="form-label fw-semibold">Password *</label>
                            <input type="password" class="form-control" id="password">
                            <small class="form-text text-muted">Minimum 8 characters</small>
                        </div>

                        <div class="col-md-6" id="passwordConfirmField">
                            <label for="passwordConfirm" class="form-label fw-semibold">Confirm Password *</label>
                            <input type="password" class="form-control" id="passwordConfirm">
                        </div>

                        <div class="col-md-6" id="primaryOrgField">
                            <label for="organization" class="form-label fw-semibold">Primary Organization *</label>
                            <select class="form-select" id="organization" required>
                                <option value="">Loading...</option>
                            </select>
                            <small class="text-muted">Initial organization for the user. Additional orgs can be added after creation.</small>
                        </div>

                        <div class="col-md-12">
                            <label for="userRole" class="form-label fw-semibold">Role *</label>
                            <select class="form-select" id="userRole" onchange="updateRoleDescription()">
                                <option value="user">User - View-only access to vulnerabilities</option>
                                <option value="manager">Manager - Can manage products and view vulnerabilities</option>
                                <option value="org_admin">Organization Admin - Full access within their organization</option>
                                <option value="super_admin">Super Admin - Full system access across all organizations</option>
                            </select>
                            <div class="alert alert-sm mt-2" id="roleDescription"></div>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label fw-semibold">Additional Permissions</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="canManageProducts">
                                <label class="form-check-label" for="canManageProducts">
                                    Can manage products (add/edit/delete)
                                </label>
                            </div>
                            <div class="form-check" id="viewAllOrgsCheck">
                                <input type="checkbox" class="form-check-input" id="canViewAllOrgs">
                                <label class="form-check-label" for="canViewAllOrgs">
                                    Can view all organizations (super admin only)
                                </label>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="form-check form-switch">
                                <input type="checkbox" class="form-check-input" id="isActive" checked>
                                <label class="form-check-label fw-semibold" for="isActive">
                                    Active (user can log in)
                                </label>
                            </div>
                        </div>

                        <!-- Additional Organization Memberships (shown when editing) -->
                        <div class="col-md-12 mt-4" id="orgMembershipsSection" style="display: none;">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-buildings me-2"></i>Organization Memberships</span>
                                    <button type="button" class="btn btn-sm btn-light" onclick="showAddOrgMembershipModal()">
                                        <i class="bi bi-plus-circle me-1"></i>Add Organization
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Organization</th>
                                                    <th>Role</th>
                                                    <th>Type</th>
                                                    <th style="width: 120px;">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="orgMembershipsTable">
                                                <tr>
                                                    <td colspan="4" class="text-center text-muted py-3">
                                                        <i class="bi bi-info-circle me-1"></i>Loading memberships...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">
                    <i class="bi bi-check-circle me-1"></i>Save User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Organization Membership Modal -->
<div class="modal fade" id="addOrgMembershipModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-building-add me-2"></i>Add Organization Membership
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="addOrgMembershipUserId">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Organization *</label>
                    <select class="form-select" id="addOrgMembershipOrg" required>
                        <option value="">Select organization...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Role *</label>
                    <select class="form-select" id="addOrgMembershipRole" required>
                        <option value="user">User - View-only access</option>
                        <option value="manager">Manager - Can manage products</option>
                        <option value="org_admin">Organization Admin - Full org access</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addOrgMembership()">
                    <i class="bi bi-check-circle me-1"></i>Add Membership
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Organization Modal -->
<div class="modal fade" id="orgModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orgModalTitle">
                    <i class="bi bi-building me-2"></i>Create Organization
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="orgForm">
                    <input type="hidden" id="orgId">

                    <ul class="nav nav-tabs mb-3" id="orgFormTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basicInfo" type="button">
                                <i class="bi bi-info-circle me-1"></i>Basic Info
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="smtp-tab" data-bs-toggle="tab" data-bs-target="#smtpConfig" type="button">
                                <i class="bi bi-envelope me-1"></i>Email (SMTP)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alertSettings" type="button">
                                <i class="bi bi-bell me-1"></i>Alert Settings
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="webhook-tab" data-bs-toggle="tab" data-bs-target="#webhookSettings" type="button">
                                <i class="bi bi-broadcast me-1"></i>Webhook
                                <span class="badge bg-warning text-dark ms-1" style="font-size: 0.6em;">PRO</span>
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Basic Info Tab -->
                        <div class="tab-pane fade show active" id="basicInfo">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="orgName" class="form-label fw-semibold">Organization Name *</label>
                                    <input type="text" class="form-control" id="orgName" required>
                                    <small class="form-text text-muted">Unique identifier (lowercase, no spaces)</small>
                                </div>

                                <div class="col-md-6">
                                    <label for="orgDisplayName" class="form-label fw-semibold">Display Name *</label>
                                    <input type="text" class="form-control" id="orgDisplayName" required>
                                    <small class="form-text text-muted">Shown in UI</small>
                                </div>

                                <div class="col-md-12">
                                    <label for="orgDescription" class="form-label fw-semibold">Description</label>
                                    <textarea class="form-control" id="orgDescription" rows="2"></textarea>
                                </div>

                                <div class="col-md-12">
                                    <label for="orgEmails" class="form-label fw-semibold">Notification Emails</label>
                                    <input type="text" class="form-control" id="orgEmails" placeholder="email1@company.com, email2@company.com">
                                    <small class="form-text text-muted">Comma-separated email addresses for vulnerability alerts</small>
                                </div>

                                <div class="col-md-12">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="orgActive" checked>
                                        <label class="form-check-label fw-semibold" for="orgActive">
                                            Active
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SMTP Config Tab -->
                        <div class="tab-pane fade" id="smtpConfig">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure SMTP settings for this organization's email alerts. Leave empty to use global SMTP settings.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="smtpHost" class="form-label fw-semibold">SMTP Server</label>
                                    <input type="text" class="form-control" id="smtpHost" placeholder="smtp.gmail.com">
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpPort" class="form-label fw-semibold">Port</label>
                                    <input type="number" class="form-control" id="smtpPort" value="587" onchange="autoConfigureSmtpSecurity()">
                                    <small class="form-text text-muted">
                                        25 = Plain SMTP (no TLS/SSL) | 587 = TLS/STARTTLS | 465 = SSL
                                    </small>
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpUsername" class="form-label fw-semibold">Username</label>
                                    <input type="text" class="form-control" id="smtpUsername">
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpPassword" class="form-label fw-semibold">Password</label>
                                    <input type="password" class="form-control" id="smtpPassword" placeholder="••••••••">
                                    <small class="form-text text-muted">Leave blank to keep existing password</small>
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpFromEmail" class="form-label fw-semibold">From Email</label>
                                    <input type="email" class="form-control" id="smtpFromEmail" placeholder="noreply@company.com">
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpFromName" class="form-label fw-semibold">From Name</label>
                                    <input type="text" class="form-control" id="smtpFromName" value="SentriKat Alerts">
                                </div>

                                <div class="col-md-12">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="smtpUseTls" checked>
                                        <label class="form-check-label fw-semibold" for="smtpUseTls">
                                            Use TLS/STARTTLS
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-12">
                                    <button type="button" class="btn btn-outline-primary" onclick="testSMTP()">
                                        <i class="bi bi-envelope-check me-1"></i>Test SMTP Connection
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Alert Settings Tab -->
                        <div class="tab-pane fade" id="alertSettings">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure when this organization receives email alerts
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="alertCritical" checked>
                                        <label class="form-check-label" for="alertCritical">
                                            <strong>Alert on Critical CVEs</strong> (CVSS 9.0-10.0)
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="alertHigh">
                                        <label class="form-check-label" for="alertHigh">
                                            <strong>Alert on High CVEs</strong> (CVSS 7.0-8.9)
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="alertNewCVE" checked>
                                        <label class="form-check-label" for="alertNewCVE">
                                            <strong>Alert on New CVEs</strong> (when CISA adds new vulnerabilities)
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="alertRansomware" checked>
                                        <label class="form-check-label" for="alertRansomware">
                                            <strong>Alert on Ransomware</strong> (known to be used in ransomware)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Webhook Settings Tab -->
                        <div class="tab-pane fade" id="webhookSettings">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure a webhook for this organization. Takes priority over global webhook settings.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-12">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="orgWebhookEnabled">
                                        <label class="form-check-label fw-semibold" for="orgWebhookEnabled">
                                            Enable Organization Webhook
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-8">
                                    <label for="orgWebhookUrl" class="form-label fw-semibold">Webhook URL</label>
                                    <input type="url" class="form-control" id="orgWebhookUrl" placeholder="https://hooks.slack.com/services/...">
                                    <small class="form-text text-muted">Incoming webhook URL from your chat platform</small>
                                </div>

                                <div class="col-md-4">
                                    <label for="orgWebhookFormat" class="form-label fw-semibold">Platform Format</label>
                                    <select class="form-select" id="orgWebhookFormat">
                                        <option value="slack">Slack</option>
                                        <option value="rocketchat">RocketChat</option>
                                        <option value="discord">Discord</option>
                                        <option value="teams">Microsoft Teams</option>
                                        <option value="custom">Custom JSON</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label for="orgWebhookName" class="form-label fw-semibold">Webhook Name</label>
                                    <input type="text" class="form-control" id="orgWebhookName" placeholder="Org Alerts">
                                    <small class="form-text text-muted">Display name for this webhook</small>
                                </div>

                                <div class="col-md-6">
                                    <label for="orgWebhookToken" class="form-label fw-semibold">Auth Token <span class="text-muted">(optional)</span></label>
                                    <input type="password" class="form-control" id="orgWebhookToken" placeholder="Leave empty if not needed">
                                    <small class="form-text text-muted">For webhooks requiring authentication</small>
                                </div>

                                <div class="col-md-12">
                                    <button type="button" class="btn btn-outline-primary" onclick="testOrgWebhook()">
                                        <i class="bi bi-send me-1"></i>Test Webhook
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveOrganization()">
                    <i class="bi bi-check-circle me-1"></i>Save Organization
                </button>
            </div>
        </div>
    </div>
</div>

<!-- LDAP Search Modal -->
<div class="modal fade" id="ldapSearchModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-search me-2"></i>Search LDAP Directory
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="ldapSearchQuery" placeholder="Search by username, email, or name (use * for wildcard)">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="searchLdapUsers()">
                            <i class="bi bi-search me-1"></i>Search
                        </button>
                    </div>
                </div>
                <div id="ldapSearchResultsTable">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search" style="font-size: 2rem;"></i>
                        <p class="mt-2">Enter a search query and click Search</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- LDAP Invite User Modal -->
<div class="modal fade" id="ldapInviteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus me-2"></i>Invite LDAP User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="ldapInviteForm">
                    <input type="hidden" id="ldapUserDN">

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        This user will be invited to SentriKat and will authenticate using LDAP credentials.
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="ldapInviteUsername" class="form-label fw-semibold">Username *</label>
                            <input type="text" class="form-control bg-light text-muted" id="ldapInviteUsername" readonly>
                            <small class="text-muted">From LDAP - cannot be changed</small>
                        </div>

                        <div class="col-md-6">
                            <label for="ldapInviteEmail" class="form-label fw-semibold">Email *</label>
                            <input type="email" class="form-control bg-light text-muted" id="ldapInviteEmail" readonly>
                            <small class="text-muted">From LDAP - cannot be changed</small>
                        </div>

                        <div class="col-md-12">
                            <label for="ldapInviteFullName" class="form-label fw-semibold">Full Name</label>
                            <input type="text" class="form-control bg-light text-muted" id="ldapInviteFullName" readonly>
                            <small class="text-muted">From LDAP - cannot be changed</small>
                        </div>

                        <div class="col-md-6">
                            <label for="ldapInviteOrganization" class="form-label fw-semibold">Organization *</label>
                            <select class="form-select" id="ldapInviteOrganization" required>
                                <option value="">Select organization...</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="ldapInviteRole" class="form-label fw-semibold">Role *</label>
                            <select class="form-select" id="ldapInviteRole" required>
                                <option value="user">User - View-only access</option>
                                <option value="manager">Manager - Can manage products</option>
                                <option value="org_admin">Organization Admin - Full org access</option>
                                <option value="super_admin">Super Admin - Full system access</option>
                            </select>
                        </div>

                        <div class="col-md-12">
                            <div id="ldapInviteGroups" class="alert alert-secondary">
                                <strong>LDAP Groups:</strong> <span id="ldapGroupsList">Loading...</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="inviteLdapUser()">
                    <i class="bi bi-check-circle me-1"></i>Invite User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Group Mapping Modal -->
<div class="modal fade" id="groupMappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="groupMappingModalTitle">Create Group Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="groupMappingForm">
                    <input type="hidden" id="mappingId">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">LDAP Group DN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ldapGroupDn" required
                                   placeholder="CN=Admins,OU=Groups,DC=company,DC=com">
                            <small class="text-muted">Full Distinguished Name of the LDAP group</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Group Common Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ldapGroupCn" required
                                   placeholder="Admins">
                            <small class="text-muted">Display name for the group</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Organization</label>
                            <select class="form-select" id="mappingOrganization">
                                <option value="">All Organizations</option>
                            </select>
                            <small class="text-muted">Leave blank for system-wide mapping</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Assigned Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="mappingRole" required>
                                <option value="">Select Role...</option>
                                <option value="user">User - Basic access</option>
                                <option value="manager">Manager - Team management</option>
                                <option value="org_admin">Organization Admin - Full org access</option>
                                <option value="super_admin">Super Admin - Full system access</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Priority</label>
                            <input type="number" class="form-control" id="mappingPriority" value="0" min="0" max="100">
                            <small class="text-muted">Higher priority wins if user is in multiple groups</small>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="ldapGroupDescription" rows="2"
                                      placeholder="Optional description of this group mapping"></textarea>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoProvision" checked>
                                <label class="form-check-label" for="autoProvision">
                                    Auto-Provision Users
                                </label>
                            </div>
                            <small class="text-muted">Automatically create accounts when users login</small>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoDeprovision">
                                <label class="form-check-label" for="autoDeprovision">
                                    Auto-Deprovision Users
                                </label>
                            </div>
                            <small class="text-muted">Deactivate users when they leave the group</small>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="syncEnabled" checked>
                                <label class="form-check-label" for="syncEnabled">
                                    Sync Enabled
                                </label>
                            </div>
                            <small class="text-muted">Include in automatic synchronization</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveGroupMapping()">Save Mapping</button>
            </div>
        </div>
    </div>
</div>

<!-- LDAP Group Discovery Modal -->
<div class="modal fade" id="ldapDiscoveryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Discover LDAP Groups</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="groupSearchBase"
                               placeholder="Search base DN (e.g., OU=Groups,DC=company,DC=com)">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="performGroupDiscovery()">
                            <i class="bi bi-search me-1"></i>Search
                        </button>
                    </div>
                </div>
                <div id="discoveredGroupsContainer">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-diagram-2" style="font-size: 3rem;"></i>
                        <p class="mt-3">Enter a search base DN and click Search to discover LDAP groups</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin_panel.js') }}"></script>
{% endblock %}
