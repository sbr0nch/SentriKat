{% extends "base.html" %}

{% block title %}Admin Panel - SentriKat{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6 fw-bold text-dark mb-2">
                <i class="bi bi-shield-lock me-2"></i>Administration Panel
            </h1>
            <p class="text-muted">Manage users, organizations, and system settings</p>
        </div>
    </div>

    <!-- Admin Tabs -->
    <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
                <i class="bi bi-people me-2"></i>Users
            </button>
        </li>
        <li class="nav-item" role="presentation" id="ldap-users-tab-item" style="display: none;">
            <button class="nav-link" id="ldap-users-tab" data-bs-toggle="tab" data-bs-target="#ldapUsers" type="button" onclick="setTimeout(searchLdapUsersInline, 100)">
                <i class="bi bi-diagram-3 me-2"></i>LDAP Users
            </button>
        </li>
        <li class="nav-item" role="presentation" id="ldap-groups-tab-item" style="display: none;">
            <button class="nav-link" id="ldap-groups-tab" data-bs-toggle="tab" data-bs-target="#ldapGroups" type="button">
                <i class="bi bi-diagram-2 me-2"></i>LDAP Groups
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="organizations-tab" data-bs-toggle="tab" data-bs-target="#organizations" type="button">
                <i class="bi bi-building me-2"></i>Organizations
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">
                <i class="bi bi-gear me-2"></i>Settings
            </button>
        </li>
    </ul>

    <div class="tab-content" id="adminTabsContent">
        <!-- Users Tab -->
        <div class="tab-pane fade show active" id="users" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-people me-2"></i>User Management</span>
                    <button class="btn btn-primary btn-sm" onclick="showCreateUserModal()">
                        <i class="bi bi-plus-circle me-1"></i>Create User
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Organization</th>
                                    <th>Auth Type</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="text-muted mt-2">Loading users...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- LDAP Users Tab -->
        <div class="tab-pane fade" id="ldapUsers" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <span><i class="bi bi-diagram-3 me-2"></i>LDAP User Discovery & Management</span>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>LDAP User Management:</strong> Search your LDAP/Active Directory to discover users, then invite them to SentriKat.
                        Users will authenticate against your LDAP server when logging in.
                    </div>

                    <!-- Search Interface -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="ldapUserSearchQuery"
                                       placeholder="Search by username, email, or display name..."
                                       value="*"
                                       onkeypress="if(event.key==='Enter') searchLdapUsersInline()">
                                <button class="btn btn-primary" onclick="searchLdapUsersInline()">
                                    <i class="bi bi-search me-1"></i>Search
                                </button>
                                <button class="btn btn-success" onclick="document.getElementById('ldapUserSearchQuery').value='*'; searchLdapUsersInline()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Load All
                                </button>
                            </div>
                            <small class="text-muted">
                                Examples: "john", "john.doe", "john*", "*admin*" or "*" for all users
                            </small>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="ldapSearchPageSize" onchange="searchLdapUsersInline()">
                                <option value="10">10 per page</option>
                                <option value="25" selected>25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>

                    <!-- Search Stats -->
                    <div id="ldapSearchStats" class="mb-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Showing <strong id="ldapResultCount">0</strong> users
                            </span>
                            <div id="ldapPagination" class="btn-group btn-group-sm"></div>
                        </div>
                    </div>

                    <!-- Results Table -->
                    <div id="ldapSearchResultsTable">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-search" style="font-size: 3rem;"></i>
                            <p class="mt-3">Enter a search query above to discover LDAP users</p>
                            <p class="text-muted">You can search by username, email, or display name</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Organizations Tab -->
        <div class="tab-pane fade" id="organizations" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-building me-2"></i>Organization Management</span>
                    <button class="btn btn-primary btn-sm" onclick="showCreateOrgModal()">
                        <i class="bi bi-plus-circle me-1"></i>Create Organization
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Display Name</th>
                                    <th>Users</th>
                                    <th>SMTP Configured</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orgsTable">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="text-muted mt-2">Loading organizations...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- LDAP Groups Tab -->
        <div class="tab-pane fade" id="ldapGroups" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Enterprise LDAP Group Management:</strong> Map LDAP/Active Directory groups to SentriKat roles. Users are automatically assigned roles based on their group memberships.
                    </div>
                </div>
            </div>

            <!-- Sub-tabs for LDAP Groups -->
            <ul class="nav nav-pills mb-4" id="ldapGroupsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="group-mappings-tab" data-bs-toggle="pill" data-bs-target="#groupMappings" type="button">
                        <i class="bi bi-link-45deg me-2"></i>Group Mappings
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sync-dashboard-tab" data-bs-toggle="pill" data-bs-target="#syncDashboard" type="button">
                        <i class="bi bi-arrow-repeat me-2"></i>Sync Dashboard
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="ldapGroupsTabContent">
                <!-- Group Mappings Sub-tab -->
                <div class="tab-pane fade show active" id="groupMappings" role="tabpanel">
                    <!-- Group Discovery Panel -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-search me-2"></i>Discover LDAP Groups</span>
                                <button class="btn btn-sm btn-outline-secondary" onclick="toggleGroupDiscovery()">
                                    <i class="bi bi-chevron-down" id="discoveryToggleIcon"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="groupDiscoveryPanel" style="display: none;">
                            <div class="row g-3 mb-3">
                                <div class="col-md-8">
                                    <label class="form-label fw-semibold">Search Base DN</label>
                                    <input type="text" class="form-control" id="groupSearchBaseInline"
                                           placeholder="e.g., OU=Groups,DC=company,DC=com"
                                           onkeypress="if(event.key==='Enter') performGroupDiscoveryInline()">
                                    <small class="text-muted">The base DN where your LDAP groups are located</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">&nbsp;</label>
                                    <button class="btn btn-primary w-100" onclick="performGroupDiscoveryInline()">
                                        <i class="bi bi-search me-1"></i>Search for Groups
                                    </button>
                                </div>
                            </div>
                            <div id="discoveredGroupsContainerInline">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-diagram-2" style="font-size: 2.5rem;"></i>
                                    <p class="mt-3">Enter a search base DN and click Search to discover LDAP groups</p>
                                    <p class="text-muted mb-0">Example: OU=Security Groups,DC=example,DC=com</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Group Mappings Table -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-link-45deg me-2"></i>LDAP Group Mappings</span>
                            <button class="btn btn-primary btn-sm" onclick="showCreateMappingModal()">
                                <i class="bi bi-plus-circle me-1"></i>Create Mapping
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>LDAP Group</th>
                                            <th>Organization</th>
                                            <th>Role</th>
                                            <th>Priority</th>
                                            <th>Auto-Provision</th>
                                            <th>Members</th>
                                            <th>Last Sync</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="groupMappingsTable">
                                        <tr>
                                            <td colspan="9" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status"></div>
                                                <p class="text-muted mt-2">Loading group mappings...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sync Dashboard Sub-tab -->
                <div class="tab-pane fade" id="syncDashboard" role="tabpanel">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
                                    <h5 class="mt-2" id="syncStatsTotal">-</h5>
                                    <p class="text-muted mb-0">Total LDAP Users</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-clock-history text-info" style="font-size: 2rem;"></i>
                                    <h5 class="mt-2" id="syncStatsLastSync">Never</h5>
                                    <p class="text-muted mb-0">Last Sync</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
                                    <h5 class="mt-2" id="syncStatsSuccess">-</h5>
                                    <p class="text-muted mb-0">Successful Syncs</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 2rem;"></i>
                                    <h5 class="mt-2" id="syncStatsErrors">-</h5>
                                    <p class="text-muted mb-0">Errors</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-arrow-repeat me-2"></i>Manual Synchronization</span>
                            <button class="btn btn-primary btn-sm" onclick="triggerManualSync()" id="syncButton">
                                <i class="bi bi-arrow-repeat me-1"></i>Sync Now
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="syncStatus" class="text-center text-muted py-4">
                                <i class="bi bi-info-circle" style="font-size: 3rem;"></i>
                                <p class="mt-3">Click "Sync Now" to synchronize all LDAP users with their group memberships</p>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <span><i class="bi bi-clock-history me-2"></i>Sync History</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Sync ID</th>
                                            <th>Type</th>
                                            <th>Started</th>
                                            <th>Duration</th>
                                            <th>Status</th>
                                            <th>Added</th>
                                            <th>Updated</th>
                                            <th>Deactivated</th>
                                            <th>Errors</th>
                                        </tr>
                                    </thead>
                                    <tbody id="syncHistoryTable">
                                        <tr>
                                            <td colspan="9" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status"></div>
                                                <p class="text-muted mt-2">Loading sync history...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <!-- Settings Sub-Tabs -->
            <ul class="nav nav-pills mb-4" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="ldap-settings-tab" data-bs-toggle="pill" data-bs-target="#ldapSettings" type="button">
                        <i class="bi bi-diagram-3 me-2"></i>LDAP / Active Directory
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="smtp-settings-tab" data-bs-toggle="pill" data-bs-target="#smtpSettings" type="button">
                        <i class="bi bi-envelope me-2"></i>Global SMTP
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sync-settings-tab" data-bs-toggle="pill" data-bs-target="#syncSettings" type="button">
                        <i class="bi bi-arrow-clockwise me-2"></i>Sync Schedule
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="general-settings-tab" data-bs-toggle="pill" data-bs-target="#generalSettings" type="button">
                        <i class="bi bi-sliders me-2"></i>General
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="settingsTabContent">
                <!-- LDAP Settings -->
                <div class="tab-pane fade show active" id="ldapSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-diagram-3 me-2"></i>LDAP / Active Directory Configuration
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>LDAP Authentication Setup:</strong> Configure connection to your Active Directory/LDAP server.
                                LDAP users cannot be created directly - they are discovered when they log in. You need a service account
                                with read permissions to search for users in your directory.
                            </div>

                            <form id="ldapSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="ldapEnabled">
                                            <label class="form-check-label fw-semibold" for="ldapEnabled">
                                                Enable LDAP Authentication
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-8">
                                        <label for="ldapServer" class="form-label fw-semibold">LDAP Server URL *</label>
                                        <input type="text" class="form-control" id="ldapServer" placeholder="ldap://dc3.bonelabs.com:389">
                                        <small class="form-text text-muted">Format: ldap://server:port or ldaps://server:636</small>
                                    </div>

                                    <div class="col-md-4">
                                        <label for="ldapPort" class="form-label fw-semibold">Port</label>
                                        <input type="number" class="form-control" id="ldapPort" value="389">
                                        <small class="form-text text-muted">389 (LDAP) or 636 (LDAPS)</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="ldapBaseDN" class="form-label fw-semibold">Base DN *</label>
                                        <input type="text" class="form-control" id="ldapBaseDN" placeholder="DC=bonelabs,DC=com">
                                        <small class="form-text text-muted">Base Distinguished Name for searches</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="ldapBindDN" class="form-label fw-semibold">Bind DN (Service Account) *</label>
                                        <input type="text" class="form-control" id="ldapBindDN" placeholder="CN=Service Account,OU=Users,DC=bonelabs,DC=com">
                                        <small class="form-text text-muted">Service account for LDAP binds</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="ldapBindPassword" class="form-label fw-semibold">Bind Password *</label>
                                        <input type="password" class="form-control" id="ldapBindPassword" placeholder="••••••••">
                                        <small class="form-text text-muted">Service account password. Leave blank to keep existing. Encrypted and not shown for security.</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="ldapSearchFilter" class="form-label fw-semibold">Search Filter</label>
                                        <input type="text" class="form-control" id="ldapSearchFilter" value="(sAMAccountName={username})">
                                        <small class="form-text text-muted">Use {username} as placeholder for login username</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="ldapUsernamAttr" class="form-label fw-semibold">Username Attribute</label>
                                        <input type="text" class="form-control" id="ldapUsernameAttr" value="sAMAccountName">
                                        <small class="form-text text-muted">AD: sAMAccountName, OpenLDAP: uid</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="ldapEmailAttr" class="form-label fw-semibold">Email Attribute</label>
                                        <input type="text" class="form-control" id="ldapEmailAttr" value="mail">
                                        <small class="form-text text-muted">Attribute containing email address</small>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="ldapUseTLS">
                                            <label class="form-check-label fw-semibold" for="ldapUseTLS">
                                                Use TLS/STARTTLS
                                            </label>
                                        </div>
                                    </div>

                                    <!-- LDAP Sync Scheduling -->
                                    <div class="col-md-12 mt-4">
                                        <hr>
                                        <h6 class="text-muted mb-3">
                                            <i class="bi bi-arrow-repeat me-2"></i>Automatic Synchronization
                                        </h6>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="alert alert-secondary">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Automatic Sync:</strong> Automatically synchronize LDAP users' roles and organizations based on their group memberships at regular intervals.
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="ldapSyncEnabled">
                                            <label class="form-check-label fw-semibold" for="ldapSyncEnabled">
                                                Enable Scheduled LDAP Synchronization
                                            </label>
                                        </div>
                                        <small class="text-muted">When enabled, LDAP users will be automatically synced with group mappings at the specified interval</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="ldapSyncInterval" class="form-label fw-semibold">Sync Interval (hours)</label>
                                        <select class="form-select" id="ldapSyncInterval">
                                            <option value="1">Every 1 hour</option>
                                            <option value="4">Every 4 hours</option>
                                            <option value="8">Every 8 hours</option>
                                            <option value="12">Every 12 hours</option>
                                            <option value="24" selected>Every 24 hours (daily)</option>
                                            <option value="48">Every 48 hours</option>
                                            <option value="168">Every 7 days (weekly)</option>
                                        </select>
                                        <small class="text-muted">How often to automatically sync LDAP users</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Last Scheduled Sync</label>
                                        <div class="form-control bg-light" id="ldapLastScheduledSync">
                                            Never
                                        </div>
                                        <small class="text-muted">Last time the scheduled sync ran</small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary me-2" onclick="saveLDAPSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save LDAP Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testLDAPConnection()">
                                            <i class="bi bi-plug me-1"></i>Test Connection
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Global SMTP Settings -->
                <div class="tab-pane fade" id="smtpSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-envelope me-2"></i>Global SMTP Configuration
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Default SMTP settings for all organizations. Organizations can override these with their own SMTP config.
                            </div>

                            <form id="smtpSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label for="globalSmtpHost" class="form-label fw-semibold">SMTP Server *</label>
                                        <input type="text" class="form-control" id="globalSmtpHost" placeholder="smtp.gmail.com">
                                    </div>

                                    <div class="col-md-4">
                                        <label for="globalSmtpPort" class="form-label fw-semibold">Port *</label>
                                        <input type="number" class="form-control" id="globalSmtpPort" value="587">
                                        <small class="form-text text-muted">587 (TLS) or 465 (SSL)</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="globalSmtpUsername" class="form-label fw-semibold">Username</label>
                                        <input type="text" class="form-control" id="globalSmtpUsername">
                                    </div>

                                    <div class="col-md-6">
                                        <label for="globalSmtpPassword" class="form-label fw-semibold">Password</label>
                                        <input type="password" class="form-control" id="globalSmtpPassword" placeholder="••••••••">
                                        <small class="form-text text-muted">Leave blank to keep existing password. Passwords are encrypted and not shown for security.</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="globalSmtpFromEmail" class="form-label fw-semibold">From Email *</label>
                                        <input type="email" class="form-control" id="globalSmtpFromEmail" placeholder="noreply@company.com">
                                    </div>

                                    <div class="col-md-6">
                                        <label for="globalSmtpFromName" class="form-label fw-semibold">From Name</label>
                                        <input type="text" class="form-control" id="globalSmtpFromName" value="SentriKat Alerts">
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="globalSmtpUseTLS" checked>
                                            <label class="form-check-label fw-semibold" for="globalSmtpUseTLS">
                                                Use TLS/STARTTLS
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary me-2" onclick="saveGlobalSMTPSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save SMTP Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testGlobalSMTP()">
                                            <i class="bi bi-envelope-check me-1"></i>Send Test Email
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Sync Schedule Settings -->
                <div class="tab-pane fade" id="syncSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-arrow-clockwise me-2"></i>CISA KEV Sync Schedule
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Global Sync Schedule:</strong> Configure automatic synchronization with the CISA Known Exploited Vulnerabilities catalog.
                                This applies to all organizations system-wide and keeps the vulnerability database up-to-date.
                            </div>

                            <form id="syncSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="autoSyncEnabled">
                                            <label class="form-check-label fw-semibold" for="autoSyncEnabled">
                                                Enable Automatic Sync
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="syncInterval" class="form-label fw-semibold">Sync Interval</label>
                                        <select class="form-select" id="syncInterval">
                                            <option value="hourly">Every Hour</option>
                                            <option value="4hours">Every 4 Hours</option>
                                            <option value="6hours">Every 6 Hours</option>
                                            <option value="12hours">Every 12 Hours</option>
                                            <option value="daily" selected>Daily</option>
                                            <option value="weekly">Weekly</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="syncTime" class="form-label fw-semibold">Preferred Time (UTC)</label>
                                        <input type="time" class="form-control" id="syncTime" value="02:00">
                                        <small class="form-text text-muted">Time to run daily/weekly syncs</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="nvdApiKey" class="form-label fw-semibold">NVD API Key</label>
                                        <input type="password" class="form-control" id="nvdApiKey" placeholder="Optional - for CVSS enrichment">
                                        <small class="form-text text-muted">Get from <a href="https://nvd.nist.gov/developers/request-an-api-key" target="_blank">NIST NVD</a></small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="cisaKevUrl" class="form-label fw-semibold">CISA KEV URL</label>
                                        <input type="text" class="form-control" id="cisaKevUrl" value="https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json">
                                        <small class="form-text text-muted">Usually leave as default</small>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="alert alert-secondary">
                                            <strong>Last Sync:</strong> <span id="lastSyncTime">Never</span><br>
                                            <strong>Next Scheduled:</strong> <span id="nextSyncTime">Not scheduled</span><br>
                                            <strong>Total Vulnerabilities:</strong> <span id="totalVulns">0</span>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveSyncSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Sync Settings
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- General Settings -->
                <div class="tab-pane fade" id="generalSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-sliders me-2"></i>General System Settings
                        </div>
                        <div class="card-body">
                            <form id="generalSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="verifySSL" checked>
                                            <label class="form-check-label fw-semibold" for="verifySSL">
                                                Verify SSL Certificates
                                            </label>
                                            <small class="form-text text-muted d-block">Disable if behind corporate proxy with SSL inspection</small>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="httpProxy" class="form-label fw-semibold">HTTP Proxy</label>
                                        <input type="text" class="form-control" id="httpProxy" placeholder="http://proxy.company.com:3128">
                                    </div>

                                    <div class="col-md-6">
                                        <label for="httpsProxy" class="form-label fw-semibold">HTTPS Proxy</label>
                                        <input type="text" class="form-control" id="httpsProxy" placeholder="http://proxy.company.com:3128">
                                    </div>

                                    <div class="col-md-12">
                                        <label for="noProxy" class="form-label fw-semibold">No Proxy (Bypass List)</label>
                                        <input type="text" class="form-control" id="noProxy" placeholder="localhost,127.0.0.1,.company.com">
                                        <small class="form-text text-muted">Comma-separated hostnames to bypass proxy</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="sessionTimeout" class="form-label fw-semibold">Session Timeout (minutes)</label>
                                        <input type="number" class="form-control" id="sessionTimeout" value="480">
                                        <small class="form-text text-muted">User session timeout (default: 480 = 8 hours)</small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveGeneralSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save General Settings
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">
                    <i class="bi bi-person-plus me-2"></i>Create User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">

                    <!-- Auth Type Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Authentication Type *</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="authType" id="authLocal" value="local" checked onchange="toggleAuthFields()">
                            <label class="btn btn-outline-primary" for="authLocal">
                                <i class="bi bi-key me-1"></i>Local Account
                            </label>
                            <input type="radio" class="btn-check" name="authType" id="authLdap" value="ldap" onchange="toggleAuthFields()">
                            <label class="btn btn-outline-primary" for="authLdap" id="authLdapLabel">
                                <i class="bi bi-diagram-3 me-1"></i>LDAP Account
                            </label>
                        </div>
                        <small class="form-text text-muted">Local: Password stored in database. LDAP: Authenticates against Active Directory</small>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="username" class="form-label fw-semibold">Username *</label>
                            <input type="text" class="form-control" id="username" required>
                            <small class="form-text text-muted" id="usernameHelp">For LDAP: Use AD sAMAccountName</small>
                        </div>

                        <div class="col-md-6">
                            <label for="email" class="form-label fw-semibold">Email *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>

                        <div class="col-md-12">
                            <label for="fullName" class="form-label fw-semibold">Full Name</label>
                            <input type="text" class="form-control" id="fullName">
                        </div>

                        <!-- Password fields (only for local auth) -->
                        <div class="col-md-6" id="passwordField">
                            <label for="password" class="form-label fw-semibold">Password *</label>
                            <input type="password" class="form-control" id="password">
                            <small class="form-text text-muted">Minimum 8 characters</small>
                        </div>

                        <div class="col-md-6" id="passwordConfirmField">
                            <label for="passwordConfirm" class="form-label fw-semibold">Confirm Password *</label>
                            <input type="password" class="form-control" id="passwordConfirm">
                        </div>

                        <div class="col-md-6">
                            <label for="organization" class="form-label fw-semibold">Organization *</label>
                            <select class="form-select" id="organization" required>
                                <option value="">Loading...</option>
                            </select>
                        </div>

                        <div class="col-md-12">
                            <label for="userRole" class="form-label fw-semibold">Role *</label>
                            <select class="form-select" id="userRole" onchange="updateRoleDescription()">
                                <option value="user">User - View-only access to vulnerabilities</option>
                                <option value="manager">Manager - Can manage products and view vulnerabilities</option>
                                <option value="org_admin">Organization Admin - Full access within their organization</option>
                                <option value="super_admin">Super Admin - Full system access across all organizations</option>
                            </select>
                            <div class="alert alert-sm mt-2" id="roleDescription"></div>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label fw-semibold">Additional Permissions</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="canManageProducts">
                                <label class="form-check-label" for="canManageProducts">
                                    Can manage products (add/edit/delete)
                                </label>
                            </div>
                            <div class="form-check" id="viewAllOrgsCheck">
                                <input type="checkbox" class="form-check-input" id="canViewAllOrgs">
                                <label class="form-check-label" for="canViewAllOrgs">
                                    Can view all organizations (super admin only)
                                </label>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="form-check form-switch">
                                <input type="checkbox" class="form-check-input" id="isActive" checked>
                                <label class="form-check-label fw-semibold" for="isActive">
                                    Active (user can log in)
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">
                    <i class="bi bi-check-circle me-1"></i>Save User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Organization Modal -->
<div class="modal fade" id="orgModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orgModalTitle">
                    <i class="bi bi-building me-2"></i>Create Organization
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="orgForm">
                    <input type="hidden" id="orgId">

                    <ul class="nav nav-tabs mb-3" id="orgFormTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basicInfo" type="button">
                                <i class="bi bi-info-circle me-1"></i>Basic Info
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="smtp-tab" data-bs-toggle="tab" data-bs-target="#smtpConfig" type="button">
                                <i class="bi bi-envelope me-1"></i>Email (SMTP)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alertSettings" type="button">
                                <i class="bi bi-bell me-1"></i>Alert Settings
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Basic Info Tab -->
                        <div class="tab-pane fade show active" id="basicInfo">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="orgName" class="form-label fw-semibold">Organization Name *</label>
                                    <input type="text" class="form-control" id="orgName" required>
                                    <small class="form-text text-muted">Unique identifier (lowercase, no spaces)</small>
                                </div>

                                <div class="col-md-6">
                                    <label for="orgDisplayName" class="form-label fw-semibold">Display Name *</label>
                                    <input type="text" class="form-control" id="orgDisplayName" required>
                                    <small class="form-text text-muted">Shown in UI</small>
                                </div>

                                <div class="col-md-12">
                                    <label for="orgDescription" class="form-label fw-semibold">Description</label>
                                    <textarea class="form-control" id="orgDescription" rows="2"></textarea>
                                </div>

                                <div class="col-md-12">
                                    <label for="orgEmails" class="form-label fw-semibold">Notification Emails</label>
                                    <input type="text" class="form-control" id="orgEmails" placeholder="email1@company.com, email2@company.com">
                                    <small class="form-text text-muted">Comma-separated email addresses for vulnerability alerts</small>
                                </div>

                                <div class="col-md-12">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="orgActive" checked>
                                        <label class="form-check-label fw-semibold" for="orgActive">
                                            Active
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SMTP Config Tab -->
                        <div class="tab-pane fade" id="smtpConfig">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure SMTP settings for this organization's email alerts. Leave empty to use global SMTP settings.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="smtpHost" class="form-label fw-semibold">SMTP Server</label>
                                    <input type="text" class="form-control" id="smtpHost" placeholder="smtp.gmail.com">
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpPort" class="form-label fw-semibold">Port</label>
                                    <input type="number" class="form-control" id="smtpPort" value="587" onchange="autoConfigureSmtpSecurity()">
                                    <small class="form-text text-muted">
                                        25 = Plain SMTP (no TLS/SSL) | 587 = TLS/STARTTLS | 465 = SSL
                                    </small>
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpUsername" class="form-label fw-semibold">Username</label>
                                    <input type="text" class="form-control" id="smtpUsername">
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpPassword" class="form-label fw-semibold">Password</label>
                                    <input type="password" class="form-control" id="smtpPassword" placeholder="••••••••">
                                    <small class="form-text text-muted">Leave blank to keep existing password</small>
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpFromEmail" class="form-label fw-semibold">From Email</label>
                                    <input type="email" class="form-control" id="smtpFromEmail" placeholder="noreply@company.com">
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpFromName" class="form-label fw-semibold">From Name</label>
                                    <input type="text" class="form-control" id="smtpFromName" value="SentriKat Alerts">
                                </div>

                                <div class="col-md-12">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="smtpUseTls" checked>
                                        <label class="form-check-label fw-semibold" for="smtpUseTls">
                                            Use TLS/STARTTLS
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-12">
                                    <button type="button" class="btn btn-outline-primary" onclick="testSMTP()">
                                        <i class="bi bi-envelope-check me-1"></i>Test SMTP Connection
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Alert Settings Tab -->
                        <div class="tab-pane fade" id="alertSettings">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure when this organization receives email alerts
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="alertCritical" checked>
                                        <label class="form-check-label" for="alertCritical">
                                            <strong>Alert on Critical CVEs</strong> (CVSS 9.0-10.0)
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="alertHigh">
                                        <label class="form-check-label" for="alertHigh">
                                            <strong>Alert on High CVEs</strong> (CVSS 7.0-8.9)
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="alertNewCVE" checked>
                                        <label class="form-check-label" for="alertNewCVE">
                                            <strong>Alert on New CVEs</strong> (when CISA adds new vulnerabilities)
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="alertRansomware" checked>
                                        <label class="form-check-label" for="alertRansomware">
                                            <strong>Alert on Ransomware</strong> (known to be used in ransomware)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveOrganization()">
                    <i class="bi bi-check-circle me-1"></i>Save Organization
                </button>
            </div>
        </div>
    </div>
</div>

<!-- LDAP Search Modal -->
<div class="modal fade" id="ldapSearchModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-search me-2"></i>Search LDAP Directory
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="ldapSearchQuery" placeholder="Search by username, email, or name (use * for wildcard)">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="searchLdapUsers()">
                            <i class="bi bi-search me-1"></i>Search
                        </button>
                    </div>
                </div>
                <div id="ldapSearchResultsTable">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search" style="font-size: 2rem;"></i>
                        <p class="mt-2">Enter a search query and click Search</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- LDAP Invite User Modal -->
<div class="modal fade" id="ldapInviteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus me-2"></i>Invite LDAP User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="ldapInviteForm">
                    <input type="hidden" id="ldapUserDN">

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        This user will be invited to SentriKat and will authenticate using LDAP credentials.
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="ldapInviteUsername" class="form-label fw-semibold">Username *</label>
                            <input type="text" class="form-control" id="ldapInviteUsername" readonly>
                        </div>

                        <div class="col-md-6">
                            <label for="ldapInviteEmail" class="form-label fw-semibold">Email *</label>
                            <input type="email" class="form-control" id="ldapInviteEmail" readonly>
                        </div>

                        <div class="col-md-12">
                            <label for="ldapInviteFullName" class="form-label fw-semibold">Full Name</label>
                            <input type="text" class="form-control" id="ldapInviteFullName" readonly>
                        </div>

                        <div class="col-md-6">
                            <label for="ldapInviteOrganization" class="form-label fw-semibold">Organization *</label>
                            <select class="form-select" id="ldapInviteOrganization" required>
                                <option value="">Select organization...</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="ldapInviteRole" class="form-label fw-semibold">Role *</label>
                            <select class="form-select" id="ldapInviteRole" required>
                                <option value="user">User - View-only access</option>
                                <option value="manager">Manager - Can manage products</option>
                                <option value="org_admin">Organization Admin - Full org access</option>
                                <option value="super_admin">Super Admin - Full system access</option>
                            </select>
                        </div>

                        <div class="col-md-12">
                            <div id="ldapInviteGroups" class="alert alert-secondary">
                                <strong>LDAP Groups:</strong> <span id="ldapGroupsList">Loading...</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="inviteLdapUser()">
                    <i class="bi bi-check-circle me-1"></i>Invite User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Group Mapping Modal -->
<div class="modal fade" id="groupMappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="groupMappingModalTitle">Create Group Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="groupMappingForm">
                    <input type="hidden" id="mappingId">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">LDAP Group DN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ldapGroupDn" required
                                   placeholder="CN=Admins,OU=Groups,DC=company,DC=com">
                            <small class="text-muted">Full Distinguished Name of the LDAP group</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Group Common Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ldapGroupCn" required
                                   placeholder="Admins">
                            <small class="text-muted">Display name for the group</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Organization</label>
                            <select class="form-select" id="mappingOrganization">
                                <option value="">All Organizations</option>
                            </select>
                            <small class="text-muted">Leave blank for system-wide mapping</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Assigned Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="mappingRole" required>
                                <option value="">Select Role...</option>
                                <option value="user">User - Basic access</option>
                                <option value="manager">Manager - Team management</option>
                                <option value="org_admin">Organization Admin - Full org access</option>
                                <option value="super_admin">Super Admin - Full system access</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Priority</label>
                            <input type="number" class="form-control" id="mappingPriority" value="0" min="0" max="100">
                            <small class="text-muted">Higher priority wins if user is in multiple groups</small>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="ldapGroupDescription" rows="2"
                                      placeholder="Optional description of this group mapping"></textarea>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoProvision" checked>
                                <label class="form-check-label" for="autoProvision">
                                    Auto-Provision Users
                                </label>
                            </div>
                            <small class="text-muted">Automatically create accounts when users login</small>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoDeprovision">
                                <label class="form-check-label" for="autoDeprovision">
                                    Auto-Deprovision Users
                                </label>
                            </div>
                            <small class="text-muted">Deactivate users when they leave the group</small>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="syncEnabled" checked>
                                <label class="form-check-label" for="syncEnabled">
                                    Sync Enabled
                                </label>
                            </div>
                            <small class="text-muted">Include in automatic synchronization</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveGroupMapping()">Save Mapping</button>
            </div>
        </div>
    </div>
</div>

<!-- LDAP Group Discovery Modal -->
<div class="modal fade" id="ldapDiscoveryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Discover LDAP Groups</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="groupSearchBase"
                               placeholder="Search base DN (e.g., OU=Groups,DC=company,DC=com)">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="performGroupDiscovery()">
                            <i class="bi bi-search me-1"></i>Search
                        </button>
                    </div>
                </div>
                <div id="discoveredGroupsContainer">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-diagram-2" style="font-size: 3rem;"></i>
                        <p class="mt-3">Enter a search base DN and click Search to discover LDAP groups</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin_panel.js') }}?v=20250121c"></script>
{% endblock %}
