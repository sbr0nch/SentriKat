{% extends "base.html" %}

{% block title %}Admin Panel - SentriKat{% endblock %}

{% block extra_css %}
<style>
    /* ================================================================
       ADMIN PANEL â€” Visual Clarity Improvements
       ================================================================ */

    /* --- Settings Group Cards: better spacing & visual separation --- */
    #settingsTabContent .tab-pane > .card {
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        box-shadow: var(--shadow-sm);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    /* Card headers: subtle gradient background for clear section identification */
    #settingsTabContent .card > .card-header,
    #integrationsTabContent .card > .card-header {
        background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
        border-bottom: 2px solid var(--primary-color);
        font-weight: 600;
        font-size: 0.95rem;
        padding: 0.75rem 1.25rem;
        color: var(--text-color);
        letter-spacing: 0.01em;
    }
    [data-theme="dark"] #settingsTabContent .card > .card-header,
    [data-theme="dark"] #integrationsTabContent .card > .card-header {
        background: linear-gradient(135deg, rgba(30, 64, 175, 0.08) 0%, rgba(59, 130, 246, 0.05) 100%);
        border-bottom-color: var(--primary-light);
    }

    /* Card body padding consistency */
    #settingsTabContent .card > .card-body {
        padding: 1.5rem;
    }

    /* --- Sub-section headers within cards: left accent bar --- */
    #settingsTabContent h6.text-muted.border-bottom,
    #integrationsTabContent h6.text-muted.border-bottom {
        border-bottom: 1px solid var(--border-color) !important;
        padding: 0.5rem 0 0.5rem 0.75rem;
        margin-bottom: 1rem;
        margin-top: 0.5rem;
        border-left: 3px solid var(--primary-color);
        background: var(--gray-50);
        border-radius: 0 0.25rem 0.25rem 0;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--gray-600) !important;
    }
    [data-theme="dark"] #settingsTabContent h6.text-muted.border-bottom,
    [data-theme="dark"] #integrationsTabContent h6.text-muted.border-bottom {
        background: rgba(59, 130, 246, 0.06);
        border-left-color: var(--primary-light);
    }

    /* --- Settings Pills (group tabs): cleaner active state --- */
    #settingsTabs.nav-pills .nav-link {
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-muted);
        border: 1px solid transparent;
        transition: all 0.15s ease;
    }
    #settingsTabs.nav-pills .nav-link:hover {
        background-color: var(--gray-100);
        color: var(--text-color);
    }
    #settingsTabs.nav-pills .nav-link.active {
        background-color: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color);
        box-shadow: 0 2px 4px rgba(30, 64, 175, 0.2);
    }
    [data-theme="dark"] #settingsTabs.nav-pills .nav-link.active {
        background-color: var(--primary-dark);
        border-color: var(--primary-light);
        box-shadow: 0 2px 4px rgba(75, 140, 212, 0.20);
    }

    /* --- Integrations Pills: same treatment --- */
    #integrationsTabs.nav-pills .nav-link {
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-muted);
        border: 1px solid transparent;
        transition: all 0.15s ease;
    }
    #integrationsTabs.nav-pills .nav-link:hover {
        background-color: var(--gray-100);
        color: var(--text-color);
    }
    #integrationsTabs.nav-pills .nav-link.active {
        background-color: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color);
        box-shadow: 0 2px 4px rgba(30, 64, 175, 0.2);
    }
    [data-theme="dark"] #integrationsTabs.nav-pills .nav-link.active {
        background-color: var(--primary-dark);
        border-color: var(--primary-light);
    }

    /* --- System Sub-Tabs: smaller, secondary style --- */
    #systemSubNav.nav-pills {
        background: var(--gray-50);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 0.35rem;
        display: inline-flex;
        gap: 0.25rem;
    }
    #systemSubNav.nav-pills .nav-link {
        border-radius: 0.375rem;
        padding: 0.35rem 0.75rem;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-muted);
        border: 1px solid transparent;
        transition: all 0.15s ease;
    }
    #systemSubNav.nav-pills .nav-link:hover {
        background-color: var(--gray-200);
        color: var(--text-color);
    }
    #systemSubNav.nav-pills .nav-link.active {
        background-color: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color);
        box-shadow: 0 1px 3px rgba(30, 64, 175, 0.2);
    }
    [data-theme="dark"] #systemSubNav.nav-pills {
        background: rgba(30, 64, 175, 0.06);
        border-color: var(--border-color);
    }
    [data-theme="dark"] #systemSubNav.nav-pills .nav-link:hover {
        background-color: rgba(75, 140, 212, 0.08);
    }
    [data-theme="dark"] #systemSubNav.nav-pills .nav-link.active {
        background-color: var(--primary-dark);
        border-color: var(--primary-light);
        box-shadow: 0 1px 3px rgba(75, 140, 212, 0.20);
    }

    /* --- Info alerts inside cards: softer look --- */
    #settingsTabContent .alert-info {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.06) 0%, rgba(59, 130, 246, 0.03) 100%);
        border: 1px solid rgba(59, 130, 246, 0.15);
        border-radius: 0.375rem;
        color: var(--text-color);
        font-size: 0.875rem;
    }
    #settingsTabContent .alert-info i,
    #settingsTabContent .alert-info strong {
        color: var(--primary-color);
    }
    [data-theme="dark"] #settingsTabContent .alert-info {
        background: linear-gradient(135deg, rgba(75, 140, 212, 0.08) 0%, rgba(75, 140, 212, 0.04) 100%);
        border-color: rgba(75, 140, 212, 0.15);
    }
    [data-theme="dark"] #settingsTabContent .alert-info i,
    [data-theme="dark"] #settingsTabContent .alert-info strong {
        color: var(--primary-light);
    }

    /* --- Separator between stacked cards in same group: cleaner --- */
    .settings-group-separator hr {
        border-top: 2px dashed var(--border-color) !important;
        opacity: 0.4 !important;
        margin: 0.5rem 0 !important;
    }

    /* --- Form labels: slightly more distinct --- */
    #settingsTabContent .form-label.fw-semibold {
        font-size: 0.8125rem;
        color: var(--text-color);
        margin-bottom: 0.35rem;
    }

    /* --- Form help text: smaller and dimmer --- */
    #settingsTabContent .form-text.text-muted {
        font-size: 0.75rem;
    }

    /* --- Save buttons in settings: consistent styling --- */
    #settingsTabContent .card-body > form > .row > .col-12:last-child .btn-primary,
    #settingsTabContent .card-body > form .btn-primary {
        min-width: 120px;
    }

    /* --- Log Viewer --- */
    .log-line {
        padding: 1px 12px;
        border-bottom: 1px solid rgba(128,128,128,0.08);
        white-space: pre-wrap;
        word-break: break-all;
    }
    .log-line:hover {
        background-color: rgba(59, 130, 246, 0.06);
    }
    .log-error {
        color: var(--critical-color);
        background-color: rgba(185, 28, 28, 0.04);
    }
    .log-warning {
        color: var(--warning-color);
        background-color: rgba(217, 119, 6, 0.04);
    }
    .log-debug {
        color: var(--gray-500);
    }
    [data-theme="dark"] .log-error {
        color: #d08080;
        background-color: rgba(208, 128, 128, 0.06);
    }
    [data-theme="dark"] .log-warning {
        color: #c0a060;
        background-color: rgba(192, 160, 96, 0.06);
    }
    [data-theme="dark"] .log-debug {
        color: #9ca3af;
    }
    [data-theme="dark"] .log-line:hover {
        background-color: rgba(59, 130, 246, 0.1);
    }
    .log-line mark {
        background-color: rgba(250, 204, 21, 0.2);
        color: inherit;
        padding: 0 2px;
        border-radius: 2px;
    }
    [data-theme="dark"] .log-line mark {
        background-color: rgba(250, 204, 21, 0.3);
    }

    /* --- Feature comparison collapse chevron rotation --- */
    [data-bs-target="#featureComparisonBody"] #featureComparisonChevron {
        transition: transform 0.2s ease;
    }
    [data-bs-target="#featureComparisonBody"][aria-expanded="true"] #featureComparisonChevron {
        transform: rotate(180deg);
    }

    /* --- Stronger form section separation within cards --- */
    #settingsTabContent .row.g-3 > .col-12.mt-4,
    #settingsTabContent .row.g-3 > .col-md-12.mt-4 {
        margin-top: 1.5rem !important;
    }

    /* --- Form switch toggles: slightly more prominent --- */
    #settingsTabContent .form-check-label.fw-semibold {
        font-size: 0.875rem;
    }

    /* --- Alert boxes inside cards: add left accent --- */
    #settingsTabContent .alert {
        border-left: 3px solid;
        border-radius: 0 0.375rem 0.375rem 0;
    }
    #settingsTabContent .alert-info {
        border-left-color: var(--primary-color) !important;
    }
    #settingsTabContent .alert-warning {
        border-left-color: var(--warning-color) !important;
    }
    #settingsTabContent .alert-secondary {
        border-left-color: var(--gray-400) !important;
    }

    /* --- Card bodies with forms: consistent inner padding --- */
    #settingsTabContent .card > .card-body > form {
        padding: 0.25rem 0;
    }

    /* --- Users/Orgs table cards --- */
    #users .card,
    #organizations .card,
    #ldapUsers .card,
    #ldapGroups .card {
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        box-shadow: var(--shadow-sm);
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">Administration</li>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Hidden tab triggers (for programmatic switching) -->
    <div id="adminTabs" class="d-none">
        <button id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button"></button>
        {% if license and license.is_professional() %}
        <button id="ldapUsers-tab" data-bs-toggle="tab" data-bs-target="#ldapUsers" type="button"></button>
        <button id="ldapGroups-tab" data-bs-toggle="tab" data-bs-target="#ldapGroups" type="button"></button>
        {% endif %}
        <button id="organizations-tab" data-bs-toggle="tab" data-bs-target="#organizations" type="button"></button>
        <button id="integrations-tab" data-bs-toggle="tab" data-bs-target="#integrations" type="button"></button>
        <button id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button"></button>
    </div>

    <div class="tab-content" id="adminTabsContent">
        <!-- Users Section -->
        <div class="tab-pane fade" id="users" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h4 fw-bold mb-1"><i class="bi bi-people-fill me-2"></i>All Users</h2>
                    <p class="text-muted mb-0 small">Manage user accounts and permissions</p>
                </div>
            </div>
            <div class="alert alert-light border mb-3 small">
                <i class="bi bi-info-circle me-1"></i>
                <strong>Local users</strong> can be created manually below. <strong>LDAP users</strong> are auto-created when they first log in (if Auto-Provision is enabled in LDAP Group Mappings).
            </div>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-people me-2"></i>User Management</span>
                    <button class="btn btn-primary" onclick="showCreateUserModal()">
                        <i class="bi bi-person-plus-fill me-1"></i>Create User
                    </button>
                </div>
                <!-- Bulk Actions Toolbar -->
                <div id="usersBulkActions" class="alert alert-info mx-3 mt-3 mb-0" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-check-square me-2"></i>
                            <strong><span id="usersSelectedCount">0</span> user(s) selected</strong>
                        </span>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" onclick="bulkActivateUsers()">
                                <i class="bi bi-check-circle me-1"></i>Activate
                            </button>
                            <button class="btn btn-outline-secondary" onclick="bulkDeactivateUsers()">
                                <i class="bi bi-pause-circle me-1"></i>Deactivate
                            </button>
                            <button class="btn btn-outline-danger" onclick="bulkDeleteUsers()">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearUserSelection()">
                                <i class="bi bi-x me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTableContainer" data-sortable="true" data-enhanced="true">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" class="form-check-input" id="selectAllUsers" onchange="toggleSelectAllUsers()">
                                    </th>
                                    <th data-column="username" data-column-label="Username" data-sort-key="username" data-sort-type="string">Username</th>
                                    <th data-column="fullname" data-column-label="Full Name" data-sort-key="fullname" data-sort-type="string">Full Name</th>
                                    <th data-column="email" data-column-label="Email" data-sort-key="email" data-sort-type="string">Email</th>
                                    <th data-column="organization" data-column-label="Organization" data-sort-key="organization" data-sort-type="string">Organization</th>
                                    <th data-column="authtype" data-column-label="Auth Type" data-sort-key="authtype" data-sort-type="string">Auth Type</th>
                                    <th data-column="role" data-column-label="Role" data-sort-key="role" data-sort-type="string">Role</th>
                                    <th data-column="status" data-column-label="Status" data-sort-key="status" data-sort-type="boolean">Status</th>
                                    <th data-column="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="text-muted mt-2">Loading users...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- LDAP Users Tab -->
        <div class="tab-pane fade" id="ldapUsers" role="tabpanel">
            <div class="mb-4">
                <h2 class="h4 fw-bold mb-1"><i class="bi bi-diagram-3 me-2"></i>LDAP Users</h2>
                <p class="text-muted mb-0 small">Discover and invite users from your LDAP/Active Directory</p>
            </div>
            <div class="card">
                <div class="card-header">
                    <span><i class="bi bi-search me-2"></i>User Discovery</span>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>LDAP User Management:</strong> Search your LDAP/Active Directory to discover users, then invite them to SentriKat.
                        Users will authenticate against your LDAP server when logging in.
                    </div>

                    <!-- Search Interface -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="ldapUserSearchQuery"
                                       placeholder="Search by username, email, or display name..."
                                       onkeypress="if(event.key==='Enter') searchLdapUsersInline()">
                                <button class="btn btn-primary" onclick="searchLdapUsersInline()">
                                    <i class="bi bi-search me-1"></i>Search
                                </button>
                            </div>
                            <small class="text-muted">
                                Examples: "john", "john.doe", "john*", "*admin*"
                            </small>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="ldapSearchPageSize" onchange="searchLdapUsersInline()">
                                <option value="10">10 per page</option>
                                <option value="25" selected>25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>

                    <!-- Search Stats -->
                    <div id="ldapSearchStats" class="mb-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Showing <strong id="ldapResultCount">0</strong> users
                            </span>
                            <div id="ldapPagination" class="btn-group btn-group-sm"></div>
                        </div>
                    </div>

                    <!-- Results Table -->
                    <div id="ldapSearchResultsTable">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-search" style="font-size: 3rem;"></i>
                            <p class="mt-3">Enter a search query above to discover LDAP users</p>
                            <p class="text-muted">You can search by username, email, or display name</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Organizations Section -->
        <div class="tab-pane fade" id="organizations" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h4 fw-bold mb-1"><i class="bi bi-building me-2"></i>Organizations</h2>
                    <p class="text-muted mb-0 small">Manage tenants, departments, and team structures</p>
                </div>
            </div>
            <div class="alert alert-light border mb-3 small">
                <i class="bi bi-info-circle me-1"></i>
                <strong>Organizations</strong> are logical groups (e.g., tenants, departments, teams) that contain users and products. Each organization can have its own SMTP settings for notifications. Users are assigned to one organization, while Super Admins can access all.
            </div>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-building me-2"></i>Organization Management</span>
                    {% if current_user and current_user.is_super_admin() %}
                    <button class="btn btn-primary" onclick="showCreateOrgModal()">
                        <i class="bi bi-building-add me-1"></i>Create Organization
                    </button>
                    {% endif %}
                </div>
                <!-- Bulk Actions Toolbar -->
                <div id="orgsBulkActions" class="alert alert-info mx-3 mt-3 mb-0" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-check-square me-2"></i>
                            <strong><span id="orgsSelectedCount">0</span> organization(s) selected</strong>
                        </span>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" onclick="bulkActivateOrgs()">
                                <i class="bi bi-check-circle me-1"></i>Activate
                            </button>
                            <button class="btn btn-outline-secondary" onclick="bulkDeactivateOrgs()">
                                <i class="bi bi-pause-circle me-1"></i>Deactivate
                            </button>
                            <button class="btn btn-outline-danger" onclick="bulkDeleteOrgs()">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearOrgSelection()">
                                <i class="bi bi-x me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="orgsTableContainer" data-sortable="true" data-enhanced="true">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" class="form-check-input" id="selectAllOrgs" onchange="toggleSelectAllOrgs()">
                                    </th>
                                    <th data-column="displayname" data-column-label="Organization" data-sort-key="displayname" data-sort-type="string">Organization</th>
                                    <th data-column="users" data-column-label="Users" data-sort-key="users" data-sort-type="number">Users</th>
                                    <th data-column="smtp" data-column-label="SMTP" data-sort-key="smtp" data-sort-type="boolean">SMTP Configured</th>
                                    <th data-column="status" data-column-label="Status" data-sort-key="status" data-sort-type="boolean">Status</th>
                                    <th data-column="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orgsTable">
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="text-muted mt-2">Loading organizations...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        {% if license and license.is_professional() %}
        <!-- LDAP Groups Section (Professional License Only) -->
        <div class="tab-pane fade" id="ldapGroups" role="tabpanel">
            <div class="mb-4">
                <h2 class="h4 fw-bold mb-1"><i class="bi bi-diagram-2 me-2"></i>LDAP Groups</h2>
                <p class="text-muted mb-0 small">Map LDAP/AD groups to SentriKat roles and organizations</p>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info mb-3">
                        <h6 class="alert-heading mb-2"><i class="bi bi-info-circle me-2"></i>How LDAP Group Mapping Works</h6>
                        <p class="mb-2">Map LDAP/Active Directory groups to SentriKat roles. When users log in via LDAP, they are automatically assigned roles based on their group memberships.</p>
                        <hr class="my-2">
                        <div class="row small">
                            <div class="col-md-4">
                                <strong><i class="bi bi-person-plus me-1"></i>Auto-Provision:</strong><br>
                                Creates user accounts when they <u>first log in</u> via LDAP (if enabled for the mapping).
                            </div>
                            <div class="col-md-4">
                                <strong><i class="bi bi-arrow-repeat me-1"></i>Sync Now:</strong><br>
                                Updates roles/organizations for <u>existing</u> LDAP users based on current group memberships.
                            </div>
                            <div class="col-md-4">
                                <strong><i class="bi bi-people me-1"></i>Members Count:</strong><br>
                                Shows how many users are in the LDAP group (from directory, not SentriKat).
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tabs for LDAP Groups -->
            <ul class="nav nav-pills mb-4" id="ldapGroupsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="group-mappings-tab" data-bs-toggle="pill" data-bs-target="#groupMappings" type="button">
                        <i class="bi bi-link-45deg me-2"></i>Group Mappings
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sync-dashboard-tab" data-bs-toggle="pill" data-bs-target="#syncDashboard" type="button">
                        <i class="bi bi-arrow-repeat me-2"></i>Sync Dashboard
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="ldapGroupsTabContent">
                <!-- Group Mappings Sub-tab -->
                <div class="tab-pane fade show active" id="groupMappings" role="tabpanel">
                    <!-- Group Discovery Panel -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-search me-2"></i>Discover LDAP Groups</span>
                                <button class="btn btn-sm btn-outline-secondary" onclick="toggleGroupDiscovery()">
                                    <i class="bi bi-chevron-up" id="discoveryToggleIcon"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="groupDiscoveryPanel">
                            <div class="row g-3 mb-3">
                                <div class="col-md-8">
                                    <label class="form-label fw-semibold">Search Base DN</label>
                                    <input type="text" class="form-control" id="groupSearchBaseInline"
                                           placeholder="e.g., OU=Groups,DC=company,DC=com"
                                           onkeypress="if(event.key==='Enter') performGroupDiscoveryInline()">
                                    <small class="text-muted">The base DN where your LDAP groups are located</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">&nbsp;</label>
                                    <button class="btn btn-primary w-100" onclick="performGroupDiscoveryInline()">
                                        <i class="bi bi-search me-1"></i>Search for Groups
                                    </button>
                                </div>
                            </div>
                            <div id="discoveredGroupsContainerInline">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-diagram-2" style="font-size: 2.5rem;"></i>
                                    <p class="mt-3">Enter a search base DN and click Search to discover LDAP groups</p>
                                    <p class="text-muted mb-0">Example: OU=Security Groups,DC=example,DC=com</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Group Mappings Table -->
                    <div class="card">
                        <div class="card-header">
                            <span><i class="bi bi-link-45deg me-2"></i>LDAP Group Mappings</span>
                        </div>
                        <!-- Bulk Actions Toolbar -->
                        <div id="mappingsBulkActions" class="alert alert-info mx-3 mt-3 mb-0" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="bi bi-check-square me-2"></i>
                                    <strong><span id="mappingsSelectedCount">0</span> mapping(s) selected</strong>
                                </span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success" onclick="bulkActivateMappings()">
                                        <i class="bi bi-check-circle me-1"></i>Activate
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="bulkDeactivateMappings()">
                                        <i class="bi bi-pause-circle me-1"></i>Deactivate
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="bulkDeleteMappings()">
                                        <i class="bi bi-trash me-1"></i>Delete
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="clearMappingSelection()">
                                        <i class="bi bi-x me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="groupMappingsTableContainer" data-sortable="true" data-enhanced="true">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" class="form-check-input" id="selectAllMappings" onchange="toggleSelectAllMappings()">
                                            </th>
                                            <th data-column="group" data-column-label="LDAP Group" data-sort-key="group" data-sort-type="string">LDAP Group</th>
                                            <th data-column="organization" data-column-label="Organization" data-sort-key="organization" data-sort-type="string">Organization</th>
                                            <th data-column="role" data-column-label="Role" data-sort-key="role" data-sort-type="string">Role</th>
                                            <th data-column="priority" data-column-label="Priority" data-sort-key="priority" data-sort-type="number">Priority</th>
                                            <th data-column="autoprovision" data-column-label="Auto-Provision" data-sort-key="autoprovision" data-sort-type="boolean">Auto-Provision</th>
                                            <th data-column="members" data-column-label="Members" data-sort-key="members" data-sort-type="number">Members</th>
                                            <th data-column="lastsync" data-column-label="Last Sync" data-sort-key="lastsync" data-sort-type="date">Last Sync</th>
                                            <th data-column="status" data-column-label="Status" data-sort-key="status" data-sort-type="boolean">Status</th>
                                            <th data-column="actions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="groupMappingsTable">
                                        <!-- Content loaded by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sync Dashboard Sub-tab -->
                <div class="tab-pane fade" id="syncDashboard" role="tabpanel">
                    <div class="alert alert-secondary mb-3">
                        <h6 class="alert-heading mb-2"><i class="bi bi-arrow-repeat me-2"></i>Sync Dashboard</h6>
                        <p class="mb-0 small">
                            <strong>Sync Now</strong> re-evaluates all existing LDAP users' group memberships and updates their roles/organizations accordingly.
                            This does <u>not</u> create new users - use Auto-Provision for that (users are created when they first log in).
                            Run a sync after changing group mappings to apply changes to existing users immediately.
                        </p>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
                                    <h5 class="mt-2" id="syncStatsTotal">-</h5>
                                    <p class="text-muted mb-0">Total LDAP Users</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-clock-history text-info" style="font-size: 2rem;"></i>
                                    <h5 class="mt-2" id="syncStatsLastSync">Never</h5>
                                    <p class="text-muted mb-0">Last Sync</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
                                    <h5 class="mt-2" id="syncStatsSuccess">-</h5>
                                    <p class="text-muted mb-0">Successful Syncs</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 2rem;"></i>
                                    <h5 class="mt-2" id="syncStatsErrors">-</h5>
                                    <p class="text-muted mb-0">Errors</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-arrow-repeat me-2"></i>Manual Synchronization</span>
                            <button class="btn btn-primary btn-sm" onclick="triggerManualSync()" id="syncButton">
                                <i class="bi bi-arrow-repeat me-1"></i>Sync Now
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="syncStatus" class="text-center text-muted py-4">
                                <i class="bi bi-info-circle" style="font-size: 3rem;"></i>
                                <p class="mt-3">Click "Sync Now" to synchronize all LDAP users with their group memberships</p>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <span><i class="bi bi-clock-history me-2"></i>Sync History</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm" id="syncHistoryTableContainer" data-sortable="true" data-enhanced="true">
                                    <thead>
                                        <tr>
                                            <th data-column="syncid" data-column-label="Sync ID" data-sort-key="id" data-sort-type="number">Sync ID</th>
                                            <th data-column="type" data-column-label="Type" data-sort-key="type" data-sort-type="string">Type</th>
                                            <th data-column="started" data-column-label="Started" data-sort-key="started" data-sort-type="date">Started</th>
                                            <th data-column="duration" data-column-label="Duration" data-sort-key="duration" data-sort-type="number">Duration</th>
                                            <th data-column="status" data-column-label="Status" data-sort-key="status" data-sort-type="string">Status</th>
                                            <th data-column="added" data-column-label="Added" data-sort-key="added" data-sort-type="number">Added</th>
                                            <th data-column="updated" data-column-label="Updated" data-sort-key="updated" data-sort-type="number">Updated</th>
                                            <th data-column="deactivated" data-column-label="Deactivated" data-sort-key="deactivated" data-sort-type="number">Deactivated</th>
                                            <th data-column="errors" data-column-label="Errors" data-sort-key="errors" data-sort-type="number">Errors</th>
                                        </tr>
                                    </thead>
                                    <tbody id="syncHistoryTable">
                                        <tr>
                                            <td colspan="9" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status"></div>
                                                <p class="text-muted mt-2">Loading sync history...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if license and license.is_professional() %}
        <!-- Integrations Section -->
        <div class="tab-pane fade" id="integrations" role="tabpanel">
            <div class="mb-4">
                <h2 class="h4 fw-bold mb-1"><i class="bi bi-plug-fill me-2"></i>Integrations</h2>
                <p class="text-muted mb-0 small">Agent management, API keys, and data imports</p>
            </div>
            <!-- Integrations Sub-Tabs (Simplified) -->
            <ul class="nav nav-pills mb-4" id="integrationsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="push-agents-tab" data-bs-toggle="pill" data-bs-target="#pushAgents" type="button">
                        <i class="bi bi-key-fill me-2"></i>Agent Keys
                    </button>
                </li>
                <!-- Import Queue moved to Inventory page (/admin#import-queue) -->
                {% if license and license.is_professional() %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="jira-integration-tab" data-bs-toggle="pill" data-bs-target="#jiraIntegration" type="button">
                        <i class="bi bi-kanban me-2"></i>Issue Trackers
                    </button>
                </li>
                {% endif %}
            </ul>

            <div class="tab-content" id="integrationsTabContent">
                <!-- Overview section removed - simplified layout -->
                <div class="d-none" id="integrationsOverview">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h5 class="card-title mb-3"><i class="bi bi-diagram-3 me-2 text-muted"></i>How Push Agents Work</h5>
                                    <div class="row align-items-center justify-content-center">
                                        <!-- Push Agents -->
                                        <div class="col-md-4 text-center mb-3 mb-md-0">
                                            <div class="p-3 bg-white rounded border">
                                                <i class="bi bi-cloud-upload text-muted" style="font-size: 2rem;"></i>
                                                <h6 class="mt-2 mb-1">Push Agents</h6>
                                                <small class="text-muted">Windows/Linux endpoints</small>
                                            </div>
                                        </div>
                                        <!-- Arrow -->
                                        <div class="col-md-1 text-center d-none d-md-block">
                                            <i class="bi bi-arrow-right text-secondary" style="font-size: 1.5rem;"></i>
                                        </div>
                                        <!-- SentriKat -->
                                        <div class="col-md-4 text-center mb-3 mb-md-0">
                                            <div class="p-3 bg-white rounded border border-2">
                                                <i class="bi bi-shield-check text-dark" style="font-size: 2rem;"></i>
                                                <h6 class="mt-2 mb-1 fw-bold">SentriKat</h6>
                                                <small class="text-muted">Import Queue &rarr; Products</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="row mb-4" id="integrationStatsRow">
                        <div class="col-md-4">
                            <div class="card h-100 stat-card" style="cursor: pointer;" onclick="document.getElementById('push-agents-tab').click()">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted mb-1">Push Agents</h6>
                                            <h3 class="mb-0"><span id="statEndpointsOnline">-</span><small class="text-muted fs-6">/<span id="statEndpointsTotal">-</span></small></h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-pc-display text-secondary" style="font-size: 2rem; opacity: 0.4;"></i>
                                        </div>
                                    </div>
                                    <small class="text-muted">Online / Total endpoints</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100 stat-card" style="cursor: pointer;" onclick="window.location.href='/admin#import-queue'">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted mb-1">Import Queue</h6>
                                            <h3 class="mb-0" id="statPendingImports">-</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-inbox text-secondary" style="font-size: 2rem; opacity: 0.4;"></i>
                                        </div>
                                    </div>
                                    <small class="text-muted">Pending review</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted mb-1">Recent Activity</h6>
                                            <h3 class="mb-0" id="statRecentCheckins">-</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-activity text-secondary" style="font-size: 2rem; opacity: 0.4;"></i>
                                        </div>
                                    </div>
                                    <small class="text-muted">Check-ins last 24h</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <i class="bi bi-cloud-upload me-2 text-muted"></i><strong>Push Agents</strong>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-3">Deploy lightweight agents on servers and workstations. Agents report installed software directly to SentriKat.</p>
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <span class="badge bg-light text-dark border"><i class="bi bi-windows me-1"></i>Windows</span>
                                        <span class="badge bg-light text-dark border"><i class="bi bi-ubuntu me-1"></i>Linux</span>
                                        <span class="badge bg-light text-dark border"><i class="bi bi-terminal me-1"></i>PowerShell/Bash</span>
                                    </div>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('push-agents-tab').click()">
                                        <i class="bi bi-download me-1"></i>Deploy Agents
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Import Queue moved to Inventory page (/admin#import-queue) -->

                <!-- Push Agents Sub-Tab (Unified: API Keys + Scripts + Assets) -->
                <div class="tab-pane fade show active" id="pushAgents" role="tabpanel">

                    <!-- API Keys & Agent Downloads -->
                    <div class="card mb-4">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-key-fill me-2"></i>API Keys</span>
                            <button class="btn btn-primary btn-sm" onclick="showCreateAgentKeyModal()">
                                <i class="bi bi-plus-lg me-1"></i>Create API Key
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="agentKeysTable" data-sortable="true">
                                    <thead class="table-light">
                                        <tr>
                                            <th data-column="name" data-sort-key="name" data-sort-type="string">Name / Key Prefix</th>
                                            <th data-column="organization" data-sort-key="organization" data-sort-type="string">Organization</th>
                                            <th data-column="type" data-sort-key="type" data-sort-type="string">Type</th>
                                            <th data-column="mode" data-sort-key="mode" data-sort-type="string">Mode</th>
                                            <th data-column="capabilities">Scan</th>
                                            <th data-column="lastused" data-sort-key="lastused" data-sort-type="date">Last Used</th>
                                            <th data-column="usage" data-sort-key="usage" data-sort-type="number">Usage</th>
                                            <th data-column="expires" data-sort-key="expires" data-sort-type="date">Expires</th>
                                            <th style="width: 150px;">Download / Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="agentKeysTableBody">
                                        <tr>
                                            <td colspan="9" class="text-center py-4">
                                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                                <span class="ms-2">Loading agent keys...</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light small">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>How it works:</strong> Create an API key, then use the
                            <i class="bi bi-windows text-primary"></i> / <i class="bi bi-ubuntu text-success"></i>
                            buttons to download agents. The server URL and API key are automatically embedded in the script.
                        </div>
                    </div>

                    <!-- Connected Endpoints moved to Inventory > Endpoints tab -->
                    <div class="alert alert-light border mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Connected endpoints are now managed under <a href="/admin#endpoints" class="alert-link">Inventory &gt; Endpoints</a>.
                    </div>
                </div>

                {% if license and license.is_professional() %}
                <!-- Issue Trackers Sub-Tab -->
                <div class="tab-pane fade" id="jiraIntegration" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-kanban me-2"></i>Issue Tracker Integration
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Issue Tracker Integration:</strong> Create issues directly from vulnerabilities.
                                Supports Jira, YouTrack, GitHub Issues, GitLab Issues, and custom webhooks.
                            </div>

                            <!-- Tracker Type Selector (multi-select via checkboxes) -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Enabled Issue Trackers</label>
                                <div class="d-flex flex-wrap gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input tracker-type-check" type="checkbox" value="jira" id="trackerCheck-jira" onchange="toggleTrackerConfig()">
                                        <label class="form-check-label" for="trackerCheck-jira"><i class="bi bi-kanban me-1"></i>Jira</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input tracker-type-check" type="checkbox" value="youtrack" id="trackerCheck-youtrack" onchange="toggleTrackerConfig()">
                                        <label class="form-check-label" for="trackerCheck-youtrack"><i class="bi bi-bug me-1"></i>YouTrack</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input tracker-type-check" type="checkbox" value="github" id="trackerCheck-github" onchange="toggleTrackerConfig()">
                                        <label class="form-check-label" for="trackerCheck-github"><i class="bi bi-github me-1"></i>GitHub Issues</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input tracker-type-check" type="checkbox" value="gitlab" id="trackerCheck-gitlab" onchange="toggleTrackerConfig()">
                                        <label class="form-check-label" for="trackerCheck-gitlab"><i class="bi bi-gitlab me-1"></i>GitLab Issues</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input tracker-type-check" type="checkbox" value="webhook" id="trackerCheck-webhook" onchange="toggleTrackerConfig()">
                                        <label class="form-check-label" for="trackerCheck-webhook"><i class="bi bi-globe me-1"></i>Custom Webhook</label>
                                    </div>
                                </div>
                                <small class="form-text text-muted">Enable one or more trackers. A "Create Issue" button will appear for each on the dashboard.</small>
                                <!-- Hidden select kept for backward compat with existing JS -->
                                <select class="form-select d-none" id="issueTrackerType"></select>
                            </div>

                            <!-- Jira Configuration -->
                            <div id="trackerConfig-jira" class="tracker-config" style="display: none;">
                                <h6 class="text-muted mb-3"><i class="bi bi-kanban me-2"></i>Jira Configuration</h6>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-semibold">Jira URL</label>
                                        <input type="url" class="form-control" id="jiraUrl" placeholder="https://yourcompany.atlassian.net">
                                        <small class="form-text text-muted">Cloud or Server URL</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold" id="jiraEmailLabel">Email (Cloud) or Username (Server)</label>
                                        <input type="text" class="form-control" id="jiraEmail" placeholder="user@example.com">
                                        <small class="form-text text-muted" id="jiraEmailHelp">For Jira Cloud use your email; for Jira Server use your username</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold" id="jiraTokenLabel">API Token (Cloud) or Password (Server)</label>
                                        <input type="password" class="form-control" id="jiraApiToken" placeholder="API token or password">
                                        <small class="form-text text-muted" id="jiraTokenHelp">
                                            <span id="jiraTokenHelpCloud"><a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank">Generate API token</a> (Cloud)</span>
                                            <span id="jiraTokenHelpServer" style="display: none;">Use your Jira account password (Server)</span>
                                        </small>
                                    </div>
                                    <div class="col-md-12" id="jiraPatRow" style="display: none;">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="jiraUsePat">
                                            <label class="form-check-label" for="jiraUsePat">
                                                <strong>Use Personal Access Token (PAT)</strong>
                                                <small class="text-muted d-block">Enable for Jira Server 8.14+ when using a Personal Access Token instead of password. Required if your account has CAPTCHA protection.</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Project Key</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="jiraProjectKey" placeholder="SEC">
                                            <button class="btn btn-outline-secondary" type="button" onclick="fetchJiraIssueTypes()" title="Fetch issue types for this project">
                                                <i class="bi bi-arrow-clockwise"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Issue Type</label>
                                        <select class="form-select" id="jiraIssueType">
                                            <option value="">-- Enter project key and click refresh --</option>
                                        </select>
                                        <small class="form-text text-muted" id="jiraIssueTypeHelp">Click the refresh button after entering credentials and project key</small>
                                    </div>
                                </div>

                                <!-- Custom Fields Section -->
                                <div class="mt-3 border-top pt-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label fw-semibold mb-0">
                                            <i class="bi bi-list-columns me-1"></i>Custom Fields
                                        </label>
                                        <button class="btn btn-sm btn-outline-primary" type="button" onclick="fetchJiraCustomFields()" id="fetchFieldsBtn">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Fetch Required Fields
                                        </button>
                                    </div>
                                    <small class="form-text text-muted d-block mb-2">
                                        Configure required custom fields for your Jira project. Click "Fetch Required Fields" after selecting project and issue type.
                                    </small>
                                    <div id="jiraCustomFieldsContainer">
                                        <div class="alert alert-info py-2 mb-0">
                                            <i class="bi bi-info-circle me-1"></i>
                                            No custom fields loaded. Click "Fetch Required Fields" to load available fields from Jira.
                                        </div>
                                    </div>
                                    <!-- Hidden input to store custom fields JSON -->
                                    <input type="hidden" id="jiraCustomFields" value="">
                                </div>
                            </div>

                            <!-- YouTrack Configuration -->
                            <div id="trackerConfig-youtrack" class="tracker-config" style="display: none;">
                                <h6 class="text-muted mb-3"><i class="bi bi-journal-code me-2"></i>YouTrack Configuration </h6>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-semibold">YouTrack URL</label>
                                        <input type="url" class="form-control" id="youtrackUrl" placeholder="https://yourcompany.youtrack.cloud">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Permanent Token</label>
                                        <input type="password" class="form-control" id="youtrackToken" placeholder="perm:xxx">
                                        <small class="form-text text-muted">Profile > Account Security > Tokens</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Project ID</label>
                                        <input type="text" class="form-control" id="youtrackProjectId" placeholder="0-0">
                                        <small class="form-text text-muted">Found in project settings URL</small>
                                    </div>
                                </div>
                            </div>

                            <!-- GitHub Configuration -->
                            <div id="trackerConfig-github" class="tracker-config" style="display: none;">
                                <h6 class="text-muted mb-3"><i class="bi bi-github me-2"></i>GitHub Issues Configuration </h6>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-semibold">Personal Access Token</label>
                                        <input type="password" class="form-control" id="githubToken" placeholder="ghp_xxx">
                                        <small class="form-text text-muted">
                                            <a href="https://github.com/settings/tokens" target="_blank">Generate token</a> with 'repo' scope
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Repository Owner</label>
                                        <input type="text" class="form-control" id="githubOwner" placeholder="username or org">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Repository Name</label>
                                        <input type="text" class="form-control" id="githubRepo" placeholder="repo-name">
                                    </div>
                                </div>
                            </div>

                            <!-- GitLab Configuration -->
                            <div id="trackerConfig-gitlab" class="tracker-config" style="display: none;">
                                <h6 class="text-muted mb-3"><i class="bi bi-gitlab me-2"></i>GitLab Issues Configuration </h6>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-semibold">GitLab URL</label>
                                        <input type="url" class="form-control" id="gitlabUrl" value="https://gitlab.com" placeholder="https://gitlab.com">
                                        <small class="form-text text-muted">Use gitlab.com or your self-hosted instance</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Personal Access Token</label>
                                        <input type="password" class="form-control" id="gitlabToken" placeholder="glpat-xxx">
                                        <small class="form-text text-muted">Settings > Access Tokens with 'api' scope</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Project ID</label>
                                        <input type="text" class="form-control" id="gitlabProjectId" placeholder="12345">
                                        <small class="form-text text-muted">Found in project settings or URL encoded path</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Webhook Configuration -->
                            <div id="trackerConfig-webhook" class="tracker-config" style="display: none;">
                                <h6 class="text-muted mb-3"><i class="bi bi-broadcast me-2"></i>Custom Webhook Configuration </h6>
                                <div class="alert alert-warning mb-3">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    <strong>Tip:</strong> Use webhooks to integrate with Linear, Asana, Monday.com, or any system that accepts HTTP requests.
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-semibold">Webhook URL</label>
                                        <input type="url" class="form-control" id="webhookUrl" placeholder="https://api.example.com/issues">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">HTTP Method</label>
                                        <select class="form-select" id="webhookMethod">
                                            <option value="POST">POST</option>
                                            <option value="PUT">PUT</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Authentication</label>
                                        <select class="form-select" id="webhookAuthType">
                                            <option value="none">None</option>
                                            <option value="bearer">Bearer Token</option>
                                            <option value="basic">Basic Auth (user:pass)</option>
                                            <option value="header">Custom Header (Name:Value)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Auth Value</label>
                                        <input type="password" class="form-control" id="webhookAuthValue" placeholder="Token or credentials">
                                    </div>
                                    <div class="col-12">
                                        <small class="form-text text-muted">
                                            Payload includes: title, description, priority, labels, vulnerability details, and product info.
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="mt-4">
                                <hr>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveIssueTrackerSettings()">
                                        <i class="bi bi-check-lg me-1"></i>Save Settings
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="testIssueTrackerConnection()">
                                        <i class="bi bi-plug me-1"></i>Test Connection
                                    </button>
                                </div>
                            </div>

                            <!-- Test Result -->
                            <div class="mt-3" id="trackerTestResult" style="display: none;">
                                <div class="alert" id="trackerTestAlert">
                                    <span id="trackerTestMessage"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h4 fw-bold mb-1"><i class="bi bi-gear-fill me-2"></i>System Settings</h2>
                    <p class="text-muted mb-0 small">LDAP configuration, SMTP settings, and system options</p>
                </div>
            </div>
            <!-- Settings Sub-Tabs (Consolidated into 6 groups) -->
            <ul class="nav nav-pills mb-4" id="settingsTabs" role="tablist">
                {% if current_user and current_user.is_super_admin() %}
                {% if license and license.is_professional() %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="auth-settings-tab" type="button" onclick="showSettingsGroup('auth', this)">
                        <i class="bi bi-shield-lock me-2"></i>Authentication
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="email-settings-tab" type="button" onclick="showSettingsGroup('email', this)">
                        <i class="bi bi-envelope me-2"></i>Email & Alerts
                    </button>
                </li>
                {% else %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="email-settings-tab" type="button" onclick="showSettingsGroup('email', this)">
                        <i class="bi bi-envelope me-2"></i>Email & Alerts
                    </button>
                </li>
                {% endif %}
                {% else %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="email-settings-tab" type="button" onclick="showSettingsGroup('email', this)">
                        <i class="bi bi-envelope me-2"></i>Email & Alerts
                    </button>
                </li>
                {% endif %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="system-settings-tab" type="button" onclick="showSettingsGroup('system', this)">
                        <i class="bi bi-gear me-2"></i>System
                    </button>
                </li>
                {% if license and license.is_professional() %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="syslog-settings-tab" type="button" onclick="showSettingsGroup('syslog', this)">
                        <i class="bi bi-broadcast me-2"></i>SIEM / Syslog
                    </button>
                </li>
                {% endif %}
                {% if current_user and current_user.is_super_admin() %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="compliance-settings-tab" type="button" onclick="showSettingsGroup('compliance', this)">
                        <i class="bi bi-clipboard-check me-2"></i>Compliance
                    </button>
                </li>
                {% if license and license.is_professional() %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="appearance-settings-tab" type="button" onclick="showSettingsGroup('appearance', this)">
                        <i class="bi bi-palette me-2"></i>Appearance
                    </button>
                </li>
                {% endif %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="license-tab" type="button" onclick="showSettingsGroup('license', this)">
                        <i class="bi bi-key me-2"></i>License
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="health-settings-tab" type="button" onclick="showSettingsGroup('health', this)">
                        <i class="bi bi-heart-pulse me-2"></i>Health Checks
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="logs-settings-tab" type="button" onclick="showSettingsGroup('logs', this)">
                        <i class="bi bi-journal-text me-2"></i>Logs
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="guide-settings-tab" type="button" onclick="showSettingsGroup('guide', this)">
                        <i class="bi bi-book me-2"></i>Admin Guide
                    </button>
                </li>
                {% endif %}
            </ul>

            <div class="tab-content" id="settingsTabContent">
                {% if current_user and current_user.is_super_admin() and license and license.is_professional() %}
                <!-- LDAP Settings (Super Admin + Professional License Only) -->
                <div class="tab-pane fade show active" id="ldapSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-diagram-3 me-2"></i>LDAP / Active Directory Configuration
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>LDAP Authentication Setup:</strong> Configure connection to your Active Directory/LDAP server.
                                LDAP users cannot be created directly - they are discovered when they log in. You need a service account
                                with read permissions to search for users in your directory.
                            </div>

                            <form id="ldapSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="ldapEnabled">
                                            <label class="form-check-label fw-semibold" for="ldapEnabled">
                                                Enable LDAP Authentication
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-8">
                                        <label for="ldapServer" class="form-label fw-semibold">LDAP Server URL *</label>
                                        <input type="text" class="form-control" id="ldapServer" placeholder="ldap://dc.example.com:389">
                                        <small class="form-text text-muted">Format: ldap://server:port or ldaps://server:636</small>
                                    </div>

                                    <div class="col-md-4">
                                        <label for="ldapPort" class="form-label fw-semibold">Port</label>
                                        <input type="number" class="form-control" id="ldapPort" value="389">
                                        <small class="form-text text-muted">389 (LDAP) or 636 (LDAPS)</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="ldapBaseDN" class="form-label fw-semibold">Base DN *</label>
                                        <input type="text" class="form-control" id="ldapBaseDN" placeholder="DC=example,DC=com">
                                        <small class="form-text text-muted">Base Distinguished Name for searches</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="ldapBindDN" class="form-label fw-semibold">Bind DN (Service Account) *</label>
                                        <input type="text" class="form-control" id="ldapBindDN" placeholder="CN=Service Account,OU=Users,DC=example,DC=com">
                                        <small class="form-text text-muted">Service account for LDAP binds</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="ldapBindPassword" class="form-label fw-semibold">Bind Password *</label>
                                        <input type="password" class="form-control" id="ldapBindPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                        <small class="form-text text-muted">Service account password. Leave blank to keep existing. Encrypted and not shown for security.</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="ldapSearchFilter" class="form-label fw-semibold">Search Filter</label>
                                        <input type="text" class="form-control" id="ldapSearchFilter" value="(sAMAccountName={username})">
                                        <small class="form-text text-muted">Use {username} as placeholder for login username</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="ldapUsernamAttr" class="form-label fw-semibold">Username Attribute</label>
                                        <input type="text" class="form-control" id="ldapUsernameAttr" value="sAMAccountName">
                                        <small class="form-text text-muted">AD: sAMAccountName, OpenLDAP: uid</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="ldapEmailAttr" class="form-label fw-semibold">Email Attribute</label>
                                        <input type="text" class="form-control" id="ldapEmailAttr" value="mail">
                                        <small class="form-text text-muted">Attribute containing email address</small>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="ldapUseTLS">
                                            <label class="form-check-label fw-semibold" for="ldapUseTLS">
                                                Use TLS/STARTTLS
                                            </label>
                                        </div>
                                    </div>

                                    <!-- LDAP Sync Scheduling -->
                                    <div class="col-md-12 mt-4">
                                        <hr>
                                        <h6 class="text-muted mb-3">
                                            <i class="bi bi-arrow-repeat me-2"></i>Automatic Synchronization
                                        </h6>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="alert alert-secondary">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Automatic Sync:</strong> Automatically synchronize LDAP users' roles and organizations based on their group memberships at regular intervals.
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="ldapSyncEnabled">
                                            <label class="form-check-label fw-semibold" for="ldapSyncEnabled">
                                                Enable Scheduled LDAP Synchronization
                                            </label>
                                        </div>
                                        <small class="text-muted">When enabled, LDAP users will be automatically synced with group mappings at the specified interval</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="ldapSyncInterval" class="form-label fw-semibold">Sync Interval (hours)</label>
                                        <select class="form-select" id="ldapSyncInterval">
                                            <option value="1">Every 1 hour</option>
                                            <option value="4">Every 4 hours</option>
                                            <option value="8">Every 8 hours</option>
                                            <option value="12">Every 12 hours</option>
                                            <option value="24" selected>Every 24 hours (daily)</option>
                                            <option value="48">Every 48 hours</option>
                                            <option value="168">Every 7 days (weekly)</option>
                                        </select>
                                        <small class="text-muted">How often to automatically sync LDAP users</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Last Scheduled Sync</label>
                                        <div class="form-control bg-light" id="ldapLastScheduledSync">
                                            Never
                                        </div>
                                        <small class="text-muted">Last time the scheduled sync ran</small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary me-2" onclick="saveLDAPSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save LDAP Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testLDAPConnection()">
                                            <i class="bi bi-plug me-1"></i>Test Connection
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- SAML SSO Settings (Super Admin + Professional License Only) -->
                <div class="tab-pane fade" id="samlSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-key-fill me-2"></i>SAML Single Sign-On (SSO)</span>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure SAML 2.0 SSO to allow users to log in using your Identity Provider (IdP) like Okta, Azure AD, or OneLogin.
                            </div>

                            <form id="samlSettingsForm">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="samlEnabled">
                                            <label class="form-check-label" for="samlEnabled">Enable SAML SSO</label>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <h6 class="text-muted border-bottom pb-2 mt-3"><i class="bi bi-cloud-download me-2"></i>Service Provider (SP) Information</h6>
                                        <p class="text-muted small">Use these values when configuring your Identity Provider:</p>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">SP Entity ID</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="samlSpEntityId" readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="copySamlValue('samlSpEntityId')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">Also known as Audience URI</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">ACS URL</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="samlAcsUrl" readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="copySamlValue('samlAcsUrl')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">Assertion Consumer Service URL</small>
                                    </div>

                                    <div class="col-12">
                                        <a href="/api/saml/metadata" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-download me-1"></i>Download SP Metadata XML
                                        </a>
                                    </div>

                                    <div class="col-12">
                                        <h6 class="text-muted border-bottom pb-2 mt-3"><i class="bi bi-cloud-upload me-2"></i>Identity Provider (IdP) Configuration</h6>
                                    </div>

                                    <div class="col-12">
                                        <label for="samlIdpMetadata" class="form-label">IdP Metadata (XML or URL)</label>
                                        <textarea class="form-control" id="samlIdpMetadata" rows="6" placeholder="Paste your IdP metadata XML here, or enter the metadata URL"></textarea>
                                        <small class="form-text text-muted">You can paste the full XML metadata or provide a URL to fetch it from</small>
                                    </div>

                                    <div class="col-12">
                                        <h6 class="text-muted border-bottom pb-2 mt-3"><i class="bi bi-person-badge me-2"></i>User Provisioning</h6>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="samlDefaultOrg" class="form-label">Default Organization</label>
                                        <select class="form-select" id="samlDefaultOrg">
                                            <option value="">Select organization...</option>
                                        </select>
                                        <small class="form-text text-muted">Organization for new SAML users</small>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="mt-4">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="samlAutoProvision" checked>
                                                <label class="form-check-label" for="samlAutoProvision">Auto-provision new users</label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="samlUpdateUserInfo" checked>
                                                <label class="form-check-label" for="samlUpdateUserInfo">Update user info on login</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <h6 class="text-muted border-bottom pb-2 mt-3"><i class="bi bi-arrow-left-right me-2"></i>Attribute Mapping</h6>
                                        <p class="text-muted small">Map SAML assertion attributes to user fields. Default values work with most IdPs.</p>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Username Attribute</label>
                                        <input type="text" class="form-control" id="samlAttrUsername" value="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name">
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Email Attribute</label>
                                        <input type="text" class="form-control" id="samlAttrEmail" value="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress">
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Full Name Attribute</label>
                                        <input type="text" class="form-control" id="samlAttrFullName" value="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname">
                                    </div>

                                    <div class="col-12 mt-4">
                                        <hr>
                                        <button type="button" class="btn btn-primary me-2" onclick="saveSamlSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save SAML Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testSamlConfig()">
                                            <i class="bi bi-check2-circle me-1"></i>Test Configuration
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Global SMTP Settings -->
                <div class="tab-pane fade {% if not current_user or not current_user.is_super_admin() or not license or not license.is_professional() %}show active{% endif %}" id="smtpSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-envelope me-2"></i>Global SMTP Configuration
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Default SMTP settings for all organizations. Organizations can override these with their own SMTP config.
                            </div>

                            <form id="smtpSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label for="globalSmtpHost" class="form-label fw-semibold">SMTP Server *</label>
                                        <input type="text" class="form-control" id="globalSmtpHost" placeholder="smtp.gmail.com">
                                    </div>

                                    <div class="col-md-4">
                                        <label for="globalSmtpPort" class="form-label fw-semibold">Port *</label>
                                        <input type="number" class="form-control" id="globalSmtpPort" value="587">
                                        <small class="form-text text-muted">587 (TLS) or 465 (SSL)</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="globalSmtpUsername" class="form-label fw-semibold">Username</label>
                                        <input type="text" class="form-control" id="globalSmtpUsername">
                                    </div>

                                    <div class="col-md-6">
                                        <label for="globalSmtpPassword" class="form-label fw-semibold">Password</label>
                                        <input type="password" class="form-control" id="globalSmtpPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                        <small class="form-text text-muted">Leave blank to keep existing password. Passwords are encrypted and not shown for security.</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="globalSmtpFromEmail" class="form-label fw-semibold">From Email *</label>
                                        <input type="email" class="form-control" id="globalSmtpFromEmail" placeholder="noreply@company.com">
                                        <small class="form-text text-muted">Sender address for all outgoing SentriKat emails (CVE alerts, reports, notifications)</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="globalSmtpFromName" class="form-label fw-semibold">From Name</label>
                                        <input type="text" class="form-control" id="globalSmtpFromName" value="SentriKat Alerts">
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="globalSmtpUseTLS" checked>
                                            <label class="form-check-label fw-semibold" for="globalSmtpUseTLS">
                                                Use TLS/STARTTLS
                                            </label>
                                        </div>
                                        <small class="text-muted">For port 587 (recommended)</small>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="globalSmtpUseSSL">
                                            <label class="form-check-label fw-semibold" for="globalSmtpUseSSL">
                                                Use SSL
                                            </label>
                                        </div>
                                        <small class="text-muted">For port 465 (implicit SSL)</small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary me-2" onclick="saveGlobalSMTPSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save SMTP Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testGlobalSMTP()">
                                            <i class="bi bi-envelope-check me-1"></i>Send Test Email
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- System Sub-Tabs Navigation -->
                <div class="tab-pane fade" id="systemSubTabs" role="tabpanel">
                    <ul class="nav nav-pills mb-3" id="systemSubNav" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" type="button" onclick="showSystemSubTab('sync', this)">
                                <i class="bi bi-arrow-clockwise me-1"></i>Sync & Updates
                            </button>
                        </li>
                        {% if current_user and current_user.is_super_admin() %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" type="button" onclick="showSystemSubTab('general', this)">
                                <i class="bi bi-gear me-1"></i>General
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" type="button" onclick="showSystemSubTab('security', this)">
                                <i class="bi bi-shield-lock me-1"></i>Security
                            </button>
                        </li>
                        {% endif %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" type="button" onclick="showSystemSubTab('retention', this)">
                                <i class="bi bi-archive me-1"></i>Data Retention
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Sync Schedule Settings -->
                <div class="tab-pane fade" id="syncSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-arrow-clockwise me-2"></i>CISA KEV Sync Schedule
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Global Sync Schedule:</strong> Configure automatic synchronization with the CISA Known Exploited Vulnerabilities catalog.
                                This applies to all organizations system-wide and keeps the vulnerability database up-to-date.
                            </div>

                            <form id="syncSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="autoSyncEnabled">
                                            <label class="form-check-label fw-semibold" for="autoSyncEnabled">
                                                Enable Automatic Sync
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="syncInterval" class="form-label fw-semibold">Sync Interval</label>
                                        <select class="form-select" id="syncInterval">
                                            <option value="hourly">Every Hour</option>
                                            <option value="4hours">Every 4 Hours</option>
                                            <option value="6hours">Every 6 Hours</option>
                                            <option value="12hours">Every 12 Hours</option>
                                            <option value="daily" selected>Daily</option>
                                            <option value="weekly">Weekly</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="syncTime" class="form-label fw-semibold">Preferred Time (<span class="tz-label">UTC</span>)</label>
                                        <input type="time" class="form-control" id="syncTime" value="02:00">
                                        <small class="form-text text-muted">Time to run daily/weekly syncs</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="nvdApiKey" class="form-label fw-semibold">NVD API Key</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="nvdApiKey" placeholder="Optional - for CVSS enrichment">
                                            <button class="btn btn-outline-secondary d-none" type="button" id="btnClearNvdKey" onclick="clearNvdApiKey()" title="Clear API Key">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">Get from <a href="https://nvd.nist.gov/developers/request-an-api-key" target="_blank">NIST NVD</a></small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="cisaKevUrl" class="form-label fw-semibold">CISA KEV URL</label>
                                        <input type="text" class="form-control" id="cisaKevUrl" value="https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json">
                                        <small class="form-text text-muted">Usually leave as default</small>
                                    </div>

                                    <!-- NVD Health Status -->
                                    <div class="col-md-12">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body py-2">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div>
                                                        <strong><i class="bi bi-shield-check me-1"></i>NVD Connection Status:</strong>
                                                        <span id="nvdHealthStatus" class="ms-2">
                                                            <span class="spinner-border spinner-border-sm text-muted" role="status"></span>
                                                            <span class="text-muted">Checking...</span>
                                                        </span>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="checkNvdHealth()" title="Refresh NVD Status">
                                                        <i class="bi bi-arrow-clockwise"></i>
                                                    </button>
                                                </div>
                                                <div id="nvdHealthDetails" class="mt-2 small text-muted d-none"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="alert alert-secondary">
                                            <strong>Last Sync:</strong> <span id="lastSyncTime">Never</span><br>
                                            <strong>Next Scheduled:</strong> <span id="nextSyncTime">Not scheduled</span><br>
                                            <strong>Total Vulnerabilities:</strong> <span id="totalVulns">0</span>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveSyncSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Sync Settings
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Manual Alert Triggers -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <i class="bi bi-megaphone me-2"></i>Manual Alert Triggers
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Manual Alerts:</strong> Manually trigger alerts for all organizations with unacknowledged critical and high priority CVEs.
                                Use these buttons to send notifications on-demand outside of the automatic sync schedule.
                            </div>

                            <div class="row g-4">
                                <!-- Email Alerts -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-danger">
                                        <div class="card-header bg-danger text-white">
                                            <i class="bi bi-envelope-exclamation me-2"></i>Email Alerts
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text text-muted mb-3">
                                                Send email notifications to all configured recipients in each organization.
                                            </p>
                                            <button type="button" class="btn btn-danger w-100" onclick="triggerCriticalCVEAlerts()" id="btnTriggerEmail">
                                                <i class="bi bi-envelope-exclamation me-1"></i>Send Email Alerts Now
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Webhook Alerts -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <i class="bi bi-broadcast me-2"></i>Webhook Alerts
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text text-muted mb-3">
                                                Send webhook notifications to Slack, Teams, Discord, or custom endpoints.
                                            </p>
                                            <button type="button" class="btn btn-primary w-100" onclick="triggerWebhookAlerts()" id="btnTriggerWebhook">
                                                <i class="bi bi-broadcast me-1"></i>Send Webhook Alerts Now
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Results Container -->
                                <div class="col-md-12" id="alertResultsContainer" style="display: none;">
                                    <div class="alert" id="alertResultsAlert">
                                        <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Alert Results</h6>
                                        <div id="alertResultsContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- EPSS (Exploit Prediction Scoring System) Sync -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <i class="bi bi-lightning-charge me-2"></i>EPSS Scoring (Exploit Prediction)
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>EPSS (Exploit Prediction Scoring System):</strong> Fetches probability scores from FIRST.org
                                indicating how likely each CVE is to be exploited in the next 30 days. Higher scores = higher priority.
                                EPSS automatically syncs after each CISA KEV sync.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0" id="epssTotal">-</h3>
                                            <small class="text-muted">CVEs with EPSS</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-danger" id="epssHighRisk">-</h3>
                                            <small class="text-muted">High Risk (Top 15%)</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-success" id="epssCoverage">-</h3>
                                            <small class="text-muted">Coverage %</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <small class="text-muted">Last EPSS Sync: <span id="epssLastSync">Never</span></small>
                            </div>

                            <div class="mt-3">
                                <button type="button" class="btn btn-primary" onclick="syncEpssScores()" id="btnSyncEpss">
                                    <i class="bi bi-lightning-charge me-1"></i>Sync EPSS Scores Now
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="syncEpssScores(true)" id="btnSyncEpssForce">
                                    <i class="bi bi-arrow-repeat me-1"></i>Force Refresh All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- CPE Dictionary -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <i class="bi bi-book me-2"></i>CPE Dictionary (Offline Product Matching)
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>CPE Dictionary:</strong> A local database of ~40-50K vendor:product pairs from the NVD.
                                Enables offline CPE matching without rate-limited API calls. Downloads automatically on first use
                                and refreshes monthly. Incremental updates from NVD API run weekly.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0" id="cpeDictTotal">-</h3>
                                            <small class="text-muted">Total Entries</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-primary" id="cpeDictAliases">-</h3>
                                            <small class="text-muted">With Aliases</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-success" id="cpeDictUsed">-</h3>
                                            <small class="text-muted">Used for Matching</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-info" id="cpeDictCoverage">-</h3>
                                            <small class="text-muted">Product Coverage</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <small class="text-muted">Last Bulk Download: <span id="cpeDictLastBulk">Never</span></small><br>
                                <small class="text-muted">Last NVD Sync: <span id="cpeDictLastSync">Never</span></small>
                            </div>

                            <div class="mt-3">
                                <button type="button" class="btn btn-primary" onclick="syncCpeDictionary()" id="btnSyncCpeDict">
                                    <i class="bi bi-cloud-download me-1"></i>Sync CPE Dictionary Now
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="rebuildCpeDictionary()" id="btnRebuildCpeDict">
                                    <i class="bi bi-arrow-repeat me-1"></i>Rebuild from Vulnerabilities
                                </button>
                            </div>
                            <div id="cpeDictSyncResult" class="mt-2 d-none">
                                <div class="alert alert-success py-2 mb-0">
                                    <i class="bi bi-check-circle me-1"></i><span id="cpeDictSyncMsg"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Knowledge Base Sync -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <i class="bi bi-cloud-arrow-up-down me-2"></i>SentriKat Knowledge Base
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>KB Sync:</strong> Shares proven CPE mappings with the SentriKat community.
                                Your mappings (human-verified + auto-verified with 20+ uses) are pushed to the KB.
                                Community-verified mappings are pulled back to improve your matching.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0" id="kbUser">-</h3>
                                            <small class="text-muted">Human Mappings</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-success" id="kbAutoVerified">-</h3>
                                            <small class="text-muted">Auto-Verified</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-warning" id="kbAutoNvd">-</h3>
                                            <small class="text-muted">Auto-Discovered</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-info" id="kbCommunity">-</h3>
                                            <small class="text-muted">Community</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <small class="text-muted">KB Server: <span id="kbServer">-</span></small><br>
                                <small class="text-muted">Last Pull: <span id="kbLastPull">Never</span></small>
                            </div>
                        </div>
                    </div>
                </div>

                {% if current_user and current_user.is_super_admin() %}
                <!-- General Settings (Super Admin Only) -->
                <div class="tab-pane fade" id="proxySettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-gear me-2"></i>General Settings
                        </div>
                        <div class="card-body">
                            <form id="proxySettingsForm">
                                <div class="row g-3">
                                    <!-- Date & Time Display -->
                                    <div class="col-12">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-clock me-2"></i>Date & Time Display</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="displayTimezone" class="form-label fw-semibold">Display Timezone</label>
                                        <select class="form-select" id="displayTimezone">
                                            <option value="UTC">UTC (Coordinated Universal Time)</option>
                                            <option value="local">Browser Local Time</option>
                                            <option value="America/New_York">Eastern Time (US)</option>
                                            <option value="America/Chicago">Central Time (US)</option>
                                            <option value="America/Denver">Mountain Time (US)</option>
                                            <option value="America/Los_Angeles">Pacific Time (US)</option>
                                            <option value="Europe/London">London (UK)</option>
                                            <option value="Europe/Paris">Paris (CET)</option>
                                            <option value="Europe/Berlin">Berlin (CET)</option>
                                            <option value="Europe/Rome">Rome (CET)</option>
                                            <option value="Europe/Madrid">Madrid (CET)</option>
                                            <option value="Europe/Amsterdam">Amsterdam (CET)</option>
                                            <option value="Europe/Zurich">Zurich (CET)</option>
                                            <option value="Asia/Tokyo">Tokyo (Japan)</option>
                                            <option value="Asia/Shanghai">Shanghai (China)</option>
                                            <option value="Asia/Singapore">Singapore</option>
                                            <option value="Asia/Dubai">Dubai (UAE)</option>
                                            <option value="Australia/Sydney">Sydney (Australia)</option>
                                        </select>
                                        <small class="form-text text-muted">Timezone for displaying dates throughout the app</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="dateFormat" class="form-label fw-semibold">Date Format</label>
                                        <select class="form-select" id="dateFormat">
                                            <option value="YYYY-MM-DD HH:mm">2024-01-15 14:30 (ISO)</option>
                                            <option value="DD/MM/YYYY HH:mm">15/01/2024 14:30 (European)</option>
                                            <option value="MM/DD/YYYY hh:mm A">01/15/2024 02:30 PM (US)</option>
                                            <option value="DD MMM YYYY HH:mm">15 Jan 2024 14:30</option>
                                            <option value="MMM DD, YYYY hh:mm A">Jan 15, 2024 02:30 PM</option>
                                        </select>
                                        <small class="form-text text-muted">Format for displaying dates and times</small>
                                    </div>

                                    <!-- Network/Proxy Settings -->
                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-hdd-network me-2"></i>Network & Proxy</h6>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="alert alert-info mb-3">
                                            <i class="bi bi-info-circle me-2"></i>
                                            Configure proxy settings for external API connections (CISA KEV, NVD). Required if SentriKat is behind a corporate proxy.
                                        </div>
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="verifySSL" checked>
                                            <label class="form-check-label fw-semibold" for="verifySSL">
                                                Verify SSL Certificates
                                            </label>
                                            <small class="form-text text-muted d-block">Disable if behind corporate proxy with SSL inspection (not recommended for production)</small>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="httpProxy" class="form-label fw-semibold">HTTP Proxy</label>
                                        <input type="text" class="form-control" id="httpProxy" placeholder="http://proxy.company.com:3128">
                                        <small class="form-text text-muted">Proxy for HTTP connections</small>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="httpsProxy" class="form-label fw-semibold">HTTPS Proxy</label>
                                        <input type="text" class="form-control" id="httpsProxy" placeholder="http://proxy.company.com:3128">
                                        <small class="form-text text-muted">Proxy for HTTPS connections</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="noProxy" class="form-label fw-semibold">No Proxy (Bypass List)</label>
                                        <input type="text" class="form-control" id="noProxy" placeholder="localhost,127.0.0.1,.company.com">
                                        <small class="form-text text-muted">Comma-separated hostnames to bypass proxy</small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveProxySettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Proxy Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="testProxyConnection()">
                                            <i class="bi bi-plug me-1"></i>Test Connection
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="tab-pane fade" id="securitySettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-shield-lock me-2"></i>Security Settings
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure session security, login protection, and password policies.
                            </div>

                            <form id="securitySettingsForm">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-clock me-2"></i>Session Settings</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="sessionTimeout" class="form-label fw-semibold">Session Timeout (minutes)</label>
                                        <input type="number" class="form-control" id="sessionTimeout" value="480" min="5" max="10080">
                                        <small class="form-text text-muted">User sessions expire after this period of inactivity (5 min - 7 days)</small>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-lock me-2"></i>Login Protection</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="maxFailedLogins" class="form-label fw-semibold">Max Failed Login Attempts</label>
                                        <input type="number" class="form-control" id="maxFailedLogins" value="5" min="3" max="20">
                                        <small class="form-text text-muted">Lock account after this many failed attempts</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lockoutDuration" class="form-label fw-semibold">Lockout Duration (minutes)</label>
                                        <input type="number" class="form-control" id="lockoutDuration" value="30" min="5" max="1440">
                                        <small class="form-text text-muted">How long account stays locked</small>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-key me-2"></i>Password Policy (Local Users)</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="passwordMinLength" class="form-label fw-semibold">Minimum Password Length</label>
                                        <input type="number" class="form-control" id="passwordMinLength" value="8" min="6" max="32">
                                    </div>
                                    <div class="col-md-6">
                                        <div class="pt-4">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="passwordRequireUppercase" checked>
                                                <label class="form-check-label" for="passwordRequireUppercase">Require uppercase letter (A-Z)</label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="passwordRequireLowercase" checked>
                                                <label class="form-check-label" for="passwordRequireLowercase">Require lowercase letter (a-z)</label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="passwordRequireNumbers" checked>
                                                <label class="form-check-label" for="passwordRequireNumbers">Require number (0-9)</label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="passwordRequireSpecial">
                                                <label class="form-check-label" for="passwordRequireSpecial">Require special character (!@#$%^&*)</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-calendar-x me-2"></i>Password Expiration</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="passwordExpiryDays" class="form-label fw-semibold">Password Expiry (days)</label>
                                        <input type="number" class="form-control" id="passwordExpiryDays" value="0" min="0" max="365">
                                        <small class="form-text text-muted">Set to 0 to disable password expiration. Users must change password after this many days.</small>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-phone me-2"></i>Two-Factor Authentication</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="require2FA">
                                            <label class="form-check-label" for="require2FA">Require 2FA for all users</label>
                                        </div>
                                        <small class="form-text text-muted">When enabled, users must set up TOTP-based two-factor authentication</small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveSecuritySettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Security Settings
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Backup & Restore Card -->
                    <div class="card mt-4" id="backupRestoreCard">
                        <div class="card-header">
                            <i class="bi bi-cloud-download me-2"></i>Backup & Restore
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Backup includes settings, organizations, and user accounts (without passwords). Use with caution when restoring.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <i class="bi bi-download display-4 text-primary mb-3"></i>
                                            <h5>Export Backup</h5>
                                            <p class="text-muted small">Download a JSON backup of your settings and configuration</p>
                                            <button type="button" class="btn btn-primary" onclick="downloadBackup()">
                                                <i class="bi bi-cloud-download me-1"></i>Download Backup
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <i class="bi bi-upload display-4 text-secondary mb-3"></i>
                                            <h5>Restore Backup</h5>
                                            <p class="text-muted small">Restore from a previously exported backup file</p>
                                            <input type="file" class="form-control mb-2" id="restoreFile" accept=".json" style="display: none;">
                                            <input type="file" class="form-control mb-2" id="restoreFullFile" accept=".json" style="display: none;">
                                            <div class="d-grid gap-2">
                                                <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('restoreFile').click()">
                                                    <i class="bi bi-sliders me-1"></i>Settings Only
                                                </button>
                                                <button type="button" class="btn btn-outline-primary" onclick="confirmFullRestore()">
                                                    <i class="bi bi-database-up me-1"></i>Full Restore
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if license and license.is_professional() %}
                <!-- Notifications Settings (Professional License Only) -->
                <div class="tab-pane fade" id="notificationsSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-bell me-2"></i>Notification Integrations
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure webhooks to receive vulnerability alerts in Slack or Microsoft Teams.
                            </div>

                            <form id="notificationsSettingsForm">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-slack me-2"></i>Slack Integration</h6>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-check form-switch mb-2">
                                            <input type="checkbox" class="form-check-input" id="slackEnabled">
                                            <label class="form-check-label fw-semibold" for="slackEnabled">Enable Slack Notifications</label>
                                        </div>
                                    </div>
                                    <div class="col-md-10">
                                        <label for="slackWebhookUrl" class="form-label">Slack Webhook URL</label>
                                        <input type="text" class="form-control" id="slackWebhookUrl" placeholder="https://hooks.slack.com/services/...">
                                        <small class="form-text text-muted">Create an incoming webhook in your Slack workspace settings</small>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="button" class="btn btn-outline-secondary w-100" onclick="testWebhook('slack')">
                                            <i class="bi bi-send me-1"></i>Test
                                        </button>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-microsoft-teams me-2"></i>Microsoft Teams Integration</h6>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-check form-switch mb-2">
                                            <input type="checkbox" class="form-check-input" id="teamsEnabled">
                                            <label class="form-check-label fw-semibold" for="teamsEnabled">Enable Teams Notifications</label>
                                        </div>
                                    </div>
                                    <div class="col-md-10">
                                        <label for="teamsWebhookUrl" class="form-label">Teams Webhook URL</label>
                                        <input type="text" class="form-control" id="teamsWebhookUrl" placeholder="https://outlook.office.com/webhook/...">
                                        <small class="form-text text-muted">Create an incoming webhook connector in your Teams channel</small>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="button" class="btn btn-outline-secondary w-100" onclick="testWebhook('teams')">
                                            <i class="bi bi-send me-1"></i>Test
                                        </button>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-webhook me-2"></i>Generic Webhook (RocketChat, Mattermost, Discord, etc.)</h6>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-check form-switch mb-2">
                                            <input type="checkbox" class="form-check-input" id="genericWebhookEnabled">
                                            <label class="form-check-label fw-semibold" for="genericWebhookEnabled">Enable Generic Webhook Notifications</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="genericWebhookName" class="form-label">Webhook Name</label>
                                        <input type="text" class="form-control" id="genericWebhookName" placeholder="RocketChat" value="Custom Webhook">
                                        <small class="form-text text-muted">Display name for this integration</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="genericWebhookFormat" class="form-label">Payload Format</label>
                                        <select class="form-select" id="genericWebhookFormat">
                                            <option value="slack">Slack-compatible (RocketChat, Mattermost)</option>
                                            <option value="discord">Discord</option>
                                            <option value="custom">Custom JSON Template</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="genericWebhookUrl" class="form-label">Webhook URL</label>
                                        <input type="text" class="form-control" id="genericWebhookUrl" placeholder="https://your-server.com/hooks/...">
                                        <small class="form-text text-muted">Incoming webhook URL from your chat platform</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="genericWebhookToken" class="form-label">Auth Token <span class="text-muted">(optional)</span></label>
                                        <input type="password" class="form-control" id="genericWebhookToken" placeholder="Leave empty if not needed">
                                        <small class="form-text text-muted">For webhooks requiring authentication</small>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="button" class="btn btn-outline-secondary w-100" onclick="testWebhook('generic')">
                                            <i class="bi bi-send me-1"></i>Test
                                        </button>
                                    </div>
                                    <div class="col-md-12" id="customTemplateContainer" style="display: none;">
                                        <label for="genericWebhookTemplate" class="form-label">Custom JSON Template</label>
                                        <textarea class="form-control font-monospace" id="genericWebhookTemplate" rows="4" placeholder='{"text": "{{message}}", "title": "{{title}}"}'></textarea>
                                        <small class="form-text text-muted">Use <code>{{message}}</code> and <code>{{title}}</code> as placeholders</small>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-envelope-exclamation me-2"></i>Critical CVE Email Reminders</h6>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-check form-switch mb-2">
                                            <input type="checkbox" class="form-check-input" id="criticalEmailEnabled" checked>
                                            <label class="form-check-label fw-semibold" for="criticalEmailEnabled">Enable Daily Critical CVE Reminder Emails</label>
                                        </div>
                                        <small class="form-text text-muted">Send daily reminder emails about unacknowledged CRITICAL CVEs to organization notification emails</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="criticalEmailTime" class="form-label">Email Time (<span class="tz-label">UTC</span>)</label>
                                        <input type="time" class="form-control" id="criticalEmailTime" value="09:00">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="criticalEmailMaxAge" class="form-label">Max CVE Age (days)</label>
                                        <input type="number" class="form-control" id="criticalEmailMaxAge" value="30" min="7" max="90">
                                        <small class="form-text text-muted">Only include CVEs discovered within this many days</small>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-gear me-2"></i>Default Alert Mode</h6>
                                        <small class="text-muted">These defaults can be overridden per-organization</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="defaultAlertMode" class="form-label">Alert Mode</label>
                                        <select class="form-select" id="defaultAlertMode">
                                            <option value="new_only">New Only - Only alert on new CVEs from each sync</option>
                                            <option value="daily_reminder" selected>Daily Reminder - All unacknowledged CVEs due within 7 days</option>
                                            <option value="escalation">Escalation - Re-alert as CVEs approach due date</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            <strong>New Only:</strong> Alert only when new vulnerabilities are discovered<br>
                                            <strong>Daily Reminder:</strong> Daily reminder of ALL unacknowledged critical CVEs due within 7 days<br>
                                            <strong>Escalation:</strong> Re-alert when CVE is within X days of due date
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="defaultEscalationDays" class="form-label">Escalation Days</label>
                                        <input type="number" class="form-control" id="defaultEscalationDays" value="3" min="1" max="14">
                                        <small class="form-text text-muted">For Escalation mode: Days before due date to re-alert</small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Notification Settings
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Branding Settings -->
                <div class="tab-pane fade" id="brandingSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-palette me-2"></i>Branding & Appearance
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Customize the application name and appearance.
                            </div>

                            <form id="brandingSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="appName" class="form-label fw-semibold">Application Name</label>
                                        <input type="text" class="form-control" id="appName" value="SentriKat" maxlength="50">
                                        <small class="form-text text-muted">Displayed in browser title and header</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="supportEmail" class="form-label fw-semibold">Support Email</label>
                                        <input type="email" class="form-control" id="supportEmail" placeholder="support@company.com">
                                        <small class="form-text text-muted">Shown on login page and error messages</small>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="loginMessage" class="form-label fw-semibold">Login Page Message</label>
                                        <textarea class="form-control" id="loginMessage" rows="2" maxlength="500" placeholder="Welcome message or security notice for users..."></textarea>
                                        <small class="form-text text-muted">Optional message displayed on the login page</small>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="showVersion" checked>
                                            <label class="form-check-label fw-semibold" for="showVersion">Show Version in Footer</label>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="reportBrandingEnabled" checked>
                                            <label class="form-check-label fw-semibold" for="reportBrandingEnabled">Show Branding in Compliance Reports</label>
                                        </div>
                                        <small class="form-text text-muted">When enabled, the application name appears in exported PDF and JSON compliance reports. Disable for fully white-labeled reports.</small>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-image me-2"></i>Custom Logo</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Current Logo</label>
                                        <div class="d-flex align-items-center gap-3">
                                            <img id="currentLogoPreview" src="/static/images/favicon-128x128.png" alt="Logo" style="width: 64px; height: 64px; object-fit: contain; border: 1px solid #ddd; border-radius: 8px; padding: 4px;">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteLogo()" id="deleteLogoBtn" style="display: none;">
                                                <i class="bi bi-trash me-1"></i>Remove
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="logoUpload" class="form-label fw-semibold">Upload New Logo</label>
                                        <input type="file" class="form-control" id="logoUpload" accept=".png,.jpg,.jpeg,.gif,.svg,.webp">
                                        <small class="form-text text-muted">Max 2MB. Recommended: 128x128px PNG with transparent background</small>
                                    </div>
                                    <div class="col-md-12">
                                        <button type="button" class="btn btn-outline-primary" onclick="uploadLogo()">
                                            <i class="bi bi-upload me-1"></i>Upload Logo
                                        </button>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveBrandingSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Branding Settings
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Data Retention Settings -->
                <div class="tab-pane fade" id="retentionSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-archive me-2"></i>Data Retention
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Caution:</strong> Data older than the retention period will be permanently deleted during cleanup tasks.
                            </div>

                            <form id="retentionSettingsForm">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="auditLogRetention" class="form-label fw-semibold">Audit Log Retention (days)</label>
                                        <input type="number" class="form-control" id="auditLogRetention" value="365" min="30" max="3650">
                                        <small class="form-text text-muted">User activity and change logs</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="syncHistoryRetention" class="form-label fw-semibold">Sync History Retention (days)</label>
                                        <input type="number" class="form-control" id="syncHistoryRetention" value="90" min="7" max="365">
                                        <small class="form-text text-muted">CISA/NVD sync logs</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="sessionLogRetention" class="form-label fw-semibold">Session Log Retention (days)</label>
                                        <input type="number" class="form-control" id="sessionLogRetention" value="30" min="7" max="365">
                                        <small class="form-text text-muted">User login sessions</small>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <h6 class="text-muted border-bottom pb-2"><i class="bi bi-check2-circle me-2"></i>Auto-Acknowledge</h6>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="autoAcknowledgeRemovedSoftware" checked>
                                            <label class="form-check-label fw-semibold" for="autoAcknowledgeRemovedSoftware">
                                                Auto-acknowledge vulnerabilities when software is removed
                                            </label>
                                        </div>
                                        <small class="form-text text-muted d-block mt-1">
                                            Automatically acknowledge CVE matches when the affected software is no longer installed on any asset.
                                            This reduces alert fatigue for vulnerabilities that no longer apply.
                                        </small>
                                    </div>

                                    <div class="col-md-12">
                                        <hr>
                                        <button type="button" class="btn btn-primary" onclick="saveRetentionSettings()">
                                            <i class="bi bi-check-circle me-1"></i>Save Retention Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="runAutoAcknowledge()">
                                            <i class="bi bi-play-circle me-1"></i>Run Auto-Acknowledge Now
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Syslog / SIEM Settings -->
                <div class="tab-pane fade" id="syslogSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-broadcast me-2"></i>SIEM / Syslog Forwarding
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                Forward vulnerability events to your SIEM (Splunk, ELK, ArcSight, QRadar) via syslog.
                                Supports CEF, JSON, and RFC 5424 formats over UDP or TCP.
                            </p>

                            <div class="row g-3">
                                <div class="col-md-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="syslogEnabled">
                                        <label class="form-check-label" for="syslogEnabled">Enable Syslog Forwarding</label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label" for="syslogHost">Syslog Server Host</label>
                                    <input type="text" class="form-control" id="syslogHost" placeholder="siem.example.com">
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label" for="syslogPort">Port</label>
                                    <input type="number" class="form-control" id="syslogPort" value="514" min="1" max="65535">
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label" for="syslogProtocol">Protocol</label>
                                    <select class="form-select" id="syslogProtocol">
                                        <option value="udp">UDP</option>
                                        <option value="tcp">TCP</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label" for="syslogFormat">Event Format</label>
                                    <select class="form-select" id="syslogFormat">
                                        <option value="cef">CEF (ArcSight, QRadar)</option>
                                        <option value="json">JSON (Splunk HEC, ELK)</option>
                                        <option value="rfc5424">RFC 5424 (Standard Syslog)</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label" for="syslogFacility">Facility</label>
                                    <select class="form-select" id="syslogFacility">
                                        <option value="local0">local0</option>
                                        <option value="local1">local1</option>
                                        <option value="local2">local2</option>
                                        <option value="local3">local3</option>
                                        <option value="local4">local4</option>
                                        <option value="local5">local5</option>
                                        <option value="local6">local6</option>
                                        <option value="local7">local7</option>
                                    </select>
                                </div>

                                <div class="col-12">
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary" onclick="saveSyslogSettings()">
                                            <i class="bi bi-check-lg me-1"></i>Save Settings
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="testSyslog()">
                                            <i class="bi bi-send me-1"></i>Send Test Event
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Logs -->
                <div class="tab-pane fade" id="auditLogs" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-journal-text me-2"></i>Audit Logs</span>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="bi bi-download me-1"></i>Export
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="exportAuditLogs('csv', 30)"><i class="bi bi-filetype-csv me-2"></i>CSV (Last 30 days)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportAuditLogs('csv', 90)"><i class="bi bi-filetype-csv me-2"></i>CSV (Last 90 days)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportAuditLogs('csv', 365)"><i class="bi bi-filetype-csv me-2"></i>CSV (Last year)</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportAuditLogs('json', 30)"><i class="bi bi-filetype-json me-2"></i>JSON (Last 30 days)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportAuditLogs('json', 90)"><i class="bi bi-filetype-json me-2"></i>JSON (Last 90 days)</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                View and export audit logs for compliance and security review. Logs include user actions, configuration changes, and security events.
                            </div>

                            <!-- Search and Filters Row 1 -->
                            <div class="row g-2 mb-2">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="auditSearchInput" placeholder="Search logs..." onkeyup="if(event.key==='Enter') loadAuditLogs()">
                                        <button class="btn btn-outline-secondary" type="button" onclick="loadAuditLogs()">Search</button>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="auditActionFilter" onchange="loadAuditLogs()">
                                        <option value="">All Actions</option>
                                        <option value="CREATE">Create</option>
                                        <option value="UPDATE">Update</option>
                                        <option value="DELETE">Delete</option>
                                        <option value="LOGIN">Login</option>
                                        <option value="LOGOUT">Logout</option>
                                        <option value="LOGIN_FAILED">Login Failed</option>
                                        <option value="BLOCK">Block</option>
                                        <option value="UNBLOCK">Unblock</option>
                                        <option value="UNLOCK">Unlock</option>
                                        <option value="RESET_2FA">Reset 2FA</option>
                                        <option value="FORCE_PASSWORD_CHANGE">Force Password</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="auditResourceFilter" onchange="loadAuditLogs()">
                                        <option value="">All Resources</option>
                                        <option value="users">Users</option>
                                        <option value="products">Products</option>
                                        <option value="organizations">Organizations</option>
                                        <option value="settings">Settings</option>
                                        <option value="ldap">LDAP</option>
                                        <option value="auth">Authentication</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="date" class="form-control" id="auditStartDate" onchange="loadAuditLogs()" title="Start Date">
                                </div>
                                <div class="col-md-2">
                                    <input type="date" class="form-control" id="auditEndDate" onchange="loadAuditLogs()" title="End Date">
                                </div>
                            </div>

                            <!-- Controls Row 2 -->
                            <div class="row g-2 mb-3">
                                <div class="col-md-2">
                                    <select class="form-select form-select-sm" id="auditPerPage" onchange="loadAuditLogs()">
                                        <option value="25">25 per page</option>
                                        <option value="50" selected>50 per page</option>
                                        <option value="100">100 per page</option>
                                        <option value="200">200 per page</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select form-select-sm" id="auditSortField" onchange="loadAuditLogs()">
                                        <option value="timestamp">Sort: Time</option>
                                        <option value="action">Sort: Action</option>
                                        <option value="resource">Sort: Resource</option>
                                        <option value="user_id">Sort: User</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select form-select-sm" id="auditSortOrder" onchange="loadAuditLogs()">
                                        <option value="desc">Newest First</option>
                                        <option value="asc">Oldest First</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAuditFilters()">
                                        <i class="bi bi-x-circle me-1"></i>Clear Filters
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadAuditLogs()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                    </button>
                                </div>
                                <div class="col-md-3 text-end">
                                    <span id="auditLogsInfo" class="text-muted small"></span>
                                </div>
                            </div>

                            <!-- Audit Logs Table -->
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-hover table-sm" id="auditLogsTableContainer">
                                    <thead class="sticky-top bg-light">
                                        <tr>
                                            <th style="width: 160px; cursor: pointer;" onclick="sortAuditLogs('timestamp')">
                                                Timestamp <i class="bi bi-arrow-down-up text-muted"></i>
                                            </th>
                                            <th style="width: 120px; cursor: pointer;" onclick="sortAuditLogs('action')">
                                                Action <i class="bi bi-arrow-down-up text-muted"></i>
                                            </th>
                                            <th style="width: 150px; cursor: pointer;" onclick="sortAuditLogs('resource')">
                                                Resource <i class="bi bi-arrow-down-up text-muted"></i>
                                            </th>
                                            <th style="width: 120px; cursor: pointer;" onclick="sortAuditLogs('user_id')">
                                                User <i class="bi bi-arrow-down-up text-muted"></i>
                                            </th>
                                            <th style="width: 120px;">IP Address</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditLogsTable">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-4">
                                                <i class="bi bi-arrow-repeat spin me-2"></i>Loading audit logs...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <div class="d-flex justify-content-between align-items-center mt-3" id="auditPaginationContainer">
                                <div>
                                    <span id="auditPaginationInfo" class="text-muted small"></span>
                                </div>
                                <nav>
                                    <ul class="pagination pagination-sm mb-0" id="auditPagination">
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compliance Reports -->
                <div class="tab-pane fade" id="complianceReports" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-clipboard-check me-2"></i>Compliance Reports
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>CISA BOD 22-01 Compliance:</strong> Generate reports showing your organization's compliance status with
                                <a href="https://www.cisa.gov/binding-operational-directive-22-01" target="_blank">CISA Binding Operational Directive 22-01</a>,
                                which requires remediation of Known Exploited Vulnerabilities (KEV) by their designated due dates.
                            </div>

                            <!-- Compliance Overview Cards -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-light h-100">
                                        <div class="card-body text-center">
                                            <h6 class="card-subtitle mb-2 text-muted">Total KEV Matches</h6>
                                            <h2 class="card-title mb-0" id="complianceTotalMatches">-</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white h-100">
                                        <div class="card-body text-center">
                                            <h6 class="card-subtitle mb-2 opacity-75">Acknowledged</h6>
                                            <h2 class="card-title mb-0" id="complianceAcknowledged">-</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning h-100">
                                        <div class="card-body text-center">
                                            <h6 class="card-subtitle mb-2">Pending Review</h6>
                                            <h2 class="card-title mb-0" id="compliancePending">-</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white h-100">
                                        <div class="card-body text-center">
                                            <h6 class="card-subtitle mb-2 opacity-75">Overdue</h6>
                                            <h2 class="card-title mb-0" id="complianceOverdue">-</h2>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Compliance Percentage -->
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-semibold">Overall Compliance Rate</span>
                                        <span class="h4 mb-0" id="compliancePercentage">-</span>
                                    </div>
                                    <div class="progress" style="height: 24px;">
                                        <div class="progress-bar bg-success" role="progressbar" id="complianceProgressBar"
                                             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted mt-1 d-block">Percentage of KEV vulnerabilities that have been acknowledged/remediated</small>
                                </div>
                            </div>

                            <!-- Report Actions -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-file-earmark-text me-2"></i>BOD 22-01 Compliance Report
                                            </h6>
                                            <p class="card-text text-muted small">
                                                Full compliance report including all KEV vulnerabilities, their status, due dates,
                                                overdue items, and severity breakdown.
                                            </p>
                                            <div class="btn-group">
                                                <button class="btn btn-primary" onclick="downloadComplianceReport('json')">
                                                    <i class="bi bi-filetype-json me-1"></i>JSON
                                                </button>
                                                <button class="btn btn-outline-primary" onclick="downloadComplianceReport('csv')">
                                                    <i class="bi bi-filetype-csv me-1"></i>CSV
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-globe-europe-africa me-2"></i>NIS2 Compliance Report
                                            </h6>
                                            <p class="card-text text-muted small">
                                                EU Directive 2022/2555 Article 21 assessment. Maps vulnerability handling,
                                                supply chain visibility, and cyber hygiene to NIS2 requirements.
                                            </p>
                                            <div class="btn-group">
                                                <button class="btn btn-primary" onclick="downloadNIS2Report('json')">
                                                    <i class="bi bi-filetype-json me-1"></i>JSON
                                                </button>
                                                <button class="btn btn-outline-primary" onclick="downloadNIS2Report('csv')">
                                                    <i class="bi bi-filetype-csv me-1"></i>CSV
                                                </button>
                                                <button class="btn btn-outline-primary" onclick="downloadNIS2Report('pdf')">
                                                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-exclamation-triangle me-2"></i>Overdue Items Report
                                            </h6>
                                            <p class="card-text text-muted small">
                                                List of all vulnerabilities that have exceeded their CISA-mandated due dates
                                                and require immediate attention.
                                            </p>
                                            <button class="btn btn-danger" onclick="downloadOverdueReport()">
                                                <i class="bi bi-download me-1"></i>Download Overdue Report
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-file-earmark-bar-graph me-2"></i>Executive Summary
                                            </h6>
                                            <p class="card-text text-muted small">
                                                One-page PDF for board/management. Risk score, KPIs, severity breakdown,
                                                top priorities, and remediation metrics.
                                            </p>
                                            <div class="btn-group">
                                                <button class="btn btn-primary" onclick="downloadExecutiveSummary('pdf')">
                                                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                                                </button>
                                                <button class="btn btn-outline-primary" onclick="downloadExecutiveSummary('json')">
                                                    <i class="bi bi-filetype-json me-1"></i>JSON
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Severity Breakdown -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="bi bi-bar-chart me-2"></i>Pending by Severity
                                </div>
                                <div class="card-body">
                                    <div class="row text-center" id="complianceSeverityBreakdown">
                                        <div class="col">
                                            <span class="badge bg-danger fs-5" id="severityCritical">0</span>
                                            <div class="small text-muted mt-1">Critical</div>
                                        </div>
                                        <div class="col">
                                            <span class="badge bg-warning text-dark fs-5" id="severityHigh">0</span>
                                            <div class="small text-muted mt-1">High</div>
                                        </div>
                                        <div class="col">
                                            <span class="badge bg-info text-dark fs-5" id="severityMedium">0</span>
                                            <div class="small text-muted mt-1">Medium</div>
                                        </div>
                                        <div class="col">
                                            <span class="badge bg-success fs-5" id="severityLow">0</span>
                                            <div class="small text-muted mt-1">Low</div>
                                        </div>
                                        <div class="col">
                                            <span class="badge bg-secondary fs-5" id="severityUnknown">0</span>
                                            <div class="small text-muted mt-1">Unknown</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ransomware Exposure -->
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-shield-exclamation me-2"></i>Ransomware Exposure</span>
                                    <span class="badge bg-danger" id="ransomwareExposureCount">0</span>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small mb-2">
                                        Number of unacknowledged vulnerabilities that are known to be used in ransomware campaigns.
                                        These should be prioritized for immediate remediation.
                                    </p>
                                    <div id="ransomwareExposureDetails" class="text-muted">
                                        Click "Refresh Data" to load compliance statistics.
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 text-center">
                                <button class="btn btn-primary" onclick="loadComplianceData()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- License Settings -->
                <div class="tab-pane fade" id="licenseSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-key me-2"></i>License Management</span>
                            <span class="badge" id="licenseEditionBadge">Loading...</span>
                        </div>
                        <div class="card-body">
                            <!-- Current License Status -->
                            <div id="licenseStatusCard" class="mb-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h5 class="card-title mb-3">
                                                    <i class="bi bi-shield-check me-2"></i>Current License
                                                </h5>
                                                <div id="licenseDetails">
                                                    <div class="text-center py-3">
                                                        <div class="spinner-border spinner-border-sm text-primary"></div>
                                                        <span class="ms-2">Loading license info...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h5 class="card-title mb-3">
                                                    <i class="bi bi-bar-chart me-2"></i>Usage
                                                </h5>
                                                <div id="licenseUsage">
                                                    <div class="text-center py-3">
                                                        <div class="spinner-border spinner-border-sm text-primary"></div>
                                                        <span class="ms-2">Loading usage data...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Installation ID (for requesting licenses) -->
                            <div class="card mb-4">
                                <div class="card-header bg-info text-white">
                                    <i class="bi bi-fingerprint me-2"></i>Your Installation ID
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-2">
                                        <strong>To request a license:</strong> Send this Installation ID to SentriKat sales along with your company details.
                                        Each license is locked to a specific installation.
                                    </p>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control font-monospace bg-light" id="installationIdDisplay" readonly value="Loading...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyInstallationId()">
                                            <i class="bi bi-clipboard"></i> Copy
                                        </button>
                                    </div>
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        This ID is unique to your installation and cannot be changed.
                                    </small>
                                </div>
                            </div>

                            <!-- Online Activation -->
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <i class="bi bi-cloud-arrow-up me-2"></i>Activate Online
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-3">
                                        Enter your activation code from the purchase confirmation email.
                                        Requires HTTPS connectivity to <code>license.sentrikat.com</code>.
                                    </p>
                                    <div class="mb-3">
                                        <label for="activationCodeInput" class="form-label fw-semibold">Activation Code</label>
                                        <input type="text" class="form-control font-monospace" id="activationCodeInput" placeholder="e.g. SK-XXXX-XXXX-XXXX-XXXX">
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="activateLicenseOnline()" id="onlineActivateBtn">
                                        <i class="bi bi-cloud-check me-1"></i>Activate Online
                                    </button>
                                    <div id="onlineActivateStatus" class="mt-2" style="display: none;"></div>
                                </div>
                            </div>

                            <!-- Offline License Key Input -->
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-key-fill me-2"></i>Activate Offline
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-3">
                                        No internet? Paste the license key received from SentriKat support.
                                        The license must be generated for this specific installation.
                                    </p>
                                    <div class="mb-3">
                                        <label for="licenseKeyInput" class="form-label fw-semibold">License Key</label>
                                        <textarea class="form-control font-monospace" id="licenseKeyInput" rows="3" placeholder="Paste your license key here..."></textarea>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="activateLicense()">
                                            <i class="bi bi-check-circle me-1"></i>Activate License
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" onclick="removeLicense()" id="removeLicenseBtn" style="display: none;">
                                            <i class="bi bi-x-circle me-1"></i>Remove License
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Feature Comparison (Collapsible) -->
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center" role="button"
                                     data-bs-toggle="collapse" data-bs-target="#featureComparisonBody" aria-expanded="false">
                                    <span><i class="bi bi-list-check me-2"></i>Feature Comparison</span>
                                    <i class="bi bi-chevron-down" id="featureComparisonChevron"></i>
                                </div>
                                <div class="collapse" id="featureComparisonBody">
                                <div class="card-body p-0">
                                    <table class="table table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th>Feature</th>
                                                <th class="text-center">Demo</th>
                                                <th class="text-center">Professional</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Vulnerability Management</td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>CISA KEV Sync</td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Dashboard & Reporting</td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Agents</td>
                                                <td class="text-center">5</td>
                                                <td class="text-center text-success">10+</td>
                                            </tr>
                                            <tr>
                                                <td>Users</td>
                                                <td class="text-center">1</td>
                                                <td class="text-center text-success">Unlimited</td>
                                            </tr>
                                            <tr>
                                                <td>Organizations</td>
                                                <td class="text-center">1</td>
                                                <td class="text-center text-success">Unlimited</td>
                                            </tr>
                                            <tr>
                                                <td>Products</td>
                                                <td class="text-center">50</td>
                                                <td class="text-center text-success">Unlimited</td>
                                            </tr>
                                            <tr>
                                                <td>LDAP / Active Directory</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>SAML SSO</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Email Alerts</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Webhooks</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Issue Trackers (Jira, GitHub, GitLab)</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Scheduled Reports</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Push Agents</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>API Access</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>White-Labeling</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Backup & Restore</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Audit Log Export</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Compliance Reports</td>
                                                <td class="text-center text-muted"><i class="bi bi-x-lg"></i></td>
                                                <td class="text-center text-success"><i class="bi bi-check-lg"></i></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                </div><!-- end collapse -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Guide -->
                <div class="tab-pane fade" id="guideSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-book me-2"></i>Administration & Troubleshooting Guide
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <!-- Log Files Section -->
                                <div class="col-12">
                                    <h5 class="fw-bold"><i class="bi bi-journal-text me-2 text-primary"></i>Log Files</h5>
                                    <p class="text-muted mb-2">SentriKat writes structured logs to <code>/var/log/sentrikat/</code> (configurable via <code>LOG_DIR</code> env var).</p>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped mb-3">
                                            <thead><tr><th>File</th><th>Contents</th><th>Level</th></tr></thead>
                                            <tbody>
                                                <tr><td><code>application.log</code></td><td>General application events, startup, sync operations</td><td>INFO+</td></tr>
                                                <tr><td><code>error.log</code></td><td>Errors and critical failures only</td><td>ERROR+</td></tr>
                                                <tr><td><code>security.log</code></td><td>Login attempts, permission denials, auth events</td><td>WARNING+</td></tr>
                                                <tr><td><code>access.log</code></td><td>HTTP request log (method, URL, status, duration)</td><td>INFO</td></tr>
                                                <tr><td><code>audit.log</code></td><td>Data modification trail (JSON format) &mdash; who changed what</td><td>INFO</td></tr>
                                                <tr><td><code>performance.log</code></td><td>Slow queries and endpoints (JSON format)</td><td>INFO</td></tr>
                                                <tr><td><code>ldap.log</code></td><td>LDAP/AD operations and sync events</td><td>INFO</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <p class="small text-muted mb-0">Logs rotate automatically (10-20 MB per file, up to 50 backups for audit logs). You can view them in the <a href="#" onclick="showSettingsGroup('logs', document.getElementById('logs-settings-tab'));return false;">Logs tab</a> above.</p>
                                </div>

                                <!-- Docker Commands Section -->
                                <div class="col-12">
                                    <h5 class="fw-bold"><i class="bi bi-terminal me-2 text-success"></i>Docker Commands</h5>
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <tbody>
                                                <tr>
                                                    <td style="width: 40%;"><code>docker-compose logs -f sentrikat</code></td>
                                                    <td>Follow live application logs (stdout/stderr)</td>
                                                </tr>
                                                <tr>
                                                    <td><code>docker-compose logs --tail=500 sentrikat</code></td>
                                                    <td>Show last 500 lines of container output</td>
                                                </tr>
                                                <tr>
                                                    <td><code>docker-compose exec sentrikat cat /var/log/sentrikat/error.log</code></td>
                                                    <td>Read the error log directly inside the container</td>
                                                </tr>
                                                <tr>
                                                    <td><code>docker-compose exec sentrikat tail -f /var/log/sentrikat/application.log</code></td>
                                                    <td>Follow the application log in real-time</td>
                                                </tr>
                                                <tr>
                                                    <td><code>docker-compose restart sentrikat</code></td>
                                                    <td>Restart the application container</td>
                                                </tr>
                                                <tr>
                                                    <td><code>docker-compose exec db psql -U sentrikat</code></td>
                                                    <td>Open a PostgreSQL shell (for advanced troubleshooting)</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Health Checks Section -->
                                <div class="col-12">
                                    <h5 class="fw-bold"><i class="bi bi-heart-pulse me-2 text-danger"></i>Health Checks</h5>
                                    <p class="text-muted mb-2">SentriKat runs background health checks every 30 minutes. View results in the <a href="#" onclick="showSettingsGroup('health', document.getElementById('health-settings-tab'));return false;">Health Checks tab</a>. You can also trigger them via the API:</p>
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-2">
                                            <tbody>
                                                <tr>
                                                    <td style="width: 40%;"><code>POST /api/admin/health-checks/run</code></td>
                                                    <td>Run all health checks and return results</td>
                                                </tr>
                                                <tr>
                                                    <td><code>GET /api/admin/health-checks</code></td>
                                                    <td>Get latest health check results (JSON)</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <p class="small text-muted mb-0">Health check notifications also appear in the notification banner at the top of the page when issues are detected.</p>
                                </div>

                                <!-- Agent Management Section -->
                                <div class="col-12">
                                    <h5 class="fw-bold"><i class="bi bi-cpu me-2 text-primary"></i>Agent Management</h5>
                                    <p class="text-muted mb-2">Discovery agents are lightweight scripts that scan endpoints for installed software and report back to SentriKat. The server URL and API key are <strong>embedded automatically</strong> when you download from <a href="#" onclick="showSettingsGroup('integrations', document.getElementById('integrations-settings-tab'));return false;">Integrations &gt; Push Agents</a>.</p>

                                    <div class="accordion" id="agentManagementAccordion">
                                        <!-- Windows -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#agentWindows">
                                                    <i class="bi bi-windows text-primary me-2"></i>Windows Agent
                                                </button>
                                            </h2>
                                            <div id="agentWindows" class="accordion-collapse collapse" data-bs-parent="#agentManagementAccordion">
                                                <div class="accordion-body small">
                                                    <p class="fw-semibold mb-1">Test (single scan, no install):</p>
                                                    <div class="bg-dark text-light rounded p-2 mb-2 font-monospace" style="font-size: 0.75rem;">powershell -ExecutionPolicy Bypass -File .\sentrikat-agent-windows.ps1 -RunOnce</div>

                                                    <p class="fw-semibold mb-1">Install (scheduled task &mdash; scan every 4h + heartbeat every 5min):</p>
                                                    <div class="bg-dark text-light rounded p-2 mb-2 font-monospace" style="font-size: 0.75rem;">
                                                        powershell -ExecutionPolicy Bypass -File .\sentrikat-agent-windows.ps1 -Install
                                                    </div>

                                                    <p class="fw-semibold mb-1">Install as Windows Service (alternative):</p>
                                                    <div class="bg-dark text-light rounded p-2 mb-2 font-monospace" style="font-size: 0.75rem;">
                                                        powershell -ExecutionPolicy Bypass -File .\sentrikat-agent-windows.ps1 -InstallService
                                                    </div>

                                                    <p class="fw-semibold mb-1 text-danger">Uninstall:</p>
                                                    <div class="bg-dark text-light rounded p-2 mb-2 font-monospace" style="font-size: 0.75rem;">
                                                        powershell -ExecutionPolicy Bypass -File .\sentrikat-agent-windows.ps1 -Uninstall
                                                    </div>
                                                    <p class="text-muted mb-0">Optionally remove the endpoint from <strong>Inventory &gt; Endpoints</strong> in this panel.</p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Linux -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#agentLinux">
                                                    <i class="bi bi-ubuntu text-success me-2"></i>Linux Agent
                                                </button>
                                            </h2>
                                            <div id="agentLinux" class="accordion-collapse collapse" data-bs-parent="#agentManagementAccordion">
                                                <div class="accordion-body small">
                                                    <p class="fw-semibold mb-1">Test (single scan, no install):</p>
                                                    <div class="bg-dark text-light rounded p-2 mb-2 font-monospace" style="font-size: 0.75rem;">chmod +x sentrikat-agent-linux.sh &amp;&amp; sudo ./sentrikat-agent-linux.sh --run-once</div>

                                                    <p class="fw-semibold mb-1">Install (systemd service &mdash; scan every 4h + heartbeat every 5min):</p>
                                                    <div class="bg-dark text-light rounded p-2 mb-2 font-monospace" style="font-size: 0.75rem;">
                                                        chmod +x sentrikat-agent-linux.sh &amp;&amp; sudo ./sentrikat-agent-linux.sh --install
                                                    </div>

                                                    <p class="fw-semibold mb-1 text-danger">Uninstall:</p>
                                                    <div class="bg-dark text-light rounded p-2 mb-2 font-monospace" style="font-size: 0.75rem;">
                                                        sudo /usr/local/bin/sentrikat-agent --uninstall
                                                    </div>
                                                    <p class="text-muted mb-0">Optionally remove the endpoint from <strong>Inventory &gt; Endpoints</strong> in this panel.</p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- macOS -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#agentMacos">
                                                    <i class="bi bi-apple text-dark me-2"></i>macOS Agent
                                                </button>
                                            </h2>
                                            <div id="agentMacos" class="accordion-collapse collapse" data-bs-parent="#agentManagementAccordion">
                                                <div class="accordion-body small">
                                                    <p class="fw-semibold mb-1">Test (single scan, no install):</p>
                                                    <div class="bg-dark text-light rounded p-2 mb-2 font-monospace" style="font-size: 0.75rem;">chmod +x sentrikat-agent-macos.sh &amp;&amp; sudo ./sentrikat-agent-macos.sh --run-once</div>

                                                    <p class="fw-semibold mb-1">Install (LaunchDaemon &mdash; scan every 4h + heartbeat every 5min):</p>
                                                    <div class="bg-dark text-light rounded p-2 mb-2 font-monospace" style="font-size: 0.75rem;">
                                                        chmod +x sentrikat-agent-macos.sh &amp;&amp; sudo ./sentrikat-agent-macos.sh --install
                                                    </div>

                                                    <p class="fw-semibold mb-1 text-danger">Uninstall:</p>
                                                    <div class="bg-dark text-light rounded p-2 mb-2 font-monospace" style="font-size: 0.75rem;">
                                                        sudo /usr/local/bin/sentrikat-agent --uninstall
                                                    </div>
                                                    <p class="text-muted mb-0">Optionally remove the endpoint from <strong>Inventory &gt; Endpoints</strong> in this panel.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="alert alert-info small py-2 mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i><strong>Note:</strong> The downloaded scripts have the server URL and API key pre-embedded. No <code>-ServerUrl</code> or <code>-ApiKey</code> parameters are needed. Just run the script directly.
                                    </div>
                                </div>

                                <!-- Common Troubleshooting Section -->
                                <div class="col-12">
                                    <h5 class="fw-bold"><i class="bi bi-wrench me-2 text-warning"></i>Common Troubleshooting</h5>
                                    <div class="accordion" id="troubleshootingAccordion">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ts1">Health checks show "column does not exist" errors</button></h2>
                                            <div id="ts1" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                                <div class="accordion-body small">Database schema is out of date. Restart the container &mdash; SentriKat auto-applies schema migrations on startup. If the issue persists, check <code>error.log</code> for the specific column name and verify the migration list in <code>app/__init__.py</code>.</div>
                                            </div>
                                        </div>
                                        <div class="accordion-item">
                                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ts2">Agents not reporting / stuck offline</button></h2>
                                            <div id="ts2" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                                <div class="accordion-body small">Check: (1) Agent API key is active and not expired &mdash; go to Integrations &gt; Push Agents. (2) Agent can reach the server URL. (3) Check <code>security.log</code> for 401/403 errors from agent IPs. (4) Verify the agent service is running on the host (<code>systemctl status sentrikat-agent</code> or check Task Scheduler on Windows).</div>
                                            </div>
                                        </div>
                                        <div class="accordion-item">
                                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ts3">CVE sync failing or stale data</button></h2>
                                            <div id="ts3" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                                <div class="accordion-body small">Check: (1) Network connectivity from the container to the internet. (2) If behind a proxy, set <code>HTTP_PROXY</code> / <code>HTTPS_PROXY</code> env vars in docker-compose.yml and configure proxy in Settings &gt; System &gt; General. (3) Check <code>application.log</code> for sync errors. (4) Try a manual sync from the Dashboard sync button.</div>
                                            </div>
                                        </div>
                                        <div class="accordion-item">
                                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ts4">Email alerts not being sent</button></h2>
                                            <div id="ts4" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                                <div class="accordion-body small">Check: (1) SMTP is configured in Settings &gt; Email &amp; Alerts (check the health check status for SMTP). (2) Verify the SMTP host is reachable from inside the container: <code>docker-compose exec sentrikat python -c "import socket; print(socket.create_connection(('smtp-host', 587), 5))"</code>. (3) Check <code>error.log</code> for SMTP connection errors. (4) Ensure alert recipients are configured for the organization.</div>
                                            </div>
                                        </div>
                                        <div class="accordion-item">
                                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ts5">Slow performance or high memory usage</button></h2>
                                            <div id="ts5" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                                <div class="accordion-body small">Check <code>performance.log</code> for slow endpoints and queries. Common fixes: (1) Ensure database has enough resources &mdash; check <code>docker stats</code>. (2) Review data retention settings (Settings &gt; System &gt; Data Retention) to prune old records. (3) Consider increasing container memory limits in docker-compose.yml. The health check for disk space and database response time can also help identify issues.</div>
                                            </div>
                                        </div>
                                        <div class="accordion-item">
                                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ts6">500 Internal Server Error</button></h2>
                                            <div id="ts6" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                                <div class="accordion-body small">Check <code>error.log</code> for the full stack trace. Common causes: (1) Missing database columns &mdash; restart to apply migrations. (2) Database connection pool exhausted &mdash; restart the container. (3) Disk full &mdash; check disk space health check. Copy the traceback from the error log when reporting issues.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Scaling & Performance Section -->
                                <div class="col-12">
                                    <h5 class="fw-bold"><i class="bi bi-speedometer2 me-2 text-success"></i>Scaling &amp; Performance</h5>
                                    <p class="text-muted mb-2">SentriKat uses a <strong>concurrent worker pool</strong> for processing inventory jobs. Tune these settings based on your deployment size:</p>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped mb-2">
                                            <thead><tr><th>Deployment</th><th>Agents</th><th>GUNICORN_WORKERS</th><th>WORKER_POOL_SIZE</th><th>DB_POOL_SIZE</th><th>PG_MAX_CONNECTIONS</th></tr></thead>
                                            <tbody>
                                                <tr><td>Small</td><td>&lt; 100</td><td>4</td><td>2</td><td>5</td><td>100</td></tr>
                                                <tr><td>Medium</td><td>100 &ndash; 1K</td><td>8</td><td>4</td><td>10</td><td>300</td></tr>
                                                <tr><td>Large</td><td>1K &ndash; 5K</td><td>12</td><td>8</td><td>15</td><td>500</td></tr>
                                                <tr class="table-success"><td><strong>Enterprise</strong></td><td>5K &ndash; 10K+</td><td>16</td><td>16</td><td>20</td><td>800</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="small text-muted mb-2">
                                        <strong>Worker Pool:</strong> Processes inventory jobs concurrently (not one at a time).
                                        <code>WORKER_POOL_SIZE=8</code> means 8 jobs processed simultaneously.<br>
                                        <strong>Retry:</strong> Failed jobs retry up to 5 times with exponential backoff (10s, 20s, 40s, 80s, 160s).<br>
                                        <strong>Rule of thumb:</strong> 1 CPU core per 2 Gunicorn workers, 256MB RAM per worker.
                                    </div>
                                    <div class="d-flex gap-2 mb-2">
                                        <a href="/api/admin/worker-status" target="_blank" class="btn btn-outline-success btn-sm">
                                            <i class="bi bi-activity me-1"></i>Worker Pool Status (API)
                                        </a>
                                    </div>
                                    <div class="alert alert-info small py-2 mb-0">
                                        <i class="bi bi-lightbulb me-1"></i><strong>Load Testing:</strong>
                                        Use <code>POST /api/admin/worker/simulate-load</code> to stress-test the worker pool without real agents.
                                        Example: <code>{"num_jobs": 200, "products_per_job": 100}</code> creates 200 synthetic jobs.
                                        Clean up with <code>DELETE /api/admin/worker/load-test-cleanup</code>.
                                    </div>
                                </div>

                                <!-- API Documentation Section -->
                                <div class="col-12">
                                    <h5 class="fw-bold"><i class="bi bi-code-slash me-2 text-info"></i>API Documentation</h5>
                                    <p class="text-muted mb-2">Interactive API documentation is available at:</p>
                                    <div class="d-flex gap-3">
                                        <a href="/api/docs" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-file-earmark-code me-1"></i>Swagger UI (Interactive)
                                        </a>
                                        <a href="/api/spec.json" target="_blank" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-filetype-json me-1"></i>OpenAPI Spec (JSON)
                                        </a>
                                    </div>
                                </div>

                                <!-- Key Environment Variables -->
                                <div class="col-12">
                                    <h5 class="fw-bold"><i class="bi bi-gear me-2 text-secondary"></i>Key Environment Variables</h5>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped mb-0">
                                            <thead><tr><th>Variable</th><th>Description</th><th>Default</th></tr></thead>
                                            <tbody>
                                                <tr><td><code>SECRET_KEY</code></td><td>Flask session secret (change in production)</td><td>Random</td></tr>
                                                <tr><td><code>ENCRYPTION_KEY</code></td><td>Fernet key for encrypting sensitive settings</td><td>Derived from SECRET_KEY</td></tr>
                                                <tr><td><code>DATABASE_URL</code></td><td>PostgreSQL connection string</td><td>postgresql://...@db:5432/sentrikat</td></tr>
                                                <tr><td><code>SENTRIKAT_LICENSE</code></td><td>License key (alternative to GUI activation)</td><td>&mdash;</td></tr>
                                                <tr><td><code>LOG_DIR</code></td><td>Directory for log files</td><td>/var/log/sentrikat</td></tr>
                                                <tr><td><code>SMTP_HOST</code></td><td>SMTP server hostname</td><td>&mdash;</td></tr>
                                                <tr><td><code>HTTP_PROXY</code> / <code>HTTPS_PROXY</code></td><td>Proxy for outbound connections</td><td>&mdash;</td></tr>
                                                <tr class="table-info"><td colspan="3"><strong>Performance Tuning</strong></td></tr>
                                                <tr><td><code>GUNICORN_WORKERS</code></td><td>Web server worker processes</td><td>auto (CPU*2+1, max 16)</td></tr>
                                                <tr><td><code>GUNICORN_THREADS</code></td><td>Threads per Gunicorn worker</td><td>4</td></tr>
                                                <tr><td><code>WORKER_POOL_SIZE</code></td><td>Concurrent inventory job workers</td><td>4</td></tr>
                                                <tr><td><code>DB_POOL_SIZE</code></td><td>DB connections per Gunicorn worker</td><td>10</td></tr>
                                                <tr><td><code>DB_POOL_MAX_OVERFLOW</code></td><td>Extra burst DB connections</td><td>20</td></tr>
                                                <tr><td><code>PG_MAX_CONNECTIONS</code></td><td>PostgreSQL max connections</td><td>300</td></tr>
                                                <tr><td><code>PG_SHARED_BUFFERS</code></td><td>PostgreSQL shared memory cache</td><td>256MB</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Log Viewer -->
                <div class="tab-pane fade" id="logsSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-journal-text me-2"></i>System Logs</span>
                            <div class="d-flex gap-2 align-items-center">
                                <select class="form-select form-select-sm" id="logFileSelect" onchange="loadLogFile()" style="width: auto;">
                                    <option value="application">Application</option>
                                    <option value="error">Errors</option>
                                    <option value="security">Security</option>
                                    <option value="access">Access</option>
                                    <option value="audit">Audit</option>
                                    <option value="performance">Performance</option>
                                    <option value="ldap">LDAP</option>
                                </select>
                                <select class="form-select form-select-sm" id="logLevelFilter" onchange="loadLogFile()" style="width: auto;">
                                    <option value="">All Levels</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="INFO">INFO</option>
                                    <option value="DEBUG">DEBUG</option>
                                </select>
                                <div class="input-group input-group-sm" style="width: 220px;">
                                    <input type="text" class="form-control" id="logSearchInput" placeholder="Search logs..." onkeydown="if(event.key==='Enter')loadLogFile()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="loadLogFile()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                                <select class="form-select form-select-sm" id="logLinesCount" onchange="loadLogFile()" style="width: auto;">
                                    <option value="100">100 lines</option>
                                    <option value="200" selected>200 lines</option>
                                    <option value="500">500 lines</option>
                                    <option value="1000">1000 lines</option>
                                    <option value="3000">3000 lines</option>
                                </select>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadLogFile()" title="Refresh">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="downloadLogFile()" title="Download">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="logFileInfo" class="px-3 py-2 border-bottom small text-muted d-flex justify-content-between">
                                <span id="logFileStats"></span>
                                <span id="logFilePath"></span>
                            </div>
                            <div id="logViewerContainer" style="height: 600px; overflow-y: auto; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 0.78rem; line-height: 1.5;">
                                <div class="text-center py-4">
                                    <span class="text-muted">Select a log file to view</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health Checks Settings -->
                <div class="tab-pane fade" id="healthSettings" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-heart-pulse me-2"></i>Background Health Checks</span>
                            <div>
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="runHealthChecksNow()">
                                    <i class="bi bi-play-circle me-1"></i>Run Now
                                </button>
                                <div class="form-check form-switch d-inline-flex align-items-center mb-0">
                                    <input class="form-check-input" type="checkbox" id="healthChecksGlobalToggle" onchange="toggleHealthChecksGlobal(this.checked)">
                                    <label class="form-check-label ms-2 fw-semibold" for="healthChecksGlobalToggle">Enabled</label>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                SentriKat runs background health checks every 30 minutes to monitor system components.
                                Problems and warnings are reported via email notifications and shown here.
                            </p>

                            <!-- Notification Email -->
                            <div class="mb-3">
                                <label for="healthCheckNotifyEmail" class="form-label fw-semibold">Notification Email</label>
                                <div class="input-group">
                                    <input type="email" class="form-control" id="healthCheckNotifyEmail" placeholder="admin@example.com">
                                    <button class="btn btn-outline-primary" type="button" onclick="saveHealthCheckSettings()">
                                        <i class="bi bi-check-lg me-1"></i>Save
                                    </button>
                                </div>
                                <small class="text-muted">Receive email alerts when health checks detect problems (leave empty to disable email notifications)</small>
                            </div>

                            <!-- Webhook Notifications -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="healthCheckWebhookToggle" onchange="saveHealthCheckSettings()">
                                    <label class="form-check-label fw-semibold" for="healthCheckWebhookToggle">Send alerts via webhooks</label>
                                </div>
                                <small class="text-muted">Send health check alerts to all configured webhooks (Slack, Teams, etc.) when problems are detected</small>
                            </div>

                            <!-- Health Check Results -->
                            <div id="healthCheckResults">
                                <div class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary"></div>
                                    <span class="ms-2">Loading health check results...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Create Agent Key Modal -->
<div class="modal fade" id="agentKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-key-fill me-2"></i>Create Agent API Key
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="agentKeyForm">
                    <div class="mb-3">
                        <label for="agentKeyName" class="form-label fw-semibold">Key Name</label>
                        <input type="text" class="form-control" id="agentKeyName" required placeholder="e.g., Production Servers">
                    </div>
                    <div class="mb-3">
                        <label for="agentKeyType" class="form-label fw-semibold">Key Type</label>
                        <select class="form-select" id="agentKeyType">
                            <option value="server">Server</option>
                            <option value="client">Client</option>
                        </select>
                        <small class="text-muted">Classifies endpoints and software reported by this key. Use "Server" for infrastructure and "Client" for workstations/desktops.</small>
                    </div>
                    <div class="mb-3">
                        <label for="agentKeyOrg" class="form-label fw-semibold">Primary Organization</label>
                        <select class="form-select" id="agentKeyOrg" required>
                            <option value="">Select organization...</option>
                        </select>
                        <small class="text-muted">Primary organization for this agent key. The asset will be registered here.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Additional Organizations <span class="badge bg-secondary-subtle text-secondary">Optional</span></label>
                        <div id="agentKeyAdditionalOrgs" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            <small class="text-muted">Select a primary organization first</small>
                        </div>
                        <small class="text-muted">Software reported by this agent will also appear in these organizations (without mixing data between them)</small>
                    </div>
                    <div class="mb-3">
                        <label for="agentKeyMaxAssets" class="form-label fw-semibold">Max Assets</label>
                        <input type="number" class="form-control" id="agentKeyMaxAssets" min="0" value="0">
                        <small class="text-muted">Maximum assets this key can manage (0 = unlimited)</small>
                    </div>
                    <div class="mb-3">
                        <label for="agentKeyExpires" class="form-label fw-semibold">Expires</label>
                        <input type="date" class="form-control" id="agentKeyExpires">
                        <small class="text-muted">Leave empty for no expiration</small>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Scan Capabilities</label>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="agentKeyScanOsPackages" checked>
                            <label class="form-check-label" for="agentKeyScanOsPackages">
                                <i class="bi bi-box me-1"></i>OS Packages
                            </label>
                            <small class="text-muted d-block ms-4">Scan installed operating system packages and software</small>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="agentKeyScanExtensions">
                            <label class="form-check-label" for="agentKeyScanExtensions">
                                <i class="bi bi-puzzle me-1"></i>Extensions
                            </label>
                            <small class="text-muted d-block ms-4">Scan browser extensions (Chrome, Firefox, Edge), IDE plugins (VS Code, JetBrains), and more</small>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="agentKeyScanDependencies">
                            <label class="form-check-label" for="agentKeyScanDependencies">
                                <i class="bi bi-book me-1"></i>Code Dependencies
                            </label>
                            <small class="text-muted d-block ms-4">Scan code libraries and dependencies (pip, npm, cargo, gem, go, composer)</small>
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="agentKeyAutoApprove">
                            <label class="form-check-label fw-semibold" for="agentKeyAutoApprove">
                                Auto-approve new products
                            </label>
                        </div>
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-info-circle me-1"></i>
                            When enabled, software reported by agents using this key will be added directly to your inventory.
                            When disabled, new products go to the Import Queue for manual review first.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createAgentKey()">
                    <i class="bi bi-plus-lg me-1"></i>Create Key
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Show Agent Key Modal (displays newly created key) -->
<div class="modal fade" id="showAgentKeyModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle me-2"></i>API Key Created
                </h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Your API key is ready.</strong> It is securely stored and will be embedded automatically when you download agent scripts.
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">API Key</label>
                    <div class="input-group">
                        <input type="text" class="form-control font-monospace bg-light" id="newAgentKeyValue" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyAgentKey()">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                <!-- Download agents with embedded key -->
                <div class="card border-primary mt-3">
                    <div class="card-header bg-primary text-white py-2">
                        <i class="bi bi-download me-2"></i>Download Agent with Embedded Key
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-3">Download a ready-to-run agent script with this API key already embedded:</p>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary flex-fill" onclick="downloadAgentFromModal('windows')">
                                <i class="bi bi-windows me-2"></i>Windows
                            </button>
                            <button type="button" class="btn btn-outline-success flex-fill" onclick="downloadAgentFromModal('linux')">
                                <i class="bi bi-ubuntu me-2"></i>Linux
                            </button>
                            <button type="button" class="btn btn-outline-dark flex-fill" onclick="downloadAgentFromModal('macos')">
                                <i class="bi bi-apple me-2"></i>macOS
                            </button>
                        </div>
                        <!-- Quick Start Instructions -->
                        <div class="mt-3 pt-3 border-top">
                            <p class="small fw-semibold mb-2"><i class="bi bi-terminal me-1"></i>Quick Start â€” Install as persistent service</p>
                            <p class="small text-muted mb-2"><i class="bi bi-check-circle text-success me-1"></i>Server URL and API key are already embedded. Just run the script:</p>
                            <div class="small">
                                <p class="mb-1 text-muted"><strong>Windows</strong> (run as Administrator):</p>
                                <div class="bg-dark text-light rounded p-2 mb-1 font-monospace" style="font-size: 0.75rem;">
                                    .\sentrikat-agent.ps1 -InstallService
                                </div>
                                <p class="mb-2 text-muted" style="font-size: 0.7rem;"><i class="bi bi-info-circle me-1"></i>Registers as a Windows service (visible in services.msc). Or use <code>-Install</code> for scheduled tasks instead.</p>
                                <p class="mb-1 text-muted"><strong>Linux</strong>:</p>
                                <div class="bg-dark text-light rounded p-2 mb-1 font-monospace" style="font-size: 0.75rem;">
                                    chmod +x sentrikat-agent.sh && sudo ./sentrikat-agent.sh --install
                                </div>
                                <p class="mb-2 text-muted" style="font-size: 0.7rem;"><i class="bi bi-info-circle me-1"></i>Registers as a systemd service with automatic heartbeat.</p>
                                <p class="mb-1 text-muted"><strong>macOS</strong>:</p>
                                <div class="bg-dark text-light rounded p-2 mb-1 font-monospace" style="font-size: 0.75rem;">
                                    chmod +x sentrikat-agent-macos.sh && sudo ./sentrikat-agent-macos.sh --install
                                </div>
                                <p class="mb-0 text-muted" style="font-size: 0.7rem;"><i class="bi bi-info-circle me-1"></i>Registers as a LaunchDaemon with automatic heartbeat.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="loadAgentKeys()">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View API Key Modal (generic for integrations) -->
<div class="modal fade" id="viewApiKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-key me-2"></i><span id="viewApiKeyTitle">API Key</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold">API Key</label>
                    <div class="input-group">
                        <input type="text" class="form-control font-monospace bg-light" id="viewApiKeyValue" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyViewedApiKey()">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="card bg-light">
                    <div class="card-body py-2">
                        <small><strong>Usage:</strong> Include this key in the appropriate HTTP header when calling the API.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Asset Details Modal -->
<div class="modal fade" id="assetDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pc-display me-2"></i>Asset Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="assetDetailsBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2">Loading asset details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">
                    <i class="bi bi-person-plus me-2"></i>Create User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">

                    <!-- Auth Type Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Authentication Type *</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="authType" id="authLocal" value="local" checked onchange="toggleAuthFields()">
                            <label class="btn btn-outline-primary" for="authLocal">
                                <i class="bi bi-key me-1"></i>Local Account
                            </label>
                            <input type="radio" class="btn-check" name="authType" id="authLdap" value="ldap" onchange="toggleAuthFields()">
                            <label class="btn btn-outline-primary" for="authLdap" id="authLdapLabel">
                                <i class="bi bi-diagram-3 me-1"></i>LDAP Account
                            </label>
                        </div>
                        <small class="form-text text-muted">Local: Password stored in database. LDAP: Authenticates against Active Directory</small>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="username" class="form-label fw-semibold">Username *</label>
                            <input type="text" class="form-control" id="username" required>
                            <small class="form-text text-muted" id="usernameHelp">For LDAP: Use AD sAMAccountName</small>
                        </div>

                        <div class="col-md-6">
                            <label for="email" class="form-label fw-semibold">Email *</label>
                            <input type="email" class="form-control" id="email" required>
                            <small class="form-text text-muted">User's login email. Also used for password reset and account notifications</small>
                        </div>

                        <div class="col-md-12">
                            <label for="fullName" class="form-label fw-semibold">Full Name</label>
                            <input type="text" class="form-control" id="fullName">
                        </div>

                        <!-- Password fields (only for local auth) -->
                        <div class="col-md-6" id="passwordField">
                            <label for="password" class="form-label fw-semibold">Password *</label>
                            <input type="password" class="form-control" id="password">
                            <small class="form-text text-muted">Minimum 8 characters</small>
                        </div>

                        <div class="col-md-6" id="passwordConfirmField">
                            <label for="passwordConfirm" class="form-label fw-semibold">Confirm Password *</label>
                            <input type="password" class="form-control" id="passwordConfirm">
                        </div>

                        <div class="col-md-6" id="primaryOrgField">
                            <label for="organization" class="form-label fw-semibold">Primary Organization <span id="orgRequired">*</span></label>
                            <select class="form-select" id="organization">
                                <option value="">Loading...</option>
                            </select>
                            <small class="text-muted" id="orgHelp">Initial organization for the user. Additional orgs can be added after creation.</small>
                        </div>

                        <div class="col-md-12">
                            <label for="userRole" class="form-label fw-semibold">Role *</label>
                            <select class="form-select" id="userRole" onchange="updateRoleDescription(); updateOrgRequirement()">
                                <option value="user">User - View-only access to vulnerabilities</option>
                                <option value="manager">Manager - Can manage products and view vulnerabilities</option>
                                <option value="org_admin">Organization Admin - Full access within their organization</option>
                                {% if current_user and current_user.is_super_admin() %}
                                <option value="super_admin">Super Admin - Full system access across all organizations</option>
                                {% endif %}
                            </select>
                            <div class="alert alert-sm mt-2" id="roleDescription"></div>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label fw-semibold">Additional Permissions</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="canManageProducts">
                                <label class="form-check-label" for="canManageProducts">
                                    Can manage products (add/edit/delete)
                                </label>
                            </div>
                            <div class="form-check" id="viewAllOrgsCheck">
                                <input type="checkbox" class="form-check-input" id="canViewAllOrgs">
                                <label class="form-check-label" for="canViewAllOrgs">
                                    Can view all organizations (super admin only)
                                </label>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="form-check form-switch">
                                <input type="checkbox" class="form-check-input" id="isActive" checked>
                                <label class="form-check-label fw-semibold" for="isActive">
                                    Active (user can log in)
                                </label>
                            </div>
                        </div>

                        <!-- Security Settings (shown when editing local users) -->
                        <div class="col-md-12 mt-3" id="securitySettingsSection" style="display: none;">
                            <div class="card border-info">
                                <div class="card-header bg-info bg-opacity-10 d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-shield-lock me-2"></i>Security Settings</span>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <!-- 2FA Status -->
                                        <div class="col-md-6">
                                            <label class="form-label text-muted small mb-1">Two-Factor Authentication</label>
                                            <div id="user2FAStatus">
                                                <span class="badge bg-secondary">Loading...</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <div id="user2FAActions">
                                                <!-- Actions will be populated by JS -->
                                            </div>
                                        </div>
                                        <!-- Password Status -->
                                        <div class="col-md-6">
                                            <label class="form-label text-muted small mb-1">Password Status</label>
                                            <div id="userPasswordStatus">
                                                <span class="badge bg-secondary">Loading...</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <button type="button" class="btn btn-sm btn-outline-warning" id="forcePasswordChangeBtn" onclick="forcePasswordChangeFromModal()">
                                                <i class="bi bi-key me-1"></i>Force Password Change
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Organization Memberships (shown when editing) -->
                        <div class="col-md-12 mt-4" id="orgMembershipsSection" style="display: none;">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-buildings me-2"></i>Organization Memberships</span>
                                    <button type="button" class="btn btn-sm btn-light" onclick="showAddOrgMembershipModal()">
                                        <i class="bi bi-plus-circle me-1"></i>Add Organization
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Organization</th>
                                                    <th>Role</th>
                                                    <th>Type</th>
                                                    <th style="width: 120px;">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="orgMembershipsTable">
                                                <tr>
                                                    <td colspan="4" class="text-center text-muted py-3">
                                                        <i class="bi bi-info-circle me-1"></i>Loading memberships...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">
                    <i class="bi bi-check-circle me-1"></i>Save User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Organization Membership Modal -->
<div class="modal fade" id="addOrgMembershipModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-building-add me-2"></i>Add Organization Membership
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="addOrgMembershipUserId">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Organization *</label>
                    <select class="form-select" id="addOrgMembershipOrg" required>
                        <option value="">Select organization...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Role *</label>
                    <select class="form-select" id="addOrgMembershipRole" required>
                        <option value="user">User - View-only access</option>
                        <option value="manager">Manager - Can manage products</option>
                        <option value="org_admin">Organization Admin - Full org access</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addOrgMembership()">
                    <i class="bi bi-check-circle me-1"></i>Add Membership
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Organization Modal -->
<div class="modal fade" id="orgModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orgModalTitle">
                    <i class="bi bi-building me-2"></i>Create Organization
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="orgForm">
                    <input type="hidden" id="orgId">

                    <ul class="nav nav-tabs mb-3" id="orgFormTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basicInfo" type="button">
                                <i class="bi bi-info-circle me-1"></i>Basic Info
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="smtp-tab" data-bs-toggle="tab" data-bs-target="#smtpConfig" type="button">
                                <i class="bi bi-envelope me-1"></i>Email (SMTP)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alertSettings" type="button">
                                <i class="bi bi-bell me-1"></i>Alert Settings
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="webhook-tab" data-bs-toggle="tab" data-bs-target="#webhookSettings" type="button">
                                <i class="bi bi-broadcast me-1"></i>Webhook
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Basic Info Tab -->
                        <div class="tab-pane fade show active" id="basicInfo">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="orgName" class="form-label fw-semibold">Organization Name *</label>
                                    <input type="text" class="form-control" id="orgName" required>
                                    <small class="form-text text-muted">Unique identifier (lowercase, no spaces)</small>
                                </div>

                                <div class="col-md-6">
                                    <label for="orgDisplayName" class="form-label fw-semibold">Display Name *</label>
                                    <input type="text" class="form-control" id="orgDisplayName" required>
                                    <small class="form-text text-muted">Shown in UI</small>
                                </div>

                                <div class="col-md-12">
                                    <label for="orgDescription" class="form-label fw-semibold">Description</label>
                                    <textarea class="form-control" id="orgDescription" rows="2"></textarea>
                                </div>

                                <div class="col-md-12">
                                    <label for="orgEmails" class="form-label fw-semibold">Notification Emails</label>
                                    <input type="text" class="form-control" id="orgEmails" placeholder="email1@company.com, email2@company.com">
                                    <small class="form-text text-muted">SentriKat sends CVE alerts, ransomware warnings, and vulnerability reports to these addresses. Comma-separated</small>
                                </div>

                                <div class="col-md-12">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="orgActive" checked>
                                        <label class="form-check-label fw-semibold" for="orgActive">
                                            Active
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SMTP Config Tab -->
                        <div class="tab-pane fade" id="smtpConfig">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure SMTP settings for this organization's email alerts. Leave empty to use global SMTP settings.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="smtpHost" class="form-label fw-semibold">SMTP Server</label>
                                    <input type="text" class="form-control" id="smtpHost" placeholder="smtp.gmail.com">
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpPort" class="form-label fw-semibold">Port</label>
                                    <input type="number" class="form-control" id="smtpPort" value="587" onchange="autoConfigureSmtpSecurity()">
                                    <small class="form-text text-muted">
                                        25 = Plain SMTP (no TLS/SSL) | 587 = TLS/STARTTLS | 465 = SSL
                                    </small>
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpUsername" class="form-label fw-semibold">Username</label>
                                    <input type="text" class="form-control" id="smtpUsername">
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpPassword" class="form-label fw-semibold">Password</label>
                                    <input type="password" class="form-control" id="smtpPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                    <small class="form-text text-muted">Leave blank to keep existing password</small>
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpFromEmail" class="form-label fw-semibold">From Email</label>
                                    <input type="email" class="form-control" id="smtpFromEmail" placeholder="noreply@company.com">
                                    <small class="form-text text-muted">Overrides global SMTP sender for this organization's alerts</small>
                                </div>

                                <div class="col-md-6">
                                    <label for="smtpFromName" class="form-label fw-semibold">From Name</label>
                                    <input type="text" class="form-control" id="smtpFromName" value="SentriKat Alerts">
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="smtpUseTls" checked>
                                        <label class="form-check-label fw-semibold" for="smtpUseTls">
                                            Use TLS/STARTTLS
                                        </label>
                                    </div>
                                    <small class="text-muted">For port 587</small>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="smtpUseSsl">
                                        <label class="form-check-label fw-semibold" for="smtpUseSsl">
                                            Use SSL
                                        </label>
                                    </div>
                                    <small class="text-muted">For port 465</small>
                                </div>

                                <div class="col-md-12">
                                    <button type="button" class="btn btn-outline-primary" onclick="testSMTP()">
                                        <i class="bi bi-envelope-check me-1"></i>Test SMTP Connection
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Alert Settings Tab -->
                        <div class="tab-pane fade" id="alertSettings">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure when this organization receives email alerts
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="alertCritical" checked>
                                        <label class="form-check-label" for="alertCritical">
                                            <strong>Alert on Critical CVEs</strong> (CVSS 9.0-10.0)
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="alertHigh">
                                        <label class="form-check-label" for="alertHigh">
                                            <strong>Alert on High CVEs</strong> (CVSS 7.0-8.9)
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="alertNewCVE" checked>
                                        <label class="form-check-label" for="alertNewCVE">
                                            <strong>Alert on New CVEs</strong> (when CISA adds new vulnerabilities)
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="alertRansomware" checked>
                                        <label class="form-check-label" for="alertRansomware">
                                            <strong>Alert on Ransomware</strong> (known to be used in ransomware)
                                        </label>
                                    </div>
                                </div>

                                <div class="col-12 mt-3">
                                    <hr>
                                    <h6 class="text-muted"><i class="bi bi-gear me-1"></i>Alert Mode Override</h6>
                                    <small class="text-muted">Leave blank to use global default settings</small>
                                </div>

                                <div class="col-md-6">
                                    <label for="orgAlertMode" class="form-label">Alert Mode</label>
                                    <select class="form-select" id="orgAlertMode">
                                        <option value="">Use Global Default</option>
                                        <option value="new_only">New Only - Only new CVEs from each sync</option>
                                        <option value="daily_reminder">Daily Reminder - All unack'd due within 7 days</option>
                                        <option value="escalation">Escalation - Re-alert as CVEs approach due</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label for="orgEscalationDays" class="form-label">Escalation Days</label>
                                    <input type="number" class="form-control" id="orgEscalationDays" placeholder="Use global default" min="1" max="14">
                                    <small class="form-text text-muted">Days before due date to re-alert (for escalation mode)</small>
                                </div>
                            </div>
                        </div>

                        <!-- Webhook Settings Tab -->
                        <div class="tab-pane fade" id="webhookSettings">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configure a webhook for this organization. Takes priority over global webhook settings.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-12">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="orgWebhookEnabled">
                                        <label class="form-check-label fw-semibold" for="orgWebhookEnabled">
                                            Enable Organization Webhook
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-8">
                                    <label for="orgWebhookUrl" class="form-label fw-semibold">Webhook URL</label>
                                    <input type="url" class="form-control" id="orgWebhookUrl" placeholder="https://hooks.slack.com/services/...">
                                    <small class="form-text text-muted">Incoming webhook URL from your chat platform</small>
                                </div>

                                <div class="col-md-4">
                                    <label for="orgWebhookFormat" class="form-label fw-semibold">Platform Format</label>
                                    <select class="form-select" id="orgWebhookFormat">
                                        <option value="slack">Slack</option>
                                        <option value="rocketchat">RocketChat</option>
                                        <option value="discord">Discord</option>
                                        <option value="teams">Microsoft Teams</option>
                                        <option value="custom">Custom JSON</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label for="orgWebhookName" class="form-label fw-semibold">Webhook Name</label>
                                    <input type="text" class="form-control" id="orgWebhookName" placeholder="Org Alerts">
                                    <small class="form-text text-muted">Display name for this webhook</small>
                                </div>

                                <div class="col-md-6">
                                    <label for="orgWebhookToken" class="form-label fw-semibold">Auth Token <span class="text-muted">(optional)</span></label>
                                    <input type="password" class="form-control" id="orgWebhookToken" placeholder="Leave empty if not needed">
                                    <small class="form-text text-muted">For webhooks requiring authentication</small>
                                </div>

                                <div class="col-md-12">
                                    <button type="button" class="btn btn-outline-primary" onclick="testOrgWebhook()">
                                        <i class="bi bi-send me-1"></i>Test Webhook
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveOrganization()">
                    <i class="bi bi-check-circle me-1"></i>Save Organization
                </button>
            </div>
        </div>
    </div>
</div>

<!-- LDAP Search Modal -->
<div class="modal fade" id="ldapSearchModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-search me-2"></i>Search LDAP Directory
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="ldapSearchQuery" placeholder="Search by username, email, or name (use * for wildcard)">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="searchLdapUsers()">
                            <i class="bi bi-search me-1"></i>Search
                        </button>
                    </div>
                </div>
                <div id="ldapSearchResultsTable">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search" style="font-size: 2rem;"></i>
                        <p class="mt-2">Enter a search query and click Search</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- LDAP Invite User Modal -->
<div class="modal fade" id="ldapInviteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus me-2"></i>Invite LDAP User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="ldapInviteForm">
                    <input type="hidden" id="ldapUserDN">

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        This user will be invited to SentriKat and will authenticate using LDAP credentials.
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="ldapInviteUsername" class="form-label fw-semibold">Username *</label>
                            <input type="text" class="form-control bg-light text-muted" id="ldapInviteUsername" readonly>
                            <small class="text-muted">From LDAP - cannot be changed</small>
                        </div>

                        <div class="col-md-6">
                            <label for="ldapInviteEmail" class="form-label fw-semibold">Email *</label>
                            <input type="email" class="form-control bg-light text-muted" id="ldapInviteEmail" readonly>
                            <small class="text-muted">From LDAP - cannot be changed</small>
                        </div>

                        <div class="col-md-12">
                            <label for="ldapInviteFullName" class="form-label fw-semibold">Full Name</label>
                            <input type="text" class="form-control bg-light text-muted" id="ldapInviteFullName" readonly>
                            <small class="text-muted">From LDAP - cannot be changed</small>
                        </div>

                        <div class="col-md-6" id="ldapInviteOrgField">
                            <label for="ldapInviteOrganization" class="form-label fw-semibold">Organization <span id="ldapOrgRequired">*</span></label>
                            <select class="form-select" id="ldapInviteOrganization" required>
                                <option value="">Select organization...</option>
                            </select>
                            <small class="text-muted" id="ldapOrgHelp"></small>
                        </div>

                        <div class="col-md-6">
                            <label for="ldapInviteRole" class="form-label fw-semibold">Role *</label>
                            <select class="form-select" id="ldapInviteRole" required onchange="updateLdapInviteOrgRequirement()">
                                <option value="user">User - View-only access</option>
                                <option value="manager">Manager - Can manage products</option>
                                <option value="org_admin">Organization Admin - Full org access</option>
                                <option value="super_admin">Super Admin - Full system access</option>
                            </select>
                        </div>

                        <div class="col-md-12">
                            <div id="ldapInviteGroups" class="alert alert-secondary">
                                <strong>LDAP Groups:</strong> <span id="ldapGroupsList">Loading...</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="inviteLdapUser()">
                    <i class="bi bi-check-circle me-1"></i>Invite User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Group Mapping Modal -->
<div class="modal fade" id="groupMappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="groupMappingModalTitle">Create Group Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="groupMappingForm">
                    <input type="hidden" id="mappingId">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">LDAP Group DN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ldapGroupDn" required
                                   placeholder="CN=Admins,OU=Groups,DC=company,DC=com">
                            <small class="text-muted">Full Distinguished Name of the LDAP group</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Group Common Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ldapGroupCn" required
                                   placeholder="Admins">
                            <small class="text-muted">Display name for the group</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Organization</label>
                            <select class="form-select" id="mappingOrganization">
                                <option value="">All Organizations</option>
                            </select>
                            <small class="text-muted">Leave blank for system-wide mapping</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Assigned Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="mappingRole" required>
                                <option value="">Select Role...</option>
                                <option value="user">User - Basic access</option>
                                <option value="manager">Manager - Team management</option>
                                <option value="org_admin">Organization Admin - Full org access</option>
                                <option value="super_admin">Super Admin - Full system access</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Priority</label>
                            <input type="number" class="form-control" id="mappingPriority" value="0" min="0" max="100">
                            <small class="text-muted">Higher priority wins if user is in multiple groups</small>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="ldapGroupDescription" rows="2"
                                      placeholder="Optional description of this group mapping"></textarea>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoProvision" checked>
                                <label class="form-check-label" for="autoProvision">
                                    Auto-Provision Users
                                </label>
                            </div>
                            <small class="text-muted">Automatically create accounts when users login</small>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoDeprovision">
                                <label class="form-check-label" for="autoDeprovision">
                                    Auto-Deprovision Users
                                </label>
                            </div>
                            <small class="text-muted">Deactivate users when they leave the group</small>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="syncEnabled" checked>
                                <label class="form-check-label" for="syncEnabled">
                                    Sync Enabled
                                </label>
                            </div>
                            <small class="text-muted">Include in automatic synchronization</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveGroupMapping()">Save Mapping</button>
            </div>
        </div>
    </div>
</div>

<!-- LDAP Group Discovery Modal -->
<div class="modal fade" id="ldapDiscoveryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Discover LDAP Groups</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="groupSearchBase"
                               placeholder="Search base DN (e.g., OU=Groups,DC=company,DC=com)">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="performGroupDiscovery()">
                            <i class="bi bi-search me-1"></i>Search
                        </button>
                    </div>
                </div>
                <div id="discoveredGroupsContainer">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-diagram-2" style="font-size: 3rem;"></i>
                        <p class="mt-3">Enter a search base DN and click Search to discover LDAP groups</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin_panel.js') }}"></script>
<script>
// Hash-based navigation for admin panel sections
// Supports compound hashes like #settings:auth or #integrations:pushAgents
function activateTabFromHash() {
    const rawHash = window.location.hash.replace('#', '') || 'users';

    // Parse compound hash: "settings:auth" â†’ mainTab="settings", subTab="auth"
    const colonIdx = rawHash.indexOf(':');
    const mainTab = colonIdx > -1 ? rawHash.substring(0, colonIdx) : rawHash;
    const subTab = colonIdx > -1 ? rawHash.substring(colonIdx + 1) : null;

    // Validate that the main tab exists
    const tabButton = document.getElementById(mainTab + '-tab');
    if (tabButton) {
        // Hide all main tab panes first (only direct children of adminTabsContent)
        document.querySelectorAll('#adminTabsContent > .tab-pane').forEach(pane => {
            pane.classList.remove('show', 'active');
        });

        // Show the target pane
        const targetPane = document.getElementById(mainTab);
        if (targetPane) {
            targetPane.classList.add('show', 'active');

            // Handle inner sub-tab activation
            if (subTab) {
                // Settings uses showSettingsGroup() for sub-tabs
                if (mainTab === 'settings' && typeof showSettingsGroup === 'function') {
                    const settingsTabBtn = document.getElementById(subTab + '-settings-tab') ||
                                           document.getElementById(subTab + '-tab');
                    showSettingsGroup(subTab, settingsTabBtn);
                }
                // Integrations uses Bootstrap pills for sub-tabs
                else if (mainTab === 'integrations') {
                    const pillMapping = {
                        'pushAgents': 'push-agents-tab',
                        'jiraIntegration': 'jira-integration-tab'
                    };
                    const pillTabId = pillMapping[subTab];
                    if (pillTabId) {
                        const pillBtn = document.getElementById(pillTabId);
                        if (pillBtn) pillBtn.click();
                    }
                }
            } else {
                // No sub-tab specified: activate first inner pill/group if present
                if (mainTab === 'settings' && typeof showSettingsGroup === 'function') {
                    const firstBtn = targetPane.querySelector('#settingsTabs .nav-link');
                    if (firstBtn) {
                        const match = firstBtn.getAttribute('onclick')?.match(/showSettingsGroup\('(\w+)'/);
                        if (match) showSettingsGroup(match[1], firstBtn);
                    }
                } else {
                    const innerPillsNav = targetPane.querySelector('.nav-pills');
                    if (innerPillsNav) {
                        const firstPill = innerPillsNav.querySelector('.nav-link');
                        const innerTabContent = targetPane.querySelector('.tab-content');
                        if (firstPill && innerTabContent) {
                            innerPillsNav.querySelectorAll('.nav-link').forEach(p => p.classList.remove('active'));
                            firstPill.classList.add('active');
                            innerTabContent.querySelectorAll('.tab-pane').forEach(p => {
                                p.classList.remove('show', 'active');
                            });
                            const firstInnerPane = innerTabContent.querySelector('.tab-pane');
                            if (firstInnerPane) firstInnerPane.classList.add('show', 'active');
                        }
                    }
                }
            }
        }

        // Update active state on hidden tab buttons
        document.querySelectorAll('#adminTabs button').forEach(btn => {
            btn.classList.remove('active');
        });
        tabButton.classList.add('active');

        // Scroll to top of content
        window.scrollTo(0, 0);
        const mainContent = document.querySelector('.main-content');
        if (mainContent) {
            mainContent.scrollTop = 0;
        }
    }
}

// Load data for the currently active section (since manual CSS activation doesn't fire shown.bs.tab)
function loadDataForActiveSection() {
    const activePane = document.querySelector('#adminTabsContent > .tab-pane.active');
    if (!activePane) return;
    const id = activePane.id;
    if (id === 'integrations') {
        // Check which inner pill is active
        const activePill = activePane.querySelector('.tab-pane.active');
        if (activePill) {
            const pillId = activePill.id;
            if (pillId === 'pushAgents') {
                if (typeof loadAgentKeys === 'function') loadAgentKeys();
                if (typeof loadAgentScriptOrganizations === 'function') loadAgentScriptOrganizations();
            } else if (pillId === 'jiraIntegration') {
                if (typeof loadJiraSettings === 'function') loadJiraSettings();
            } else if (pillId === 'pullSources') {
                if (typeof loadIntegrations === 'function') loadIntegrations();
            } else if (pillId === 'importQueue') {
                if (typeof loadImportQueue === 'function') loadImportQueue();
            }
        }
    }
}

// Activate correct tab immediately when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Run immediately
    activateTabFromHash();

    // Also run after a short delay to ensure Bootstrap is ready and load data
    setTimeout(function() {
        activateTabFromHash();
        loadDataForActiveSection();
    }, 100);
});

// Handle back/forward navigation
window.addEventListener('hashchange', function() {
    activateTabFromHash();
    setTimeout(loadDataForActiveSection, 50);
});

// Handle tab clicks to update URL and sidebar highlight
document.querySelectorAll('#adminTabs button[data-bs-toggle="tab"]').forEach(function(tabButton) {
    tabButton.addEventListener('shown.bs.tab', function(e) {
        const target = e.target.getAttribute('data-bs-target');
        if (target) {
            history.replaceState(null, null, target);
            // Update sidebar highlighting to match the new tab
            if (typeof updateSidebarHighlight === 'function') {
                updateSidebarHighlight();
            }
        }
    });
});

// --- CPE Dictionary & KB Status ---
async function loadCpeDictStatus() {
    try {
        const resp = await fetch('/api/cpe/dictionary/status');
        if (!resp.ok) return;
        const data = await resp.json();
        const el = id => document.getElementById(id);
        if (el('cpeDictTotal')) el('cpeDictTotal').textContent = (data.total_entries || 0).toLocaleString();
        if (el('cpeDictAliases')) el('cpeDictAliases').textContent = (data.with_aliases || 0).toLocaleString();
        if (el('cpeDictUsed')) el('cpeDictUsed').textContent = (data.used_for_matching || 0).toLocaleString();
        if (el('cpeDictLastBulk')) el('cpeDictLastBulk').textContent = data.last_bulk_download ? new Date(data.last_bulk_download).toLocaleString() : 'Never';
        if (el('cpeDictLastSync')) el('cpeDictLastSync').textContent = data.last_nvd_sync ? new Date(data.last_nvd_sync).toLocaleString() : 'Never';
    } catch (e) { console.error('CPE dict status error:', e); }

    // Also load system health for coverage
    try {
        const resp = await fetch('/api/system/health');
        if (!resp.ok) return;
        const data = await resp.json();
        const el = document.getElementById('cpeDictCoverage');
        if (el && data.cpe_coverage) el.textContent = data.cpe_coverage.coverage_percent + '%';
    } catch (e) {}
}

async function loadKbStatus() {
    try {
        const resp = await fetch('/api/cpe/kb/status');
        if (!resp.ok) return;
        const data = await resp.json();
        const el = id => document.getElementById(id);
        if (el('kbUser')) el('kbUser').textContent = (data.local_mappings?.user || 0).toLocaleString();
        if (el('kbAutoVerified')) el('kbAutoVerified').textContent = (data.local_mappings?.auto_verified || 0).toLocaleString();
        if (el('kbAutoNvd')) el('kbAutoNvd').textContent = (data.local_mappings?.auto_nvd || 0).toLocaleString();
        if (el('kbCommunity')) el('kbCommunity').textContent = (data.local_mappings?.community || 0).toLocaleString();
        if (el('kbServer')) el('kbServer').textContent = data.kb_server || '-';
        if (el('kbLastPull')) el('kbLastPull').textContent = data.last_pull ? new Date(data.last_pull).toLocaleString() : 'Never';
    } catch (e) { console.error('KB status error:', e); }
}

async function syncCpeDictionary(force = false) {
    const btn = document.getElementById('btnSyncCpeDict');
    if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Syncing...'; }
    try {
        const resp = await fetch('/api/cpe/dictionary/sync-nvd', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ force: force })
        });
        const data = await resp.json();
        const resultEl = document.getElementById('cpeDictSyncResult');
        const msgEl = document.getElementById('cpeDictSyncMsg');
        if (resultEl && msgEl) {
            msgEl.textContent = data.message || 'CPE dictionary sync started in background.';
            resultEl.classList.remove('d-none');
        }
        // Refresh stats after delay
        setTimeout(loadCpeDictStatus, 30000);
        setTimeout(loadCpeDictStatus, 90000);
    } catch (e) {
        if (typeof showToast === 'function') showToast('CPE dictionary sync failed: ' + e.message, 'danger');
    } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-cloud-download me-1"></i>Sync CPE Dictionary Now'; }
    }
}

async function rebuildCpeDictionary() {
    const btn = document.getElementById('btnRebuildCpeDict');
    if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Rebuilding...'; }
    try {
        const resp = await fetch('/api/cpe/dictionary/rebuild', { method: 'POST' });
        const data = await resp.json();
        if (typeof showToast === 'function') showToast(data.message || 'Dictionary rebuilt', 'success');
        loadCpeDictStatus();
    } catch (e) {
        if (typeof showToast === 'function') showToast('Rebuild failed: ' + e.message, 'danger');
    } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Rebuild from Vulnerabilities'; }
    }
}

// Load CPE dict & KB status when settings tab is active
setTimeout(() => { loadCpeDictStatus(); loadKbStatus(); }, 2000);

// ============================================================================
// Log Viewer
// ============================================================================

async function loadLogFile() {
    const container = document.getElementById('logViewerContainer');
    const logName = document.getElementById('logFileSelect').value;
    const level = document.getElementById('logLevelFilter').value;
    const search = document.getElementById('logSearchInput').value;
    const lines = document.getElementById('logLinesCount').value;

    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div> Loading...</div>';

    try {
        const params = new URLSearchParams({lines});
        if (search) params.set('search', search);
        if (level) params.set('level', level);

        const resp = await fetch(`/api/admin/logs/${logName}?${params}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        document.getElementById('logFileStats').textContent =
            `Showing ${data.returned} of ${data.total} lines | File size: ${formatBytes(data.file_size || 0)}`;

        if (!data.lines || data.lines.length === 0) {
            container.innerHTML = '<div class="text-center py-4 text-muted"><i class="bi bi-journal me-2"></i>No log entries found</div>';
            return;
        }

        const searchLower = search.toLowerCase();
        const html = data.lines.map(line => {
            let cls = 'log-line';
            if (line.includes('ERROR') || line.includes('CRITICAL')) cls += ' log-error';
            else if (line.includes('WARNING')) cls += ' log-warning';
            else if (line.includes('DEBUG')) cls += ' log-debug';

            let escaped = line.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            // Highlight search term
            if (searchLower) {
                const regex = new RegExp(`(${search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                escaped = escaped.replace(regex, '<mark>$1</mark>');
            }
            return `<div class="${cls}">${escaped}</div>`;
        }).join('');

        container.innerHTML = html;
    } catch (e) {
        container.innerHTML = `<div class="text-center py-4 text-danger"><i class="bi bi-exclamation-triangle me-2"></i>${e.message}</div>`;
    }
}

function downloadLogFile() {
    const logName = document.getElementById('logFileSelect').value;
    window.open(`/api/admin/logs/${logName}/download`, '_blank');
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Auto-load logs when the logs tab becomes visible
const _logsPane = document.getElementById('logsSettings');
if (_logsPane) {
    const observer = new MutationObserver(() => {
        if (_logsPane.classList.contains('show') && _logsPane.classList.contains('active')) {
            loadLogFile();
        }
    });
    observer.observe(_logsPane, { attributes: true, attributeFilter: ['class'] });
}

// ============================================================================
// Health Checks
// ============================================================================

async function loadHealthChecks() {
    const container = document.getElementById('healthCheckResults');
    if (!container) return;

    try {
        const resp = await fetch('/api/admin/health-checks');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        // Update global toggle
        const globalToggle = document.getElementById('healthChecksGlobalToggle');
        if (globalToggle) globalToggle.checked = data.enabled !== false;

        // Update notification email
        const emailInput = document.getElementById('healthCheckNotifyEmail');
        if (emailInput) emailInput.value = data.notify_email || '';

        // Update webhook toggle
        const webhookToggle = document.getElementById('healthCheckWebhookToggle');
        if (webhookToggle) webhookToggle.checked = data.notify_webhook === true;

        const checks = data.checks || [];
        if (checks.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No health checks configured</p>';
            return;
        }

        // Group by category
        const categories = {};
        checks.forEach(c => {
            if (!categories[c.category]) categories[c.category] = [];
            categories[c.category].push(c);
        });

        const categoryLabels = {
            system: 'System',
            sync: 'Data Sync',
            agents: 'Agents',
            security: 'Security',
            database: 'Database'
        };

        const statusIcons = {
            ok: '<i class="bi bi-check-circle-fill text-success"></i>',
            warning: '<i class="bi bi-exclamation-triangle-fill text-warning"></i>',
            critical: '<i class="bi bi-x-octagon-fill text-danger"></i>',
            error: '<i class="bi bi-bug-fill text-danger"></i>',
            unknown: '<i class="bi bi-question-circle text-muted"></i>'
        };

        const statusBadges = {
            ok: 'bg-success',
            warning: 'bg-warning text-dark',
            critical: 'bg-danger',
            error: 'bg-danger',
            unknown: 'bg-secondary'
        };

        let html = '';
        for (const [category, categoryChecks] of Object.entries(categories)) {
            html += `<h6 class="text-muted border-bottom pb-2 mt-3 mb-3">
                <i class="bi bi-folder me-1"></i>${categoryLabels[category] || category}
            </h6>`;

            categoryChecks.forEach(check => {
                const result = check.last_result;
                const status = result ? result.status : 'unknown';
                const message = result ? result.message : 'Not checked yet';
                const value = result ? result.value : '-';
                const checkedAt = result && result.checked_at
                    ? new Date(result.checked_at).toLocaleString()
                    : 'Never';

                html += `
                <div class="d-flex align-items-center justify-content-between py-2 px-3 mb-2 rounded border ${status === 'critical' ? 'border-danger' : status === 'warning' ? 'border-warning' : ''}">
                    <div class="d-flex align-items-center flex-grow-1">
                        <div class="form-check form-switch me-3">
                            <input class="form-check-input health-check-toggle" type="checkbox"
                                   data-check="${check.name}" id="hc_${check.name}"
                                   ${check.enabled ? 'checked' : ''}
                                   onchange="toggleSingleHealthCheck('${check.name}', this.checked)">
                        </div>
                        <div>
                            <div class="fw-semibold">
                                ${statusIcons[status] || statusIcons.unknown}
                                <span class="ms-1">${check.label}</span>
                                ${value && value !== '-' ? '<span class="badge ' + (statusBadges[status] || 'bg-secondary') + ' ms-2">' + value + '</span>' : ''}
                            </div>
                            <small class="text-muted">${message}</small>
                        </div>
                    </div>
                    <small class="text-muted ms-3 text-nowrap" title="Last checked">${checkedAt}</small>
                </div>`;
            });
        }

        container.innerHTML = html;
    } catch (e) {
        container.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error loading health checks: ${e.message}</div>`;
    }
}

async function toggleHealthChecksGlobal(enabled) {
    try {
        const resp = await fetch('/api/admin/health-checks/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled })
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        if (typeof showToast === 'function') {
            showToast(enabled ? 'Health checks enabled' : 'Health checks disabled', 'success');
        }
    } catch (e) {
        if (typeof showToast === 'function') showToast('Error: ' + e.message, 'danger');
    }
}

async function toggleSingleHealthCheck(checkName, enabled) {
    try {
        const checks = {};
        checks[checkName] = enabled;
        const resp = await fetch('/api/admin/health-checks/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ checks })
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    } catch (e) {
        if (typeof showToast === 'function') showToast('Error: ' + e.message, 'danger');
    }
}

async function saveHealthCheckSettings() {
    const email = document.getElementById('healthCheckNotifyEmail')?.value || '';
    const webhookEnabled = document.getElementById('healthCheckWebhookToggle')?.checked || false;
    try {
        const resp = await fetch('/api/admin/health-checks/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notify_email: email, notify_webhook: webhookEnabled })
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        if (typeof showToast === 'function') showToast('Health check settings saved', 'success');
    } catch (e) {
        if (typeof showToast === 'function') showToast('Error saving settings: ' + e.message, 'danger');
    }
}

async function runHealthChecksNow() {
    const btn = event?.target?.closest('button');
    if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Running...'; }
    try {
        const resp = await fetch('/api/admin/health-checks/run', { method: 'POST' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        if (typeof showToast === 'function') showToast(data.message || 'Health checks completed', 'success');
        loadHealthChecks();
    } catch (e) {
        if (typeof showToast === 'function') showToast('Error: ' + e.message, 'danger');
    } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-play-circle me-1"></i>Run Now'; }
    }
}

// Auto-load health checks when the tab becomes visible
const _healthObserver = new MutationObserver(() => {
    const pane = document.getElementById('healthSettings');
    if (pane && pane.classList.contains('active')) {
        loadHealthChecks();
        _healthObserver.disconnect();
    }
});
const _healthPane = document.getElementById('healthSettings');
if (_healthPane) _healthObserver.observe(_healthPane, { attributes: true, attributeFilter: ['class'] });
</script>
{% endblock %}
