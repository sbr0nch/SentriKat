# SentriKat Docker Compose Configuration
# ========================================
#
# EXTERNAL DATABASE CONFIGURATION:
# --------------------------------
# To use an external PostgreSQL database (on another machine):
#
# 1. Comment out or remove the 'db' service below
# 2. Update DATABASE_URL in the sentrikat service:
#    DATABASE_URL=postgresql://user:password@external-host:5432/sentrikat
# 3. Remove the 'depends_on' section from sentrikat service
# 4. Remove 'postgres_data' from volumes section
#
# Example for external DB:
#   DATABASE_URL=postgresql://sentrikat:mypassword@192.168.1.100:5432/sentrikat
#
# DEBUG MODE:
# -----------
# To enable debug mode with verbose logging:
#   - Add FLASK_DEBUG=true to environment
#   - Logs will appear in console and /var/log/sentrikat/

services:
  # PostgreSQL Database (comment out this section to use external DB)
  db:
    image: postgres:15-alpine
    container_name: sentrikat-db
    environment:
      POSTGRES_USER: sentrikat
      POSTGRES_PASSWORD: ${DB_PASSWORD:-sentrikat}
      POSTGRES_DB: sentrikat
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sentrikat"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    # Uncomment to expose DB port externally (for management tools):
    # ports:
    #   - "5432:5432"

  # SentriKat Application
  sentrikat:
    build:
      context: .
      args:
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        NO_PROXY: ${NO_PROXY:-}
    container_name: sentrikat
    ports:
      - "5001:5000"
    environment:
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}
      # For external DB, change 'db' to external hostname/IP:
      - DATABASE_URL=postgresql://sentrikat:${DB_PASSWORD:-sentrikat}@db:5432/sentrikat
      - SENTRIKAT_URL=${SENTRIKAT_URL:-http://localhost:5001}
      - FLASK_ENV=production
      - FLASK_DEBUG=${FLASK_DEBUG:-false}
      - FORCE_HTTPS=false
      - SESSION_COOKIE_SECURE=false
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1,db}
    volumes:
      - sentrikat_data:/app/data
      - sentrikat_logs:/var/log/sentrikat
    # Remove depends_on if using external database:
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/sync/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  postgres_data:      # Remove if using external DB
  sentrikat_data:
  sentrikat_logs:
